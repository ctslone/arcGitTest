rsb.templateEditor = function(props) {var DEFAULTS = {hasDataConnections: false,hasAddTableBtn: true,hasRestrictUsers: false,editorTitle: 'Template Editor',wizardTitle: 'Add Template',templateNameLabel: 'Template Name',connectionInfo: '&nbsp;&nbsp;' + 'Select a data connection from the list below.',tableInfo: '&nbsp;&nbsp;' + 'Select a resource for your API from the list below.',columnInfo: 'Select the properties for your resource from the list below.',columnName: 'Column Name',retrieveTemplateInfo: 'Retrieving template',retrieveDataConnectInfo: 'Retrieving list of data connections',retrieveTableInfo: 'Retrieving table listing',retrieveColumnInfo: 'Retrieving table information',tableColumnName: 'Table Name',defaultDescription: 'Create, Update, Query, and Delete',defaultViewDescription: 'Query',visibleColumnColumns: ["datatype", "size", "key", "nullable", "description"],templateNameEditable: false,skipEditor: false,columnEditable: false,useSaveGenerateButton: false,multiSchemaImport: false,enableFullTextSearch: false,load: function(name, args, callback) { throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "load"}); },save: function(connectionname, tablename, name, code, args, callback) { throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "save"}); },listDataConnections: function(args, callback) { throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "listDataConnections"}); },listTables: function(connectionname, args, callback) { throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "listTables"}); },listColumns: function(connectionname, tablename, args, callback) { throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "listColumns"}); },generate: function(connectionname, tablename, desc, columns, args, callback) { throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "generate"}); },preview: function(templateName, data, input, top, skip, count, args, callback) { throw rsb.evalTemplate("The $func$ function is not implemented.", {"func": "preview"}); },ready: function(modal) {},saveSample: function(connectionname, tablename, name, sample, input, args, callback) { throw rsb.evalTemplate("The $func$ function is not implemented.", {"func": "saveSample"}); }};var _props = $.extend(DEFAULTS, props);var _args = null;var _curView = null;var _isEdit = false;var _templateEditor = null;var _selectedConnection = null;var _selectedTable = null;var _selectedTableType = null;var _cloneModal = function($modal) {var id = $modal.attr("id");$modal = $modal.clone().appendTo($modal.parent());$modal.attr("id", function() {var index = 1;var newId = id + "_" + index;while ($("#" + newId).length > 0) {index++;newId = id + "_" + index}
return newId});return $modal}
var _editor = _cloneModal($("#templateEditorModal"));var _btnListTables = _editor.find(".list-tables-btn");var _restrictUser = _editor.find(".restrictUser");var _btnPreview = _editor.find(".preview-btn");var _btnBack = _editor.find(".back-connects-btn");var _btnNext = _editor.find(".next-btn");var _btnGen = _editor.find(".gene-btn");var _btnSave = _editor.find(".save-btn");var _btnYes = _editor.find(".yes-btn");var _chkAllColumns = _editor.find(".allcolumnsselected");var _chkAllTables = _editor.find(".alltablesselected");var _viewStatus = _editor.find(".status-view");var _barStatus = _editor.find(".template-status");var _title = _editor.find(".templateEditorModalLabel");var _txtTemplName = _editor.find(".templatename");var _txtTemplOName = _editor.find(".templateoname");var _txtTemplNameCol = _editor.find(".templatenamecol");var _txtTemplONameCol = _editor.find(".templateonamecol");var _txtTemplDescCol = _editor.find(".templatedesccol");var _divOperations = _editor.find(".operationsContainer");var _pResult = _editor.find(".templateResult");var _tbColumnsHeaders = _editor.find(".columns-table-header");var _tbColumns = _editor.find(".columns-table tbody");var _tbTablesHeaders = _editor.find(".tables-table-header");var _tbTables = _editor.find(".tables-table tbody");var _viewTables = _editor.find(".tables-view");var _tbConnections = _editor.find(".connections-table tbody");var _editorNavPills = _editor.find(".editor-view .nav-pills");var _addChildTableModal = _cloneModal($("#templateAddChildTableModal"));var _childTableList = _addChildTableModal.find("select");var _addChildTableBtn = _addChildTableModal.find(".btn.btn-add-table");_editor.find(".connection-info").html(_props.connectionInfo);_editor.find(".table-info").html(_props.tableInfo);_editor.find(".column-info").html(_props.columnInfo);_tbColumnsHeaders.find(".column-name").html(_props.columnName);if (_props.hasDataConnections) {_btnBack.addClass("tables-view")}
if (!_props.hasRestrictUsers) {_editor.find(".restrictUserGroup").addClass("hidden")}
if (!_props.skipEditor) {_editor.find(".columns-view .panel-body").css("height", "470px").css("max-height", "470px")}
if (_props.multiSchemaImport) {_tbTablesHeaders.find(".table-checkbox").removeClass("hidden")}
_editor.find(".templateNameLabel").html(_props.templateNameLabel + ":");_editor.find(".templateNameLabelCol").html(_props.templateNameLabel + ":");_txtTemplName.attr("placeholder", _props.templateNameLabel);_txtTemplNameCol.attr("placeholder", _props.templateNameLabel);_tbTablesHeaders.find(".table-name").text(_props.tableColumnName);var _templateChanged = function() {if (_txtTemplName.val() != _txtTemplOName.val() || _templateEditor.historySize().undo > 0) {rsb.templateEditor.enableButton(_btnSave)} else {rsb.templateEditor.disableButton(_btnSave)}}
var _templateEditor = CodeMirror.fromTextArea(_editor.find(".templatecontent")[0], {mode: "text/xml",theme: "xml",lineNumbers: true,textWrapping: false,indentUnit: 4,autoRefresh: true});_editor.find(".CodeMirror").css("height", _props.hasAddTableBtn ? "400px" : "430px");_templateEditor.on("change", _templateChanged);_txtTemplName.on("keyup", _templateChanged);var _showStatusBar = function($html) {_barStatus.html($html);_args && _args.additionData && _args.additionData.showStatusBar && $.isFunction(_args.additionData.showStatusBar) && _args.additionData.showStatusBar($html)}
var _hideStatusBar = function(argument) {_barStatus.empty();_args && _args.additionData && _args.additionData.hideStatusBar && $.isFunction(_args.additionData.hideStatusBar) && _args.additionData.hideStatusBar()}
_editor.on('show.bs.modal', function (e) {_editor.removeClass("messagebox");_editor.find(".modal-dialog").addClass("modal-lg");_editor.find(".templateResult, .connections-view, .tables-view, .columns-view, .editor-view, .yes-btn").each(function () {$(this).addClass("hidden")});_editor.find('input').val("").prop("disabled", false);_tbColumns.off("click", "td,tr,input");_tbColumns.empty();_tbTables.off("click", "tr");_tbTables.empty();_btnPreview.addClass("hidden");rsb.templateEditor.disableButton(_btnNext);rsb.templateEditor.disableButton(_btnGen);rsb.templateEditor.disableButton(_btnSave);_chkAllTables.prop("checked", false);_chkAllColumns.prop("checked");_viewStatus.empty();_hideStatusBar();_title.html(_getProp("wizardTitle", _args));_curView = ".status-view";_isEdit = false;_setSelectedConnection($.cookie("selectedConnectionName"));_selectedTable = null;_editorNavPills.hide()});_editor.on('shown.bs.modal', function (e) {_templateEditor.refresh();_props.ready(_editor)});_editor.on('hidden.bs.modal', function (e) {_switchTemplateView(".status-view");_args = null;_curView = null;_isEdit = false;_selectedTable = null;_editor.removeClass("modal-x-lg");_templateEditor.setValue("");_templateEditor.clearHistory();_editorNavPills.hide()});var _getTemplateName = function() {var templName = _txtTemplName.val();if (_props.templateNameEditable && (_txtTemplONameCol.val()||_txtTemplOName.val())) {templName = _txtTemplONameCol.val() || _txtTemplOName.val();_args.new_name = _txtTemplName.val() || _txtTemplNameCol.val()}
return templName}
var _save = function (errorCB) {if (_txtTemplName.val().length > 0) {_props.save(_selectedConnection, _selectedTable, _getTemplateName(), _templateEditor.getValue(), _args, function(result) {_hideStatusBar();var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {if ($.isFunction(errorCB)) errorCB();rsb.showResult(_pResult, errorMsg, false)} else {_pResult.addClass('hidden');_templateEditor.clearHistory();_templateChanged();if (result && result.length && result[0]["result"]) {var tmp = result[0]["result"].toLowerCase();if (tmp == 'true' || tmp == 'success') {_editor.modal('hide')} else {if ($.isFunction(errorCB)) errorCB();_txtTemplName.prop("disabled", true);_txtTemplNameCol.prop("disabled", true);rsb.showResult(_pResult, result[0]["message"], result[0]["result"])}} else {_editor.modal('hide')}}})} else {rsb.showResult(_pResult, "Entity name can not be empty", "error")}}
_btnSave.click(_save);_btnListTables.click(function () {_showStatusBar(rsb.templateEditor.createLoadingDescription(_props.retrieveTableInfo));_props.listTables(_selectedConnection, _args, function(result) {_hideStatusBar();if (_baseCallback(result, _tbTables, _selectTableRow, 1, "tablename")) {if(_props.multiSchemaImport) {if(result.length == 1) {_tbTables.find("tr").eq(0).click()}
_tbTables.find(".table-checkbox").removeClass("hidden")}
_switchTemplateView('.tables-view')}})});var _unionColumns = function(columns, result) {var colIndexes = {};var cols = [];if (columns) {for (var i = 0; i < columns.length; i++) {if (_args.excludeOutParameters && !(columns[i].direction || "IN").toUpperCase().startsWith("IN")) continue;colIndexes[columns[i].name] = cols.length;var columnSize = columns[i].columnsize || "";var isNullAble = columns[i].isnullable ? columns[i].isnullable.toLowerCase() : "";var isReadOnly = columns[i].isreadonly ? columns[i].isreadonly.toLowerCase() : "";cols.push({defined: false, name: columns[i].name, direction: (columns[i].direction || ""), alias: columns[i].alias, datatype: columns[i].datatype, columnsize: columnSize, iskey: columns[i].iskey.toLowerCase(), isnullable: isNullAble, description: columns[i].description, checked: " checked", internalColumnName: (columns[i].internalcolumnname || ""), autoincrement: (columns[i].isautoincrement || ""), isreadonly: isReadOnly, search: (columns[i].search || ""), id: (columns[i].id || ""), ref: (columns[i].ref || ""), precision: (columns[i].precision || ""), scale: (columns[i].scale || ""), relationships: (columns[i].relationships || "")})}}
var tmpChecked = columns ? "" : " checked";for (var i = 0; i < result.length; i++) {var index = colIndexes[result[i].columnname];Number.isInteger = Number.isInteger || function(value) {return typeof value === "number" && Math.floor(value) === value};if (Number.isInteger(index)) {var col = cols[index];col.defined = true;col.istimecheckcolumn = result[i].istimecheckcolumn || "false";col.internaltype = result[i].internaltype || "";col.foreignkey = result[i].foreignkey || "";col.direction = result[i].direction || "";col.ref = result[i].ref || col.ref;if (!col.alias) col.alias = result[i].alias || "";if (!col.columnsize) col.columnsize = result[i].columnsize || "";if (!col.isnullable) col.isnullable = result[i].isnullable || "";if (!col.isreadonly) col.isreadonly = result[i].isreadonly || ""} else if (!_args.excludeOutParameters || (result[i].direction || "IN").toUpperCase().startsWith("IN")) {var columnSize = result[i].columnsize || "";var isNullAble = result[i].isnullable ? result[i].isnullable.toLowerCase() : "";var isReadOnly = result[i].isreadonly ? result[i].isreadonly.toLowerCase() : "";cols.push({defined: true, name: result[i].columnname, direction: (result[i].direction || ""), alias: (result[i].alias || ""), datatype: result[i].datatype, columnsize: columnSize, iskey: result[i].iskey.toLowerCase(), isnullable: isNullAble, description: "", checked: tmpChecked, internalColumnName: (result[i].internalcolumnname || ""), autoincrement: (result[i].isautoincrement || ""), isreadonly: isReadOnly, search: (result[i].search || ""), id: (result[i].id || ""), ref: (result[i].ref || ""), istimecheckcolumn: (result[i].istimecheckcolumn || "false"), internaltype: (result[i].internaltype || ""), foreignkey: (result[i].foreignkey || ""), precision: (result[i].precision || ""), scale: (result[i].scale || ""), relationships: ""})}}
cols.sort(function(lhs, rhs) {if (lhs.direction != rhs.direction) {lhs.direction = lhs.direction.toUpperCase();if (lhs.direction == "IN" || lhs.direction == "INPUT") return -1;if (lhs.direction == "OUT" || lhs.direction == "OUTPUT") return 1;rhs.direction = rhs.direction.toUpperCase();return rhs.direction == "IN" || rhs.direction == "INPUT" ? 1 : -1}
if (lhs.iskey != rhs.iskey) return lhs.iskey == "true" ? -1 : 1;return lhs.name.toLowerCase() <= rhs.name.toLowerCase() ? -1 : 1});return cols}
var _initOperation = function(operation, isnew) {if (operation) {_divOperations.find("input").prop("checked", false);var enabledMessage = false;var parts = operation.split(";");for (var i in parts) {var idx = parts[i].indexOf(":");if (idx > -1) {var method = parts[i].substring(0, idx);var op = parts[i].substring(idx + 1);var opParts = op.split(",");for (var j in opParts) {if (opParts[j].includes("apiMessage")) {enabledMessage = true}}
if (method.toUpperCase().includes("GET")) {_divOperations.find(".opGET").prop("checked", true)}
if (method.toUpperCase().includes("POST")) {_divOperations.find(".opPOST").prop("checked", true)}
if (method.toUpperCase().includes("PUT")) {_divOperations.find(".opPUT").prop("checked", true)}
if (method.toUpperCase().includes("DELETE")) {_divOperations.find(".opDELETE").prop("checked", true)}}}
if (enabledMessage) {_divOperations.find(".genMsg").prop("checked", true)}} else {if (!isnew) {_divOperations.find("input").prop("checked", false);_divOperations.find(".genMsg").prop("checked", false)} else {if (_selectedTableType == "VIEW") {_divOperations.find(".opGET").prop("checked", true);_divOperations.find(".opPOST, .opPUT, .opDELETE, .genMsg").prop("checked", false)} else {_divOperations.find("input").prop("checked", true);_divOperations.find(".genMsg").prop("checked", false)}}}
_divOperations.removeClass("hidden")}
var _getSelectedColumnsInfo = function($tbColumns, $callback) {var cols = [];$tbColumns.find(".column-checkbox input:checked").each(function () {var col = {};var tdElems = $(this).parent().nextAll('td');col.iskey = col.key = rsb.trimStr($(tdElems[0]).text());col.name = $(tdElems[1]).text();col.direction = rsb.trimStr($(tdElems[2]).text());col.datatype = col.type = rsb.trimStr($(tdElems[3]).text());col.size = rsb.trimStr($(tdElems[4]).text());col.alias = rsb.trimStr($(tdElems[5]).text());col.isnullable = rsb.trimStr($(tdElems[6]).text());col.description = rsb.trimStr($(tdElems[7]).text());col.internalcolumnname = rsb.trimStr($(tdElems[8]).text());col.autoincrement = rsb.trimStr($(tdElems[9]).text());col.isreadonly = rsb.trimStr($(tdElems[10]).text());col.search = rsb.trimStr($(tdElems[11]).text());col.id = rsb.trimStr($(tdElems[12]).text());col.ref = rsb.trimStr($(tdElems[13]).text());col.istimecheckcolumn = col.datatype && col.datatype.toLowerCase() == "datetime" ? "true" : "false";col.foreignkey = rsb.trimStr($(tdElems[15]).text());col.internaltype = rsb.trimStr($(tdElems[16]).text());col.precision = rsb.trimStr($(tdElems[17]).text());col.scale = rsb.trimStr($(tdElems[18]).text());col.relationships = rsb.trimStr($(tdElems[19]).text());$callback && $callback($tbColumns, tdElems, col);cols.push(col)});return cols}
var _showAddChildTableModal = function() {if (_childTableList.find("option").length != _tbTables.find("tr td[data-type]").length) {_childTableList.html("")}
if (_childTableList.find("option").length <= 0) {_tbTables.find("tr td[data-type]").each(function() {_childTableList.append(new Option($(this).text(), $(this).data("qualified") || $(this).text()))})}
_addChildTableModal.find(".modal-title").text(_getProp("addChildTableTitle", _args));_addChildTableModal.modal('show');_addChildTableModal.off("hidden.bs.modal");_addChildTableModal.on("hidden.bs.modal", function() {$(this).find("select option:first").prop("selected", true)})}
var _getColumnsViewData = function(cols, args) {var tableName = args && args.tableName || $.trim(_editor.find(".templatenamecol").attr("data-name"));_args.additionData = _args.additionData || {};if (!_args.additionData.structure) _args.additionData.structure = args && args.structure;return {viewContainer: _editor.find(".columns-view"),viewBody: _editor.find(".column-view-body"),viewHeader: _editor.find(".columns-view-head"),query: args && args.query,columns: cols,columnsTable: _editor.find("table.columns-table"),columnsTableHeader: _editor.find("table.columns-table-header"),tableName: tableName,additionData: _args.additionData,editCell: _editCell,stopEditCell: _stopEditCell,handleScroolBar: _handleScroolBar,args: _args,btnPreview: _btnPreview,setPreviewTitle: function($title) {_btnPreview.html("<i class='fa fa-code'></i>&nbsp;" + $title);_previewTitle.text($title)},addChildTable: function() {_args.additionData.isChildTable = true;if (_tbTables.find("tr td[data-type]").length <= 0) {_listTables(_args, function(success, result) {success && _showAddChildTableModal()})} else {_showAddChildTableModal()}},listColumns: function(table, columns, meta) {_initColumnsView(_selectedConnection, _selectedTable, table, null, $.extend($.extend({}, args), meta), columns)},getSelectedColumnsInfo: function($tbColumns, $callback) {return _getSelectedColumnsInfo($tbColumns, $callback)}}}
var _initTable = null;var _initColumnsView = function(connection, name, table, desc, args, columns) {_initTable = table;_showStatusBar(rsb.templateEditor.createLoadingDescription(_props.retrieveColumnInfo));_addChildTableModal.modal('hide');_props.listColumns(connection, table, args, function(result, tempName) {if (table != _initTable) return false;_hideStatusBar();var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(_pResult, errorMsg, false)} else if (result && result.length || _props.showEmptyColumnsView) {_pResult.addClass('hidden');_tbColumns.off("click", "td,tr,input");_tbColumns.empty();tempName =  tempName || name;var cols = _unionColumns(columns, result);var editable = _props.columnEditable ? "editable" : "";for (var i = 0; i < cols.length; i++) {_tbColumns.append("<tr><td class='column-checkbox'><input type='checkbox' class='form-check-input'" + cols[i].checked + "></td><td class='column-key'><span class='hidden'>" + cols[i].iskey + "</span><i class='fa fa-solid fa-key-skeleton " + (cols[i].iskey.toLowerCase() == "true" ? "active'" : "' style='opacity: 0'") + "></i></td><td class='column-name'><span data-bs-toggle='popover' data-bs-placement='top' data-bs-trigger='manual' data-bs-content='" + rsb.htmlEncode(cols[i].name) + "'>" + rsb.htmlEncode(cols[i].name) + "</span>" + "</td><td class='column-direction'>" + cols[i].direction + "</td><td class='column-datatype " + editable + "'>" + cols[i].datatype + "</td><td class='column-size " + editable + "'>" + cols[i].columnsize + "</td><td class='column-alias " + editable + "'>" + rsb.htmlEncode(cols[i].alias) + "</td><td class='column-nullable " + editable + "'>" + cols[i].isnullable + "</td><td class='column-description " + editable + "'>" + rsb.htmlEncode(cols[i].description) + "</td><td class='column-internalcolumnname'>" + rsb.htmlEncode(cols[i].internalColumnName) + "</td><td class='column-autoincrement'>" + cols[i].autoincrement + "</td><td class='column-readonly'>" + cols[i].isreadonly + "</td><td class='column-search'>" + cols[i].search + "</td><td class='column-id editable'>" + cols[i].id + "</td><td class='column-ref editable'>" + cols[i].ref + "</td><td class='column-istimecheckcolumn'>" + cols[i].istimecheckcolumn + "</td><td class='column-foreignkey'>" + cols[i].foreignkey + "</td><td class='column-internaltype'>" + cols[i].internaltype + "</td><td class='column-precision'>" + cols[i].precision + "</td><td class='column-scale'>" + cols[i].scale + "</td><td class='column-rs " + editable + "'>" + rsb.htmlEncode(cols[i].relationships) + "</td></tr>")}
_tbColumns.find("tr").click(_selectColumnRow);_tbColumns.find("input").click(_columnSelectedChanged);_tbColumns.find("td.editable").click(_editCell);rsb.forEach(["direction", "alias", "datatype", "size", "key", "nullable", "description", "internalcolumnname", "autoincrement", "readonly", "search", "id", "ref", "istimecheckcolumn", "foreignkey", "internaltype", "precision", "scale", "rs"], function(c) {if ($.inArray(c, _props.visibleColumnColumns) >= 0) {_tbColumnsHeaders.find(".column-" + c).removeClass("hidden");_tbColumns.parent().find(".column-" + c).removeClass("hidden")} else {_tbColumnsHeaders.find(".column-" + c).addClass("hidden");_tbColumns.parent().find(".column-" + c).addClass("hidden")}});if (cols.length > 0 && (!columns || cols.length <= columns.length) || result.length <= 0) {_chkAllColumns.prop("checked", true)} else {_chkAllColumns.prop("checked", false)}
if (_args.excludeOutParameters) {rsb.forEach(["checkbox", "direction"], function(c) {_tbColumnsHeaders.find(".column-" + c).addClass("hidden");_tbColumns.parent().find(".column-" + c).addClass("hidden")});_chkAllColumns.prop("checked", true)}
rsb.templateEditor.enableButton(_btnGen);if (_getProp("useSaveGenerateButton", _args)) {_btnGen.find(".gene-text").addClass("hidden");_btnGen.find(".save-text").removeClass("hidden")} else {_btnGen.find(".gene-text").removeClass("hidden");_btnGen.find(".save-text").addClass("hidden")}
var height = 470;if (_getProp("skipEditor", _args)) {_restrictUser.val(_args["restrictUser"] || "");if (_txtTemplNameCol.val().length == 0) {_txtTemplNameCol.val((tempName || name).replace(/[<|>|&|\\|\s|\||\/|:|*|?|.|#]+/g, '_').replace(/["|'|\[|\]|`]+/g, '')).attr("data-name", name)}
if (_selectedTableType == "VIEW") {_txtTemplDescCol.val(desc || (_props.defaultViewDescription + ' ' + name.replace(/["|'|\[|\]|`]+/g, '')))} else {_txtTemplDescCol.val(desc || (_props.defaultDescription + ' ' + name.replace(/["|'|\[|\]|`]+/g, '')))}
if (!args["direction"] && (_selectedTableType == "TABLE" || _selectedTableType == "VIEW" || args["operation"])) {_initOperation(args["operation"], args["isnew"]);height -= 50} else {_divOperations.addClass("hidden")}
_txtTemplNameCol.closest("div.template-input-group").removeClass("hidden");height -= 100;if (_props.enableFullTextSearch) {_editor.find(".fulltextsearch-checkbox").addClass("hidden");_props.listDataConnections(args, function(result) {for(var i = 0; result && i < result.length; i++) {if(connection === result[i].name && result[i].supportfulltextsearch != null && result[i].supportfulltextsearch.toLowerCase() === 'true') {_editor.find(".fulltextsearch-checkbox").removeClass("hidden");break}}});if(_args["fulltextsearch"] && _args["fulltextsearch"].toLowerCase() === 'true') {_editor.find(".fulltextsearch").prop("checked", true)} else {_editor.find(".fulltextsearch").prop("checked", false)}}} else {_txtTemplNameCol.closest("div.template-input-group").addClass("hidden")}
height = height + "px";_editor.find(".columns-view .panel-body").css("height", height).css("max-height", height);var columnsViewData = _getColumnsViewData(cols, args);if ($.isFunction(args.columnsViewExtendShow)) {args.columnsViewExtendShow(columnsViewData);_args.columnsViewExtendDestroy = args.columnsViewExtendDestroy} else if ($.isFunction(args.columnsViewExtendDestroy)) {args.columnsViewExtendDestroy(columnsViewData)}
_switchTemplateView('.columns-view');columnsViewData && columnsViewData.viewContainer && columnsViewData.viewContainer.trigger('shown.columns.editor');if (columns) {_editor.find(".back-btn.columns-view").addClass("hidden");if (columns.length) rsb.templateEditor.enableButton(_btnGen)} else {_allColumnsChanged()}} else {_btnGen.click()}})}
_btnNext.click(function () {var checkedTables = _tbTables.find("input:checked");if(checkedTables.length > 1) {var errorMsg = "The following errors were encountered while importing these resources:<br>";var hasError = false;var args = _args;_editor.modal('hide');tableCount = checkedTables.length;rsb.showInfoModal("Importing Resources", "", false, true, tableCount * 2, false, function() {checkedTables.each(function () {var tableName = $(this).parent().next().text();_props.generate(_selectedConnection, tableName, null, null, args, function(template, templateName) {templateName = (templateName || tableName).replace(/["|'|\[|\]|`]+/g, '').replace(/\W/g, '_');rsb.changeInfoModalMessage("generating " + tableName);rsb.increaseInfoModalProgress();_props.save(_selectedConnection, tableName, templateName, template, args, function(result) {rsb.changeInfoModalMessage("saving " + tableName);rsb.increaseInfoModalProgress();_hideStatusBar();if(result && result[0].error) {errorMsg += result[0].error;errorMsg += "<br>";hasError = true}
if(!--tableCount) {rsb.closeInfoModal();if(hasError && args.tipName) {errorMsg += "You may import those resources individually to resolve those errors.";rsb.showResult($(args.tipName), errorMsg, false, true)}}})})})})} else {if(_props.multiSchemaImport && checkedTables.length == 1) {_selectedTable = checkedTables.parent().next().data("qualified") || checkedTables.parent().next().text();_selectedTable = rsb.htmlDecode(_selectedTable);_selectedTableType = checkedTables.parent().next().attr("data-type");if (_selectedTableType != "SP") {if (_selectedTableType.indexOf("TABLE") >= 0) {_selectedTableType = "TABLE"} else {_selectedTableType = "VIEW"}}}
_initColumnsView(_selectedConnection, _selectedTable, _selectedTable, null, _args)}});_editorNavPills.children("li").click(function() {if (_args.editingInput == $(this).hasClass('input')) return false;_args.editingInput = !_args.editingInput;$(this).addClass('active').siblings('.active').removeClass('active');if (_args.editingInput) {_args.outputContent = _templateEditor.getValue();_templateEditor.setValue(_args.inputContent || "")} else {_args.inputContent = _templateEditor.getValue();_templateEditor.setValue(_args.outputContent || "")}
_templateEditor.clearHistory();_templateEditor.refresh()});_addChildTableBtn.click(function() {_selectedTable = _childTableList.val();var tbCol = _tbTables.find("tr td[data-type]").filter(function() { return ($(this).data("qualified") || $(this).text()) === _selectedTable; });tbCol && (tbCol.parent().removeClass('api-security-selected-row'), tbCol.click());_initColumnsView(_selectedConnection, _selectedTable, _selectedTable, null, _args)});_btnGen.click(function () {_args["resourcetype"] = _selectedTableType;var opStr = ["POST", "GET", "PUT", "DELETE"];var operation = "";for (var i = 0; i < 4 ; i++) {if (_divOperations.find(".op" + opStr[i]).prop("checked")) {operation += opStr[i]}}
_args["operation"] = operation;_args["restrictUser"] = _restrictUser.val();_args["genMsg"] = _divOperations.find(".genMsg").prop("checked");_args["query"] = $.trim(_editor.find(".sqlText").val()) || "";_args["fulltextsearch"] = _editor.find(".fulltextsearch").prop("checked");_selectedTable = _selectedTable || _editor.find(".templatenamecol").attr("data-name");_props.generate(_selectedConnection, _selectedTable, _txtTemplDescCol.val(), _getSelectedColumnsInfo(_tbColumns), _args, function(template, templateName) {if (_getProp("skipEditor", _args)) {if (!_args.subtable && (!_args.additionData || !_args.additionData.isChildTable)) {_txtTemplName.val(_txtTemplNameCol.val())}
_templateEditor.setValue("")}
if (_txtTemplName.val().length == 0) {_txtTemplName.val(templateName || _selectedTable)}
if (_templateEditor.cursorCoords() == null) {_templateEditor.setValue(_templateEditor.getValue() + template)} else {_templateEditor.replaceSelection(template)}
if (_getProp("skipEditor", _args)) {_save()} else {_switchTemplateView('.editor-view')}})});var _closeTemplateModal = function(e) {rsb.stopPropagation(e);$(this).blur();if (_isEdit && (_curView != '.editor-view' || _templateEditor.historySize().undo > 0
&& !confirm('You haven\'t saved your changes.'+ "\n\n" + 'Are you sure you want to leave without saving?'))) {if (_curView != '.editor-view') {_switchTemplateView('.editor-view')}} else if (_args.additionData && _args.additionData.isChildTable && _curView == '.tables-view') {_switchTemplateView('.columns-view')} else {if (_curView && _curView == ".columns-view" && $.isFunction(_args.columnsViewExtendDestroy)) {_args.columnsViewExtendDestroy(_getColumnsViewData(), _args)}
_editor.modal('hide')}}
var _switchTemplateView = function(to) {_btnYes.addClass('hidden');_editorNavPills.hide();if (_curView && _curView != to) {_editor.find(_curView).addClass('hidden');if (_curView == ".columns-view" && $.isFunction(_args.columnsViewExtendDestroy)) {_args.columnsViewExtendDestroy(_getColumnsViewData(), _args)}}
if (to == ".editor-view") {_args.showEditorNavPills && _editorNavPills.show().children().removeClass('active').first().addClass('active')
_title.html(_getProp("editorTitle", _args));_isEdit = true} else if (to == ".columns-view") {_title.html(_getProp("editorTitle", _args))} else {_title.html(_getProp("wizardTitle", _args));if (_getProp("skipEditor", _args) && !_txtTemplNameCol.hasClass('hidden')) {_txtTemplNameCol.val('')}}
_handleScroolBar(_editor.find(to).removeClass('hidden'));_curView = to;if (_isEdit) {_templateEditor.refresh()}
if ($.isFunction(_args.switchCallback)) {_args.switchCallback(_args, _props)}}
var _baseCallback = function(result, _table, selectRowCallback, startRowIndex, sortName, descName, clearTable) {_hideStatusBar();_table.off("click", "tr");if(clearTable === undefined || clearTable) {_table.empty()}
var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(_pResult, errorMsg, false);return false} else {_pResult.addClass('hidden');result.sort(function(lhs, rhs) { return lhs[sortName].localeCompare(rhs[sortName]); });var paging = false;var pagingMessage = "";for (var i = 0; i < result.length; i++, startRowIndex++) {var text = rsb.htmlEncode(result[i][sortName]);if (descName) {text += " (" + rsb.htmlEncode(result[i][descName])+ ")"}
if (result[i]["type"]) {if(result[i]["type"] === "more") {paging = true;pagingMessage = result[i][sortName]} else {_table.append("<tr><td class='table-checkbox hidden' width='10px'><input type='checkbox' class='form-check-input'></td><td data-type='" + result[i]["type"].toUpperCase() + "' data-qualified='" + rsb.htmlEncode(result[i]["qualified" + sortName] || text) + "'>" + text + "</td></tr>")}} else {if (result[i]["connectionstatus"] == "1" || result[i]["connectionstatus"] == "2") {if (result[i]["shortname"]) {_table.append("<tr class='odata-connection-status'><td><span style='opacity: 64%;'><span style='width: 20px; height: 20px; margin-left: -10px; margin-bottom: -5px; padding-top: 5px;' class='app-icon app-icon-" + result[i]["shortname"].toLowerCase() + "'></span>&nbsp;" + text + "</span><span class='badge bg-danger connection-status' style='margin-left: 5px;'>Upgrade License Tier</span></td></tr>")} else {_table.append("<tr class='odata-connection-status'><td><span style='opacity: 64%;'>" + text + "</span><span class='badge bg-danger connection-status' style='margin-left: 5px;'>Upgrade License Tier</span></td></tr>")}} else {if (result[i]["shortname"]) {_table.append("<tr><td><span style='width: 20px; height: 20px; margin-left: -10px; margin-bottom: -5px; padding-top: 5px;' class='app-icon app-icon-" + result[i]["shortname"].toLowerCase() + "'></span>&nbsp;" + text + "</td></tr>")} else {_table.append("<tr><td>" + text + "</td></tr>")}}}}
if(paging) {_table.append("<tr><td></td><td data-type='more'><span style='font-weight:bold'>"+ pagingMessage + "</span></td></tr>")}
_table.find("tr").click(selectRowCallback);return true}}
var _selectRow = function(row, _table, _btn, tagName) {if (row.hasClass("odata-connection-status")) {return null}
if (!row.hasClass('api-security-selected-row')) {_table.find('tr.api-security-selected-row').removeClass('api-security-selected-row');row.addClass('api-security-selected-row');rsb.templateEditor.enableButton(_btn);if(!tagName) tagName = "td:eq(0)";var ele = row.find(tagName);return rsb.trimStr(ele.data("qualified") || ele.text())} else {row.removeClass('api-security-selected-row');row.removeClass('api-security-selected-row');rsb.templateEditor.disableButton(_btn);return null}}
var _selectConnectionRow = function(e) {var conn = _selectRow($(this), _tbConnections, _btnListTables);_setSelectedConnection(conn);$.cookie('selectedConnectionName', conn)}
var _setSelectedConnection = function (conn) {_selectedConnection = !conn || conn.substring(0, conn.lastIndexOf(" ("))}
var _selectTableRow = function(e) {if(_props.multiSchemaImport) {_selectedTable = _selectedTableType = null;if (e.target.type !== 'checkbox') {$(':checkbox', this).trigger('click')}
var cb = $(this).find("input");if (cb.prop("checked")) {rsb.templateEditor.enableButton(_btnNext);if (_tbTables.find("input:checked").length == _tbTables.find("input").length) {_chkAllTables.prop("checked", true)}} else {_chkAllTables.prop("checked", false);if (_tbTables.find("input:checked").length == 0) {rsb.templateEditor.disableButton(_btnNext)}}
if($(this).find("td:eq(1)").attr("data-type") === "more") {$(this).closest("tr").remove();args = [];args["skiptable"] = _tbTables.find("tr").length;_showStatusBar(rsb.templateEditor.createLoadingDescription(_props.retrieveTableInfo));_props.listTables(_selectedConnection, args, function(result) {if (_baseCallback(result, _tbTables, _selectTableRow, 1, "tablename", "", false)) {if(_props.multiSchemaImport) {_tbTables.find(".table-checkbox").removeClass("hidden")}
_switchTemplateView('.tables-view')}})}} else {_selectedTable= _selectRow($(this), _tbTables, _btnNext, "td:eq(1)");_selectedTableType = $(this).find("td:eq(1)").attr("data-type")}
_txtTemplNameCol.attr("data-name", _selectedTable);if (_txtTemplNameCol.val().length <= 0 || _txtTemplName.val().length <= 0) {_txtTemplNameCol.val(_selectedTable)}}
var _selectColumnRow = function(e) {var cb = $(this).find('input');cb.click();_updateColumnSelect(cb)}
var _columnSelectedChanged = function(e) {rsb.stopPropagation(e);_updateColumnSelect($(this))}
var _editCell = function (e, cell) {rsb.stopPropagation(e);_startEditCell(cell || $(this))}
var _startEditCell = function (elem) {if (elem.hasClass("edit")) return;var width = elem.width();if (elem.hasClass("column-datatype")) {width = 120} else if (elem.hasClass("column-size")) {width = 80} else if (elem.hasClass("column-alias")) {width = 200}
if (elem.hasClass("column-datatype")) {var types = ["string", "bool", "int", "long", "decimal", "double", "time", "date", "datetime"];var eleSel = "<select onclick='rsb.stopPropagation(event);' onfocus='this.value=this.value;' value='" + elem.text() + "' style='width:" + width + "px'>";rsb.forEach(types, function(type, i) {if (type.toUpperCase() == (elem.text() || "").toUpperCase()) {eleSel += "<option selected value='" + type + "'>" + type + "</option>"} else {eleSel += "<option value='" + type + "'>" + type + "</option>"}});eleSel += "</select>";elem.html(eleSel);elem.find("select").on("focusout", _stopEditCell).focus().on("keyup", function(e) {if (e.keyCode == 27 || e.keyCode == 13) _stopEditCell(e, elem.text())});elem.find("select").on("change", _stopEditCell).focus().on("keyup", function(e) {if (e.keyCode == 27 || e.keyCode == 13) _stopEditCell(e, elem.text())})} else {elem.html("<input onclick='rsb.stopPropagation(event);' onfocus='this.value=this.value;' type='text' value=\"" + elem.text() + "\" style='width:" + width + "px'>");elem.find("input").on("focusout", _stopEditCell).focus().on("keyup", function(e) {if (e.keyCode == 27 || e.keyCode == 13) _stopEditCell(e)})}
elem.addClass("edit")}
var _stopEditCell = function (e, defVal) {$((e || window.event).target).parent().parent().find("td.edit").each(function() {$(this).removeClass("edit");var changed = true;if ($(this).hasClass("column-datatype")) {var select = $(this).find("select");if (select.length) {select.off("focusout").off("keyup");$(this).text(select.val());changed = defVal != select.val()}} else {var input = $(this).find("input");if (input.length) {input.off("focusout").off("keyup");$(this).text(input.val());changed = input[0].defaultValue != input[0].value}}
changed && $(this).trigger("cellChanged")})}
var _updateColumnSelect = function(cb) {if (cb.prop("checked")) {rsb.templateEditor.enableButton(_btnGen);if (_tbColumns.find("input:checked").length == _tbColumns.find("input").length) {_chkAllColumns.prop("checked", true)}} else {_chkAllColumns.prop("checked", false);if (_tbColumns.find("input:checked").length == 0) {rsb.templateEditor.disableButton(_btnGen)}}}
var _allColumnsChanged = function(e) {var isChecked = _chkAllColumns.prop("checked");_tbColumns.find("input").prop("checked", isChecked);if (isChecked) {rsb.templateEditor.enableButton(_btnGen)} else {rsb.templateEditor.disableButton(_btnGen)}}
var _allTablesChanged = function(e) {var isChecked = _chkAllTables.prop("checked");_tbTables.find("input").prop("checked", isChecked);if (isChecked) {rsb.templateEditor.enableButton(_btnNext)} else {rsb.templateEditor.disableButton(_btnNext)}}
var _loadConnectionCookie = function(_tbConnections) {if ($.cookie("selectedConnectionName") != null) {for (var i=0;i < _tbConnections.find("td").length;i++) {var connectionName = _tbConnections.find("td").eq(i).text();if (connectionName == $.cookie("selectedConnectionName")) {_selectRow(_tbConnections.find("tr").eq(i), _tbConnections, _btnListTables)}}}}
var _showMessageBox = function(message, yesFunc) {_editor.addClass("messagebox");_editor.find(".modal-dialog").removeClass("modal-lg");_viewStatus.html(message);_btnYes.removeClass("hidden").one("click", function() {_editor.modal('hide');if (yesFunc) yesFunc()})}
var _getProp = function(name, args) {return $.isFunction(args[name + "Callback"]) ? args[name + "Callback"](args, _props) : _props[name]}
var _handleScroolBar = function($panel) {var panelBody = $panel.find(".panel-body");panelBody.length && panelBody.prev(".panel-heading").css("padding-right", panelBody[0].scrollHeight > panelBody[0].clientHeight ? "17px" : "0px")}
this.edit = function(name, args) {_edit(name, args, _getProp("skipEditor", args))};this.code = function(name, args) {_edit(name, args, false)}
var _edit = function(name, args, skipEditor) {_args = $.extend(_args, args);_editor.modal('show');_title.html(_getProp("editorTitle", _args));_txtTemplName.val(name);_txtTemplOName.val(name);_txtTemplNameCol.val(name);_txtTemplONameCol.val(name);if (!_props.templateNameEditable) {_txtTemplName.prop("disabled", true);_txtTemplNameCol.prop("disabled", true)}
_viewStatus.html(rsb.templateEditor.createLoadingDescription(_props.retrieveTemplateInfo));_viewStatus.removeClass('hidden');if (args.isResource) {_selectedTableType = "TABLE"}
_props.load(name, args, function(result) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(_pResult, errorMsg, false);_viewStatus.html(errorMsg)} else {if (result && result[0]) {_args.inputContent = result[0]["content"] || "";_args.outputContent = result[0]["outputcontent"] || "";_templateEditor.setValue(_args.inputContent);args.table = result[0]["table"] || args.table || name} else {args.table = args.table || name;args.inputContent = args.outputContent = ""}
_txtTemplNameCol.attr("data-name", args.table);_templateEditor.clearHistory();_templateChanged();_viewStatus.empty();if (skipEditor) {_props.getSchemaInfo(name, args, function(connection, table, desc, result) {errorMsg = rsb.getResultErrorMessage(result)
if (!connection || !table) {errorMsg = "Connection or resource does not exist.";rsb.showResult(_pResult, errorMsg, false);_viewStatus.html(errorMsg)} else if (errorMsg) {rsb.showResult(_pResult, errorMsg, false);_viewStatus.html(errorMsg)} else {_selectedConnection = connection;_selectedTable = table;args["restrictUser"] = _args["restrictUser"];args.structure = null;if (result.length && result[0]["structure"]) {try {var structure = JSON.parse(result[0]["structure"]);if (structure.table && structure.columns) {result = structure.columns;args.structure = structure;args.query = structure.query || args.query}} catch (err) { console.log(err); }}
_initColumnsView(connection, name, table, desc, args, result)}})} else {_switchTemplateView('.editor-view')}}})};var _listTables = function(args, callback) {_props.listTables(null, args, function(result) {_viewStatus.empty();var success = _baseCallback(result, _tbTables, _selectTableRow, 1, "tablename");callback && callback(success, result)})}
this.wizard = function(args, inEditor) {_args = $.extend(_args, args);var infoHtml = rsb.templateEditor.createLoadingDescription(_props.hasDataConnections ? _props.retrieveDataConnectInfo : _props.retrieveTableInfo);if (inEditor) {_showStatusBar(infoHtml)} else {_editor.modal('show');if (!_props.templateNameEditable) {_txtTemplName.prop("disabled", false);_txtTemplNameCol.prop("disabled", false)}
_viewStatus.html(infoHtml);_viewStatus.removeClass('hidden')}
if (_props.hasDataConnections) {_props.listDataConnections(args, function(result) {rsb.templateEditor.disableButton(_btnListTables);if (typeof result === "string") {_showMessageBox('You must create a connection before adding a resource.  Would you like to do that now?', function() { window.location.href = result; })} else {_viewStatus.empty();if (_baseCallback(result, _tbConnections, _selectConnectionRow, 1, "name", "providername")) {_viewStatus.empty();if(result.length == 1) {_setSelectedConnection(_selectRow(_tbConnections.find("tr").eq(0), _tbConnections, _btnListTables))} else {_loadConnectionCookie(_tbConnections)}
_switchTemplateView(".connections-view")} else {_switchTemplateView('.editor-view')}}})} else {_listTables(args, function(success, result) {if (success) {if(_props.multiSchemaImport) {_tbTables.find(".table-checkbox").removeClass("hidden")}
if (inEditor) {rsb.templateEditor.disableButton(_btnNext)}
_switchTemplateView(result.length > 0 ? '.tables-view' : '.editor-view');if (result.length <= 0) {rsb.showResult(_pResult, "No tables found.", "warning")}} else if (!inEditor) {_switchTemplateView('.editor-view')}})}};_editor.find("button.btn-close").not("button.templateResult-btn").click(_closeTemplateModal);_editor.find(".close-btn").click(_closeTemplateModal);_chkAllTables.change(_allTablesChanged);_chkAllColumns.change(_allColumnsChanged);if (_props.hasAddTableBtn) {var _wizard = this.wizard;_editor.find(".btnAddTable").removeClass('hidden').click(function() {_props.skipEditor = false;_args.subtable = true;_args.query = null;_wizard(_args, true)})}
_btnBack.click(function() { _switchTemplateView('.connections-view'); });_editor.find(".back-btn").click(function() { if (_args.additionData) _args.additionData.isChildTable = false; _switchTemplateView('.tables-view'); _editor.removeClass("modal-x-lg")});_editor.on("keydown", function($event) {var event = $event || window.event;if (event.ctrlKey && event.keyCode == 83) {$(":focus").trigger("blur")
!_btnGen.hasClass("hidden") && _btnGen.click();!_btnSave.hasClass("hidden") && _btnSave.click();rsb.stopPropagation(event);event.preventDefault()}});if (!_props.supportPreview) {return this}
var _previewXMLOutputModal = _cloneModal($("#previewXMLOutputModal"));var _previewDialog = _previewXMLOutputModal.find(".modal-dialog");var _previewTitle = _previewXMLOutputModal.find(".modal-title");var _previewResult = _previewXMLOutputModal.find("div.alert");var _previewPrevious = _previewXMLOutputModal.find("li.previous");var _previewNext = _previewXMLOutputModal.find("li.next");var _previewStatus = _previewXMLOutputModal.find(".preview-status");var _previewInputFormBtn = _previewXMLOutputModal.find(".input-form-btn");var _previewInputCodeBtn = _previewXMLOutputModal.find(".input-code-btn");var _previewInputForm = _previewXMLOutputModal.find(".input-form");var _previewExecuteBtn = _previewXMLOutputModal.find(".execute-btn");var _previewBackBtn = _previewXMLOutputModal.find(".back-btn");var _previewSave = _previewXMLOutputModal.find(".save-btn");var _previewOutputWell = _previewXMLOutputModal.find(".output-well");var _previewMeta = {};var _previewInputEditor = CodeMirror.fromTextArea(_previewXMLOutputModal.find(".input-content")[0], {mode: "text/xml",theme: "xml",lineNumbers: true,textWrapping: false,indentUnit: 4,autoRefresh: true});var _previewEditor = CodeMirror.fromTextArea(_previewXMLOutputModal.find(".xml-content")[0], {mode: "text/xml",theme: "xml",lineNumbers: true,textWrapping: false,indentUnit: 4,autoRefresh: true});var _setPreviewEditorData = function($editor, $data) {$editor.setValue($data || "");$editor.refresh()}
_previewXMLOutputModal.on('show.bs.modal', function(e) { _editor.hide(); });_previewXMLOutputModal.on('shown.bs.modal', function(e) { _previewInputEditor.refresh(); _previewEditor.refresh() });_previewXMLOutputModal.on('hide.bs.modal', function(e) { _editor.show(); _setPreviewEditorData(_previewEditor, ""); _setPreviewEditorData(_previewInputEditor, ""); });_previewXMLOutputModal.on('hidden.bs.modal', function(e) {_previewXMLOutputModal.removeClass("input");_previewDialog.addClass("modal-lg").removeClass("modal-md");_previewPrevious.addClass("disabled");_previewNext.addClass("disabled");_previewResult.addClass("hidden");_previewStatus.show();_previewBackBtn.hide();_previewInputForm.empty()});if (!_props.supportPaging) {_previewPrevious.addClass('hidden');_previewNext.addClass('hidden')}
var _getPreviewInputData = function() {if (_previewInputFormBtn.hasClass('btn-primary')) {var data = rsb.getFormData(_previewInputForm);var eleName = _props.getValidElementName ? _props.getValidElementName(_previewMeta.templateName) : _previewMeta.templateName;var content = "<Items>\r\n\t<" + eleName + ">\r\n";for (param in data) {var colName = _props.getValidElementName ? _props.getValidElementName(param) : param;content += "\t\t<" + colName + ">" + rsb.xmlEscape(data[param] || "") + "</" + colName + ">\r\n" }
content += "\t</" + eleName + ">\r\n</Items>\r\n";return content} else {return _previewInputEditor.getValue()}}
var _preview = function($next, $count) {_previewResult.addClass("hidden");_previewSave.addClass("disabled");_previewPrevious.addClass('disabled');_previewNext.addClass('disabled');_args && _args.additionData && _args.additionData.previewOptions && _args.additionData.previewOptions.previewTitle && _previewTitle.text(_args.additionData.previewOptions.previewTitle);if ($next && !$count && _previewMeta.Skip >= _previewMeta.Count || !$next && _previewMeta.Skip <= _previewMeta.Top) {rsb.showResult(_previewResult, 'No data available.', false)
return false}
_previewOutputWell.find("span.event-label").text("");_previewStatus.find("p.load-desc").text('Loading data...');_previewStatus.removeClass("custom-disable");_previewStatus.show();_setPreviewEditorData(_previewEditor, "");_props.preview(_getTemplateName() || _selectedTable, _previewMeta.Data, _getPreviewInputData(), _previewMeta.Top, _previewMeta.Skip - ($next ? 0 : _previewMeta.Top << 1), !!$count, _args, function($result) {var errorMsg = rsb.getResultErrorMessage($result) || !$result.length && 'No data available.';if (errorMsg || !$result[0].data) {_previewStatus.addClass("custom-disable");errorMsg && rsb.showResult(_previewResult, errorMsg, false);_previewStatus.find("p.load-desc").html("<i class='fa fa-warning'></i>&nbsp;" + 'The operation did not return any results...')} else {_previewStatus.hide();_previewEditor.setOption("readOnly", false)
!!$count && (_previewMeta.Count = Math.max(parseInt($result[0].count || "0"), 0));if (_previewMeta.Count <= 1) {_previewOutputWell.find("span.event-label").text('The XML output may be previewed below, and the "Save Sample Data" button at the right may be used to store this data for mapping in other connectors.')} else {_previewOutputWell.find("span.event-label").text('Cycle through the available data.')}
var text = $result[0].data && rsb.connect.BASE64Decode($result[0].data) || "";_setPreviewEditorData(_previewEditor, text);_previewMeta.Skip += $next ? _previewMeta.Top : -_previewMeta.Top;text ? _previewSave.removeClass("disabled") : _previewSave.addClass("disabled");if (_previewMeta.Skip >= _previewMeta.Count) {_previewNext.addClass('disabled')} else {_previewNext.removeClass('disabled')}
if (_previewMeta.Skip <= _previewMeta.Top) {_previewPrevious.addClass('disabled')} else {_previewPrevious.removeClass('disabled')}}})}
var _showPreviewXMLOutputModal = function() {var columns = _getSelectedColumnsInfo(_tbColumns);_previewMeta = { Top: Math.max(_args.Top || _props.Top || 1, 1), Skip: 0, Count: -1 };_props.generate(_selectedConnection, _selectedTable, _txtTemplDescCol.val(), columns, _args, function(template, templateName) {_previewMeta.Data = template;_previewMeta.templateName = templateName;_previewStatus.hide();if (_args && _args.additionData && _args.additionData.previewOptions && _args.additionData.previewOptions.showInput) {var maxLength = 0;var params = [];rsb.forEach(columns, function(col, index) {if ((col.direction || "IN").toUpperCase().startsWith("IN")) {params.push(col);maxLength = Math.max(maxLength, col.name.length)}});if (params.length > 0) {var html = "";var nameSize = 2;if (maxLength > 16) nameSize = 6;else if (maxLength > 12) nameSize = 5;else if (maxLength > 8) nameSize = 4;else if (maxLength > 4) nameSize = 3;rsb.forEach(params, function(col, index) {html += '<div class="form-group row mb-3">' +'  <label for="port" class="col-md-' + nameSize + ' control-label col-form-label" style="word-break: break-all;">' + col.name + ':</label>' +'  <div class="col-md-' + (11 - nameSize) + '">' +'    <input type="text" class="form-control" name="' + (col.elementName || col.name) + '">' +'  </div>' +'</div>'});_previewInputForm.html(html);_args.additionData.previewOptions.inputTitle && _previewTitle.text(_args.additionData.previewOptions.inputTitle);_previewInputFormBtn.click();_previewXMLOutputModal.addClass("input").removeClass("code-mode");_previewDialog.addClass("modal-md").removeClass("modal-lg");_previewXMLOutputModal.modal("show");_setPreviewEditorData(_previewInputEditor, _previewMeta.Data || "<Items>\n\n</Items>\n");return true}}
_previewXMLOutputModal.removeClass("input");_previewDialog.addClass("modal-lg").removeClass("modal-md");_previewXMLOutputModal.modal("show");_setPreviewEditorData(_previewInputEditor, "");_preview(true, true)})}
var _previewInputOnToggle = function($isFrom, $curBtn, $previousBtn) {if ($curBtn.hasClass("btn-primary")) return false;_previewXMLOutputModal.toggleClass("code-mode");_setPreviewEditorData(_previewInputEditor, _getPreviewInputData());if ($isFrom) {var root = $($.parseXML(_previewInputEditor.getValue())).children();if (root.length && root[0].tagName == "Items") {root = root.children()}
root.children().each(function() {_previewInputForm.find("input[name=" + $(this)[0].tagName +"]").val($(this).text())})}
$curBtn.addClass("btn-primary").removeClass("btn-outline-secondary");$previousBtn.addClass("btn-outline-secondary").removeClass("btn-primary")}
_previewInputFormBtn.click(function() {_previewInputOnToggle(true, _previewInputFormBtn, _previewInputCodeBtn)});_previewInputCodeBtn.click(function() {_previewInputOnToggle(true, _previewInputCodeBtn, _previewInputFormBtn)});_previewPrevious.click(function() { !$(this).hasClass('disabled') && _preview(false); });_previewNext.click(function() { !$(this).hasClass('disabled') && _preview(true); });_btnPreview.click(_showPreviewXMLOutputModal);_previewExecuteBtn.click(function() {$.extend(_previewMeta, { Top: 1, Skip: 0, Count: 1 });_previewXMLOutputModal.removeClass("input");_previewDialog.addClass("modal-lg").removeClass("modal-md");_previewBackBtn.show();_preview(true, false)});_previewBackBtn.click(function() {_previewResult.addClass("hidden");_previewBackBtn.hide();_args.additionData.previewOptions.inputTitle && _previewTitle.text(_args.additionData.previewOptions.inputTitle);_previewXMLOutputModal.addClass("input");_previewDialog.addClass("modal-md").removeClass("modal-lg")});_previewSave.click(function($event) {rsb.stopPropagation($event);_props.saveSample(_selectedConnection, _selectedTable, _getTemplateName() || _selectedTable, _previewEditor.getValue(), _getPreviewInputData(), _args, function(result) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(_previewResult, errorMsg, false)} else {rsb.showResult(_previewResult, 'The sample data is saved.', true)}})});_previewXMLOutputModal.on("keydown", function($event) {var event = $event || window.event;if (event.ctrlKey && event.keyCode == 83) {$(":focus").trigger("blur")
!_previewXMLOutputModal.hasClass("input") && _previewSave.click();rsb.stopPropagation(event);event.preventDefault()}});return this};rsb.templateEditor.enableButton = function(btn) {$(btn).prop("disabled", false);$(btn).removeClass("btn-outline-secondary").addClass("btn-primary")}
rsb.templateEditor.disableButton = function (btn) {$(btn).prop("disabled", true);$(btn).removeClass("btn-primary").addClass("btn-outline-secondary")}
rsb.templateEditor.createLoadingDescription = function(content) {return "<p class='load-desc'>" + content + "...</p>&nbsp;<i class='fa fa-spinner fa-pulse'></i>"}
$(function () {rsb.keepalive();$('[data-bs-toggle="popover"]').popover()})
