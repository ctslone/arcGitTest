rsb = rsb || {};rsb.flowapiContentEditor = function ($container, $readOnly) {var _container = $($container);var _readOnly = !!$readOnly;var _contentHeader = _container.find("div.content-header");var _contentTypeOption = _contentHeader.find(".flowapi-type-scheme");var _contentType = _contentHeader.find("input").not(_contentTypeOption);var _containerTextarea = _container.find("div.content-editor>textarea")[0];var _editor = null;var _editorMode = null;var _getMode = function () {var $type = rsb.trimStr(_contentType.val() || "application/xml").toLowerCase();if (["application/json", "application/x-json", "application/ld+json"].indexOf($type) >= 0) {return "application/json"} else if (["application/xml", "text/xml", "text/html"].indexOf($type) >= 0) {return "text/xml"} else if (["text/javascript", "text/ecmascript", "application/javascript", "application/x-javascript", "application/ecmascript", "application/json", "text/typescript", "application/typescript"].indexOf($type) >= 0) {return "text/javascript"} else if (["text/x-sql", "text/x-mssql", "text/x-mysql", "text/x-mariadb", "text/x-sqlite", "text/x-cassandra", "text/x-plsql", "text/x-hive", "text/x-pgsql", "text/x-gql", "text/x-gpsql", "text/x-sparksql", "text/x-esper"].indexOf($type) >= 0) {return "text/x-sql"} else {return "null"}}
var _getTheme = function ($mode) {if ($mode == "text/xml") {return "xml"} else if ($mode == "text/x-sql") {return "sql"} else if ($mode == "application/json" || $mode == "text/javascript") {return "javascript"} else {return "default"}}
var _sync = function () {_editor.save()}
var _initSampleEditor = function () {var $mode = _getMode();if (!_editorMode || $mode != _editorMode) {!!_editor && _editor.off("change", _sync)
!!_editor && _editor.toTextArea();_editorMode = $mode;_editor = CodeMirror.fromTextArea(_containerTextarea, {mode: $mode,theme: _getTheme($mode),lineNumbers: true,textWrapping: false,indentUnit: 4,autoRefresh: true,readOnly: _readOnly});_editor.refresh();_editor.clearHistory();_editor.on("change", _sync)}}
var _contentTypeOptionChanged = function () {_contentType.off("change");var $option = _contentTypeOption.val();if ($option == "XML") {_contentType.val("application/xml")} else if ($option == "JSON") {_contentType.val("application/json")} else {_contentType.on("change", _initSampleEditor)}
_contentType.prop("readonly", $option != "CUSTOM");_initSampleEditor()}
_contentTypeOption.off("change").on("change", _contentTypeOptionChanged);_contentTypeOption.prop("readonly", _readOnly);this.setContentType = function ($contentType) {var $type = rsb.trimStr($contentType || "application/xml").toLowerCase();_contentType.val($type);if ($type == "application/xml") {_contentTypeOption.val("XML")} else if ($type == "application/json") {_contentTypeOption.val("JSON")} else {_contentTypeOption.val("CUSTOM")}
_contentTypeOptionChanged()}
this.setContent = function ($content) {_editor.setValue($content || "");_editor.clearHistory();_editor.refresh()}
this.refresh = function () {_editor.refresh()}
this.setContentType(_contentType.val());return this}
rsb.flowapiSettingsPage = function ($options) {const DEFAULT = {readOnly: false};var _oprions = $.extend(DEFAULT, $options);var _form = $("#flowapiSettingsPageForm");var _httpMethod = _form.find("input.flowapi-current-httpmethod");var _newHTTPMethod = _form.find("select.flowapi-httpmethod");var _bodyType = _form.find("select.flowapi-bodytype");var _bodySettings = _form.find("div.body-settings");var _dynamicFieldSet = [];var _contentEditors = [];var DynamicFieldSet = function ($container, $fieldTemplateHtml, $readOnly) {var _container = $($container);var _fieldTemplate = $($fieldTemplateHtml);var _readOnly = !!$readOnly;var _fieldSetContainer = _container.find("div.field-set-container");var _fieldSetInput = _container.find("input.field-set-input");var _addFieldBtn = _container.find(".btn.btn-add-field");var _split = function ($list) {$list = rsb.trimStr($list || "").replace(/\s*,\s*/g, ',').replace(/,{2,}/g, ',').replace(/^,/, '').replace(/,$/, '');return !!$list ? $list.split(/,/g) : []}
var _addField = function ($event, $name) {var $fields = _fieldSetContainer.find(".field-item");var $newEle = _fieldTemplate.clone();_readOnly && $newEle.find("input").prop("disabled", true);$newEle.find("input").val($name || "");$newEle.toggleClass("readonly", _readOnly || $fields.length <= 0);$fields.length && $fields.removeClass("readonly");$newEle.appendTo(_fieldSetContainer)}
var _removeField = function () {$(this).closest(".field-item").remove();var $fields = _fieldSetContainer.find(".field-item");if ($fields.length == 1) {$fields.toggleClass("readonly", !rsb.trimStr($($fields[0]).find("input").val()))} else if ($fields.length == 0) {_addField(null, "")}
_sync()}
var _sync = function () {var $fields = [];_fieldSetContainer.find(".field-item").each(function () {var $field = rsb.trimStr($(this).find("input").val());!!$field && $fields.push($field)});_fieldSetInput.val($fields.join(","))}
var $fields = _split(_fieldSetInput.val()) || [];$fields.push("");rsb.forEach($fields, function ($field) {_addField(null, $field)});_addFieldBtn.off("click").on("click", _addField);_fieldSetContainer.off("click").on("click", "button", _removeField);_fieldSetContainer.off("change").on("change", "input", _sync);_fieldSetContainer.off("keyup").on("keyup", "input", _sync);this.save = function () {_sync()}
return this}
var _httpMethodChange = function () {_newHTTPMethod.val() == "GET" && _bodyType.val("None").change()}
var _bodyTypeChange = function () {var $filter = "div." + rsb.trimStr(_bodyType.val() || "").toLowerCase().replace(/\W/g, '-') + "-body-settings";_bodySettings.children().addClass("hidden").filter($filter).removeClass("hidden")}
var _submitCallback = function () {var $data = rsb.getFormData(_form);if ($data.newhttpmethod?.length > 0 && $data.httpmethod !== $data.newhttpmethod) {_httpMethod.val($data.newhttpmethod);rsb.syncChanges(_form)}
_form.trigger("rsb.flowapiSettings.updated", $data)}
_newHTTPMethod.off("change").on("change", _httpMethodChange);_bodyType.off("change").on("change", _bodyTypeChange);_form.find("div.flowapi-dynamic-field-set").each(function () {_dynamicFieldSet.push(new DynamicFieldSet(this, flowapiSettingsPage_fielditemtemplate.innerHTML, _oprions.readOnly))});_form.find("div.flowapi-content-well").each(function () {_contentEditors.push(new rsb.flowapiContentEditor(this, _oprions.readOnly))});_form.off("beforeSubmit").on("beforeSubmit", function () {rsb.forEach(_dynamicFieldSet, function ($set) {$set.save()});_form.off("success", _submitCallback).one("success", _submitCallback);return true});_form.off("success", _submitCallback);_bodyTypeChange();rsb.syncChanges(_form)}
