rsb.sharedConnectionEditor = new (function () {const OAUTH_SETTINGS = {};var __instanceId__ = 1;var _modal = $("#sharedConnectionEditor_modal");var _title = _modal.find(".modal-title");var _closeBtn = _modal.find("div.modal-header > button.btn-close");var _selectedConnectionTypeView = _modal.find(".connection-type-view");var _connectionView = _modal.find(".connection-view");var _connectionSearch = _selectedConnectionTypeView.find(".connection-search");var _connectionClear = _selectedConnectionTypeView.find(".search-clear-icon");var _connectionList = _selectedConnectionTypeView.find("ul.connection-list");var _connectionForm = _modal.find("form.form-settings");var _connectionNameInput = _connectionForm.find("input.connection-name");var _connectionTypeInput = _connectionForm.find("input.connection-type");var _categoryIcon = _connectionForm.find("#sharedConnectionEditorCategoryIcon");var _categoryDisplayName = _connectionForm.find("input.category-display-name");var _connectionSettings = _connectionForm.find(".connection-settings");var _oauthSpecific = _connectionForm.find("div.oauth-specific");var _connectionAdvancedSection = _connectionForm.find(".advanced-settings-section");var _connectionBtns = _connectionForm.find(".connection-btns");var _connectionAdvancedSettings = _connectionForm.find(".advanced-settings");var _testBtn = _connectionBtns.find(".test-btn");var _connectBtn = _connectionBtns.find(".connect-btn");var _disconnectBtn = _connectionBtns.find(".disconnect-btn");var _nextBtn = _modal.find("button.next-connection-btn");var _backBtn = _modal.find("button.back-connection-btn");var _addBtn = _modal.find("button.add-connection-btn");var _saveBtn = _modal.find("button.save-connection-btn");var _selectedConnectionType = null;var _capabilities = null;var _sessionProps = null;var _args = null;var _isAddConnectionModal = false;var _reset = function ($editConnection, $resetConnectionList) {_modal.find(".modal-dialog").toggleClass("modal-lg", !!$editConnection);rsb.clearForm(_connectionForm);_connectionForm.find("div.form-group").removeClass("has-warning").removeClass("has-error");if (!!$editConnection) {_title.html('Edit Connection');_isAddConnectionModal = false;_selectedConnectionTypeView.hide();_connectionView.show();_resultContainer = _connectionView.find("div.form-result-static")} else {_title.html('Connection Type');_selectedConnectionTypeView.show();_connectionView.hide();_resultContainer = _selectedConnectionTypeView.find("div.form-result-static")}
_resultContainer.hide();_connectionSettings.empty();_oauthSpecific.empty();_connectionAdvancedSection.hide().addClass("collapsed");_connectionAdvancedSettings.empty();_testBtn.removeClass("hidden").button("reset").removeClass("disabled");_connectBtn.addClass("hidden").button("reset").removeClass("disabled");_disconnectBtn.addClass("hidden").button("reset").removeClass("disabled");_nextBtn.removeClass("hidden").addClass("disabled").button("reset");_backBtn.addClass("hidden").button("reset").removeClass("disabled");_addBtn.addClass("hidden").button("reset").removeClass("disabled");_saveBtn.removeClass("hidden").button("reset").removeClass("disabled");_capabilities = null;_sessionProps = null;if (!!$resetConnectionList) {_connectionSearch.val("");_connectionList.empty();_selectedConnectionType = null}};_modal.off("keydown").on("keydown", function (ev) {var event = ev || window.event;rsb.stopPropagation(event)
if (event.ctrlKey && event.keyCode == 83) {event.preventDefault();(_addBtn.is(":visible") ? _addBtn : _saveBtn).click()}});_modal.on('hide.bs.modal', function () {__instanceId__++;_resultContainer = null;_selectedConnectionType = null;_capabilities = null;_sessionProps = null;_args = null});_modal.on('hidden.bs.modal', function () {window?.reactObj?.callbacks?.setCreateConnectionModalOpen?.(false);_reset(false, false)});_modal.on('show.bs.modal', function () {window?.reactObj?.callbacks?.setCreateConnectionModalOpen?.(true)});_closeBtn.off("click").on("click", function () {var unsavedText = _connectionForm.is(":visible") && rsb.checkUnsave(_connectionForm);if (!unsavedText) {_modal.modal("hide");return true}
const $btn = _addBtn.is(":visible") ? _addBtn : _saveBtn;rsb.confirmModal({title: 'Save Changes',body: unsavedText + '&nbsp;' + 'Would you like to save changes before closing the editor?',okText: 'OK',ok: function () {$btn.click()},cancelText: 'Continue Without Saving',cancel: function () {rsb.revertUnsave(_connectionForm);_modal.modal("hide")}})});var _editConnection = function ($category, $displayName, $name, $wizard) {_reset(true, false);if (!$category) {rsb.showResult(_resultContainer, 'The connection type must be specified.', false);return false}
_connectionNameInput.val(_connectionNameInput[0].defaultValue = ($name || "")).prop('readonly', !!$name);_connectionTypeInput.val(_connectionTypeInput[0].defaultValue = $category);_categoryIcon[0].className = "app-icon app-icon-" + $category.toLowerCase().replace(/^cdata(.+)$/, "$1");_categoryDisplayName.val($displayName || $category);if (!$name) {_title.html('Add Connection');_isAddConnectionModal = true;_addBtn.removeClass("hidden");_saveBtn.addClass("hidden");!!_selectedConnectionType && _backBtn.removeClass("hidden")}
$.ajax({dataType: "json",url: "src/generateConnectionUI.rsb?@json",type: "GET",data: {"ConnectionType": $category,"ConnectionName": $name},success: function (data, textStatus, jqXHR) {var items = data.items || [];var errorMsg = rsb.getResultErrorMessage(items);var advanced = items && items.length && items[0].advanced || "";var oauthSettings = OAUTH_SETTINGS[$category.toLowerCase()];const vaultReferences = eval("reference = {" + (items && items.length && items[0].vaultreferences || "") + "}");_capabilities = _args && _args.capabilities || items && items.length && items[0].capabilities || !!oauthSettings && (oauthSettings.capabilities || "OAUTH_WEB") || "";_sessionProps = {};!!errorMsg && rsb.showResult(_resultContainer, errorMsg, false);_connectionSettings.html(items && items.length && items[0].settings || "");_connectionAdvancedSettings.html(advanced);_connectionAdvancedSection.toggle(!!advanced);if (_connectionSettings.is(":visible")) rsb.connect.initDisableSettings(_connectionSettings);else if (_connectionSettings[0].children.length > 0) new IntersectionObserver((entries, observer) => {if (_connectionSettings.is(":visible")) {rsb.connect.initDisableSettings(_connectionSettings);observer.disconnect()}}).observe(_connectionSettings[0]);_connectionForm.find('[data-bs-toggle="popover"]').popover({container: _modal});_connectBtn.addClass("hidden");_disconnectBtn.addClass("hidden");var authscheme = _connectionSettings.find("select[name='authscheme']");_capabilities = authscheme.attr("data-rsb-capability-map") || _capabilities;if (!!_capabilities && !!authscheme && _capabilities.indexOf(";") > 0 && authscheme.children("option").length > 1) {var capDict = Object.create(null);rsb.forEach(_capabilities.split(";"), function ($caps) {$caps = rsb.trimStr($caps);var $sepPos = $caps.indexOf("=");var $scheme = "";if ($sepPos >= 0) {$scheme = rsb.trimStr($caps.substring(0, $sepPos));$caps = rsb.trimStr($caps.substring($sepPos + 1))}
capDict[$scheme.toLowerCase() || "*"] = $caps});capDict["*"] = capDict["*"] || "";if (Object.keys(capDict).length > 1) {var stateDict = Object.create(null);authscheme.change(function () {_capabilities = capDict[Object.hasOwnProperty.call(capDict, authscheme.val().toLowerCase()) ? authscheme.val().toLowerCase() : "*"];if (!!_capabilities && _capabilities.toLowerCase().indexOf("oauth") >= 0) {_testBtn.addClass("hidden");_connectBtn.toggleClass("hidden", !!stateDict[authscheme.val().toLowerCase()]);_disconnectBtn.toggleClass("hidden", !stateDict[authscheme.val().toLowerCase()])} else {stateDict[authscheme.val().toLowerCase()] = _connectBtn.hasClass("hidden");_testBtn.removeClass("hidden");_connectBtn.addClass("hidden");_disconnectBtn.addClass("hidden")}});_capabilities = capDict[Object.hasOwnProperty.call(capDict, authscheme.val().toLowerCase()) ? authscheme.val().toLowerCase() : "*"]}}
_sessionProps = !!oauthSettings ? $.extend({}, oauthSettings) : {};delete _sessionProps.capabilities;var props = (items && items.length && items[0] && items[0].sessionprops || "").split(",");props.push("oauthaccesstoken", "oauthrefreshtoken", "oauthaccesstokensecret", "expiresin", "tokentimestamp", "oauthexpiresin", "oauthtokentimestamp", "oauthverifier");rsb.forEach(props, function (prop) {_sessionProps[prop] = _sessionProps[prop] || prop});rsb.forEach((authscheme.attr("data-rsb-section-properties") || "").split(/,/g), function (prop) {_sessionProps[prop] = _sessionProps[prop] || prop});if ($category === "AS4V2") {_testBtn.addClass("hidden")} else {_testBtn.removeClass("hidden").html("<i class='fa fa-exchange'></i>&nbsp;" + 'Test Connection')}
if (!!_capabilities && _capabilities.toLowerCase().indexOf("oauth") >= 0) {if (!errorMsg && !!$name && _connectionForm.valid()) {_testBtn.html("<i class='fa fa-refresh fa-spin'></i>&nbsp;" + 'Checking Connection Status').addClass("disabled");var instanceId = __instanceId__;_checkConnectionStatus(_disconnectBtn, function ($success) {if (__instanceId__ != instanceId) {return false}
_testBtn.removeClass("disabled").html("<i class='fa fa-exchange'></i>&nbsp;" + 'Test Connection');_testBtn.addClass("hidden");_connectBtn.toggleClass("hidden", !!$success);_disconnectBtn.toggleClass("hidden", !$success)})} else {_testBtn.addClass("hidden");_connectBtn.removeClass("hidden")}}
rsb.connect.initVaultInputGroups.references = vaultReferences
rsb.connect.initVaultInputGroups(_connectionForm, _resultContainer)}}).always(function () {!$wizard && _modal.modal('show')})}
var _saveConnection = function ($btn, $addConnection) {if (_connectionForm.valid()) {_connectionForm.attr("method", $addConnection ? "POST" : "PUT");_connectionForm.off("success").one("success", function () {_args && _args.successCallback && _args.successCallback(_connectionNameInput.val(), _connectionTypeInput.val());_modal.modal("hide");return false});var beforeSubmitRlt = $(_connectionForm[0]).triggerHandler("beforeSubmit", _connectionForm[0]);if (typeof(beforeSubmitRlt) == 'function') {beforeSubmitRlt(function() {rsb.submitForm(_connectionForm[0], $btn)})} else if (beforeSubmitRlt != false) {rsb.submitForm(_connectionForm[0], $btn)}}}
var _checkConnectionStatus = function ($btn, $successCallBack) {var beforeSubmitRlt = $(_connectionForm[0]).triggerHandler("beforeSubmit", _connectionForm[0]);if (typeof(beforeSubmitRlt) == 'function') {beforeSubmitRlt(function() {})}
var queryData = rsb.getFormData(_connectionForm);queryData.connectortype = queryData.category;queryData.sharedconnectioncategory = _connectionTypeInput.val();queryData.sharedconnectionname = _connectionNameInput.val();var downloadLink = '<a class="btn btn-secondary btn-outline-secondary pull-right me-24" style="margin-top: -5px;" href="src/downloadTestConnectionLog.rst?testconnectiontype=sharedConnection&ConnectionName=' + encodeURIComponent(queryData.sharedconnectionname) + '&ConnectionType=' + encodeURIComponent(queryData.sharedconnectioncategory) + '" download="testConnection.log" role="button"><i class="fa fa-download"></i> ' + 'Download Logs'+ ' </a>';var resultString = JSON.stringify(queryData);var postData = { workspaceid: queryData["workspaceid"], connectorid: queryData["connectorid"], connectortype: queryData["connectortype"] };for (var key in queryData) {postData["param@" + key] = queryData[key]}
var instanceId = __instanceId__;rsb.testConnection(postData, $btn, null, function (queryData, result) {if (instanceId == __instanceId__) {rsb.showResult(_resultContainer, $i18n("sharedConnectionEditor_js_0008", downloadLink + "<b>Success!</b>"), true, true);$successCallBack && $successCallBack(true)}}, function (queryData, errMsg) {if (instanceId == __instanceId__) {rsb.showResult(_resultContainer, $i18n("sharedConnectionEditor_js_0009", downloadLink + "<b>Failure!</b>") + errMsg, false, true);$successCallBack && $successCallBack(false)}})}
_connectionList.off("click", "li").on("click", "li", function () {_selectedConnectionType = $(this).hasClass("active") ? null : $(this);_connectionList.find("li.active").removeClass("active");$(this).toggleClass("active", !!_selectedConnectionType);_nextBtn.toggleClass("disabled", !_selectedConnectionType);_nextBtn.toggleClass("btn-primary", !!_selectedConnectionType)});var searchConnections = function($filter) {if ($filter) {var filter = $filter.trim().toLowerCase();_connectionList.find("li").each(function() {$(this).removeClass("first-connection-item").removeClass("last-connection-item");var type = $(this).attr("data-type").toLowerCase();if (!type.includes(filter)) {$(this).addClass("search-not-matched")} else {$(this).removeClass("search-not-matched")}});_connectionList.find("li.list-group-item:not(.search-not-matched):first").addClass("first-connection-item");_connectionList.find("li.list-group-item:not(.search-not-matched):last").addClass("last-connection-item")} else {_connectionList.find("li").each(function() {$(this).removeClass("search-not-matched").removeClass("first-connection-item").removeClass("last-connection-item")})}}
_connectionSearch.on("keyup", function($event) {var event = $event || window.event;if (event.keyCode == 13) {searchConnections($(this).val());return} else if (event.keyCode == 27) {_connectionSearch.val("")}
_connectionClear.toggleClass("hidden", _connectionSearch.val().length <= 0);searchConnections($(this).val())});_connectionClear.click(function() {_connectionSearch.val("");_connectionClear.toggleClass("hidden");searchConnections("")});_connectionAdvancedSection.off("click", "a").on("click", "a", function () {_connectionAdvancedSection.toggleClass("collapsed")});_testBtn.off("click").on("click", function () {_checkConnectionStatus(_testBtn)});_connectBtn.off("click").on("click", function () {var instanceId = __instanceId__;_oauthSpecific.empty();var queryData = rsb.getFormData(_connectionForm);queryData.connectortype = queryData.category;queryData.sharedconnectioncategory = _connectionTypeInput.val();queryData.sharedconnectionname = _connectionNameInput.val();var downloadLink = '<a class="btn btn-secondary btn-outline-secondary pull-right me-24" style="margin-top: -5px;" href="src/downloadTestConnectionLog.rst?testconnectiontype=sharedConnection&ConnectionName=' + encodeURIComponent(queryData.sharedconnectionname) + '&ConnectionType=' + encodeURIComponent(queryData.sharedconnectioncategory) + '" download="testConnection.log" role="button"><i class="fa fa-download"></i> ' + 'Download Logs'+ ' </a>';if (!!queryData.callbackurl) queryData["connectioncallbackurl"] = queryData.callbackurl;rsb.connect.resetConnection(queryData, _connectBtn, null, _capabilities, function (data) {if (__instanceId__ != instanceId) {throw 'The previous operation is been terminated.'}
for (var name in data) {var eleName = _sessionProps[name] || name;var input = _connectionForm.find("[name='" + rsb.escapeSelector(eleName) + "']");queryData[eleName] = data[name];if (input && input.length > 0) {input.val(data[name])} else if (!!_sessionProps[name]) {_oauthSpecific.append($('<input type="password" class="hidden" name="' + rsb.htmlEncode(eleName) + '">').val(data[name]))}}
var postData = { workspaceid: queryData["workspaceid"], connectorid: queryData["connectorid"], connectortype: queryData["connectortype"] };for (var key in queryData) {postData["param@" + key] = queryData[key]}
return postData}, function (data, result, oauth_callback) {if (__instanceId__ != instanceId) {return false}
if (!rsb.connect.oauthWarning(oauth_callback, _resultContainer)) {rsb.showResult(_resultContainer, $i18n("sharedConnectionEditor_js_0008", downloadLink + "<b>Success!</b>"), true, true)}
_connectBtn.addClass('hidden');_disconnectBtn.removeClass('hidden')}, function (queryData, errMsg) {instanceId == __instanceId__ && rsb.showResult(_resultContainer, "<b>Failure!</b>&nbsp;&nbsp;" + errMsg, false, true)}, null,function (queryData, errMsg) {instanceId == __instanceId__ && rsb.showResult(_resultContainer, downloadLink + "<b>Failure!</b>&nbsp;&nbsp;" + errMsg, false, true)});return false});_disconnectBtn.off("click").on("click", function () {var instanceId = __instanceId__;var queryData = rsb.getFormData(_connectionForm);queryData.connectortype = queryData.category;queryData.sharedconnectioncategory = _connectionTypeInput.val();queryData.sharedconnectionname = _connectionNameInput.val();$.ajax({dataType: "json",url: "src/disconnectOAuthAccessToken.rsb?@json",type: "POST",data: queryData,success: function (data, textStatus, jqXHR) {if (__instanceId__ != instanceId) {return false}
var errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult(_resultContainer, errorMsg, false);return false}
for (var name in (_sessionProps || {})) {var eleName = _sessionProps[name] || name;var input = _connectionForm.find("[name='" + rsb.escapeSelector(eleName) + "']");if (input && input.length > 0) {input.val("")} else if (!!_sessionProps[name]) {_oauthSpecific.append('<input type="password" class="hidden" name="' + rsb.htmlEncode(eleName) + '" value="">')}}
_connectionForm.attr("method", "PUT");_connectionForm.off("success").one("success", function () {_connectBtn.removeClass('hidden');_disconnectBtn.addClass('hidden');_oauthSpecific.empty()});if(_isAddConnectionModal){_connectBtn.removeClass('hidden');_disconnectBtn.addClass('hidden');_oauthSpecific.empty()}else{rsb.submitForm(_connectionForm[0], _disconnectBtn)}}})});_nextBtn.off("click").on("click", function () {_editConnection(_selectedConnectionType.data("type"), _selectedConnectionType.text(), null, true)});_backBtn.off("click").on("click", function () {__instanceId__++;_reset(false);_nextBtn.toggleClass("disabled", !_selectedConnectionType);_nextBtn.toggleClass("btn-primary", !!_selectedConnectionType)});_addBtn.off("click").on("click", function () {_saveConnection(_addBtn, true)});_saveBtn.off("click").on("click", function () {_saveConnection(_saveBtn, false)});this.wizard = function ($args) {_reset(false, true);_args = $.extend({}, $args);_title.html('Connection Type');$.ajax({dataType: "json",url: "src/listConnectorTypes.rsb?@json",type: "POST",success: function (data, textStatus, jqXHR) {_modal.modal('show');var errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult(_resultContainer, errorMsg, false)} else {var $showDeprecatedConnectors = rsb.getValueAsBool(_args.showDeprecatedConnectors, false);rsb.forEach(data.items || [], function ($type) {if (rsb.getValueAsBool($type.hasconnectionsettings, false) && ($showDeprecatedConnectors || ($type.releasestatus || "").toLowerCase() != 'deprecated')) {_connectionList.append('<li class="d-flex list-group-item" data-type="' + rsb.htmlEncode($type.type) + '"><i class="connector-type-item-icon app-icon app-icon-' + rsb.htmlEncode($type.type).toLowerCase() + '"></i><span>' + rsb.htmlEncode(($type.releasestatus || "").toLowerCase() != 'deprecated' ? $type.name : $type.type) + '</span></li>')}});if (!data.items || !data.items.length) {rsb.showResult(_resultContainer, 'No connection type.', false)}}}})}
this.addConnection = function ($category, $args) {_args = $.extend({}, $args);_editConnection($category, _args.displayName, null)}
this.editConnection = function ($category, $name, $args) {_args = $.extend({}, $args);_editConnection($category, _args.displayName, $name)}
this.registerOAuthSettings = function ($category, $settings) {if (!!$category) {$settings = $settings || "OAUTH_WEB";if (typeof $settings == "string") {$settings = {capabilities: $settings}} else if ($.isArray($settings)) {var names = $settings;$settings = {};rsb.forEach(names, function (name) {$settings[name] = name})}
OAUTH_SETTINGS[$category.toLowerCase()] = $settings}}
return this});