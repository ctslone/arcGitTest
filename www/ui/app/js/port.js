rsb.connect.checkCertSelection = function(obj, changedCallback) {var newCert = false;if (obj.val() == "rsb:uploadCert") {rsb.uploadCert.form.one("success", function (e, result) {rsb.connect.addNewCert(obj, result["name"]);if (result["password"] && obj.attr("certificate")) {var params = $.parseJSON(obj.attr("certificate"));if (params["password"]) {$(params["password"]).val(result["password"])}
if (params["subject"]) {$(params["subject"]).val("")}}
newCert = true;rsb.uploadCert.modal.modal('hide')});rsb.uploadCert.modal.one("hidden.bs.modal", function (e) {if (!newCert) {obj.find("option").each(function() {this.selected = this.defaultSelected})} else if (changedCallback) {changedCallback()}});rsb.uploadCert.show(obj.children("option[value='rsb:uploadCert']").attr("type"))} else if (changedCallback) {changedCallback()}}
rsb.connect.refreshInheritanceStatus = function(form, portid) {$.ajax({dataType: "json",url: "api/connectors.rsd",type: "GET",data: { "portid": portid, "getparentsettings": true, "joinparentsettings": true, "@json": true },success: function(data) {var result = data["items"];if (!rsb.getResultErrorMessage(result)) {var parentSettings = result[0];form.find(".inherited-settings").removeClass("inherited-settings");var isOldApp = true;for (var name in parentSettings) {if (name.startsWith("parent@")) {isOldApp = false;break}}
for (var name in parentSettings) {if (name.startsWith("parent@")) continue;var inputs = form.find("input, select").filter(function() {return $(this).attr("name") && $(this).attr("name").toLowerCase() == name});if (inputs) {for (var i = 0; i < inputs.length; i++) {var input = $(inputs[i]);var parentValue = parentSettings[name];if (!isOldApp) {rsb.setInputValue(input, parentSettings[name]);parentValue = parentSettings["parent@" + name]}
input.prop("parentValue", parentValue);if (input[0].type == 'hidden') continue;if (rsb.connect.inputCompare(input, parentValue)) {var div = input.closest("div.setting-group").length ? input.closest("div.setting-group") : input.closest("div");div.addClass("inherited-settings")}
input.change(function() {var obj = $(this);var div = obj.closest("div.setting-group").length ? obj.closest("div.setting-group") : obj.closest("div");if (rsb.connect.inputCompare(obj, obj.prop("parentValue"))) {div.addClass("inherited-settings")} else {div.removeClass("inherited-settings")}})}}}
rsb.syncChanges(form)}}})}
rsb.connect.testConnection = function(form, btn, portId, workspace, porttype) {var formData = rsb.getFormData(form, true);var postData = {};postData["workspaceid"] = rsb.htmlDecode(workspace);postData["connectorid"] = rsb.htmlDecode(portId);if (porttype) {postData["connectortype"] = porttype}
for (var key in formData) {postData["param@" + key] = formData[key]}
btn.button("loading");$.ajax({dataType: "json",url: "src/testConnection.rsb?@json",type: "POST",data: postData,success: function(data, textStatus, jqXHR) {var resultContainer = $("#testConnectionResult");if (resultContainer.length < 1) {resultContainer = rsb.getFormResultContainer(form)}
var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result) || rsb.getResultErrorMessageByIndex(result, 1);var downloadLink = '<a class="btn btn-secondary btn-outline-secondary pull-right me-24" style="margin-top: -5px;" href="src/downloadTestConnectionLog.rst?testconnectiontype=connector&connectorid=' + encodeURIComponent(portId) + '&workspaceid=' + encodeURIComponent(workspace) + '" download="testConnection.log" role="button"><i class="fa fa-download"></i> ' + 'Download Logs'+ ' </a>';if (errorMsg) {rsb.showResult(resultContainer, downloadLink + "<b>" + 'Failure!'+"</b>&nbsp;&nbsp;" + errorMsg, false, true);if(result[0]["errormessage"] != undefined) {if (result[0]["thumbprint"]) {rsb.connect.loadModal("thumbprintModal.rst", function() {(window.self !== window.top ? window.parent.rsb.thumbprintModal : rsb.thumbprintModal).show(result[0]["thumbprint"], function() {if (result[0]["keyalgorithm"]) {form.find("#sshpublickeyalgorithms,input[name='sshpublickeyalgorithms']").val(result[0]["keyalgorithm"])}
form.find("#sshservercert,input[name='sshservercert']").val(result[0]["thumbprint"]);form.submit()})})}}} else {form.submit();rsb.showResult(resultContainer, downloadLink + "<b>" + 'Test connection successful!'+ "</b>", true, true)}}}).always(function() {btn.button("reset")})}
rsb.connect.deleteResourceCache = function(btn, portId, workspace, storageName, resourceId) {$.ajax({dataType: "json",url: "src/connectordata.rsd?@json",type: "GET",async: false,data: { "ConnectorId": portId, "WorkspaceId": workspace, "Key": storageName, "@json": true },success: function(data, textStatus, jqXHR) {var resultContainer = rsb.getFormResultContainer(btn.parents("form.form-settings"));var errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult(resultContainer, "<b>Failure!</b>&nbsp;&nbsp;" + errorMsg, false, true)} else {var $_deleteResourceCache = function() {btn.popover("hide");btn.button("loading");$.ajax({dataType: "json",url: "src/connectordata.rsd?@json",type: "DELETE",data: { "ConnectorId": portId, "WorkspaceId": workspace, "Key": storageName, "@json": true },success: function(data, textStatus, jqXHR) {var resultContainer = rsb.getFormResultContainer(btn.parents("form.form-settings"));var errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult(resultContainer, "<b>Failure!</b>&nbsp;&nbsp;" + errorMsg, false, true)} else {rsb.showResult(resultContainer, "<b>" + 'Success!'+ "</b>", true, true)}}}).always(function() {btn.button("reset");btn.popover()})}
var count = data.items ? data.items.length : 0;if ((count = parseInt(count || 0)) > 0) {rsb.confirmModal({title: 'Warning',body:  rsb.evalTemplate('The cache currently contains metadata for $count$ files. If any of these files still exist on the server, continuing with this action causes the application to download them again during the next receive operation. Are you sure you want to remove all entries from the cache?', {"count": count || 0}),okText: 'Yes',cancelText: 'No',ok: function() {$_deleteResourceCache(btn, portId, resourceId)}})} else {$_deleteResourceCache(btn, portId, resourceId)}}}})}
rsb.connect.showPswd = function(btn) {var icon = $(btn).find('i');var input = $(btn).siblings('input.rsb-password');if (input.length <= 0) {input = $(btn).siblings('.input-group').find('input.rsb-password')}
if (icon.hasClass('fa-eye')) {icon.removeClass('fa-eye').addClass('fa-eye-slash');if (input.val() == rsb.connect.pswdmask) {var psw = rsb.connect.getUnmaskedPswd(input);input.val(psw).prop("type", "text")[0].defaultValue = psw} else {input.prop("type", "text")}} else {icon.removeClass('fa-eye-slash').addClass('fa-eye');if (input[0].value && input[0].defaultValue == input[0].value) {input.val(rsb.connect.pswdmask).prop("type", "password")[0].defaultValue = rsb.connect.pswdmask} else {input.prop("type", "password")}}}
rsb.connect.clearOAuthToken = function(workspace, connectorid, successCallback, errorCallback) {$.ajax({dataType: "json",url: "src/disconnectOAuthAccessToken.rsb",type: "POST",data: { "workspaceid": workspace, "connectorid": connectorid, "@json": "true" },success: function(data, textStatus, jqXHR) {var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result);if(errorMsg) {if (typeof(errorCallback) == "function") {errorCallback(errorMsg)}} else {if (typeof(successCallback) == "function") {successCallback(result)}}}})}
rsb.connect.buildConnectionString = function(form, driverType, driverName, driverClass, connectionStringType, pswd, sensitiveType, callback) {var postData = { "@json": true, "DriverType": driverType, "DriverName": driverName, "DriverClass": driverClass, "connectionstringtype": connectionStringType };if (!callback && $.isFunction(sensitiveType)) {callback = sensitiveType} else if(sensitiveType) {postData["SensitiveType"] = sensitiveType}
var values = rsb.getFormData(form, false);for (var key in values) {if (key.startsWith("connection")) {postData[key.substring(10).toLowerCase()] = values[key]}}
if (pswd && postData["Password"] == rsb.connect.pswdmask) {postData["Password"] = pswd}
$.ajax({dataType: "json",url: "src/buildConnectionString.rsb",type: "POST",data: postData,success: function(data, textStatus, jqXHR) {if (callback) {callback( data["items"])}}})}
rsb.connect.parseConnectionString = function(connectionString, driverType, driverName, driverClass, connectionStringType, callback) {if (connectionString && connectionString.length > 0) {var postData = { "@json": true, "DriverType": driverType, "DriverName": driverName, "DriverClass": driverClass, "ConnectionStringType": connectionStringType, "ConnectionString": connectionString };$.ajax({dataType: "json",url: "src/parseConnectionString.rsb",type: "POST",data: postData,success: function(data, textStatus, jqXHR) {if (callback) {callback(data["items"])}}})} else if (callback) {callback([{}])}}
rsb.connect.createCertModal = function(privcert, certpwd, pubcert, resultContainer, pubKeyType) {rsb.createCert.form.one("success", function (e, result) {rsb.connect.addNewCert(privcert, result["name"]);certpwd.val(result["password"]);if (pubcert) {if (pubcert.is("select")) {rsb.connect.addNewCert(pubcert, result["pubname"])} else {pubcert.val(result["pubname"])}}
if (resultContainer) {rsb.showResult(resultContainer, 'Certificate created successfully.', true)}
rsb.createCert.modal.modal('hide')});if (pubKeyType) {rsb.createCert.publickeytype.val(pubKeyType)}
rsb.createCert.modal.modal('show')}
rsb.connect.addNewCert = function(obj, value) {if (obj && value) {var duplicate = false;obj.find("option").each(function() {if ($(this).text() == value) {duplicate = true}});if (!duplicate) {var newOption = $("<option>").val(value).text(value);obj.children("option[value='rsb:uploadCert']").before(newOption)}
obj.val(value)}}
rsb.connect.addCustomItem = function(container, keyText, valueText) {var html = "<div class='form-group custom-item-group'>"+"  <div class='col-md-3 input-inline'>"+"    <input type='text' class='form-control item-key' placeholder='" + keyText + "'>"+"  </div>"+"  <div class='col-md-3 input-inline'>"+"    <input type='text' class='form-control item-value' placeholder='" + valueText + "'>"+"  </div>"+"  <button type='button' class='close pull-left'><span aria-hidden='true' onclick=\"rsb.connect.removeCustomItem($('#" + $(container).attr("id") + "'), this)\">&times;</span></button>"+"</div>";$(container).append(html);$(container).find("button").removeClass("hidden")}
rsb.connect.removeCustomItem = function(container, obj) {var group = $(obj).parents("div.custom-item-group");group[0].remove()}
rsb.connect.getCustomValue = function(container, urlencodeing) {var result = "";var prefix = "";var key = null;var value = null;$(container).find("div.custom-item-group").each(function() {key = $(this).find("input.item-key:eq(0)").val();if (key && key.length > 0) {value = $(this).find("input.item-value:eq(0)").val();if (urlencodeing && typeof(urlencodeing) == "boolean") {result += prefix + encodeURIComponent(key) + "=" + encodeURIComponent(value)} else {result += prefix + key + "=" + value}
prefix = ";"}});return result}
rsb.connect.importTSL = function(button, resultContainer) {button.button("loading");$.post("src/standard/importTSL.rsb?@json&@fmtoptions=exparen", function($data) {var result = $data.items[0];var errorMsg = rsb.getResultErrorMessage($data.items);if (errorMsg) {rsb.showResult(resultContainer, errorMsg, false)} if (result["other:warning"]) {rsb.showResult(resultContainer, result["other:warning"], "warning")} else {rsb.showResult(resultContainer, 'Successful', true)}}).always(function() {button.button("reset")})}
rsb.connect.onAuthmodeChanged = function(elem, port) {var selectedValue = elem.val().toLowerCase();if (selectedValue == "password" || selectedValue == "keyboardinteractive") {port.certAuthFields.addClass("hidden");port.basicAuthFields.removeClass("hidden")} else if (selectedValue == "publickey") {port.basicAuthFields.addClass("hidden");port.certAuthFields.removeClass("hidden")} else if (selectedValue == "none") {port.basicAuthFields.addClass("hidden");port.certAuthFields.addClass("hidden")} else {port.basicAuthFields.removeClass("hidden");port.certAuthFields.removeClass("hidden")}}
rsb.connect.getUnmaskedPswd = function(input) {var pswd = input.val();if (pswd == rsb.connect.pswdmask) {if (input.closest(".vault-input-group").hasClass("active")) {let $payload = {};input.closest(".vault-input-group").trigger("vault.group.getValue", $payload);if (!!$payload.value) return $payload.value}
var form = input.parents('form');var data = { "@json": true, "workspaceid": rsb.connect.options && rsb.connect.options.workspaceid, "connectorid": rsb.connect.options && rsb.connect.options.portId };rsb.forEach(form.find('input[required],input[type="hidden"]').serializeArray(), function(op, index) {data[op.name.toLowerCase()] = op.value});$.ajax({dataType: "json",url: form.attr("action"),type: "GET",async: false,data: data,success: function(data) {var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.getFormResultContainer(form), errorMsg, false)} else {pswd = result[0][input.attr("name").toLowerCase()]}}})}
return pswd || ""}
rsb.connect.inputCompare = function(input, value) {if (input.length > 1) {var result = false;input.each(function() {result = result || rsb.connect.inputCompare(this, value)})
return result}
input = $(input);var tagName = (input.prop("tagName") || "").toLowerCase();if ("input" == tagName) {var inputType = input.prop("type");if (inputType == "checkbox") {return rsb.equalsIgnoreCase(value, input.prop("checked") ? input.val() : input.attr("data-uncheckvalue"))} else if (inputType == "password") {return rsb.connect.getUnmaskedPswd(input) == value}} else if ("select" == tagName) {return rsb.equalsIgnoreCase(value, input.val())}
return value == input.val()}
rsb.connect.pathCombine = function(path1, path2) {if (!path1 || !path2) {return null}
if ((typeof(path1) != 'string') || (typeof(path2) != 'string')) {return null}
path1 = path1.trim();path2 = path2.trim();if (path1.endsWith('/') || path1.endsWith('\\')) {return path1 + path2} else {return path1 + '/' + path2}}
rsb.connect.initDisableSettings = function(container) {$(container || document).find("[data-rsb-enable-settings],[data-rsb-show-settings],[data-rsb-enable-settings-true],[data-rsb-enable-settings-false],[data-rsb-show-settings-true],[data-rsb-show-settings-false]").each(function() {if ($(this).is("input[type=checkbox]") || $(this).is("input[type=radio]")) {$(this).change(rsb.connect.disableSettings);if (!$(this).closest(".form-group").hasClass("hidden")) {$(this).change()}} else if ($(this).is("option")) {var obj = $(this).closest("select");if (!obj.attr("data-rsb-enable-settings-switcher")) {obj.change(rsb.connect.disableSettings);if (!obj.closest(".form-group").hasClass("hidden")) {obj.attr("data-rsb-enable-settings-switcher", true);obj.change()}}}});$(container || document).find("[data-rsb-reset-settings-section-count]").each(function() {if ($(this).is("option")) {var obj = $(this).closest("select");if (!obj.attr("data-rsb-reset-settings-section-switcher")) {obj.change(rsb.connect.resetSettingsSection);if (obj.is(":visible")) {obj.attr("data-rsb-enable-settings-switcher", true);obj.change()}}}})}
rsb.connect.updateSettingsPane = function() {$("div.port-tab-content div.tab-pane.active form.form-settings").on("success", function (e, result) {var connectorid = result.connectorid;var workspaceid = result.workspaceid;var postData = {};postData["connectortype"] = result.connectortype;postData["connectorid"] = result.connectorid;$.ajax({dataType: "json",url: "src/getConnectorMetadata.rsb?@json",type: "POST",data: postData,success: function(data) {var result = data["items"];if (result.length > 0) {var hasTestFile = rsb.getValueAsBool(result[0].hastestfile.toLowerCase(), false);var createTestFileBtn = $("div.tab-pane#input #createTestFileButton");if (createTestFileBtn.length > 0 && !hasTestFile) {var firstObj = $("div.tab-pane#input .dropdown-menu[role='menu'] li").eq(0);firstObj.remove()} else if (createTestFileBtn.length < 1 && hasTestFile) {var firstObj = $("div.tab-pane#input .dropdown-menu[role='menu'] li").eq(0);firstObj.before("<li id=\"createTestFileButton\"><a class=\"dropdown-item\" href=\"javascript:void(0);\" onclick=\"rsb.connect.createTestFiles('" + workspaceid + "', '" + connectorid + "', $('#sendTable'));return false;\"><i class=\"fa fa-copy\"></i> " + 'Create Test Files'+ "</a></li>")}
if (result[0].supportedoperations) {var supportedOperations = [].concat(result[0].supportedoperations);$("#port-tab").removeClass("port-input port-output");if (supportedOperations.find((op) => op.match(/ActiveSend|PassiveSend|Transform|ScheduledTransform/gi))) $("#port-tab").addClass("port-input");if (supportedOperations.find((op) => op.match(/ActiveReceive|PassiveReceive|Transform|ScheduledTransform/gi))) $("#port-tab").addClass("port-output");if (rsb.connectorSettings && rsb.connectorSettings.calcMiniWidth) rsb.connectorSettings.calcMiniWidth()}
if (rsb.getValueAsBool(result[0].issupportreceivefile, false)) {$(".port-tab-content #output").addClass("port-supportreceivefile");$("#automationSettingsForm").addClass("port-supportreceivefile")} else {$(".port-tab-content #output").removeClass("port-supportreceivefile");$("#automationSettingsForm").removeClass("port-supportreceivefile")}
if (rsb.getValueAsBool(result[0].issupportsendfile, false)) {$(".port-tab-content #input").addClass("port-supportsendfile");$("#automationSettingsForm").addClass("port-supportsendfile")} else {$(".port-tab-content #input").removeClass("port-supportsendfile");$("#automationSettingsForm").removeClass("port-supportsendfile")}}}})})}
rsb.connect.disableSettings = function() {var getControlledElems = function($settings, $form) {var elems = [];if ($settings) {$settings.split(",").map(name => name.trim()).filter(Boolean).forEach(function($settingsName) {const [name, secondaryName] = $settingsName.split(":").map(str => str.trim());var elem = $form.find("[name=" + $.escapeSelector(name.toLowerCase()) + "]");if (elem.length < 1) {elem = $form.find("[data-arc-for=" + $.escapeSelector(name.toLowerCase()) + "]")}
if (elem.is("select") && secondaryName) {elem = elem.find("option[value=" + $.escapeSelector(secondaryName) + "]")}
elems.push(elem)})}
return elems};var toggleElems = function($elems, $action, $depExpr) {$elems.forEach(function($elem) {if ($action == "enable") {$($elem).prop("disabled", false)} else if ($action == "show") {if ($depExpr) {const deps = $depExpr.split(",").map(dep => dep.trim()).filter(Boolean);const conditions = deps.reduce((conditions, dep) => {const [setting, value] = dep.split(":");if (!conditions?.[setting]) conditions[setting] = [];conditions[setting].push(value);return conditions}, {});const show = Object.entries(conditions).every(([setting, values]) => {const depElem = $(`[name=${setting.toLowerCase()}]`);if (depElem.length > 0) {return values.some(value => depElem.val() === value)}
return false});if (show) {if ($elem.is("option")) {$($elem).removeClass("hidden")} else {$($elem).closest(".form-group").removeClass("hidden")}}} else {if ($elem.is("option")) {$($elem).removeClass("hidden")} else {$($elem).closest(".form-group").removeClass("hidden")}}}});$elems.forEach(function($elem) {if ($action == "show" && $elem.is("option")) {const select = $elem.closest("select");const selectedOption = select.find("option:selected:not(.hidden)");if (selectedOption.length <= 0) {select.val(select.find("option:not(.hidden)").eq(0).val())}}})};var settings = [];if ($(this).is("select")) {$(this).find("option").each(function($i, $elem) {var obj = $($elem);var enableElems = getControlledElems(obj.attr("data-rsb-enable-settings"), obj.closest("form.sync-changes"));var showElems = getControlledElems(obj.attr("data-rsb-show-settings"), obj.closest("form.sync-changes"));if (enableElems.length > 0) {settings.push({"obj": obj,"value": "selected","action": "enable","elems": enableElems})}
if (showElems.length > 0) {const otherDepsCount = parseInt(obj.attr("data-rsb-show-settings-other-deps-count"));const otherDeps = Array.from({length: otherDepsCount}, (_, index) => obj.attr(`data-rsb-show-settings-other-deps-${index}`)).map(dep => dep.trim());const otherDepsElemNames = Array.from({length: otherDepsCount}, (_, index) => obj.attr(`data-rsb-show-settings-${index}`)).map(dep => dep.trim());const otherDepsElems = otherDepsElemNames.map(names => getControlledElems(names, obj.closest("form.sync-changes")));settings.push({"obj": obj,"value": "selected","action": "show","elems": showElems,"otherDeps": otherDepsCount > 0 ? otherDeps : undefined,"otherDepsElems":  otherDepsCount > 0 ? otherDepsElems : undefined,})}})} else if ($(this).is("input[type=checkbox]")) {var obj = $(this);var enableElemsTrue = getControlledElems(obj.attr("data-rsb-enable-settings-true"), obj.closest("form.sync-changes"));var enableElemsFalse = getControlledElems(obj.attr("data-rsb-enable-settings-false"), obj.closest("form.sync-changes"));var showElemsTrue = getControlledElems(obj.attr("data-rsb-show-settings-true"), obj.closest("form.sync-changes"));var showElemsFalse = getControlledElems(obj.attr("data-rsb-show-settings-false"), obj.closest("form.sync-changes"));if (enableElemsTrue.length > 0) {settings.push({"obj": obj,"value": "checked","action": "enable","elems": enableElemsTrue})}
if (enableElemsFalse.length > 0) {settings.push({"obj": obj,"value": "unchecked","action": "enable","elems": enableElemsFalse})}
if (showElemsTrue.length > 0) {settings.push({"obj": obj,"value": "checked","action": "show","elems": showElemsTrue})}
if (showElemsFalse.length > 0) {settings.push({"obj": obj,"value": "unchecked","action": "show","elems": showElemsFalse})}} else if ($(this).is("input[type=radio]")) {if ($(this).is(":checked")) {var obj = $(this);var unCheckedObjs = $("input:radio[name='" + $(this).attr("name") + "'][value!='" + $(this).val() + "']");var enableElems = getControlledElems(obj.attr("data-rsb-enable-settings"), obj.closest("form.sync-changes"));var showElems = getControlledElems(obj.attr("data-rsb-show-settings"), obj.closest("form.sync-changes"));if (enableElems.length > 0) {settings.push({"obj": obj,"value": "checked","action": "enable","elems": enableElems})}
if (showElems.length > 0) {settings.push({"obj": obj,"value": "checked","action": "show","elems": showElems})}
unCheckedObjs.each(function($i, $elem) {var unCheckedObj = $($elem);var disableElems = getControlledElems(unCheckedObj.attr("data-rsb-enable-settings"), obj.closest("form.sync-changes"));var hideElems = getControlledElems(unCheckedObj.attr("data-rsb-show-settings"), obj.closest("form.sync-changes"));if (disableElems.length > 0) {settings.push({"obj": obj,"value": "unchecked","action": "enable","elems": disableElems})}
if (hideElems.length > 0) {settings.push({"obj": obj,"value": "unchecked","action": "show","elems": hideElems})}})}}
settings.forEach(function($setting) {if ($setting.action == "enable") {$setting.elems.forEach(function($elem) {$($elem).prop("disabled", true)})} else if ($setting.action == "show") {$setting.elems.forEach(function($elem) {if ($elem.is("option")) {$($elem).addClass("hidden")} else {$($elem).closest(".form-group").addClass("hidden")}})}});settings.forEach(function($setting) {if ($setting.value == "checked" && $setting.obj.prop("checked")) {toggleElems($setting.elems, $setting.action)} else if ($setting.value == "unchecked" && !$setting.obj.prop("checked")) {toggleElems($setting.elems, $setting.action)} else if ($setting.value == "selected") {if ($setting.obj.prop("selected") && !$setting.obj.closest(".form-group").hasClass("hidden")) {if ($setting.otherDeps && $setting.otherDeps.length > 0) {$setting.otherDeps.forEach(($dep, $index) => toggleElems($setting.otherDepsElems[$index], $setting.action, $dep))} else {toggleElems($setting.elems, $setting.action)}}}
$setting.elems.forEach($elem => $elem.change())});settings.forEach(function($setting) {if ($setting.action == "show") {$setting.elems.forEach(function($elem) {var sectionElem = $($elem).closest(".form-group");while (sectionElem.length > 0 && !sectionElem.is("h4.page-header")) {sectionElem = sectionElem.prev()}
var sectionSettings = sectionElem.nextUntil("h4.page-header:not(.hidden)").filter(":not(.hidden, script, style)");if (sectionSettings.length <= 0) {sectionElem.addClass("hidden")} else {sectionElem.removeClass("hidden")}})}})}
rsb.connect.resetSettingsSection = function(e) {const moveElems = (settingsDests, otherDeps) => {settingsDests.forEach(pair => {let needMove = false;if (otherDeps) {const deps = otherDeps.split(",").map(dep => dep.trim()).filter(Boolean);const conditions = deps.reduce((conditions, dep) => {const [setting, value] = dep.split(":");if (!conditions?.[setting]) conditions[setting] = [];conditions[setting].push(value);return conditions}, {});needMove = Object.entries(conditions).every(([setting, values]) => {const depElem = $(`[name=${setting.toLowerCase()}]`);if (depElem.length > 0) {if (depElem.attr("type") === "checkbox") {return values.some(value => depElem.prop("checked") === rsb.getValueAsBool(value, false))} else {return values.some(value => depElem.val() === value)}}
return false})} else {needMove = true}
if (needMove) {const [elem, dests] = pair;const formControl = elem.find("input.form-control, select.form-select");$(`[data-rsb-reset-settings-section-copy=${formControl.attr("id")}]`).remove();dests.forEach(dest => {const newElem = elem.clone();const [tab, section] = dest.split(":").map(str => str.trim());if (tab && section) {const tabElem = $(`#${tab.toLowerCase()}.tab-pane`);let sectionElem = tabElem.find(`[data-rsb-section='${section}']`);if (sectionElem.length > 0) {let nextElement = sectionElem.next();while (nextElement.length > 0 && nextElement.is('div.form-group')) {sectionElem = nextElement;nextElement = nextElement.next()}
elem.after(`<span style="display: none;" data-rsb-reset-settings-section-original-placeholder="${formControl.attr("id")}" />`)
elem.detach();sectionElem.after(elem)}}})}})};const settings = [];if ($(this).is("select")) {$(this).find("option").each(function($i, $elem) {var obj = $($elem);const container = obj.closest(".form-settings");const count = parseInt(obj.attr("data-rsb-reset-settings-section-count"));if (count > 0) {for (let $i = 0; $i < count; $i++) {const settingsDests = (obj.attr(`data-rsb-reset-settings-section-settings-${$i}`) || "").split(",").map(setting => setting.split("=>")).map(([setting, dest]) => [setting.trim(), dest?.trim()]).filter(([setting, dest]) => setting && dest);const settingsDestsObj = settingsDests.reduce((settingsDestsObj, [setting, dest]) => {if (!settingsDestsObj[setting]) settingsDestsObj[setting] = [];if (!settingsDestsObj[setting].includes(dest)) {settingsDestsObj[setting].push(dest)}
return settingsDestsObj}, {});const elemDests = Object.entries(settingsDestsObj).map(([setting, dests]) => [container.find(`[name=${setting.toLowerCase()}`).closest(".form-group"), dests]).filter(([elem]) => elem.length > 0);if (elemDests.length > 0) {settings.push({"obj": obj,"value": "selected","dests": elemDests,"otherDeps": obj.attr(`data-rsb-reset-settings-section-other-deps-${$i}`)})}}}})}
settings.forEach(setting => {setting.dests.forEach(([elem]) => {const elemObj = $(elem);const placeholder = $(`[data-rsb-reset-settings-section-original-placeholder=${elemObj.find("input.form-control, select.form-select").attr("id")}]`);if (placeholder.length > 0) {elemObj.detach();placeholder.after(elemObj);placeholder.remove()}})});settings.forEach(setting => {if (setting.obj.prop("selected") && !setting.obj.closest(".form-group").hasClass("hidden")) {moveElems(setting.dests, setting.otherDeps)}
setting.dests.forEach(([elem]) => elem.change())});$(this).closest("form").find("h4.page-header").each(function (_, elem) {var sectionElem = $(elem);var sectionSettings = sectionElem.nextUntil("h4.page-header:not(.hidden)").filter(":not(.hidden, script, style, [type='hidden'], [data-rsb-reset-settings-section-original-placeholder])");if (sectionSettings.length <= 0) {sectionElem.addClass("hidden")} else {sectionElem.removeClass("hidden")}})}
rsb.connect.checkFileSelection = function($workspaceId, $connectorId, $elem) {if ($elem.val() == "rsb:uploadCollectionValue") {var revert = true;var name = $elem.data("collection-name") || $elem.attr("name");rsb.connect.loadModal("addCollectionValueModal.rst", function() {(window.self !== window.top ? window.parent.rsb.connect.addCollectionValueModal : rsb.connect.addCollectionValueModal).show($workspaceId, $connectorId, name, function ($value) {var duplicate = false;$elem.find("option").each(function() {if ($(this).val() == $value) {duplicate = true}});if (!duplicate) {var newOption = $("<option>").val($value).text($value);$elem.children("option[value='rsb:uploadCollectionValue']").before(newOption)}
$elem.children("option").prop("selected", false).filter("[value=" + $.escapeSelector($value) + "]").prop("selected", true);$("#" + $elem.attr("id") + "SelectedName").val($value).change();revert = false}, function() {if (revert) {$elem.find("option").each(function() {this.selected = this.defaultSelected})}})})} else {$("#" + $elem.attr("id") + "SelectedName").val($elem.val()).change()}}
rsb.connect.download = function(url, resultContainer) {window.onDownloadError = function(error) {rsb.showResult(resultContainer, error, false)}
window.open(url, '_blank').focus()}
rsb.connect.BASE64Encode = function(str) {return window.btoa(unescape(encodeURIComponent(str)))}
rsb.connect.BASE64Decode = function(str) {return decodeURIComponent(escape(window.atob(str)))}
rsb.connect.loadModal = function (name, arg1, arg2) {if (window.self !== window.top) {window.parent.rsb.loadModal(name, arg1, arg2)} else {rsb.loadModal(name, arg1, arg2)}};rsb.connect.getValidXMLElementName = (name) => {name = name.replace(/[^\u0300-\u036F\u203F-\u2040-.0-9_a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u200FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/g, "_");return name && /[_a-zA-Z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u200FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/.test(name.charAt(0)) ? name : "_" + name};rsb.connect.resetState = function (form, btn, portId, workspace) {btn.button("loading");$.ajax({dataType: "json",url: "src/connectorResetState.rsb?@json",type: "POST",data: {WorkspaceId: workspace, ConnectorId: portId},success: function (data, textStatus, jqXHR) {const resultContainer = rsb.getFormResultContainer(form);var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result) || rsb.getResultErrorMessageByIndex(result, 1);if (errorMsg) {rsb.showResult(resultContainer, "<b>" + 'Failure!'+ "</b>&nbsp;&nbsp;" + errorMsg, false, true)} else {rsb.showResult(resultContainer, 'Reset state successful!'+ "</b>", true, true)}}}).always(function () {btn.button("reset")})}
rsb.connect.setObject = function ($form, $workspaceId, $connectorId, $data, $callback) {const resId = $workspaceId?.toLowerCase() + ":" + $connectorId?.toLowerCase() + "@obj";return $.ajax({url: "src/setObject.rsb",type: "POST",data: {...$data, "@json": true, "workspaceId": $workspaceId, "connectorId": $connectorId},dataType: "json",headers: {"If-Unmodified-Since": rsb.getResourceLastModified(resId)},success: function (data, textStatus, jqXHR) {rsb.setResourceLastModified(resId, jqXHR.getResponseHeader("Last-Modified"));$callback?.(data, textStatus, jqXHR)},error: function (jqXHR, errorStatus, thrownError) {const error = rsb.ajaxError(jqXHR, errorStatus, thrownError);if (error) {const resultContainer = rsb.getFormResultContainer($form);rsb.showResult(resultContainer, error, false);$($form).trigger("error", false)}}})}
rsb.connect.addCollectionValue = function ($form, $workspaceId, $connectorId, $data, $callback) {const resId = $workspaceId?.toLowerCase() + ":" + $connectorId?.toLowerCase() + "@collection";return $.ajax({url: "src/addCollectionValue.rsb",type: "POST",data: {...$data, "@json": true, "workspaceId": $workspaceId, "connectorId": $connectorId},dataType: "json",headers: {"If-Unmodified-Since": rsb.getResourceLastModified(resId)},success: function (data, textStatus, jqXHR) {rsb.setResourceLastModified(resId, jqXHR.getResponseHeader("Last-Modified"));$callback?.(data, textStatus, jqXHR)},error: function (jqXHR, errorStatus, thrownError) {const error = rsb.ajaxError(jqXHR, errorStatus, thrownError);if (error) {const resultContainer = rsb.getFormResultContainer($form);rsb.showResult(resultContainer, error, false);$($form).trigger("error", false)}}})}
$(document).ready(function() {rsb.connect.initDisableSettings();rsb.connect.updateSettingsPane()});