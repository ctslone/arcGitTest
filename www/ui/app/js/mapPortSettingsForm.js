rsb.mapSettings = rsb.mapSettings || {};rsb.mapSettings.options = {};rsb.mapSettings.mappingScriptEditor = null;rsb.mapSettings.form = $("#mapPortSettings");rsb.mapSettings.resultContainer = rsb.getFormResultContainer(rsb.mapSettings.form);rsb.mapSettings.templatePanel = rsb.mapSettings.form.find(".template-panel");rsb.mapSettings.mapControlGroup = rsb.mapSettings.form.find(".map-control-group");rsb.mapSettings.mappanel = rsb.mapSettings.form.find("#mappanel");rsb.mapSettings.mapwell = rsb.mapSettings.form.find(".map-well");rsb.mapSettings.status = rsb.mapSettings.form.find("#status");rsb.mapSettings.designBtn = rsb.mapSettings.mapControlGroup.find("#mapportsettingsform_design_btn");rsb.mapSettings.codeBtn = rsb.mapSettings.mapControlGroup.find("#mapportsettingsform_code_btn");rsb.mapSettings.mapTable = rsb.mapSettings.mappanel.find("#mapTable");rsb.mapSettings.mapBody = rsb.mapSettings.mapTable.find("tbody");rsb.mapSettings.sourceZone = rsb.mapSettings.form.find("div.template-source");rsb.mapSettings.destinationZone = rsb.mapSettings.form.find("div.template-destination");rsb.mapSettings.SrcSchemaName = rsb.mapSettings.form.find("#SrcSchemaName");rsb.mapSettings.DestSchemaName = rsb.mapSettings.form.find("#DestSchemaName");rsb.mapSettings.quickSearch = rsb.mapSettings.form.find("#quickSearch");rsb.mapSettings.mappedBtn = rsb.mapSettings.form.find("#mappedBtn");rsb.mapSettings.unmappedBtn = rsb.mapSettings.form.find("#unmappedBtn");rsb.mapSettings.mappingChanged = false;rsb.mapSettings.fieldsChanged = false;rsb.mapSettings.mapInfo = {Receive: {}, Send: {}};rsb.mapSettings.init = function($options) {rsb.mapSettings.isInitEmpty = false;rsb.mapSettings.options = $.extend($options, rsb.connect.options);const renderSampleEditors = function () {const props = {disabled: rsb.mapSettings.options.readonly,sampleUri: "src/mapListTemplates.rsb?@json&workspaceId=" + encodeURIComponent(rsb.mapSettings.options.workspaceid) + "&connectorId=" + encodeURIComponent(rsb.mapSettings.options.portId),accept: ".xml,.csv,.tsv,.eml,.psv",sampleResolver: (items, props) => {const errMsg = rsb.getResultErrorMessage(items);if (errMsg) {rsb.showResult(rsb.mapSettings.resultContainer, errMsg, false);return []}
items = items[0];if (typeof items.template === "string") {items.template = [items.template];items.type = [items.type]}
const type = props.sampleName === "destination" ? "2" : "1";return items.template?.filter((template, index) => items.type[index].includes(type))},uploadUri: "src/uploadTemplate.rsb?@json&ConnectorType=Map&Overwrite=false&workspaceId=" + encodeURIComponent(rsb.mapSettings.options.workspaceid) + "&connectorId=" + encodeURIComponent(rsb.mapSettings.options.portId),onChanged: (sample, isUploaded, callback, props) => {if (!sample) return false;const source = rsb.mapSettings.sourceZone.find("input.source").val();const destination = rsb.mapSettings.destinationZone.find("input.destination").val();if (props.sampleName !== "destination" && sample === source) return false;if (props.sampleName === "destination" && sample === destination) return false;const changeSample = () => {callback(true);rsb.mapSettings.templateChanged(props.sampleName !== "destination" ? sample : source, props.sampleName === "destination" ? sample : destination, props.sampleName !== "destination" ? "Receive" : "Send")}
if (source.length > 0 && destination.length > 0) {rsb.confirmModal({title: 'Warning',body: rsb.evalTemplate('Changing the $direction$ file will cause any currently defined mappings to be discarded. Are you sure you want to make this change?', {"direction": props.sampleName}),okText: 'Yes',cancelText: 'No',ok: changeSample})} else {changeSample()}
return false},};rsb.renderComponent("ConnectorSampleFileSelector", $("#mapPortSettings_source_file_selector")[0], {sampleFile: rsb.mapSettings.sourceZone.find("input.source").val(),sampleName: "source",...props});props.accept = "text/" + "*,.xml,.csv,.tsv,.json,.psv";rsb.renderComponent("ConnectorSampleFileSelector", $("#mapPortSettings_destination_file_selector")[0], {sampleFile: rsb.mapSettings.destinationZone.find("input.destination").val(),sampleName: "destination",...props})}
renderSampleEditors();$(document).one("registerComponent.ConnectorSampleFileSelector", renderSampleEditors);rsb.mapSettings.initSource = rsb.mapSettings.sourceZone.find("input.source").val();rsb.mapSettings.initDestination = rsb.mapSettings.destinationZone.find("input.destination").val();if(!rsb.mapSettings.initSource || !rsb.mapSettings.initDestination) {rsb.mapSettings.isInitEmpty = true}}
rsb.externalCheckUnsaveFunc.mapPortSettings = function() {return rsb.mapSettings.mappingChanged}
rsb.mapSettings.rowHover = function() {!rsb.mapSettings.options.readonly && $(this).find('td:not(.unselected) .map-reset').addClass("d-inline-block")};rsb.mapSettings.rowUnHover = function() {!rsb.mapSettings.options.readonly && $(this).find('.map-reset').removeClass("d-inline-block");!rsb.mapSettings.options.readonly && $(this).find('.map-select').removeClass('open')};rsb.mapSettings.previousPopoverObj = null;rsb.mapSettings.showPopover = function(e) {rsb.stopPropagation(e);rsb.mapSettings.resetPopover();if (rsb.isTruncated($(this))) {$(this).popover('show');rsb.mapSettings.previousPopoverObj = $(this)}
$(this).one('click', rsb.mapSettings.hidePopover)}
rsb.mapSettings.hidePopover = function(e) {rsb.stopPropagation(e);rsb.mapSettings.resetPopover();if (rsb.isTruncated($(this))) {$(this).popover('hide')}
$(this).one('click', rsb.mapSettings.showPopover)}
rsb.mapSettings.resetPopover = function() {if (rsb.mapSettings.previousPopoverObj) {rsb.mapSettings.previousPopoverObj.trigger('click');rsb.mapSettings.previousPopoverObj = null}}
rsb.mapSettings.reset = function() {rsb.mapSettings.mappedBtn.removeClass('active');rsb.mapSettings.unmappedBtn.removeClass('active');rsb.mapSettings.quickSearch.val("");rsb.mapSettings.mapBody.find("tr.map").hover(rsb.mapSettings.rowHover, rsb.mapSettings.rowUnHover).removeClass('mismatched').removeClass('unfiltered');if (rsb.mapSettings.mappingScriptEditor && rsb.mapSettings.mappingScriptEditor.editor) {rsb.mapSettings.mappingScriptEditor.clearHistory()}
rsb.mapSettings.resetPopover();rsb.mapSettings.mapBody.find("tr>td:nth-child(2)").each(function() {if (rsb.isTruncated($(this))) {$(this).addClass('pointercursor').one('click', rsb.mapSettings.showPopover)}});rsb.mapSettings.mapTable.mouseleave(function(e) {e = e || window.event;var top = rsb.mapSettings.mapTable.offset().top;if (e.pageY <= top || e.pageY >= top + rsb.mapSettings.mapTable.outerHeight()) {rsb.mapSettings.resetPopover()}})}
rsb.mapSettings.matchRow = function(row, searchText, textLength) {var items = [row.find('td:eq(0)'), row.find('td:eq(1)'), row.find('td:eq(2) button.dropdown-toggle')];var invalids = ["* Formula", "", "Select..."];if (row.hasClass('formula')) {items[0] = row.find('td:eq(0) button.dropdown-toggle')}
var found = false;for (var i = 0; i < 3; i++) {var obj = items[i];var text = obj.text();var position = -1;if (text && text.length > 0 && rsb.trimStr(text) != invalids[i]) {position = textLength > 0 ? text.toLowerCase().indexOf(searchText.toLowerCase()) : -1;if (position > -1) {found = true;var fragment = text.substr(position, textLength);var leftSub = text.substr(0, position);var rightSub = text.substr(position + textLength);text = leftSub + "<b>" + fragment + "</b>" + rightSub;found = true}
if (obj.hasClass('dropdown-toggle')) {obj.html(text + ' <span class="caret">')} else {obj.html(text)}}}
if (textLength > 0 && !found) {row.addClass('mismatched')} else {row.removeClass('mismatched')}}
rsb.mapSettings.search = function(event) {var searchText = rsb.trimStr(rsb.mapSettings.quickSearch.val());var textLength = searchText.length;rsb.mapSettings.mapBody.find("tr.map").each(function(index, tr) {rsb.mapSettings.matchRow($(tr), searchText, textLength)})}
rsb.mapSettings.quickSearch.on("keyup", function(event) {rsb.mapSettings.search(event);rsb.stopPropagation(event)}).on("keydown", function(event) {if (event.keyCode == 27) {rsb.mapSettings.quickSearch.val("");rsb.mapSettings.search(event)}
rsb.stopPropagation(event)});rsb.mapSettings.unFilter = function(event) {rsb.mapSettings.mappedBtn.removeClass('active');rsb.mapSettings.unmappedBtn.removeClass('active');rsb.mapSettings.mapBody.find("tr.unfiltered").removeClass('unfiltered')}
rsb.mapSettings.filter = function(btn, mapped) {var unfiltered = rsb.mapSettings.mapBody.find("tr.unfiltered");if (btn.hasClass('active')) {btn.removeClass('active')} else {btn.addClass('active');(mapped ? rsb.mapSettings.unmappedBtn : rsb.mapSettings.mappedBtn).removeClass('active');if (unfiltered && unfiltered.length > 0) {rsb.mapSettings.mapBody.find("tr.map").each(function(index, tr) {tr = $(tr);if (!tr.hasClass('unfiltered')) {tr.addClass('unfiltered')}})} else {rsb.mapSettings.mapBody.find("tr.map").each(function(index, tr) {tr = $(tr);var destValue = rsb.trimStr(tr.find('td:eq(2) button.dropdown-toggle').text());if ((destValue != "Select...")  != mapped) {tr.addClass('unfiltered')}})}}
unfiltered.removeClass('unfiltered')}
rsb.mapSettings.fieldChange = function(a, dest) {rsb.mapSettings.fieldsChanged = rsb.mapSettings.mappingChanged = true;var td = a.parents('td:first');td.removeClass('unselected');var button = td.find('button.dropdown-toggle');var preText = rsb.trimStr(button.text());var newText = rsb.trimStr(a.parent().text());button.html(rsb.htmlEncode(newText) + ' <span class="caret">');if (dest) {rsb.mapSettings.form.find("ul.dest li#" + rsb.mapSettings.geneId(newText)).addClass("hidden");if (preText && preText != "Select...") {rsb.mapSettings.form.find("ul.dest li#" + rsb.mapSettings.geneId(preText)).removeClass("hidden")} else {rsb.mapSettings.refreshAddMap(rsb.mapSettings.mapTable.find("#addBtn"));if (rsb.mapSettings.unmappedBtn.hasClass('active')) {td.parent().addClass('unfiltered')}}} else if (preText == "* Formula") {td.siblings("td:eq(1)").find("div.map-formula").addClass('hidden')}
var searchText = rsb.trimStr(rsb.mapSettings.quickSearch.val());if (searchText && searchText.length > 0) {rsb.mapSettings.matchRow(td.parent(), searchText, searchText.length)}}
rsb.mapSettings.fieldDisSelect = function(i, dest) {rsb.mapSettings.fieldsChanged = rsb.mapSettings.mappingChanged = true;var td = i.parents('td:first');td.addClass('unselected');var preText = rsb.trimStr(td.find('button.dropdown-toggle').text());var text = dest ? "Select..." : "* Formula";if (preText && preText != text) {if (dest) {rsb.mapSettings.form.find("ul.dest li#" + rsb.mapSettings.geneId(preText)).removeClass("hidden");rsb.mapSettings.mapTable.find("#addBtn").prop("disabled", false);if (rsb.mapSettings.mappedBtn.hasClass('active')) {td.parent().addClass('unfiltered')}
rsb.mapSettings.status.addClass('hidden')} else {td.siblings("td:eq(1)").find("div.map-formula").removeClass('hidden')}
i.parent().parent().siblings('div.map-select').find("button").html(text + ' <span class="caret">');var searchText = rsb.trimStr(rsb.mapSettings.quickSearch.val());if (searchText && searchText.length > 0) {rsb.mapSettings.matchRow(td.parent(), searchText, searchText.length)}}}
rsb.mapSettings.removeMap = function(btn) {rsb.mapSettings.fieldsChanged = rsb.mapSettings.mappingChanged = true;var tr = btn.parents('tr:first');rsb.mapSettings.fieldDisSelect(tr.find("td:eq(2) .map-reset a i"), true);tr.remove()}
rsb.mapSettings.addMap = function(btn) {rsb.mapSettings.fieldsChanged = rsb.mapSettings.mappingChanged = true;rsb.mapSettings.refreshAddMap(btn, function(newMap) {newMap.clone().removeClass('hidden').addClass("map").insertBefore(newMap).hover(rsb.mapSettings.rowHover, rsb.mapSettings.rowUnHover).attr("id", "")})};rsb.mapSettings.refreshAddMap = function(btn, callback) {var newMap = rsb.mapSettings.mapTable.find("#newMap");if (newMap && newMap.find("ul.dest li:not(.hidden)").length > 0) {if (callback) {callback(newMap)}} else {btn.prop("disabled", true);rsb.mapSettings.status.removeClass('hidden').html('All fields have been mapped.')}}
rsb.mapSettings.templateChanged = function(source, destination, direction) {if (source && source.length > 0 && destination && destination.length > 0) {rsb.mapSettings.templatePanel.removeClass('template-unmaped').addClass('template-mapped');rsb.mapSettings.mapInfo[direction].schemas = null;if (!rsb.mapSettings.mapInfo["Receive"].schemas) {rsb.mapSettings.getSchema(source, 'Receive', "false", function(result) {rsb.mapSettings.mapInfo["Receive"].schemas = result[0];if (!rsb.mapSettings.mapInfo["Send"].schemas) {rsb.mapSettings.getSchema(destination, 'Send', "true", function(result2) {rsb.mapSettings.mapInfo["Send"].schemas = result2[0];rsb.mapSettings.renewMaps()})} else {rsb.mapSettings.renewMaps()}})} else if (!rsb.mapSettings.mapInfo["Send"].schemas) {rsb.mapSettings.getSchema(destination, 'Send', "true", function(result) {rsb.mapSettings.mapInfo["Send"].schemas = result[0];rsb.mapSettings.renewMaps()})}}}
rsb.mapSettings.getSchema = function(schema, direction, returnCountent, callback) {$.ajax({dataType: "json",type: "POST",url: "src/mapGetSchema.rsb",data: { "@json": true, "WorkspaceId": rsb.connect.options.workspaceid, "ConnectorId": rsb.mapSettings.options.portId, "Schema": schema, "Direction": direction, "ReturnContent": returnCountent },success: function(data, textStatus, jqXHR) {var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.mapSettings.resultContainer, errorMsg, false)} else {callback(result)}}})}
rsb.mapSettings.geneId = function(text) {return text.replace(/[^\w\d]/g, '_')}
rsb.mapSettings.geneKey = function(text) {return text.replace(/[<|>|&|"|'|\\|\s|\.|(|)|:|\/|"|'|\[|\]|`]/g, '')}
rsb.mapSettings.renewMaps = function(entries) {rsb.mapSettings.mapBody.find('[data-bs-toggle="popover"]').popover('dispose');rsb.mapSettings.mapBody.empty();var source = rsb.mapSettings.mapInfo["Receive"].schemas;var destination = rsb.mapSettings.mapInfo["Send"].schemas;rsb.mapSettings.SrcSchemaName.text(source.schemaname);rsb.mapSettings.DestSchemaName.text(destination.schemaname);if ((source.issimple || "true").toLowerCase() == "false" || (destination.issimple || "true").toLowerCase() == "false") {rsb.mapSettings.mapControlGroup.removeClass('hidden');rsb.mapSettings.designBtn.prop("disabled", true).removeClass('btn-primary').addClass('btn-outline-secondary');rsb.mapSettings.codeBtn.prop("disabled", true).removeClass('btn-outline-secondary').addClass('btn-primary');rsb.mapSettings.mappanel.addClass('hidden');rsb.mapSettings.mapwell.addClass('hidden');rsb.mapSettings.status.addClass('hidden');rsb.mapSettings.mapwell.find('.CodeMirror').addClass('hidden');rsb.mapSettings.mappingChanged = true;rsb.mapSettings.code(false);rsb.showResult(rsb.mapSettings.resultContainer, 'Multi-level XML files are not supported in the CSV Map connector. Please use the XML Map connector for multi-level XML files.', "warning");return false}
rsb.mapSettings.codeBtn.prop("disabled", false).removeClass('btn-outline-secondary').addClass('btn-primary');rsb.mapSettings.mapwell.find('.CodeMirror').removeClass('hidden');var html = "";var destList = "";var destMap = {};var defMap = {};var mappedBtn = new Array();if (destination.fields) {if (typeof(destination.fields) == "string") {destination.fields = [destination.fields]}
rsb.forEach(destination.fields, function(field, index) {destMap[rsb.mapSettings.geneKey(field)] = field;destList += '<li id=' + rsb.mapSettings.geneId(field) + '><a class="dropdown-item" href="javascript:void(0);" onclick="rsb.mapSettings.fieldChange($(this), true);return false;">' + rsb.htmlEncode(field) + '</a></li>'})}
var formulas = (entries || {})["* Formula"];if (formulas && formulas.length > 0) {rsb.forEach(formulas, function(entry, index) {if (entry.destfield) {var id = rsb.mapSettings.geneId(entry.destfield);mappedBtn.push(id);destMap[id] = null}})}
if (source.fields) {if (typeof(source.fields) == "string") {source.fields = [source.fields]}
rsb.forEach(source.fields, function(field, index) {var key = rsb.mapSettings.geneKey(field);var destField = entries ? entries[key] : null;if (!entries && (!destField || destField.length <= 0)) {destField = destMap[key]}
if (destField && destField.length > 0) {mappedBtn.push(rsb.mapSettings.geneId(destField))} else {destField = null}
field = rsb.htmlEncode(field);html += '<tr class="map">' +'  <td>' + field + '</td>' +((source.samples[index] || "").length <= 0 ? '  <td></td>' : '  <td data-bs-toggle="popover" data-bs-placement="top" data-container="#mapTable" data-bs-trigger="manual" data-template="' + rsb.mapSettings.options.popovertemplate + '" data-bs-content="' + source.samples[index].replace(/"/g, '&quot;') + '&nbsp;">' + rsb.htmlEncode(source.samples[index]) + '</td>') +'  <td' + (rsb.htmlEncode(destField) ? '' : ' class="unselected"') + '>' +'    <i class="fa fa-arrow-right hidden-xs"></i>' +'    <div class="btn-group map-select">' +'      <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' + (rsb.htmlEncode(destField) || "Select...") + (!destination.fields || destField && destination.fields.indexOf(destField) < 0 ? rsb.mapSettings.options.destnonexistentwarning : '') + ' <span class="caret"></span></button>' +'      <ul class="dropdown-menu dest">' + destList + '</ul>' +'    </div>' +'    <span class="map-reset"><a href="javascript:void(0);"><i class="fa fa-times align-middle" onclick="rsb.mapSettings.fieldDisSelect($(this), true)"></i></a></span>' +'  </td>' +'  <td align="center" class="formula-control"></td>' +'</tr>'})}
if (formulas && formulas.length > 0) {rsb.forEach(formulas, function(entry, index) {if (entry.destfield) {html += '<tr class="map formula">' +'  <td' + (entry.issource ? '' : ' class="unselected"') + '>' + (entry.issource ? entry.srcfield : '* Formula') + '</td>' +'  <td></td>' +'  <td>' +'    <div class="row">' +'      <div class="col-md-6">' +'        <i class="fa fa-arrow-right hidden-xs"></i>' +'        <div class="btn-group map-select">' +'          <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' + rsb.htmlEncode(entry.destfield) + (!destination.fields || destination.fields.indexOf(entry.destfield) < 0 ? rsb.mapSettings.options.destnonexistentwarning : '') + ' <span class="caret"></span></button>' +'          <ul class="dropdown-menu dest">' + destList + '</ul>' +'        </div>' +'        <span class="map-reset"><a href="javascript:void(0);"><i class="fa fa-times align-middle" onclick="rsb.mapSettings.fieldDisSelect($(this), true)"></i></a></span>' +'      </div>' +'      <div class="col-md-6 map-formula"' + (entry.issource ? 'hidden' : '') + '>' +'        <input type="text" class="form-control rsb-form-nosubmit"' + (entry.issource ? '' : 'value="' + entry.srcfield.replace(/"/g, '&quot;') + '"') + '>' +'      </div>' +'    </div>' +'  </td>' +'  <td align="center" class="formula-control">' +'    <a href="javascript:void(0);" class="btn btn-danger map-remove-btn" onclick="rsb.mapSettings.removeMap($(this));return false;"><i class="fa fa-remove"></i></a>' +'  </td>' +'</tr>'}})}
rsb.mapSettings.mapBody.append(html);rsb.mapSettings.mapBody.find('[data-bs-toggle="popover"]').popover();rsb.forEach(mappedBtn, function(dest, index) {rsb.mapSettings.form.find("ul.dest li#" + dest).addClass("hidden")});if (destination.fields && mappedBtn.length >= destination.fields.length) {rsb.mapSettings.refreshAddMap(rsb.mapSettings.mapTable.find("#addBtn"))}
rsb.mapSettings.mapControlGroup.removeClass('hidden');rsb.mapSettings.mappanel.removeClass('hidden');rsb.mapSettings.mapwell.addClass('hidden');rsb.mapSettings.status.addClass('hidden');rsb.mapSettings.designBtn.prop("disabled", false).removeClass('btn-outline-secondary').addClass('btn-primary');rsb.mapSettings.codeBtn.removeClass('btn-primary').addClass('btn-outline-secondary');rsb.mapSettings.fieldsChanged = rsb.mapSettings.mappingChanged = true;rsb.mapSettings.reset()}
rsb.mapSettings.form.on("success", function() {if (!rsb.mapSettings.sourceZone.find("input.source").val() || !rsb.mapSettings.destinationZone.find("input.destination").val() || !rsb.mapSettings.mappingChanged && rsb.mapSettings.mappingScriptEditor.historySize().undo <= 0) {rsb.mapSettings.mappingChanged = false;return}
rsb.mapSettings.saveMapping();rsb.mapSettings.isInitEmpty = false});rsb.mapSettings.saveMapping = function() {if (!rsb.mapSettings.mappanel.hasClass('hidden')) {rsb.mapSettings.generateMapping(true, false, function(result) {if (result && result.length > 0) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.mapSettings.resultContainer, errorMsg, false)} else {rsb.mapSettings.mappingChanged = false;rsb.showResult(rsb.mapSettings.resultContainer, 'The mapping was saved.', true)}} else {rsb.showResult(rsb.mapSettings.resultContainer, 'The mapping was saved.', true)}})} else if (!rsb.mapSettings.mapwell.hasClass('hidden')) {var postData = { "@json": true, "WorkspaceId": rsb.connect.options.workspaceid, "ConnectorId": rsb.mapSettings.options.portId, "Content": window.btoa(unescape(encodeURIComponent(rsb.mapSettings.mappingScriptEditor.getValue()))) };$.ajax({dataType: "json",type: "POST",url: "src/saveMapping.rsb",data: postData,traditional: true,success: function(data, textStatus, jqXHR) {var errorMsg = rsb.getResultErrorMessage(data["items"])
if (errorMsg) {rsb.showResult(rsb.mapSettings.resultContainer, errorMsg, false)} else {rsb.mapSettings.mappingChanged = false;rsb.mapSettings.mappingScriptEditor.clearHistory();rsb.showResult(rsb.mapSettings.resultContainer, 'The mapping was saved.', true)}}})} else {rsb.mapSettings.mappingChanged = false}}
rsb.mapSettings.showDesignWarningModal = function(event) {if(rsb.mapSettings.mappanel.hasClass('hidden')) {if (rsb.mapSettings.mappingScriptEditor.historySize().undo > 0) {rsb.confirmModal({title: 'Warning!',body: 'The modifications you have made may break the mappings in your design view.<br><br>Do you want to continue?',okText: 'Continue',cancelText: 'Cancel',ok: rsb.mapSettings.design})} else {rsb.mapSettings.design(event)}}}
rsb.mapSettings.design = function(event) {if (rsb.mapSettings.mappanel.hasClass('hidden')) {if (rsb.mapSettings.mappingScriptEditor.historySize().undo > 0) {rsb.mapSettings.mappingChanged = true;var postData = { "@json": true, "WorkspaceId": rsb.connect.options.workspaceid, "ConnectorId": rsb.mapSettings.options.portId, "Source": rsb.mapSettings.sourceZone.find("input.source").val(), "Destination": rsb.mapSettings.destinationZone.find("input.destination").val(), "Content": window.btoa(unescape(encodeURIComponent(rsb.mapSettings.mappingScriptEditor.getValue()))) };$.ajax({dataType: "json",type: "POST",url: "src/mapParseMapping.rsb",data: postData,traditional: true,success: function(data, textStatus, jqXHR) {var result = data["items"];if (result && result.length > 0) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.mapSettings.resultContainer, errorMsg, false)} else if ((result[0]["issimple"] || "true").toLowerCase() == "false") {rsb.showResult(rsb.mapSettings.resultContainer, 'The mapping code is too complex for parsing.', "warning");return false} else {rsb.mapSettings.mappingScriptEditor.clearHistory();var entries = { "* Formula":[] };rsb.forEach(result, function(entry, index) {if (index == 0) {rsb.mapSettings.mapInfo["Receive"].schemas = { fields: entry.srcfields, samples: entry.samples, issimple: entry.srcissimple };rsb.mapSettings.mapInfo["Send"].schemas = { fields: entry.destfields, issimple: entry.destissimple }} else {if (entry.type.toLowerCase() == "source") {entries[rsb.mapSettings.geneKey(entry.srcfield)] = entry.destfield} else if (entry.type.toLowerCase() == "formula") {entry.issource = (entry.issource.toLowerCase() == 'true');rsb.addValueToMap(entries, "* Formula", entry)}}});rsb.mapSettings.renewMaps(entries);rsb.mapSettings.switchToDesign()}} else {rsb.mapSettings.mappingScriptEditor.clearHistory();rsb.mapSettings.switchToDesign()}}})} else {rsb.mapSettings.switchToDesign()}}}
rsb.mapSettings.code = function(simple) {if (rsb.mapSettings.mapwell.hasClass('hidden')) {if (rsb.mapSettings.fieldsChanged) {if (simple) {rsb.mapSettings.generateMapping(false, true, function(result) {var code = "";if (result && result.length > 0) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.mapSettings.resultContainer, errorMsg, false);return false} else {code = result[0]["content"]}}
rsb.mapSettings.mappingScriptEditor.setValue(code);rsb.mapSettings.mappingScriptEditor.clearHistory();rsb.mapSettings.switchToCode(code, true)})} else {var destination = rsb.mapSettings.mapInfo["Send"].schemas;if (destination && destination.content) {rsb.mapSettings.switchToCode(destination.content, false)} else {rsb.mapSettings.getSchema(destination, 'Send', "true", function(result) {rsb.mapSettings.switchToCode(result[0]["content"], false)})}}} else {rsb.mapSettings.switchToCode()}}}
rsb.mapSettings.switchToDesign = function() {rsb.mapSettings.mappanel.removeClass('hidden');rsb.mapSettings.mapwell.addClass('hidden');rsb.mapSettings.designBtn.removeClass('btn-outline-secondary').addClass('btn-primary');rsb.mapSettings.codeBtn.removeClass('btn-primary').addClass('btn-outline-secondary');rsb.mapSettings.fieldsChanged = false}
rsb.mapSettings.switchToCode = function(code, simple) {if (!rsb.mapSettings.mappanel.hasClass('hidden')) {rsb.mapSettings.mapwell.find('.CodeMirror').css('height', Math.min(600, Math.max($(document).height() / 3, rsb.mapSettings.mappanel.outerHeight() - 67)) + 'px')}
if (code) {if (code.length > 0) {code = window.atob(code);try { code = decodeURIComponent(escape(code)); } catch (err) {}}
if (!simple) {code = rsb.mapSettings.options.comment + code}
rsb.mapSettings.mappingScriptEditor.setValue(code);rsb.mapSettings.mappingScriptEditor.clearHistory()}
rsb.mapSettings.mapwell.removeClass('hidden');rsb.mapSettings.mappanel.addClass('hidden');rsb.mapSettings.designBtn.removeClass('btn-primary').addClass('btn-outline-secondary');rsb.mapSettings.codeBtn.removeClass('btn-outline-secondary').addClass('btn-primary');rsb.mapSettings.mappingScriptEditor.refresh();rsb.mapSettings.fieldsChanged = false}
rsb.mapSettings.generateMapping = function(save, returnContent, callback) {var postData = { "@json": true, "WorkspaceId": rsb.connect.options.workspaceid, "ConnectorId": rsb.mapSettings.options.portId, "Source": rsb.mapSettings.sourceZone.find("input.source").val(), "Destination": rsb.mapSettings.destinationZone.find("input.destination").val(), "Save": save, "ReturnContent": returnContent };rsb.mapSettings.mapTable.find("tr.map").each(function(index, tr) {tr = $(tr);var destValue = rsb.trimStr(tr.find('td:eq(2) button.dropdown-toggle').text());if (destValue != "Select...") {var srcValue = rsb.trimStr(tr.find(tr.hasClass('formula') ? 'td:eq(0) button.dropdown-toggle' : 'td:eq(0)').text());if (srcValue != "* Formula") {rsb.addValueToMap(postData, "SrcField", srcValue);rsb.addValueToMap(postData, "DestField", destValue);rsb.addValueToMap(postData, "Type", "Source")} else {rsb.addValueToMap(postData, "SrcField", rsb.trimStr(tr.find('td:eq(2) .map-formula input').val()));rsb.addValueToMap(postData, "DestField", destValue);rsb.addValueToMap(postData, "Type", "Formula")}}});$.ajax({dataType: "json",type: "POST",url: "src/generateMapping.rsb",data: postData,traditional: true,success: function(data, textStatus, jqXHR) {callback(data["items"])}})}
