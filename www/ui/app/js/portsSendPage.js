rsb.portsSend = rsb.portsSend || {};rsb.portsSend.options = {};rsb.portsSend.init = function($options) {rsb.portsSend.options = $.extend($options, rsb.connect.options);rsb.portsSend.uploadFileModal = new rsb.uploadFileModal({workspaceId: rsb.portsSend.options.workspaceid,connectorId: rsb.portsSend.options.portId,accept: rsb.portsSend.options.accept,callback: function() {$('#sendTable').DataTable().ajax.reload()}});rsb.portsSend.uploadMappingTestFileModal = new rsb.uploadFileModal({workspaceId: rsb.portsSend.options.workspaceid,connectorId: rsb.portsSend.options.portId,header: 'Upload Mapping Test File',info: 'Select file to upload for generating the sample to be used by the Map or XMLMap connectors.',label: 'Upload file',action: rsb.connect.pathCombine(rsb.connect.options.srcDir, "uploadMappingTestFile.rsb"),multifiles: false,callback: function(result, args) {result && result.template && rsb.showResult($('#sendError'), rsb.evalTemplate('Sample file uploaded.  Any connected XML Map Connectors can use this as a Source or Destination file by selecting "$template$".', {"template": result.template}), true)}})}
rsb.portsSend.outToggleSelected = function(event) {event && rsb.toggleSelected(event);var unsentFiles = $('#sendTable').find("tbody tr.unsent-file").not(".sending").has("input[type='checkbox']:checked");var transactionLogs = $('#sendTable').find("tbody tr:not(.unsent-file)").has("input[type='checkbox']:checked");if (!rsb.portsSend.options.readonly && (transactionLogs.length > 0 || unsentFiles.length > 0)) {$("#btn-out-delete").prop("disabled", false)} else if (unsentFiles.length == 0) {$("#btn-out-delete").prop("disabled", true)}
if (unsentFiles.length > 0) {$("#btn-out-send").prop("disabled", false)} else {$("#btn-out-send").prop("disabled", true)}
if (transactionLogs.length > 0) {$("#sendRequeueButton").removeClass("disabled")} else {$("#sendRequeueButton").addClass("disabled")}
$("#btn-input-refresh").prop("disabled", false);$("#btn-input-refresh i").removeClass("fa-spin")}
rsb.portsSend.getReceipt = function(portId, table) {$('#sendError').hide();var postData = { "@json": true, "portid": portId };$.ajax({dataType: "json",url: "src/getReceipt.rsb",type: "POST",data: postData,success: function(data, textStatus, jqXHR) {var result = data["items"];if (result && result.length > 0) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult($('#sendError'), errorMsg, false)}
var count = result[0]["count"];if (count && parseInt(count) > 0) {$(table).DataTable().ajax.reload()}}}})}
rsb.portsSend.requeue = function() {var selectedMessages = $('#sendTable').find("tbody tr:not(.unsent-file)").has("input[type='checkbox']:checked");var index = 0;selectedMessages.each(function() {var postData = { "@json": true,"workspaceid": rsb.portsSend.options.workspaceid,"connectorid": rsb.portsSend.options.portId,"messageid": $(this).find("input[name='messageid']").val(),"direction": "Send",};$.ajax({url: "src/requeueMessage.rsb",type: "POST",dataType: "json",data: postData,success: function(data, textStatus, jqXHR) {var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult($("#sendError"), errorMsg, "error")} else {index++;if (index >= selectedMessages.length) {$("#sendTable").DataTable().ajax.reload()}}}})})}
$(document).ready(function() {var locked = false;var filter = "direction eq Send and workspace eq " + rsb.odataEscape(rsb.portsSend.options.workspaceid) + " and portid eq " + rsb.odataEscape(rsb.portsSend.options.portId) + " and batchgroupid eq ''";$("#btn-input-refresh").click(function(){if (!locked) {$('#sendTable').DataTable().ajax.reload()}});var options = {searching: false,sDom: "<'row'<'col-md-3'f>r>t<'row'<'col-md-3'i><'col-md-2 table-filter'><'col-md-2 nowrap'l><'col-md-5'p>>",autoWidth: false,lengthMenu: [10, 20, 50, 100, 200, 500],pageLength: rsb.pageRecordsCount.get(),language: {url : 'ui/datatables/lang/'+ 'english.js'},rowCallback: function (row, data) {if (data["status"] == "Error" || data["status"] == "Send Error" || data["status"] == "MDN Error") {$(row).children(".status").addClass("text-danger");$(row).addClass("send-error");if (data["etag"].length > 0 && $("#portRestart").val() == "true") {$(row).children(".status").text(data["status"] + " [R]")}} else if (data["status"] == "Success" || data["status"] == "Sent") {$(row).children(".status").addClass("text-success");$(row).addClass("send-success")} else if (data["status"] == "Pending" || data["status"] == "Warning" || data["status"] == "Pending MDN" || data["status"] == "Pending Receipt" || data["status"] == "Pending ACK" || data["status"] == "Pending Pull" || data["status"] == "MDN Warning" || data["status"] == "Send Warning" || data["status"] == "Processing Response" || data["status"] == "Send Skipped") {$(row).children(".status").addClass("text-warning");$(row).addClass("send-warning")} else if (data["status"] == "Sending") {$(row).addClass("sending");$(row).children(".status").text(data["status"])}
var idx = -1;var type = 0;if (typeof(data["failedcount"]) != 'undefined' && parseInt(data["failedcount"]) > 0 && data["status"] == "Unsent") {$(row).children(".status").text(data["status"] + " (Attempts: " + data["failedcount"] + ")")}
if (data["messageid"] != null) {var logInfo = '<input type="hidden" name="messageid" value="' + data["messageid"] + '"><input type="hidden" name="direction" value="Send"><input type="hidden" name="filename" value="' + data["filename"] + '"><input type="hidden" name="filepath" value="' + data["filepath"] + '"><input type="hidden" name="subfolder" value="' + (data["subfolder"]||"") + '"><input type="hidden" name="etag" value="' + data["etag"] + '"><input type="hidden" name="formatresult" value="' + (rsb.portsSend.options.portType.toLowerCase() === "as2") + '">';if (data["status"] != "Unsent" && data["status"] != "Sending") {$(row).children("td:eq(1)").html('<i class="fa fa-plus-circle"></i>' + logInfo).click({ "data": rsb.decodeRowData(data), "resultContainer": "#sendError" }, rsb.connect.showDetails)} else {$(row).children("td:eq(1)").html(logInfo)}
if (rsb.getValueAsBool(data.isbatchgroup, false)) {$(row).children("td:eq(4)").html('<i class="fa fa-envelope-o"></i>').click(rsb.decodeRowData(data), rsb.connect.showMessageInfo)} else {$(row).children("td:eq(4)").html("")}
$(row).children("td:eq(5)").html('<a href="javascript:void(0);">' + data["filename"] + '</a>').click(rsb.decodeRowData(data), rsb.connect.showMessageInfo)}
$(row).children("td:first").html('<input type="checkbox" class="form-check-input pointercursor">').click(rsb.portsSend.outToggleSelected)},order: [[ 2, 'desc' ]],columns: [{orderable: false,width: "5px",data: null,className: "details-control center"},{orderable: false,width: "5px",data: "messageid",className: "details-control"},{data: "timestamp",render: rsb.formatTimestamp,width: "120px",className: "hidden-xs"},{data: "status",width: "120px",className: "status"},{data: "workspace",visible: false},{data: "connectorid",visible: false},{data: "direction",visible: false},{orderable: false,width: "5px",data: null,className: "details-control hidden-xxs"},{data: "filename",width: "100%"},{data: "filepath",visible: false},{data: "filesize",render: rsb.connect.formatFileSize,width: "100px",className: "hidden-xs"},{data: "etag",defaultContent: "",visible: false},{data: "batchgroupid",defaultContent: "<i>(null)</i>",visible: false},{data: "isbatchgroup",defaultContent: "false",visible: false}
],preAjax: function(opt, request) {locked = true;$("#btn-input-refresh").prop("disabled", true);$("#btn-input-refresh i").addClass("fa-spin");opt["requestData"] = { "$filter": filter };var status = $("#sendTableContainer div.table-filter select").val();if (status && status != "All") {if (status == "Success") {opt["requestData"]["$filter"] += " and (status eq 'Success' or status eq 'Sent')"} else if (status == "Error") {opt["requestData"]["$filter"] += " and (status eq 'Error' or status eq 'Send Error')"} else if (status == "Warning") {opt["requestData"]["$filter"] += " and (status eq 'Warning' or status eq 'Send Warning')"} else if (status == "Pending") {opt["requestData"]["$filter"] += " and (startswith(status, 'Pending'))"} else if (status == "Skippped") {opt["requestData"]["$filter"] += " and (status eq 'Skippped')"} else if (status == "Unsent") {opt["requestData"]["$filter"] += " and (status eq 'Unsent')"}}
if (status == undefined || status == "All" || status == "Unsent") {var param =
{ "@json": true,"workspaceid": rsb.portsSend.options.workspaceid,"portid": rsb.portsSend.options.portId,"folder": "Send","returnstatus": "True","$count": -1,};if (typeof(request.length) != 'undefined') {param["$top"] = request.length}
if (typeof(request.start) != 'undefined') {param["$skip"] = request.start}
if (request.order[0].column == 6) {param["$orderby"] = "Filename " + request.order[0].dir} else if (request.order[0].column == 8) {param["$orderby"] = "FileSize " + request.order[0].dir} else {param["$orderby"] = "TimeCreated " + request.order[0].dir + ", Filename"}
opt["suspending"] = true;var requrl = "api/files.rsd?" + rsb.securityRand();$.ajax({dataType: "json",url: requrl,type: "GET",timeout : 120000,data: param,success: function(data, textStatus, jqXHR) {var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult($("#sendError"), errorMsg, false)} else {for (var i in result) {if (typeof(result[i]["connectorid"]) != 'undefined') {result[i]["workspace"] = result[i]["workspaceid"];result[i]["DT_RowClass"] = "unsent-file";if (result[i]["subfolder"]) {result[i]["filename"] = result[i]["subfolder"] + result[i]["filename"]} else {result[i]["subfolder"] = ""}
result[i]["timestamp"] = result[i]["timecreated"];delete result[i]["timecreated"];result[i]["direction"] = result[i]["folder"];result[i]["etag"] = "";result[i]["source"] = "MessageMgr"}}
opt["additionData"] = result}},complete: function(x, s) {opt["suspending"] = false;if (s == 'timeout') {rsb.showResult($("#sendError"), 'GetFiles Timeout.', false)}}})} else {delete opt["additionData"]}},drawCallback: function(settings) {$("#sendToggleAll").prop("checked", false)},afterAjax: function(settings) {rsb.portsSend.outToggleSelected();locked = false},initComplete: function() {$("#sendTable #sendToggleAll").change(rsb.portsSend.outToggleSelected);$("#sendTableContainer div.table-filter").html(rsb.portsSend.options.filterHtml)}};rsb.initTable($("#sendTable"), "api/transactions.rsd", $("#sendError"), options);$("#portsInputTab").on('shown.bs.tab', function (e) {if (!locked) {$('#sendTable').DataTable().ajax.reload()}});$("#sendError").dblclick(function() {$("#sendError").toggleClass("ellipsis")})});