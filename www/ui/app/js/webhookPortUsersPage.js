rsb = rsb || {};rsb.webhook = rsb.webhook || {};rsb.webhook.users = rsb.webhook.users || {};rsb.webhook.users.options = {};rsb.webhook.users.userTableResultContainer = $("#webhookportuserspage_userTableResultContainer");rsb.webhook.users.defaultMaxRequest = 0;rsb.webhook.users.defaultMaxRequestStr = 0;rsb.webhook.users.defaultMaxConcurrent = 0;rsb.webhook.users.defaultMaxConcurrentStr = 0;rsb.webhook.users.init = function($options) {rsb.webhook.users.options = $.extend($options, rsb.connect.options);rsb.webhook.users.defaultMaxRequest = rsb.webhook.users.options.defaultMaxRequest;rsb.webhook.users.defaultMaxRequestStr = 'Default'+" (" + rsb.webhook.users.defaultMaxRequest + ")";rsb.webhook.users.defaultMaxConcurrent = rsb.webhook.users.options.defaultMaxConcurrent;rsb.webhook.users.defaultMaxConcurrentStr = 'Default'+ " (" + rsb.webhook.users.defaultMaxConcurrent + ")"}
rsb.webhook.users.onUsersSelected = function(event) {var selectedCount = $("#webhookportuserspage_users_table .piportuserspage-user-checkbox:checked").length;var elem = $(this);if($(event.target).is("input.piportuserspage-user-checkbox")) {$("#webhookportuserspage_user_toggle_all").prop("checked", false);if (elem.hasClass("user-selected-row")) {elem.removeClass("user-selected-row");elem.find("input[type=checkbox]").prop("checked", false)} else {elem.addClass("user-selected-row");elem.find("input[type=checkbox]").prop("checked", "checked")}} else {$("#webhookportuserspage_users_table").find("input[type='checkbox']").prop("checked", false);$("#webhookportuserspage_users_tbody tr.user-selected-row").each(function(){$(this).removeClass("user-selected-row")});elem.addClass("user-selected-row");elem.find("input[type=checkbox]").prop("checked", "checked");selectedCount = 1}
if(selectedCount == $("#webhookportuserspage_users_tbody tr").length) {$("#webhookportuserspage_user_toggle_all").prop("checked", "checked")}
if(selectedCount == 0) {$("#webhookportuserspage_edit_btn").addClass("disabled");$("#webhookportuserspage_delete_btn").addClass("disabled")} else if(selectedCount == 1) {$("#webhookportuserspage_edit_btn").removeClass("disabled");$("#webhookportuserspage_delete_btn").removeClass("disabled")} else {$("#webhookportuserspage_edit_btn").addClass("disabled");$("#webhookportuserspage_delete_btn").removeClass("disabled")}}
rsb.webhook.users.syncResourceLastModified = function () {rsb.setResourceLastModified(rsb.webhook.users.options.workspaceid.toLowerCase() + ":" + rsb.webhook.users.options.portId.toLowerCase(), new Date().toUTCString())}
rsb.webhook.users.add_user = function() {var form = rsb.webhookPort.addUserModal.form;form.find("#webhook_addusermodal_active").val(form.find("#webhook_addusermodal_is_active").prop('checked') ? "True" : "False");form.find("input\[name=Authtoken\]").val(rsb.webhook.users.trimUsername(form.find("#webhook_addusermodal_authtoken").val()));form.one("success", function (e, result) {$("#webhookportuserspage_users_table").DataTable().ajax.reload();rsb.webhookPort.addUserModal.modal('hide');rsb.webhook.users.syncResourceLastModified()});form.submit()}
rsb.webhook.users.edit_user = function() {var form = rsb.webhookPort.editUserModal.form;form.find("#webhook_editusermodal_active").val(form.find("#webhook_editusermodal_is_active").prop('checked') ? "True" : "False");form.find("input\[name=Authtoken\]").val(rsb.webhook.users.trimUsername(form.find("#webhook_editusermodal_authtoken").val()));form.one("success", function (e, result) {$("#webhookportuserspage_users_table").DataTable().ajax.reload();rsb.webhookPort.editUserModal.modal('hide');rsb.webhook.users.syncResourceLastModified()});form.submit();$("#webhookportuserspage_edit_btn").addClass("disabled");$("#webhookportuserspage_delete_btn").addClass("disabled")}
rsb.webhook.users.delete_user = function() {var users = null;$("#webhookportuserspage_users_tbody tr.user-selected-row").each(function(){var tmp = $(this).find("td:eq(1)").text();if(users == null) {users = tmp} else {users += ", " + tmp}});if (confirm(rsb.evalTemplate('Are you sure you want to delete the following user? $user$', {"user": "\r\n" + users}))) {$.ajax({dataType: "json",type: "DELETE",url: "src/connectorUsers.rsd?@json",data: { "user": users, "ConnectorId" : rsb.webhook.users.options.portId, "WorkspaceId": rsb.webhook.users.options.workspaceid, "connectortype": "webhook" },traditional: true,success: function (data, textStatus, jqXHR) {var errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult(rsb.webhook.users.userTableResultContainer, "Error deleting user" + ": " + errorMsg, false)} else {$("#webhookportuserspage_users_table").DataTable().ajax.reload();$("#webhookportuserspage_edit_btn").addClass("disabled");$("#webhookportuserspage_delete_btn").addClass("disabled");rsb.webhook.users.syncResourceLastModified()}}})}}
rsb.webhook.users.load_AddUserModal = function() {rsb.webhookPort.addUserModal.modal("show")}
rsb.webhook.users.load_EditUserModal = function() {var selectedRow = $("#webhookportuserspage_users_tbody tr.user-selected-row");if (!selectedRow[0]) {rsb.showResult(rsb.webhook.users.userTableResultContainer, "You must select a user to edit.", false)} else {var userName = selectedRow.find("td:eq(1)").text();rsb.webhookPort.editUserModal.find("#webhook_editusermodal_user, #webhook_editusermodal_new_user").val(userName.substring(userName.indexOf("\\") + 1));var privileges = selectedRow.find("td:eq(2)").text();rsb.webhookPort.editUserModal.find("#webhook_editusermodal_privileges_container input").each(function() {if (privileges.indexOf($(this).val()) >= 0) {$(this).prop("checked", "checked")}});var maxrequest = selectedRow.find("td:eq(3)").text();var maxconcurrent = selectedRow.find("td:eq(4)").text();if(maxrequest != rsb.webhook.users.defaultMaxRequest) {rsb.webhookPort.editUserModal.find("#webhook_editusermodal_max_request").val(maxrequest)} else {rsb.webhookPort.editUserModal.find("#webhook_editusermodal_max_request").val("")}
if(maxconcurrent != rsb.webhook.users.defaultMaxConcurrent) {rsb.webhookPort.editUserModal.find("#webhook_editusermodal_max_concurrent").val(maxconcurrent)} else {rsb.webhookPort.editUserModal.find("#webhook_editusermodal_max_concurrent").val("")}
if(selectedRow.find("td:eq(5)").text() == "True") {rsb.webhookPort.editUserModal.find("#webhook_editusermodal_is_active").prop("checked", "checked");rsb.webhookPort.editUserModal.find("#webhook_editusermodal_active").val("True")}
rsb.webhookPort.editUserModal.modal('show')}}
rsb.webhook.users.inToggleALLSelected = function(event) {rsb.toggleSelected(event);var selectedCount = $("#webhookportuserspage_users_table .piportuserspage-user-checkbox:checked").length;if (selectedCount > 0) {$("#webhookportuserspage_users_tbody .piportuserspage-user-checkbox:checked").each(function(){$(this).parent().parent().addClass("user-selected-row")});if(selectedCount == 1) {$("#webhookportuserspage_edit_btn").removeClass("disabled")} else {$("#webhookportuserspage_edit_btn").addClass("disabled")}
$("#webhookportuserspage_delete_btn").removeClass("disabled")} else {$("#webhookportuserspage_users_tbody tr.user-selected-row").each(function(){$(this).removeClass("user-selected-row")});$("#webhookportuserspage_edit_btn").addClass("disabled");$("#webhookportuserspage_delete_btn").addClass("disabled")}};rsb.webhook.users.trimUsername = function(authtoken) {if (authtoken && authtoken.lastIndexOf(":") >= 0) {return authtoken.substring(authtoken.lastIndexOf(":") + 1)} else {return authtoken}};rsb.webhook.users.getUsername = function(form) {var newname = form.find("input\[name=NewUser\]").val();if (newname && newname.length > 0) {return newname}
var name = form.find("input\[name=User\]").val();if (name && name.length > 0) {return name}};rsb.webhook.users.updateAuthtoken = function(form, tokenEle) {var authtoken = rsb.webhook.users.trimUsername(tokenEle.val());var name = rsb.webhook.users.getUsername(form);if (name && name.length > 0) {tokenEle.val(name + ":" + authtoken)}};rsb.webhook.users.showTokenTip = function(form) {var resultContainer = rsb.getFormResultContainer(form);rsb.showResult(resultContainer, 'For security purposes, this is the last time the authtoken will be shown. Please copy this authtoken to a safe place before saving this new user. If the authtoken is lost, a new one can be created for this user at any time.', "warning", true, false, 60 * 1000)};$(document).ready( function () {var updateLastModified = rsb.webhook.users.syncResourceLastModified
var options = {serverSide: true,searching: false,autoWidth: false,sDom: "<'row'<'col-md-4 webhookportuserspage-edit-bar'><'col-md-3 webhookportuserspage-search-bar pull-right'>r>t<'row'<'col-md-4'i><'col-md-3'l><'col-md-5 pull-right'p>>",lengthMenu: [10, 20, 50],pageLength: rsb.pageRecordsCount.get(),language: {url : 'ui/datatables/lang/'+ 'english.js'},rowCallback: function (row, data) {$(row).click(rsb.webhook.users.onUsersSelected);$(row).children("td:eq(0)").html('<input type="checkbox" class="form-check-input pointercursor piportuserspage-user-checkbox">');var maxrequest = data["maxrequest"];var maxconcurrent = data["maxconcurrent"];$(row).children("td:eq(3)").text(maxrequest > 0 ? maxrequest : rsb.webhook.users.defaultMaxRequest);$(row).children("td:eq(4)").text(maxconcurrent > 0 ? maxconcurrent : rsb.webhook.users.defaultMaxConcurrent)},ordering: false,columns: [{width: "5px",data: null,className: "details-control center"},{data: "username",class: "dt-webhook-head"},{data: "privileges",class: "dt-webhook-head"},{data: "maxrequest",width: "150px",class: "hidden-sm hidden-xs hidden-md dt-webhook-head text-nowrap",defaultContent: ""},{data: "maxconcurrent",width: "160px",class: "hidden-sm hidden-xs hidden-md dt-webhook-head text-nowrap",defaultContent: ""},{data: "active",width: "40px",class: "hidden-xs dt-webhook-head"}
],preAjax: function(opt)  {var filter = "";if ($('.webhookportuserspage-search-bar input').length > 0 && $('.webhookportuserspage-search-bar input').val().length > 0) {filter = "substringof(" + rsb.odataEscape($('.webhookportuserspage-search-bar input').val()) + ", username) eq True"}
opt["requestData"] = { "$filter": filter, "ConnectorId": rsb.webhook.users.options.portId, "WorkspaceId": rsb.webhook.users.options.workspaceid, "connectortype": "webhook"  }},afterAjax: function () {updateLastModified();updateLastModified = () => void 0},"initComplete": function() {var readonly = !rsb.connectorList[rsb.webhook.users.options.workspaceid.toLowerCase()].connectors[rsb.webhook.users.options.portId.toLowerCase()].allowedPrivileges.includes("updatesettings");if (!readonly) {$(".webhookportuserspage-search-bar").html('<div class="input-group ' + rsb.webhook.users.options.connString + '"><input type="text" class="form-control" placeholder="' + 'Search for...'+ '" onkeyup="$(\'#webhookportuserspage_users_table\').DataTable().ajax.reload()"><span class="input-group-btn"><button class="btn btn-outline-secondary" type="button" onclick="$(\'#webhookportuserspage_users_table\').DataTable().ajax.reload()">&nbsp;<i class="fa fa-search fa-3"></i></button></span></div>');$(".webhookportuserspage-edit-bar").html('<div class="btn-group"><button id="add-btn" type="button" class="btn btn-primary btn-sm" onclick="rsb.webhook.users.load_AddUserModal()"><i class="icon fa fa-plus"></i> ' + 'Add'+ '</button><button id="webhookportuserspage_edit_btn" type="button" class="btn btn-outline-secondary btn-sm disabled" onclick="rsb.webhook.users.load_EditUserModal();"><i class="icon fa fa-edit"></i> ' + 'Edit'+ '</button><button id="webhookportuserspage_delete_btn" type="button" class="btn btn-outline-secondary btn-sm disabled" onclick="rsb.webhook.users.delete_user();"><i class="icon fa fa-minus"></i> ' + 'Delete'+ '</button></div><div class="form-result-static alert alert-dismissible hidden" id="webhookportuserspage_users_table_error"><button type="button" class="btn-close" onclick="$(this).parent().hide();"></button><content></content></div></div>')}}};$("#webhookportuserspage_users_table thead tr th").each(function(index) {if (index > 0) {$(this).attr("style", "padding-left: 10px; padding-right: 10px")}});rsb.initTable($("#webhookportuserspage_users_table"), "src/connectorUsers.rsd", $("#webhookportuserspage_users_table_error"), options);$("#webhookportuserspage_user_toggle_all").change(rsb.webhook.users.inToggleALLSelected);rsb.webhookPort = rsb.webhookPort || {};rsb.webhookPort.userCallbacks = {updateAuthtoken: rsb.webhook.users.updateAuthtoken,getUsername: rsb.webhook.users.getUsername,showTokenTip: rsb.webhook.users.showTokenTip,add_user: rsb.webhook.users.add_user,edit_user: rsb.webhook.users.edit_user,};rsb.connect.loadModal("webhookPortUserModals.rst", function() {if (window.self !== window.top) {rsb.webhookPort.addUserModal = window.parent.rsb.webhookPort.addUserModal;rsb.webhookPort.editUserModal = window.parent.rsb.webhookPort.editUserModal;window.parent.rsb.webhookPort.userCallbacks = rsb.webhookPort.userCallbacks}
rsb.webhookPort.addUserModal.form.connectorid.val(rsb.webhook.users.options.portId);rsb.webhookPort.addUserModal.form.workspaceid.val(rsb.webhook.users.options.workspaceid);rsb.webhookPort.editUserModal.form.connectorid.val(rsb.webhook.users.options.portId);rsb.webhookPort.editUserModal.form.workspaceid.val(rsb.webhook.users.options.workspaceid);const modals = [rsb.webhookPort.addUserModal, rsb.webhookPort.editUserModal];modals.forEach(modal => {modal.find(".default-max-request").text(rsb.webhook.users.defaultMaxRequestStr);modal.find(".default-max-concurrent").text(rsb.webhook.users.defaultMaxConcurrentStr)});rsb.webhookPort.addUserModal.on('shown.bs.modal', function (e) {rsb.webhookPort.addUserModal.form.find("button.btn-gen-token").click()})})});