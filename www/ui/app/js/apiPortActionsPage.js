rsb.action = rsb.action || {};rsb.action.options = {};rsb.action.actionTableResultContainer = $("#apiportactionspage_actionTableResultContainer");rsb.action.actionTableContainer = $("#actionTable");rsb.action.actionTable = rsb.action.actionTableContainer.find("tbody");rsb.action.actionTemplate = "";rsb.action.init = function($options) {rsb.action.options = $.extend($options, rsb.connect.options);rsb.action.actionTemplate = $(rsb.action.getTemplate())}
rsb.action.getTemplate = function() {var hover = "";if (!rsb.action.readonly) {hover = '\
    <i class="pull-right fa fa-remove hover-display" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete"></i>\
    <i class="pull-right fa fa-edit hover-display" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit"></i></td>'}
return '<tr class="hover pointercursor">\
  <td class="action-name col-5" style="word-break: break-all;"></td>\
  <td class="sp-name col-6" style="word-break: break-all;"></td>\
  <td class="template-result col-1">' + hover + '</tr>'}
rsb.action.actionTable.on("click", "tr", function(e){if ($(e.target).hasClass("fa-edit")) {rsb.action.editor.code($(this).find(".action-name").text(), {isnew: false})} else if($(e.target).hasClass("fa-remove")) {rsb.action.deleteActions($(this))} else {rsb.action.editor.edit($(this).find(".action-name").text(), {isnew: false, table: $(this).find(".sp-name").text(), connection: "Connection", description: $(this).data("description"), restrictUser: $(this).data("restrictuser"), isResource: false})}});rsb.action.reloadSP = function() {$.ajax({dataType: "json",url: 'src/SPs.rsd?@json&connectorid=' + encodeURIComponent(rsb.action.options.portId) + "&workspaceid=" + encodeURIComponent(rsb.action.options.workspaceid),cache: false,type: 'GET',success: function(data) {rsb.action.actionTable.empty();var result = data["items"];if (result && result.length > 0) {rsb.action.actionTableContainer.removeClass("hidden");if (!rsb.action.actionTableResultContainer.hasClass("alert-danger")
&& !rsb.action.actionTableResultContainer.hasClass("alert-warning")) {rsb.action.actionTableResultContainer.addClass("hidden")}
result.sort(function(lhs, rhs) { return lhs.name.localeCompare(rhs.name); });for (var i = 0; i < result.length; i++) {var elem = rsb.action.actionTemplate.clone();elem.find(".action-name").text(result[i].name);if(result[i]["rsb:emessage"]){var label = elem.find(".template-result");label.append('<span class="badge text-bg-danger" data-bs-toggle="popover" data-container="body" data-bs-trigger="hover" data-bs-placement="top" data-template=\'<div class="popover" role="tooltip" style="max-width: 400px;margin-right: 2em;"><div class="popover-content" style="max-width: 400px; word-wrap: break-word;"></div></div>\' onclick="rsb.stopPropagation(event)" data-bs-content="' + result[i]["rsb:emessage"] + '" title="">' + 'Failure!'+ '</span>')}
var spName = result[i].sp;if(spName.indexOf("].[") < 0) {if(spName.startsWith("[") && spName.endsWith("]")) {spName = spName.substring(1, spName.length -1)}}
elem.find(".sp-name").text(spName);elem.data("description", result[i].description);elem.data("restrictuser", result[i].restrictuser);elem.appendTo(rsb.action.actionTable);rsb.action.actionTable.find('[data-bs-toggle="tooltip"]').tooltip()}} else {rsb.action.actionTableContainer.addClass("hidden");rsb.action.actionTableResultContainer.find("button.btn-close").addClass("hidden");rsb.action.actionTableResultContainer.removeClass("hidden alert-success alert-danger alert-info alert-warning").addClass("fade-out");rsb.action.actionTableResultContainer.find("content").text('Actions are single operations exposed in your API which may or may not be related to resources.  Add actions by clicking on the button to the right.')}},error: function(xhr, ajaxOptions, thrownError) {rsb.showResult(rsb.action.actionTableResultContainer, 'Error retrieving table listing.  Please check your connection settings.'+ thrownError, false)}})};$(document).ready(function() {var actionEditorOption = {hasDataConnections: false,hasAddTableBtn: false,hasRestrictUsers: true,wizardTitle: 'Add Action',editorTitle: 'Edit Action',templateNameLabel: 'Action Name',retrieveTemplateInfo: 'Retrieving action',tableColumnName: 'Stored Procedure Name',defaultDescription: 'Execute',columnInfo: 'Define the input and output parameters for your action below.',columnName: 'Parameter Name',tableInfo: 'Select an action for your API from the list below.',visibleColumnColumns: ["direction", "description"],skipEditor: true,columnEditable: !rsb.action.readonly,templateNameEditable: true,useSaveGenerateButton: true,multiSchemaImport: true,showEmptyColumnsView: true,listTables: function(connectionname, args, callback) {var postData = { "@json": true, "ConnectionName" : "Connection", "ConnectorId" : rsb.action.options.portId, "WorkspaceId": rsb.action.options.workspaceid};$.ajax({dataType: "json",type: 'POST',url: 'src/listAvailableSPs.rsb',data: postData,success: function(data, textStatus, jqXHR) {var result = data["items"];if (!rsb.getResultErrorMessage(result)) {for(i in result) result[i].tablename = result[i].sp}
callback(result)}})},listColumns: function(connectionname, name, args, callback) {var postData = { "@json": true, "sp" : name, "ConnectionName" : "Connection", "ConnectorId" : rsb.action.options.portId, "WorkspaceId": rsb.action.options.workspaceid};$.ajax({dataType: "json",type: 'POST',url: 'src/listProceduresParameters.rsb',data: postData,success: function(data, textStatus, jqXHR) {var result = data["items"];if (!rsb.getResultErrorMessage(result)) {for(i in result) {result[i].columnname = result[i].parametername;if(result[i].columnname.startsWith('@')) {result[i].columnname = result[i].columnname.substring(1)}
result[i].direction = result[i].direction.toUpperCase();if(result[i].direction == "IN") result[i].direction = "INPUT";else if(result[i].direction == "OUT") result[i].direction = "OUTPUT";result[i].columnsize = "";result[i].iskey = "";result[i].isnullable = ""}}
callback(result)}})},getSchemaInfo: function(name, args, callback) {$.ajax({dataType: "json",type: 'GET',url: 'src/listSPsParameters.rsb?@json&spname=' + encodeURIComponent(name) + "&connectorid=" + encodeURIComponent(rsb.action.options.portId) + "&workspaceid=" + encodeURIComponent(rsb.action.options.workspaceid),success: function(data, textStatus, jqXHR) {var result = data["items"];if (!rsb.getResultErrorMessage(result)) {for(i in result) {result[i].columnname = result[i].name;result[i].direction = result[i].direction.toUpperCase();result[i].columnsize = "";result[i].iskey = "";result[i].isnullable = ""}}
callback(args.connection, args.table, args.description, result)}})},generate: function(connectionname, name,  desc, columns, args, callback) {var postData = {"@json": true, "spname": name, "ConnectionName": "Connection", "restrictUser": args["restrictUser"], "description": desc, "ConnectorId" : rsb.action.options.portId, "WorkspaceId": rsb.action.options.workspaceid};var colInfos = {};if(columns == null) {postData["listAllParameters"] = "true"} else {for (i in columns) {for (info in columns[i]) {var colInfo = colInfos[info] || (colInfos[info]=[]);colInfo.push(columns[i][info])}}
for (info in colInfos) {postData["params:" + info] = colInfos[info].join(",")}}
$.ajax({dataType: "json",type: 'POST',url: 'src/generateActionSchema.rsb',data: postData,success: function(data, textStatus, jqXHR) {callback(data["items"][0].schema)}})},save : function(connectionname, tablename, name, code, args, callback) {if (!args.isnew && !confirm(rsb.evalTemplate('Are you sure you want to save changes?  Changes to your API may affect user implementations.', null))) {return }
var newName = args.new_name || "";var resId = rsb.action.options.workspaceid.toLowerCase() + ":" + rsb.action.options.portId.toLowerCase();$.ajax({url: "src/saveSPsSchema.rsb?@json&@fmtoptions=exparen",type: "POST",data: {"isnew" : args.isnew, "sp": name, "newsp": newName, "data": code, "ConnectorId" : rsb.action.options.portId, "WorkspaceId": rsb.action.options.workspaceid},dataType: "json",headers: {"If-Unmodified-Since": rsb.getResourceLastModified(resId)},success: function (data, textStatus, jqXHR) {rsb.setResourceLastModified(resId, jqXHR.getResponseHeader("Last-Modified"));data = data["items"];if (data && data.length > 0 && data[0]["result"] == "false") {data[0]["rsb:emessage"] = data[0]["error"]} else {rsb.action.reloadSP()}
callback(data)}})},load : function(name, args, callback){$.post("src/readSPsSchema.rsb?@json&@fmtoptions=exparen", {"schemaName": name, "ConnectorId" : rsb.action.options.portId, "WorkspaceId": rsb.action.options.workspaceid}, function(data) {data["items"][0]["content"] = data["items"][0]["data"];callback(data["items"])})},ready: function(modal) {rsb.connect.initRestrictionFeatures((rsb.action.readonly ? "true" : "disabled"), modal)}};rsb.connect.loadModal("templateEditorModal.rst", function() {window.self !== window.top && (rsb.templateEditor = window.parent.rsb.templateEditor);rsb.action.editor = new rsb.templateEditor(actionEditorOption)});rsb.action.reloadSP()});rsb.action.deleteActions = function(row) {var spName = row.find(".action-name").text();if (confirm(rsb.evalTemplate('Are you sure you want to delete $spName$?', {"spName": spName}))) {var resId = rsb.action.options.workspaceid.toLowerCase() + ":" + rsb.action.options.portId.toLowerCase();$.ajax({dataType: "json",url: 'src/SPs.rsd?@json&connectorid=' + encodeURIComponent(rsb.action.options.portId) + "&workspaceid=" + encodeURIComponent(rsb.action.options.workspaceid),data: { sp: spName },type: 'DELETE',headers: {"If-Unmodified-Since": rsb.getResourceLastModified(resId)},success: function($result, textStatus, jqXHR) {rsb.setResourceLastModified(resId, jqXHR.getResponseHeader("Last-Modified"));rsb.action.reloadSP()},error: function(xhr, ajaxOptions, thrownError) {rsb.showResult(rsb.action.actionTableResultContainer, 'Error deleting table'+ ": " + thrownError, false)}})}}
