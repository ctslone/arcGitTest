rsb = rsb || {};rsb.otable = rsb.otable || {};rsb.otable.render = function(table, options) {if (!table) return rsb.otable._error("Table element must be set!");if (!options || !options.columns || !options.data) return rsb.otable._error("Options, Options.columns and Options.data must be set!");if (!options.columns.length) return rsb.otable._error("No data.");var columns = $.extend(true, [], options.columns);var data = $.extend(true, [], options.data);var orginal_data = data;var summary = $.extend(true, {total: false, avg: false, min: false, max: false}, options.summary);var settings = $.extend(true, {multipleSort: false}, options.settings);summary.enabled = summary.total || summary.avg || summary.min || summary.max;var getMeta = function(row, column, name, defaultValue) {if (!row || !row.__meta__ || !column || !name || !row.__meta__[column] || !row.__meta__[column][name]) return defaultValue;return row.__meta__[column][name]}
var setMeta = function(row, column, name, value) {if (!row || !column || !name) return null;row.__meta__ = row.__meta__ || {};row.__meta__[column] = row.__meta__[column] || {};row.__meta__[column][name] = value;return row}
var calcSummary = function(row, total) {metrics.forEach(function(metric) {total[metric] = total[metric] || {count: 0, total: 0, min: Number.POSITIVE_INFINITY, max: Number.NEGATIVE_INFINITY};total[metric].count++;if (row[metric] !== undefined && row[metric] != null) {total[metric].total += parseInt(row[metric]);total[metric].min = Math.min(total[metric].min, parseInt(row[metric]));total[metric].max = Math.max(total[metric].max, parseInt(row[metric]))}})}
var printSubtotal = function(sdata, totalStr, formatter) {var s = "";if (summary.total) {if (summary.avg || summary.min || summary.max) s += (totalStr || 'Subtotal') + ": ";s += rsb.otable._formatText(sdata.total, formatter) + " "}
if (summary.avg) s += (s.length ? " · " : "") + 'Avg'+ ": " + rsb.otable._formatText(Math.round(sdata.total/sdata.count), formatter);if (summary.min) s += (s.length ? " · " : "") + 'Min'+ ": " + rsb.otable._formatText(sdata.min, formatter);if (summary.max) s += (s.length ? " · " : "") + 'Max'+ ": " + rsb.otable._formatText(sdata.max, formatter);return s};var sortColumn = function() {var data = $(this).attr("o-table-data");var column = columns.find(function(c) { return c.data == data; });if (!column) return;if (settings.multipleSort) {column.sort = (column.sort + 1) % 3} else {var sort = (column.sort + 1) % 3;if (sort == 0) sort = 1;columns.forEach(function(col) {if (col.sort !== undefined && col.sort != null && col.type != 2) col.sort = 0});column.sort = sort}
rsb.otable.render(table, {columns: columns, data: orginal_data, summary: summary, settings: settings})};var sorts = [];var groups = [];var metrics = [];columns.forEach(function(col) {if (col.type == 2) col.sort = col.sort || 1;if (col.sort !== undefined && col.sort != null) sorts.push({data:col.data, sort:col.sort, type:col.type});if (col.type == 2) groups.push({data:col.data, tag:null, rows:[]});if (col.type == 0) metrics.push(col.data)});summary.enabled = metrics.length && summary.enabled;if (data.length && sorts.some(function(x) {return x.sort > 0})) {data.sort(function(a, b) {for (var i = 0; i < sorts.length; i++) {if (sorts[i].sort && a[sorts[i].data] != b[sorts[i].data]) {var val1 = a[sorts[i].data];var val2 = b[sorts[i].data];if (sorts[i].type == 0) {val1 = Number.isNaN(parseInt(val1)) ? val1 :parseInt(val1);val2 = Number.isNaN(parseInt(val2)) ? val2 :parseInt(val2)}
return ((val1 < val2) ^ (sorts[i].sort == 2)) ? -1 : 1}}
return 0})}
if (data.length && groups.length) {var tmpData = $.extend(true, [], data);data = [tmpData[0]];groups.forEach(function(g) {g.tag = tmpData[0];g.rows.push(g.tag);setMeta(tmpData[0], g.data, "rowspan", 1)});for (var r = 1; r <= tmpData.length; r++) {var row = r < tmpData.length ? tmpData[r] : null;for (var index = 0; index < groups.length; index++) {var group = groups[index];if (row == null || row[group.data] != group.tag[group.data]) {for (var i = groups.length - 1; i >= index; i--) {if (summary.enabled) {var sdata = {};groups[i].rows.forEach(function(_row) {calcSummary(_row, sdata)});groups[i].rows = [];var subtotal = $.extend(true, {}, groups[i].tag);columns.forEach(function(col) {subtotal[col.data] = ""});subtotal[groups[i].data] = 'Subtotal';metrics.forEach(function(metric) {subtotal[metric] = sdata[metric]});setMeta(subtotal, "__row__", "class", "o-subtotal");data.push(subtotal);groups.forEach(function(_g, _i) {if (_i < i && _g.tag) {setMeta(subtotal, _g.data, "hidden", true);setMeta(_g.tag, _g.data, "rowspan", getMeta(_g.tag, _g.data, "rowspan", 0) + 1)}
setMeta(subtotal, _g.data, "rowspan", 1)})}
if (row != null) {groups[i].tag = row;groups[i].rows.push(row);setMeta(row, groups[i].data, "rowspan", 1)}}
break} else if (row != null){group.rows.push(row);setMeta(row, group.data, "hidden", true);setMeta(group.tag, group.data, "rowspan", getMeta(group.tag, group.data, "rowspan", 0) + 1)}}
if (row != null) data.push(row)}}
var type2Class = ["o-metric", "o-dimension", "o-group"];var cell = function(column, element) {return $(document.createElement(element || "td")).addClass(type2Class[column.type]).html("&nbsp;")};table.empty();table.addClass("o-table");var headers = $(document.createElement("tr"));for (var i = 0; i < columns.length; i++) {var column = columns[i];var cellEle = cell(column, "th").text(column.title);var sort = sorts.find(function(s) { return s.data == column.data; });if (sort) {cellEle.addClass(sort.sort ? (sort.sort == 1 ? "o-sorting_asc" : "o-sorting_desc") : "o-sorting");cellEle.attr("o-table-data", sort.data).attr("o-table-sort", sort.sort).click(sortColumn)}
headers.append(cellEle)}
table.append($(document.createElement("thead")).append(headers));var grandTotal = {};var rows = $(document.createElement("tbody"));if (data.length) {data.forEach(function(rowdata) {var row = $(document.createElement("tr"));if (getMeta(rowdata, "__row__", "class")) {row.addClass(getMeta(rowdata, "__row__", "class"))} else if (summary.enabled) {calcSummary(rowdata, grandTotal)}
columns.forEach(function(column) {var text = rowdata[column.data];text = typeof(text) == "object" ? printSubtotal(text, null, column.formatter) : rsb.otable._formatText(text, column.formatter);var cellEle = cell(column).text(text);if (getMeta(rowdata, column.data, "rowspan") > 1) cellEle.attr("rowspan", getMeta(rowdata, column.data, "rowspan"));if (getMeta(rowdata, column.data, "hidden")) cellEle.addClass("hidden");row.append(cellEle)});rows.append(row)})} else {var row = $(document.createElement("tr")).addClass("o-empty");row.append($(document.createElement("td")).attr("colspan", columns.length).text('No data available in report'));rows.append(row)}
table.append(rows);var footers = $(document.createElement("tr"));for (var i = 0; i < columns.length; i++) {var column = columns[i];var columnEle = cell(column);if (data.length && summary.enabled) {if (i == 0) columnEle.text('Grand Total');if (grandTotal[column.data]) {var text = grandTotal[column.data];text = typeof(text) == "object" ? printSubtotal(text, 'Total', column.formatter) : rsb.otable._formatText(text, column.formatter);columnEle.text(text)}}
footers.append(columnEle)}
table.append($(document.createElement("tfoot")).append(footers))};rsb.otable._error = function(message) {console.error(message)}
rsb.otable._formatText = function(text, formatter) {if (!formatter) return text;if (typeof(formatter) == "function") text = formatter(text);else if(typeof(formatter) == "string") {if (formatter.toLowerCase() == "filesize") text = rsb.connect.formatFileSize(text);if (formatter.toLowerCase() == "timespan") text = rsb.connect.formatTimeSpan(text)}
return text}
