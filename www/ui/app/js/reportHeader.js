rsb.reports = rsb.reports || {};rsb.reports.headerContainer = null;rsb.reports.headerTitle = null;rsb.reports.headerEdit = null;rsb.reports.headerInput = null;rsb.reports.headerReportName_ok = null;rsb.reports.headerReportName_cancel = null;rsb.reports.headerContent = null;rsb.reports.headerSchedule = null;rsb.reports.headerScheduleContent = null;rsb.reports.headerExportCsv = null;rsb.reports.headerSave = null;rsb.reports.headerSaveChanges = null;rsb.reports.headerSaveAsNew = null;rsb.reports.headerResultContainer = null;rsb.reports.checkInfo = function($report) {var allowed = true;if ($report && $report.timeperiod && $report.timeperiod.toLowerCase() == "custom") {if (!$report.timeperiodstart && !$report.timeperiodend) {rsb.showResult(rsb.reports.headerResultContainer, 'Start Date and End Date cannot both be empty.', false);allowed = false} else if ($report.timeperiodstart && $report.timeperiodend) {if (new Date($report.timeperiodstart) > new Date($report.timeperiodend)) {rsb.showResult(rsb.reports.headerResultContainer, 'The customer Start Date should be earlier than the End Date.', false);allowed = false}}}
if ($report && $report.enddate) {if ($report.startdate && $report.enddate) {if (new Date($report.startdate) >= new Date($report.enddate)) {rsb.showResult(rsb.reports.headerResultContainer, 'The Start Date should be earlier than the End Date.', false);allowed = false}}}
if ($report && $report.emailreport.toLowerCase() == "true") {if ($report.emailsubject == "" || $report.emailrecipients == "") {rsb.showResult(rsb.reports.headerResultContainer, 'The Subject and Recipients are required when Email Report checked', false);allowed = false}}
return allowed};rsb.reports.saveChanges = function($report) {if ($report) {var postData = {"@json": "true","_randomtoken": rsb.securityRand()}
postData = $.extend(postData, $report);$.ajax({data: postData,url: "api/reports.rsd",type: "PUT",success: function(data) {errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult(rsb.reports.headerResultContainer, errorMsg, false)} else {rsb.showResult(rsb.reports.headerResultContainer, 'Save successful.', "success");rsb.reports.nav.setSaved();if (data.items) {var result = data.items["0"];if (result) {rsb.reports.original = result;rsb.reports.headerContent.html(rsb.evalTemplate('$type$&nbsp;&nbsp;&nbsp;·&nbsp;&nbsp;&nbsp;Created: $createdtime$&nbsp;&nbsp;&nbsp;·&nbsp;&nbsp;&nbsp;Modified: $modifiedtime$&nbsp;&nbsp;&nbsp;·&nbsp;&nbsp;&nbsp;Created by: $createdby$', {"type": rsb.htmlEncode(result.type), "createdtime": rsb.htmlEncode(rsb.connect.formatTimestamp(result.createdtime)), "modifiedtime": rsb.htmlEncode(rsb.connect.formatTimestamp(result.modifiedtime)), "createdby": rsb.htmlEncode(rsb.reports.original.createdby)}));rsb.reports.nav.setNextRunTime(result["nextruntime"]);if (result.schedule) {rsb.reports.headerSchedule.removeClass("hidden");var scheduleText = rsb.reports.nav.getSchedule();var nextRunTime = rsb.reports.nav.getNextRunTime();if (nextRunTime) {scheduleText += " (" + 'next report will run on'+ " " + rsb.connect.formatTimestamp(nextRunTime) + ")"}
rsb.reports.headerScheduleContent.text(scheduleText);rsb.reports.viewer.addClass("report-viewer-has-schedule")} else {rsb.reports.headerScheduleContent.text("");rsb.reports.headerSchedule.addClass("hidden");rsb.reports.viewer.removeClass("report-viewer-has-schedule")}}}
if ($report.newname) {var originalReport = rsb.reports.nav.getOriginalReport();originalReport.name = $report.newname;rsb.reports.headerTitleSpan.text($report.newname);const nextURL = document.URL.substring(0, document.URL.indexOf("report=")) + "report=" + encodeURIComponent($report.newname);window.history.replaceState({}, document.title, nextURL)}
rsb.reports.toggleEditReportName(false)}}})}};rsb.reports.saveReport = function () {var originalReport = rsb.reports.nav.getOriginalReport();var reportInfo = rsb.reports.nav.getCurrentReport();if (originalReport.name.toLowerCase() != reportInfo.name.toLowerCase()) {var newName = reportInfo.name.trim();reportInfo.name = originalReport.name;reportInfo = $.extend({"newname": newName}, reportInfo)}
if (rsb.reports.checkInfo(reportInfo)) {rsb.reports.saveChanges(reportInfo)}}
rsb.reports.changeReportName = function () {if (!rsb.reports.headerInput.val()) {rsb.showResult(rsb.reports.headerResultContainer, 'This report name is required.', false);return}
var originalReport = rsb.reports.nav.getOriginalReport();if (originalReport.name.toLowerCase() != rsb.reports.headerInput.val().toLowerCase()) {rsb.reports.nav.setName(rsb.reports.headerInput.val());rsb.reports.saveReport()} else {rsb.reports.toggleEditReportName(false)}}
rsb.reports.toggleEditReportName = function ($enable) {rsb.reports.headerInput.off("blur");if ($enable !== false) {rsb.reports.headerInput.val(rsb.reports.headerTitleSpan.text());rsb.reports.headerTitle.addClass("hidden");rsb.reports.headerInput.closest(".report-header-report-name").removeClass("hidden");rsb.reports.headerInput.focus();rsb.reports.headerInput.on("blur", rsb.reports.changeReportName)} else {rsb.reports.headerTitle.removeClass("hidden");rsb.reports.headerInput.closest(".report-header-report-name").addClass("hidden");rsb.reports.nav.setName(rsb.reports.headerTitleSpan.text())}}
$(document).ready(function() {$(document).on("keydown", function($event) {var event = $event || window.event;if (event.ctrlKey && event.keyCode == 83) {event.preventDefault();rsb.reports.headerSave.click()}})});