rsb.singleDatabase = rsb.singleDatabase || {};rsb.singleDatabase.storedProcedureInfo = {};rsb.singleDatabase.listingMetadata = false;rsb.singleDatabase.invalidType = "0";rsb.singleDatabase.singleTableType = "1";rsb.singleDatabase.singleSPType = "2";rsb.singleDatabase.multipleType = "3";rsb.singleDatabase.complexType = "4";rsb.singleDatabase.init = function ($options) {rsb.singleDatabase.options = $.extend($.extend({endpoints: {ListTables: "databaseListTables.rsb",ListColumns: "databaseListColumns.rsb",ListSPs: "databaseListSPs.rsb",ListSPsParameters: "databaseListSPsParameters.rsb",SetTemplate: "databaseSetTemplate.rsb",SaveTemplateSample: "databaseSaveTemplateSample.rsb",ListTemplateColumns: "databaseListTemplateColumns.rsb",PreviewTemplate: "databasePreviewTemplate.rsb",ResetLookupCache: "databaseResetLookupCache.rsb"}}, $options), rsb.connect.options);rsb.singleDatabase.actionType = rsb.singleDatabase.options.actionType || "UPSERT";rsb.singleDatabase.reset()}
rsb.singleDatabase.reset = function ($isReady) {rsb.singleDatabase.form = $(rsb.singleDatabase.options.formSelector || "#singleDatabaseSettingsForm_form");rsb.singleDatabase.resultContainer = rsb.singleDatabase.form.find(".action-error-container");rsb.singleDatabase.actionTypeGroup = rsb.singleDatabase.form.find(".actiontype.form-group");rsb.singleDatabase.actionContainers = rsb.singleDatabase.form.find("div.action-containers");rsb.singleDatabase.storedprocedureDropdown = rsb.singleDatabase.actionContainers.find("div.storedprocedure-dropdown");rsb.singleDatabase.storedprocedureDropdownText = rsb.singleDatabase.storedprocedureDropdown.find("span.dropdown-text");rsb.singleDatabase.storedprocedureMenu = rsb.singleDatabase.storedprocedureDropdown.find("ul.dropdown-menu");rsb.singleDatabase.storedprocedureSettings = rsb.singleDatabase.actionContainers.find(".executesp-settings");rsb.singleDatabase.resetCacheBtn = rsb.singleDatabase.form.find(".btn.reset-cache-btn");rsb.singleDatabase.oauthSpecificContainer = rsb.singleDatabase.form.find("div.oauth-specific");rsb.singleDatabase.testBtnContainer = rsb.singleDatabase.form.find(".form-group.testconnection");rsb.singleDatabase.oauthBtnContainer = rsb.singleDatabase.form.find(".form-group.oauth-button-group");rsb.singleDatabase.connBtn = rsb.singleDatabase.oauthBtnContainer.find(".btn.connect-btn");rsb.singleDatabase.disconnBtn = rsb.singleDatabase.oauthBtnContainer.find(".btn.disconnect-btn");rsb.singleDatabase.testErrorPanel = rsb.singleDatabase.oauthBtnContainer.find(".panel.test-connection-error-panel");rsb.singleDatabase.spCodeEditor = !!rsb.singleDatabase.actionContainers.find(".executesp-code-content")[0] && CodeMirror.fromTextArea(rsb.singleDatabase.actionContainers.find(".executesp-code-content")[0], {mode: "text/xml",theme: "xml",lineNumbers: true,textWrapping: false,indentUnit: 4,autoRefresh: true});!rsb.singleDatabase.options.useSharedConnection && !!$isReady && rsb.singleDatabase.initHierarchySettings();!rsb.singleDatabase.options.useSharedConnection && !$isReady && $(document).ready(function () { rsb.singleDatabase.initHierarchySettings(); });rsb.singleDatabase.advancedLookupCacheSettings = $("form." + rsb.singleDatabase.options.portType.toLowerCase() + "-advanced-form .database-lookup-cache-settings");rsb.singleDatabase.editorSavedCallback = null;rsb.singleDatabase.form.on("beforeSubmit", function () {rsb.singleDatabase.editorSavedCallback = null;return function ($callback) {rsb.singleDatabase.actionContainers.find(".query-container,.upsert-container").find("input,textarea,select,button,option").addClass("rsb-form-nosubmit");if (rsb.singleDatabase.listingMetadata) {$callback && $callback()} else if (!!rsb.singleDatabase.queryEditor && rsb.singleDatabase.queryEditor.changed() && !rsb.singleDatabase.actionContainers.find(".query-container").hasClass("hidden")) {rsb.singleDatabase.editorSavedCallback = $callback;rsb.singleDatabase.queryEditor.save()} else if (!!rsb.singleDatabase.upsertEditor && rsb.singleDatabase.upsertEditor.changed() && !rsb.singleDatabase.actionContainers.find(".upsert-container").hasClass("hidden")) {rsb.singleDatabase.editorSavedCallback = $callback;rsb.singleDatabase.upsertEditor.save()} else if (!rsb.singleDatabase.actionContainers.find(".executesp-container").hasClass("hidden") && rsb.singleDatabase.executeSPApi?.saveMapping) {rsb.singleDatabase.executeSPApi.saveMapping($callback)} else {$callback && $callback()}}}).on("success", function () {rsb.singleDatabase.listingMetadata = false;rsb.singleDatabase.storedProcedureInfo.changed = false;rsb.singleDatabase.editorSavedCallback = null;rsb.singleDatabase.formData = rsb.getFormData(rsb.singleDatabase.form)}).on("reset", function () {if (!["lookupsp", "lookup", "executesp"].includes(rsb.singleDatabase.actionType.toLowerCase())) return true;delete rsb.singleDatabase.initialized[rsb.singleDatabase.actionType.toLowerCase()];if (rsb.singleDatabase.formData?.connectorid?.length > 0) {rsb.singleDatabase.options.sample = rsb.singleDatabase.formData.Samples;for (const key in rsb.singleDatabase.options.lookupSettings) {const value = rsb.singleDatabase.formData[key] || rsb.singleDatabase.formData[key.toLowerCase()];if (typeof rsb.singleDatabase.options.lookupSettings[key] === "boolean") {rsb.singleDatabase.options.lookupSettings[key] = rsb.getValueAsBool(value, rsb.singleDatabase.options.lookupSettings[key])} else {rsb.singleDatabase.options.lookupSettings[key] = value}}}
rsb.singleDatabase.actionChanged(rsb.singleDatabase.options.actionType)});rsb.singleDatabase.form.find("input.connection-input").off("change").one("change", function () {rsb.singleDatabase.form.find("div.testconnection").removeClass("hidden")});rsb.externalCheckUnsaveFunc[rsb.singleDatabase.form.attr("id")] = function () {if (rsb.singleDatabase.options.readonly) {return false}
return !rsb.singleDatabase.listingMetadata && !!rsb.singleDatabase.upsertEditor && rsb.singleDatabase.upsertEditor.changed() && !rsb.singleDatabase.actionContainers.find(".upsert-container").hasClass("hidden") ||
!!rsb.singleDatabase.queryEditor && rsb.singleDatabase.queryEditor.changed() && !rsb.singleDatabase.actionContainers.find(".query-container").hasClass("hidden") ||
!!rsb.singleDatabase.executeSPApi && !rsb.singleDatabase.actionContainers.find(".executesp-container").hasClass("hidden") && rsb.singleDatabase.executeSPApi.isChanged?.call()};delete rsb.singleDatabase.formData;rsb.singleDatabase.connectionNameCallback = () => {};rsb.singleDatabase.connectionName = rsb.singleDatabase.form.find("input[name='connectionname']");rsb.singleDatabase.connectionName.on("change", function () {rsb.singleDatabase.connectionNameCallback(rsb.singleDatabase.connectionName.val(), true)});rsb.singleDatabase.form.one("success", () => rsb.singleDatabase.connectionNameCallback(rsb.singleDatabase.connectionName.val(), false));rsb.singleDatabase.initialized = {};rsb.singleDatabase.actionChanged(rsb.singleDatabase.options.actionType)}
rsb.singleDatabase.actionChanged = function ($type) {rsb.singleDatabase.actionType = $type;if (["lookupsp", "lookup", "executesp"].includes($type.toLowerCase()) && rsb.singleDatabase.initialized[$type.toLowerCase()] !== true) {const setConnectionNameCallback = (callback) => rsb.singleDatabase.connectionNameCallback = callback || (() => {});const props = {connectorInfo: {"workspaceId": rsb.singleDatabase.options.workspaceid,"connectorId": rsb.singleDatabase.options.portId,"connectorType": rsb.singleDatabase.options.portType},sample: rsb.singleDatabase.options.sample,...rsb.singleDatabase.options.lookupSettings,listSPsUrl: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.ListSPs),listSPParametersUrl: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.ListSPsParameters),supportReturnValue: !!rsb.singleDatabase.options.supportReturnValueParameter,listTablesUrl: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.ListTables),listColumnsUrl: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.ListColumns),resetCacheUrl: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.ResetLookupCache),getMappingInfoUrl: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.ListTemplateColumns),saveMappingInfoUrl: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.SetTemplate),disabled: rsb.singleDatabase.options.readonly,connectionName: rsb.singleDatabase.connectionName.val(),setConnectionNameCallback};if ($type.toLowerCase() === "lookupsp") {const renderLookupStoredProcedureSettings = () => {rsb.renderComponent("Databases.LookupStoredProcedureSettings", rsb.singleDatabase.actionContainers.children().filter(".lookupsp-container")[0], props);rsb.singleDatabase.initialized.lookupsp = true}
renderLookupStoredProcedureSettings();$(document).one("registerComponent.Databases.LookupStoredProcedureSettings", renderLookupStoredProcedureSettings)} else if ($type.toLowerCase() === "lookup") {const renderLookupSettings = () => {rsb.renderComponent("Databases.LookupSettings", rsb.singleDatabase.actionContainers.children().filter(".lookup-container")[0], props);rsb.singleDatabase.initialized.lookup = true}
renderLookupSettings();$(document).one("registerComponent.Databases.LookupSettings", renderLookupSettings)} else if ($type.toLowerCase() === "executesp") {const renderLookupSettings = () => {rsb.singleDatabase.executeSPApi = {};rsb.renderComponent("Databases.ExecuteStoredProcedureSettings", rsb.singleDatabase.actionContainers.children().filter(".executesp-container")[0], {...props, executeSPApi: rsb.singleDatabase.executeSPApi});rsb.singleDatabase.initialized.executesp = true}
renderLookupSettings();$(document).one("registerComponent.Databases.LookupSettings", renderLookupSettings)}}
var $container = rsb.singleDatabase.actionContainers.children().addClass("hidden").filter("." + $type.toLowerCase() + "-container");rsb.singleDatabase.actionContainers.children().addClass("rsb-form-nosubmit").find('input,textarea,select').each(function () {$(this).attr("_name_", $(this).attr("name")).removeAttr("name", "")});$container.removeClass("rsb-form-nosubmit").find('input,textarea,select').each(function () {$(this).attr("name", $(this).attr("_name_") || $(this).attr("name")).removeAttr("_name_", "")});$container.toggleClass("hidden", $container.children().length <= 1 && !$container.hasClass("rsb-root-component"))
$container.find(".btn.show-sample-data-btn").off("click").on("click", function () {rsb.singleDatabase.showSampleData($(this).data("sp"), $(this).data("direction"))});rsb.singleDatabase.adjustAdvancedLookupCacheSettings($type.toLowerCase())}
rsb.singleDatabase.adjustAdvancedLookupCacheSettings = function ($type) {if ($type.toLowerCase() == "upsert") {rsb.singleDatabase.advancedLookupCacheSettings.show().find("input,textarea,select,button,option").removeClass("rsb-form-nosubmit")} else {rsb.singleDatabase.advancedLookupCacheSettings.hide().find("input,textarea,select,button,option").addClass("rsb-form-nosubmit")}}
rsb.singleDatabase.spChanged = function ($item) {var $spName = rsb.trimStr($item.parent().text());$spName != rsb.singleDatabase.storedProcedureInfo.table && rsb.singleDatabase.listMetadata(rsb.singleDatabase.singleSPType, "COLUMN", $spName, "Send", function ($params) {if ($params && !$.isArray($params)) {$params = [$params]}
var $spEleName = rsb.singleDatabase.getValidElementName($spName);rsb.singleDatabase.storedProcedureInfo = {changed: true, table: $spName, parameters: $params};rsb.singleDatabase.storedProcedureInfo.content = "<Items>\r\n\t<" + $spEleName + " sp='" + rsb.xmlEscape($spName) + "'>\r\n";rsb.forEach($params || [], function (col, index) {if ((col.direction || "IN").toUpperCase() != "OUT") {rsb.singleDatabase.storedProcedureInfo.content += "\t\t<" + rsb.singleDatabase.getValidElementName(col.columnname, true) + " column='" + rsb.xmlEscape(col.columnname) + "' direction='" + rsb.xmlEscape(col.direction) + "'/>\r\n"}});rsb.singleDatabase.storedProcedureInfo.content += "\t</" + $spEleName + ">\r\n</Items>\r\n";rsb.singleDatabase.storedProcedureInfo.outputContent = "<Items>\r\n\t<result_set rs=\"*\" allColumns=\"true\" />\r\n\t<" + $spEleName + " allColumns=\"true\"" +(!!rsb.singleDatabase.options.supportReturnValueParameter ? ">\r\n\t\t<ReturnValue returnval=\"true\" />\r\n\t</" + $spEleName + ">" : " />")
+ "\r\n</Items>\r\n";rsb.singleDatabase.storedprocedureDropdownText.text($spName);rsb.singleDatabase.storedprocedureSettings.removeClass("hidden");rsb.singleDatabase.setEditorValue(rsb.singleDatabase.spCodeEditor, rsb.singleDatabase.storedProcedureInfo.content)})}
rsb.singleDatabase.preview = function (templateName, input, top, skip, count, args, callback) {var postData = {"@json": true,"ConnectorId": rsb.singleDatabase.options.workspaceid + ":" + rsb.singleDatabase.options.portId,"ConnectorType": rsb.singleDatabase.options.portType,"ActionType": rsb.singleDatabase.actionType,"Direction": args.direction,"TemplateName": templateName,"Data": rsb.connect.BASE64Encode(args.data || ""),"Top": top,"Skip": skip,"Count": count,"InputData": rsb.connect.BASE64Encode(input || "")};if (args.type == rsb.singleDatabase.singleSPType && !!args.outputMapping) {postData.OutputMapping = rsb.connect.BASE64Encode(args.outputMapping)}
var fromData = rsb.getFormData(rsb.singleDatabase.form, true);for (var name in fromData) {postData["settings:" + name] = fromData[name]}
$.ajax({dataType: "json",type: "POST",url: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.PreviewTemplate),cache: false,data: postData,success: function (data, textStatus, jqXHR) {callback && callback(data["items"])}})}
rsb.singleDatabase.saveMapping = function (templatename, content, args, callback) {if (!content) {callback && callback({"rsb:emessage": 'Please select at least one table for the mapping.'})}
var postData = {"@json": true,"ConnectorId": rsb.singleDatabase.options.workspaceid + ":" + rsb.singleDatabase.options.portId,"ConnectorType": rsb.singleDatabase.options.portType,"ActionType": rsb.singleDatabase.actionType,"Direction": args.direction,"TemplateName": templatename || (args.type == rsb.singleDatabase.singleSPType ? "SP/mapping" : "mapping"),"Content": rsb.connect.BASE64Encode(content || "")};if (args.type == rsb.singleDatabase.singleSPType && !!args.outputContent) {postData.OutputContent = rsb.connect.BASE64Encode(args.outputContent)}
$.ajax({dataType: "json",type: "POST",url: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.SetTemplate),cache: false,data: postData,headers: {"If-Unmodified-Since": rsb.getResourceLastModified(postData.ConnectorId)},success: function (data, textStatus, jqXHR) {rsb.setResourceLastModified(postData.ConnectorId, jqXHR.getResponseHeader("Last-Modified"))
callback && callback(data["items"])},error: function (jqXHR, errorStatus, thrownError) {const error = rsb.ajaxError(jqXHR, errorStatus, thrownError);if (error) {const resultContainer = rsb.getFormResultContainer(rsb.singleDatabase.form);rsb.showResult(resultContainer, error, false);$(rsb.singleDatabase.form).trigger("error", false)}}})}
rsb.singleDatabase.saveSample = function (templateName, sample, input, args, callback) {var postData = {"@json": true,"ConnectorId": rsb.singleDatabase.options.workspaceid + ":" + rsb.singleDatabase.options.portId,"ConnectorType": rsb.singleDatabase.options.portType,"ActionType": rsb.singleDatabase.actionType,"Direction": args.direction,"TemplateName": templateName,"Content": rsb.connect.BASE64Encode(sample || ""),"InputContent": rsb.connect.BASE64Encode(input || "")};$.ajax({dataType: "json",type: "POST",url: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.SaveTemplateSample),cache: false,data: postData,success: function (data, textStatus, jqXHR) {callback && callback(data["items"])}})}
rsb.singleDatabase.listMetadata = function (type, category, table, direction, callback) {var resetListingState = function () {rsb.singleDatabase.actionTypeGroup.find("select,option").removeClass("rsb-form-nosubmit");rsb.singleDatabase.listingMetadata = false;rsb.singleDatabase.form.off("success", listMetadataImpl).off("error", resetListingState)}
var listMetadataImpl = function () {resetListingState();var postData = {"@json": true,"ConnectorId": rsb.singleDatabase.options.workspaceid + ":" + rsb.singleDatabase.options.portId,"ConnectorType": rsb.singleDatabase.options.portType,"ActionType": rsb.singleDatabase.actionType,"Table": table,"Direction": direction,"Type": type};var url = "";if (type != rsb.singleDatabase.singleSPType) {url = category.toLowerCase() == "table" ? rsb.singleDatabase.options.endpoints.ListTables : rsb.singleDatabase.options.endpoints.ListColumns} else {url = category.toLowerCase() == "table" ? rsb.singleDatabase.options.endpoints.ListSPs : rsb.singleDatabase.options.endpoints.ListSPsParameters}
$.ajax({dataType: "json",type: 'POST',url: rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, url),data: postData,success: function (data, textStatus, jqXHR) {callback(data["items"], table)}})}
var unsavedText = null;if (category && category.toLowerCase() == "table") {rsb.singleDatabase.listingMetadata = true;rsb.singleDatabase.actionTypeGroup.find("select,option").addClass("rsb-form-nosubmit");unsavedText = rsb.checkUnsave(rsb.singleDatabase.form)}
if (!!unsavedText && confirm(unsavedText + '\n\n' + rsb.evalTemplate('Would you like to save changes before listing $type$?', {"type": type != rsb.singleDatabase.singleSPType ? "table" : "stored procedure"}))) {rsb.singleDatabase.form.off("success", listMetadataImpl).one("success", listMetadataImpl).off("error", resetListingState).one("error", resetListingState).submit()} else {listMetadataImpl()}}
rsb.singleDatabase.getSchemaInfo = function (templateName, content, args, callback) {var postData = {"@json": true,"ConnectorId": rsb.singleDatabase.options.workspaceid + ":" + rsb.singleDatabase.options.portId,"ConnectorType": rsb.singleDatabase.options.portType,"ActionType": rsb.singleDatabase.actionType,"TemplateName": templateName,"Direction": args.direction,"Content": rsb.connect.BASE64Encode(content || "")};var url = rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.ListTemplateColumns);$.ajax({dataType: "json",type: 'POST',url: url,data: postData,success: !callback ? null : function (data, textStatus, jqXHR) {var $structute = null;var $templateType = null;var $templateContent = null;var $result = data["items"];var $errorMsg = rsb.getResultErrorMessage($result);if (!$errorMsg && $result.length) {try {$structute = !!$result[0]["structure"] ? JSON.parse($result[0]["structure"]) : null;$templateType = $result[0]["templatetype"];$templateContent = !!$result[0]["templatecontent"] ? rsb.connect.BASE64Decode($result[0]["templatecontent"]) : null} catch ($err) {$errorMsg = $err}}
callback($errorMsg, $structute, $templateContent, !$templateType || $templateType == rsb.singleDatabase.singleTableType || $templateType == rsb.singleDatabase.singleSPType || $templateType == rsb.singleDatabase.multipleType, $result && $result.length && $result[0])}})}
rsb.singleDatabase.generateXML = function ($structure, $prefix, $subTable, $args) {if (!$structure || Object.keys($structure).length <= 0) {return ""}
var tableEle = rsb.singleDatabase.getValidElementName(rsb.singleDatabase.geneTableElement($structure.name || $structure.alias || $structure.table));var isTable = $args.type == rsb.singleDatabase.singleTableType;var isOutput = ($args.direction || "").toUpperCase() == "RECEIVE";var tableName = $structure.table;var xml = "";if (!$subTable) {if (isOutput) {xml = '\x3C!--\r\n' +'NOTE: The following attributes can be included in the table XML:\r\n' +'selectQuery="SELECT * FROM XXX" - This can be used to specify a custom query to execute for this mapping.\r\n' +'skipProcessedRows="true" - When true, the application will only process rows one time.\r\n' +'-->\r\n\r\n'}
xml += "<Items>\r\n";$prefix = "    "}
xml += $prefix + "<" + tableEle + (tableName != tableEle ? " table=\"" + rsb.xmlEscape(tableName) + "\"" : "");if ($structure.allColumns && $structure.allColumns.toLowerCase() == "true" || $structure.custom || !$structure.columns || !$structure.columns.length) {xml += " allColumns=\"true\""}
if ($structure.action) {xml += " action=\"" + rsb.xmlEscape($structure.action) + "\""}
if ($structure.upsertQuery) {xml += " upsertQuery=\"" + rsb.xmlEscape($structure.upsertQuery) + "\""}
if ($args.type == rsb.singleDatabase.singleSPType) {xml += " sp=\"" + rsb.xmlEscape(tableName) + "\""} else if ($structure.query || !isTable) {xml += (isOutput ? " selectQuery=\"" : " insertQuery=\"") +(isTable ? rsb.xmlEscape($structure.query) : "EXEC " + rsb.xmlEscape($structure.table)) + "\""}
if (!$subTable && isOutput && !!$structure.processChangesOnly) {xml += " processChangesOnly=\"true\""}
if (!!$structure.innerTables && !!$structure.excludedInnerTables) {xml += " excludedInnerTables=\"" + $structure.excludedInnerTables + "\""}
xml += ">\r\n";for (var i in $structure.columns) {if ($args.type != rsb.singleDatabase.singleSPType && !isTable && isOutput != (($structure.columns[i].direction || "IN").toUpperCase() == "OUT")) {continue}
var col = $structure.columns[i].name;var colEle = rsb.singleDatabase.getValidElementName($structure.columns[i].alias || col, true);$structure.columns[i].type = $structure.columns[i].type || $structure.columns[i].datatype || "string";$structure.columns[i].key = $structure.columns[i].key || $structure.columns[i].iskey || "false";$structure.columns[i].autoincrement = $structure.columns[i].autoincrement || $structure.columns[i].isautoincrement || "false";$structure.columns[i].ref = $structure.columns[i].ref || (!isOutput && $structure.columns[i].autoincrement.toLowerCase() == "true" ? "@@LAST_INSERT_ID" : "");var aggregate = ($structure.columns[i].internaltype || "").toLowerCase();if (!!$structure.columns[i].aggregatetable) {aggregate = " aggregate=\"" + rsb.xmlEscape($structure.columns[i].aggregatetable) + "\""} else if (aggregate.startsWith("aggregate")) {if (aggregate.length == 9) {aggregate = " aggregate=\"true\""} else if (aggregate.length > 10 && aggregate[9] == ",") {aggregate = " aggregate=\"" + rsb.xmlEscape($structure.columns[i].internaltype.substring(10)) + "\""} else {aggregate = ""}} else {aggregate = ""}
xml += $prefix + "    <" + colEle +(colEle !== col ? " column=\"" + rsb.xmlEscape(col) + "\"" : "") +($structure.columns[i].type.toLowerCase() != "string" ? " type=\"" + rsb.xmlEscape($structure.columns[i].type.toLowerCase()) + "\"" : "") +($structure.columns[i].key.toLowerCase() == "true" ? " key=\"true\"" : "") +(!isOutput && $structure.columns[i].upsert ? " upsert=\"" + rsb.xmlEscape($structure.columns[i].upsert) + "\"" : "") +(!isOutput && $structure.columns[i].lookup ? " lookup=\"" + rsb.xmlEscape($structure.columns[i].lookup) + "\"" : "") +(!isOutput && $structure.columns[i].lookupquery ? " lookupQuery=\"" + rsb.xmlEscape($structure.columns[i].lookupquery) + "\"" : "") +(!isOutput && $structure.columns[i].insertquery ? " insertQuery=\"" + rsb.xmlEscape($structure.columns[i].insertquery) + "\"" : "") +(!isOutput && $structure.columns[i].usefirstresult ? " useFirstResult=\"" + rsb.xmlEscape($structure.columns[i].usefirstresult) + "\"" : "") +(!isOutput && $structure.columns[i].insertnullvalue ? " insertNullValue=\"" + rsb.xmlEscape($structure.columns[i].insertnullvalue) + "\"" : "") +($structure.columns[i].ref ? " ref=\"" + $structure.columns[i].ref + "\"" : "") +(!$subTable && isOutput && !!$structure.columns[i].updateValue ? " updateValue=\"" + rsb.xmlEscape($structure.columns[i].updateValue) + "\"" : "") +(!$subTable && isOutput && !!$structure.columns[i].timeCheck ? " timeCheck=\"" + rsb.xmlEscape($structure.columns[i].timeCheck) + "\"" : "") +(!isOutput && ($structure.columns[i].isreadonly || "false").toLowerCase() == "true" ? " readonly=\"true\"" : "") +($args.type == rsb.singleDatabase.singleSPType && ($structure.columns[i].direction || "IN").toUpperCase() != "IN" ? " direction=\"" + rsb.xmlEscape($structure.columns[i].direction) + "\"" : "") +aggregate + " />\r\n";$structure.columns[i].elementName = colEle}
if ($structure.children && typeof ($structure.children) == "object" && $structure.children.length) {for (var index = 0; index < $structure.children.length; index++) {xml += rsb.singleDatabase.generateXML($structure.children[index], $prefix + "    ", true, $args) + "\r\n"}}
xml += $prefix + "</" + tableEle + ">";if (!$subTable && $prefix && $prefix.length > 0) {xml += "\r\n</Items>"}
return xml}
rsb.singleDatabase.getValidElementName = function (name, isColumn) {name = isColumn ? name : name.split(".").slice(-1)[0];var $quotePatterns = [["\"", "\""], ["[", "]"], ["`", "`"]];for (var index = 0; index < $quotePatterns.length; index++) {if (name.startsWith($quotePatterns[index][0]) && name.endsWith($quotePatterns[index][1])) {name = name.substring(1, name.length - 1);break}}
return rsb.connect.getValidXMLElementName(name)}
rsb.singleDatabase.geneTableElement = function (name) {var parts = null;if (name.startsWith('[') && name.endsWith(']')) {parts = name.substring(1, name.length - 1).split(/\]\.\[/g)} else {parts = name.split(/\./g)}
if (parts.length > 0 && parts.length <= 3 && parts[parts.length - 1].length > 0) {name = parts[parts.length - 1]}
return name.replace(/["|'|\[|\]|`]+/g, '') || name}
rsb.singleDatabase.resetLookupCache = function ($btn) {$btn.button("loading");var postData = {"@json": true,"ConnectorId": rsb.singleDatabase.options.workspaceid + ":" + rsb.singleDatabase.options.portId,"ConnectorType": rsb.singleDatabase.options.portType,"ActionType": rsb.singleDatabase.actionType};$.post(rsb.connect.pathCombine(rsb.singleDatabase.options.srcDir, rsb.singleDatabase.options.endpoints.ResetLookupCache), postData, function (data) {var errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult(rsb.singleDatabase.resultContainer, "Failure! " + errorMsg, false)} else {rsb.showResult(rsb.singleDatabase.resultContainer, "Success!", true)}}).fail(function (error) {var innerError = "An error occured while reseting lookup cache.";var errorMsg = error.responseJSON ? rsb.getResultErrorMessage(error.responseJSON.items) : null;if (errorMsg) {innerError = errorMsg}
rsb.showResult(rsb.singleDatabase.resultContainer, innerError, false)}).always(function () {$btn.button("reset")})}
rsb.singleDatabase.resetSchemaCache = function () {const $btn = $(this);$btn.button("loading");const postData = {"@json": true,"WorkspaceId": rsb.singleDatabase.options.workspaceid,"ConnectorId": rsb.singleDatabase.options.portId,};$.post(rsb.connect.pathCombine(rsb.connect.options.srcDir, "resetSchemaCache.rsb"), postData, function (data) {const errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult($("#loadportFormResult"), "Failure! " + errorMsg, false)} else {rsb.showResult($("#loadportFormResult"), "Success!", true)}}).fail(function (error) {const errorMsg = error.responseJSON ? rsb.getResultErrorMessage(error.responseJSON.items) : null;rsb.showResult($("#loadportFormResult"), errorMsg || "An error occured while reseting cache schema.", false)}).always(function () {$btn.button("reset")})}
rsb.singleDatabase.setEditorValue = function ($editor, $value) {$editor.setValue($value || "");$editor.refresh();$editor.clearHistory()}
rsb.singleDatabase.initHierarchySettings = function () {new rsb.providerHierarchySettings({requiredContainer: "#singleDatabaseSettingsForm_settingscontainer",optionalContainer: "#databaseAdvancedFormHierarchySettings",driverName: rsb.singleDatabase.options.driverName,driverClass: rsb.singleDatabase.options.driverClass,namePrefix: "connection",driverChanged: function ($meta, $type, $args) {rsb.singleDatabase.options.capabilities = $meta.capabilities;rsb.singleDatabase.oauthSpecificContainer.empty();if ((rsb.singleDatabase.options.capabilities || "").toUpperCase().indexOf("OAUTH") >= 0 && ["zendesk", "suitecrm"].indexOf(rsb.singleDatabase.options.portType.toLowerCase()) < 0) {rsb.singleDatabase.testBtnContainer.addClass("hidden");rsb.singleDatabase.oauthBtnContainer.removeClass("hidden");rsb.singleDatabase.connBtn.removeClass('hidden');rsb.singleDatabase.disconnBtn.addClass('hidden')} else {rsb.singleDatabase.oauthBtnContainer.addClass("hidden");rsb.singleDatabase.testBtnContainer.removeClass("hidden")}},resetSchemaCache: rsb.singleDatabase.resetSchemaCache})}
rsb.singleDatabase.connect = function (form) {rsb.singleDatabase.oauthSpecificContainer.empty();var queryData = rsb.getFormData(form);queryData.workspaceid = rsb.singleDatabase.options.workspaceid;queryData.connectorid = rsb.singleDatabase.options.portId;queryData.oauthjwtcert = queryData["connectionoauthjwtcert"];queryData.oauthclientid = queryData["connectionoauthclientid"];queryData.oauthclientsecret = queryData["connectionoauthclientsecret"];rsb.connect.resetConnection(queryData, !rsb.singleDatabase.connBtn.hasClass("quickbooksonline") ? rsb.singleDatabase.connBtn : rsb.singleDatabase.disconnBtn, rsb.getFormResultContainer(form), rsb.singleDatabase.options.capabilities, function (data) {for (var name in data) {var input = rsb.singleDatabase.form.find("[name='connection" + rsb.escapeSelector(name) + "']");queryData["connection" + name] = data[name];if (input && input.length > 0) {input.val(data[name])} else {rsb.singleDatabase.oauthSpecificContainer.append('<input type="hidden" name="connection' + rsb.htmlEncode(name) + '" value="' + rsb.htmlEncode(data[name]) + '">')}}
var postData = { workspaceid: queryData["workspaceid"], connectorid: queryData["connectorid"], connectortype: queryData["connectortype"] };for (var key in queryData) {postData["param@" + key] = queryData[key]}
return postData}, function (data, result, oauth_callback) {rsb.singleDatabase.connBtn.addClass('hidden');rsb.singleDatabase.disconnBtn.removeClass('hidden');form.submit();rsb.connect.oauthWarning(oauth_callback, rsb.getFormResultContainer(form))});rsb.singleDatabase.testErrorPanel.hide().remove()}
rsb.singleDatabase.disconnect = function (form) {!rsb.singleDatabase.disconnBtn.hasClass("quickbooksonline") && rsb.singleDatabase.disconnBtn.button("loading");rsb.connect.clearOAuthToken(rsb.singleDatabase.options.workspaceid, rsb.singleDatabase.options.portId, function (data) {rsb.singleDatabase.disconnBtn.addClass('hidden').button("reset");rsb.singleDatabase.connBtn.removeClass('hidden');rsb.singleDatabase.oauthSpecificContainer.empty()}, function (errMsg) {rsb.singleDatabase.disconnBtn.button("reset");rsb.showResult(rsb.getFormResultContainer(form), "<b>" + 'Failure!'+ "</b>&nbsp;&nbsp;" + errMsg, false, true)})}
$(document).ready(function () {rsb.singleDatabase.reset(true);var _options = {hasParameter: false,disabled: rsb.singleDatabase.options.readonly,listTables: function (args, callback) {return rsb.singleDatabase.listMetadata(rsb.singleDatabase.singleTableType, "TABLE", null, args.direction, callback)},listColumns: function (tableName, args, callback) {rsb.singleDatabase.listMetadata(rsb.singleDatabase.singleTableType, "COLUMN", tableName, args.direction, callback)},getSchemaInfo: rsb.singleDatabase.getSchemaInfo,generate: function (structure, args) {return rsb.singleDatabase.generateXML(structure, "", false, args)},getValidElementName: rsb.singleDatabase.getValidElementName,preview: rsb.singleDatabase.preview,saveSample: rsb.singleDatabase.saveSample,saveMapping: rsb.singleDatabase.saveMapping};rsb.connect.loadModal("databasePreviewModal.rst", rsb.connect.options, function () {if (window.self !== window.top) {if (window.parent?.rsb?.previewModal) {rsb.previewModal = window.parent.rsb.previewModal} else {return}}
rsb.connect.loadModal("databaseAddTableModal.rst", rsb.connect.options, function () {if (window.self !== window.top) {if (window.parent?.rsb?.addTableModal) {rsb.addTableModal = window.parent.rsb.addTableModal} else {return}}
_options.dataSource = rsb.singleDatabase.options.displayName || rsb.singleDatabase.options.portType;!!rsb.singleDatabase.options.mappingOptions && (_options = $.extend(_options, rsb.singleDatabase.options.mappingOptions))
rsb.singleDatabase.queryEditor = $(".query-container").length ? new rsb.mappingEditor(".query-container", ".action-error-container", _options) : null;_options.visibleColumns = ["key", "datatype", "size", "nullable"];rsb.singleDatabase.upsertEditor = $(".upsert-container").length ? new rsb.mappingEditor(".upsert-container", ".action-error-container", _options) : null;var $editorSavedCallback = function () {!!rsb.singleDatabase.editorSavedCallback && rsb.singleDatabase.editorSavedCallback()}
!!rsb.singleDatabase.upsertEditor && rsb.singleDatabase.upsertEditor.edit(rsb.singleDatabase.options.actionType == "upsert" ? rsb.singleDatabase.options.templateName : null, {type: rsb.singleDatabase.singleTableType,direction: "Send",savedCallback: $editorSavedCallback});!!rsb.singleDatabase.queryEditor && rsb.singleDatabase.queryEditor.edit(rsb.singleDatabase.options.actionType == "query" ? rsb.singleDatabase.options.templateName : null, {type: rsb.singleDatabase.singleTableType,direction: "Receive",savedCallback: $editorSavedCallback})})});rsb.singleDatabase.storedprocedureDropdown.off("show.bs.dropdown").on("show.bs.dropdown", function () {rsb.singleDatabase.storedprocedureMenu.empty();rsb.singleDatabase.listMetadata(rsb.singleDatabase.singleSPType, "TABLE", null, "Send", function ($sps) {rsb.singleDatabase.storedprocedureMenu.empty();var errorMsg = rsb.getResultErrorMessage($sps);if (errorMsg) {rsb.showResult(rsb.singleDatabase.resultContainer, errorMsg, false);return}
for (var index = 0; index < $sps.length; index++) {rsb.singleDatabase.storedprocedureMenu.append('<li><a class="dropdown-item" href="javascript:void(0);" onclick="rsb.singleDatabase.spChanged($(this));return false;">' + rsb.htmlEncode($sps[index].tablename) + '</a></li>')}})});rsb.singleDatabase.showSampleData = function ($spName, $direction) {$spName = $spName || rsb.singleDatabase.storedProcedureInfo.table;if (!rsb.singleDatabase.showSampleDataModal) {rsb.singleDatabase.showSampleDataModal = new rsb.previewModal({hasParameter: true,getValidElementName: rsb.singleDatabase.getValidElementName,preview: rsb.singleDatabase.preview,saveSample: rsb.singleDatabase.saveSample})}
var $showSampleDataHandler = function ($params) {rsb.singleDatabase.showSampleDataModal.show((rsb.singleDatabase.options.actionType == "executesp" ? rsb.singleDatabase.options.templateName : null) || "SP/Mapping", {direction: $direction || "Send",params: $params,spName: rsb.singleDatabase.storedProcedureInfo.table,data: rsb.singleDatabase.storedProcedureInfo.content,outputMapping: rsb.singleDatabase.storedProcedureInfo.outputContent})}
if (rsb.singleDatabase.storedProcedureInfo.parameters) {$showSampleDataHandler(rsb.singleDatabase.storedProcedureInfo.parameters)} else {!!$spName && rsb.singleDatabase.listMetadata(rsb.singleDatabase.singleSPType, "COLUMN", $spName, "Send", function ($params) {rsb.singleDatabase.storedProcedureInfo.parameters = $params && !$.isArray($params) ? [$params] : $params;$showSampleDataHandler(rsb.singleDatabase.storedProcedureInfo.parameters)})}}
rsb.singleDatabase.storedprocedureSettings.find(".well>.nav>li").off("click").on("click", function () {$(this).addClass('active').siblings('.active').removeClass('active');rsb.singleDatabase.storedProcedureInfo.changed = rsb.singleDatabase.spCodeEditor.historySize().undo > 0;if ($(this).hasClass('input')) {rsb.singleDatabase.storedProcedureInfo.outputContent = rsb.singleDatabase.spCodeEditor.getValue();rsb.singleDatabase.setEditorValue(rsb.singleDatabase.spCodeEditor, rsb.singleDatabase.storedProcedureInfo.content)} else {rsb.singleDatabase.storedProcedureInfo.content = rsb.singleDatabase.spCodeEditor.getValue();rsb.singleDatabase.setEditorValue(rsb.singleDatabase.spCodeEditor, rsb.singleDatabase.storedProcedureInfo.outputContent)}});rsb.singleDatabase.resetCacheBtn.off("click").on("click", function () {rsb.singleDatabase.resetLookupCache($(this))})});