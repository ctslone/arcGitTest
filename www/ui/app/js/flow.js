rsb.workflow = rsb.workflow || {};rsb.workflow.dragMode = 1;rsb.workflow.lassoMode = 2;var ActionPlayer = function () {var MAX_ACTION_COUNT = 50;var actions = [];var actionIndex = -1;var redoBtn = $(".flow-slider-redo button");var undoBtn = $(".flow-slider-undo button");this.recordAction = function ($redoAction, $undoAction) {while (actions.length > actionIndex + 1) {actions.pop()}
actions.push({"action": $redoAction,"undoAction": $undoAction});if (actions.length > MAX_ACTION_COUNT) {actions.shift()} else {actionIndex++}
this.updateBtnStatus()}
this.undoAction = function () {if (this.canUndo()) {actions[actionIndex].undoAction();actionIndex--;rsb.workflow.flow.save();jsPlumb.repaintEverything()}}
this.redoAction = function () {if (this.canRedo()) {actionIndex++;actions[actionIndex].action();rsb.workflow.flow.save();jsPlumb.repaintEverything()}}
this.canUndo = function () {return actionIndex >= 0 && actions[actionIndex].undoAction}
this.canRedo = function () {return actions.length> 0 && actionIndex < actions.length - 1 && actions[actionIndex + 1].action}
this.cleanUpActions = function () {actions = [];actionIndex = -1;this.updateBtnStatus()}
this.updateBtnStatus = function () {if (this.canUndo()) {undoBtn.removeClass("disabled")} else {undoBtn.addClass("disabled")}
if (this.canRedo()) {redoBtn.removeClass("disabled")} else {redoBtn.addClass("disabled")}}}
var Flow = function() {var _ui = {};_ui.flow = $("#flow");_ui.canvas = $("#canvas");_ui.portContainer = _ui.canvas.find(".port-container");_ui.property = _ui.canvas.find(".flow-properties");_ui.contextMenu = $("#flowContainer").find("#contextMenu");_ui.contextMenu.trigger = _ui.contextMenu.find("a\[data-bs-toggle='dropdown'\]");_ui.contextMenu.port = null;_ui.workspaceContainer = _ui.flow.find(".flow-workspace-container");_ui.workspaceList = _ui.workspaceContainer.find("#workspaceList");_ui.workspaceMenuBtn = _ui.workspaceContainer.find("button.dropdown-toggle");_ui.workspaceMenu = _ui.workspaceContainer.find("#workspaceMenu");_ui.createWorkspaceBtn = _ui.workspaceMenu.find("a.create-workspace-btn");_ui.deleteWorkspaceBtn = _ui.workspaceMenu.find("a.delete-workspace-btn");_ui.importWorkspaceBtn = _ui.workspaceMenu.find("a.import-workspace-btn");_ui.exportWorkspaceBtn = _ui.workspaceMenu.find("a.export-workspace-btn");_ui.workspaceSettingsBtn = _ui.workspaceMenu.find("a.workspace-settings-btn");_ui.sliderContainer = _ui.flow.find(".flow-slider-container");_ui.autoFormatBtn = _ui.sliderContainer.find(".flow-slider-auto-format button");_ui.modeTrigger = _ui.sliderContainer.find(".flow-slider-mode button");_ui.addViewTrigger = _ui.sliderContainer.find(".flow-slider-create-view button");_ui.sliderElement = _ui.sliderContainer.find(".flow-slider");_ui.zoomResetBtn = _ui.sliderContainer.find(".flow-slider-reset");_ui.zoomInBtn = _ui.sliderContainer.find(".flow-slider-zoom-in");_ui.zoomOutBtn = _ui.sliderContainer.find(".flow-slider-zoom-out");_ui.dropOverlay = _ui.canvas.find("#flowDropOverLay");_ui.portTemplate = _ui.flow.find("#flowPortTemplate");_ui.savedStatusLabel = _ui.flow.find(".save-status-label");_ui.processBar = $("#flowsProcessBar");_ui.processBarMsg = $("#flowsProcessBarMsg");_ui.processBarMsgDiv = $("#processMessageDiv");_ui.redoBtn = _ui.sliderContainer.find(".flow-slider-redo button");_ui.undoBtn = _ui.sliderContainer.find(".flow-slider-undo button");var _portCollection = {};var _apiCollection = {};var _viewCollection = {};var _slider = $();var currentWorkspace = null;var isSaved = true;var mode = rsb.workflow.dragMode;var refreshTimer = null;var showPendingMessagesInfo = {"defaultCount": 6};var addedPorts = false;var automationInfo = null;var actionPlayer = new ActionPlayer();var isSaving = false;var hasActionCache = false;var isInitializing = false;var workspaceFinish = false;var connectorFinish = false;const _layoutAlgorithms = {};var addView = function($view) {_viewCollection[$view.name] = $view}
var addFlowAPI = function($flowAPI) {_apiCollection[$flowAPI.getKey()] = $flowAPI}
var getFlowAPIIndex = function ($apiKey) {var $flowAPI = _apiCollection[$apiKey];if (!!$flowAPI && $flowAPI.getKey() === $apiKey) return $apiKey;for (var $index in _apiCollection) {if (_apiCollection[$index].getKey() === $apiKey) return $index}
return $apiKey}
var addPort = function ($port, $preparePort) {_portCollection[$port.getPortStyleKey()] = $port;$port.appendToUI(_ui.portContainer, $preparePort);if ($preparePort) {return} else {setTimeout( () => {getAutomationInfo(rsb.workflow.flow.getCurrentWorkspace(), $port.getPortId(), (result) => {$port.fireUpdateAutomationInfo({outputDefs: result["outputdefs"][0], extensionDefs: result["flowextensiondefs"][0], receiveEnabled: result["receiveenabled"][0], flowUiStyle: result["flowuistyle"][0]})})}, 0)}
setTimeout(saveFlow, 1000, false)}
var createPort = function ($portId, $portType, $position, $width, $style, $desc) {if (!$position) {var bottom;var left;for (var portStyleKey in _portCollection) {var portInfo = _portCollection[portStyleKey].getPortInfo();var portTop = portInfo.posY;var portLeft = portInfo.posX;if (typeof(bottom) == 'undefined') {bottom = portTop;left = portLeft}
if (portTop > bottom) {bottom = portTop}
if (portLeft < left) {left = portLeft}}
$position = {left: left, top: bottom + 65};rsb.workflow.apiGroupMgr.getGroups().forEach(function ($group) {var $groupEl = $group.el;if ($position.left + 295 > $groupEl.offsetLeft && $position.left < $groupEl.offsetLeft + $groupEl.offsetWidth && $position.top > $groupEl.offsetTop && $position.top < $groupEl.offsetTop + $groupEl.offsetHeight) {$position.top = $groupEl.offsetTop + $groupEl.offsetHeight + 30;return false}})}
var newPort = new Port({portId: $portId,portType: $portType,desc: $desc ? ($desc.length > 300 ? ($desc.substring(0, 300) + "...") : $desc) : "",style: $style,position: $position,width: $width,onDragged: function ($originalEvent, $draggedPosition, $dropToGroupMap) {if (!rsb.workflow.hasWorkspacePrivilege("ModifyFlow")) { return false; }
var originPosition = $.extend({ top: 0, left: 0 }, this.position || {});if (originPosition.top === $draggedPosition.top && originPosition.left === $draggedPosition.left) { return; }
$dropToGroupMap = $.extend({}, $dropToGroupMap || {});Object.keys($dropToGroupMap).length <= 0 && saveFlow(false);if (!!this.style) { return; }
var draggedPosition = $draggedPosition;var selectedPorts = _ui.portContainer.find('.flow-port.ui-selected');var draggedPortsElement = [];var positionList = [];let $draggedGroups = [];var isRemovedFromGroup = false;var $originalGroup = rsb.workflow.apiGroupMgr.getGroupFor($originalEvent.currentTarget);if (selectedPorts.length > 0) {var deltaLeft = $draggedPosition.left - originPosition.left;var deltaTop = $draggedPosition.top - originPosition.top;for (let index = 0; index < selectedPorts.length; index++) {var currentPort = _portCollection[selectedPorts[index].id];var currentPortPosition = rsb.workflow.getPosition(currentPort.getUIElement());positionList.push({"portId": selectedPorts[index].id,"currentPorWidth": currentPort.width,"currentPositionTop": currentPortPosition.top,"currentPositionLeft": currentPortPosition.left,"originPositionTop": currentPortPosition.top - deltaTop,"originPositionLeft": currentPortPosition.left - deltaLeft});draggedPortsElement.push(currentPort.getUIElement());currentPort.setPortPosition(currentPortPosition)}
_ui.canvas.find(".apigroup.ui-selected").each(function () {let $group = $(this);let $position = rsb.workflow.getPosition($group);$draggedGroups.push({"group": $group,"currentPositionTop": $position.top,"currentPositionLeft": $position.left,"originPositionTop": $position.top - deltaTop,"originPositionLeft": $position.left - deltaLeft})})} else {draggedPortsElement.push(_portCollection[this.portId].getUIElement());this.position = $draggedPosition;if ($originalGroup) {var $groupEl = $originalGroup.el;if (draggedPosition.top + rsb.workflow.flow.getPort($portId).getUIElement()[0].offsetHeight < $groupEl.offsetTop ||
draggedPosition.top > $groupEl.offsetTop + $groupEl.offsetHeight ||
draggedPosition.left > $groupEl.offsetLeft + $groupEl.offsetWidth ||
draggedPosition.left + $width < $groupEl.offsetLeft) {isRemovedFromGroup = true}}
positionList.push({"portId": this.portId,"currentPorWidth": this.width,"currentPositionTop": draggedPosition.top,"currentPositionLeft": draggedPosition.left,"originPositionTop": originPosition.top,"originPositionLeft": originPosition.left})}
if ($originalEvent) {actionPlayer.recordAction(function () {var $destGroup = null;for (let index = 0; index < draggedPortsElement.length; index++) {var positionLeft = positionList[index].currentPositionLeft;var positionTop = positionList[index].currentPositionTop;if (isRemovedFromGroup) {$destGroup = $originalGroup;jsPlumb.removeFromGroup($originalGroup.id, draggedPortsElement[index][0]);var endpoints = rsb.workflow.flow.removeClassFromPort($portId, "", $originalGroup.id);rsb.workflow.flow.adjustDOMOrder(endpoints, draggedPortsElement[index][0]);jsPlumb.repaintEverything()} else if (!!$dropToGroupMap[draggedPortsElement[index][0].id]) {$destGroup = $dropToGroupMap[draggedPortsElement[index][0].id];$(draggedPortsElement[index][0]).addClass('recordAction');jsPlumb.addToGroup($destGroup.id, draggedPortsElement[index][0]);$(draggedPortsElement[index][0]).removeClass('recordAction');positionLeft -= $destGroup.el.offsetLeft;positionTop -= $destGroup.el.offsetTop} else if ($originalGroup) {positionLeft -= $originalGroup.el.offsetLeft;positionTop -= $originalGroup.el.offsetTop}
draggedPortsElement[index].addClass("window").css({"position": "absolute","top": positionTop + "px","left": positionLeft + "px","width": positionList[index].currentPorWidth + "px"});_portCollection[positionList[index].portId].setPortPosition({"left": positionList[index].currentPositionLeft,"top": positionList[index].currentPositionTop})}
rsb.forEach($draggedGroups, function ($groupInfo) {$groupInfo.group.css({"left": $groupInfo.currentPositionLeft,"top": $groupInfo.currentPositionTop})});$destGroup && rsb.workflow.apiGroupMgr.validateGroup(rsb.workflow.apiGroupMgr.getFlowAPI($destGroup));$draggedGroups.length > 0 && jsPlumb.repaintEverything()}, function () {var $destGroup = null;for (let index = 0; index < draggedPortsElement.length; index++) {var positionLeft = positionList[index].originPositionLeft;var positionTop = positionList[index].originPositionTop;if (isRemovedFromGroup) {$destGroup = $originalGroup;$(draggedPortsElement[index][0]).addClass('recordAction');jsPlumb.addToGroup($originalGroup.id, draggedPortsElement[index][0]);$(draggedPortsElement[index][0]).removeClass('recordAction');rsb.workflow.flow.addClassToPort($portId, $originalGroup.id);positionLeft -= $originalGroup.el.offsetLeft;positionTop -= $originalGroup.el.offsetTop} else if (!!$dropToGroupMap[draggedPortsElement[index][0].id]) {$destGroup = $dropToGroupMap[draggedPortsElement[index][0].id];jsPlumb.removeFromGroup($destGroup.id, draggedPortsElement[index][0]);var endpoints = rsb.workflow.flow.removeClassFromPort(draggedPortsElement[index][0].id, "", $destGroup.id);rsb.workflow.flow.adjustDOMOrder(endpoints, draggedPortsElement[index][0]);jsPlumb.repaintEverything()} else if ($originalGroup) {positionLeft -= $originalGroup.el.offsetLeft;positionTop -= $originalGroup.el.offsetTop}
draggedPortsElement[index].addClass("window").css({"position": "absolute","top": positionTop + "px","left": positionLeft + "px","width": positionList[index].width + "px"});_portCollection[positionList[index].portId].setPortPosition({"left": positionList[index].originPositionLeft,"top": positionList[index].originPositionTop})}
rsb.forEach($draggedGroups, function ($groupInfo) {$groupInfo.group.css({"left": $groupInfo.originPositionLeft,"top": $groupInfo.originPositionTop})});$destGroup && rsb.workflow.apiGroupMgr.validateGroup(rsb.workflow.apiGroupMgr.getFlowAPI($destGroup));$draggedGroups.length > 0 && jsPlumb.repaintEverything()})}}}, _ui.portTemplate.clone().removeClass("hidden"));return newPort}
var portDeletedHandler = function ($port, $portId, $result) {var group = jsPlumb.getGroupFor($port.getUIElement()[0]);if (group) {jsPlumb.removeFromGroup(group, $port.getUIElement()[0])}
rsb.workflow.portSettings.revertChanges()
deletePortFromUI(rsb.workflow.flow.getPort($portId, "sender"));if ($result && $result["other:error"]) {rsb.showResult(rsb.workflow.resultContainer, $result["other:error"], "error")} else if ($result && $result["other:warning"]) {rsb.showResult(rsb.workflow.resultContainer, $result["other:warning"], "warning")}
if (rsb.workflow.hasWorkspacePrivilege("ModifyFlow")) {saveFlow(false)}
if (group) {var flowAPI = rsb.workflow.apiGroupMgr.getFlowAPI(group);rsb.workflow.apiGroupMgr.validateGroup(flowAPI)}
actionPlayer.cleanUpActions()}
var deleteItemImpl = function ($apiList, $ports, $index) {if (rsb.checkInfoModalState($index, $apiList.length + $ports.length)) {var $item = $index < $apiList.length ? $apiList[$index] : $ports[$index - $apiList.length];rsb.changeInfoModalMessage($index >= $apiList.length ? 'Delete&nbsp;Connector&nbsp;'+ $item.getPortId() : 'Delete&nbsp;API&nbsp;Settings&nbsp;'+ $item.name + " (" + $item.method + ")");var $handler = function (data, $successCallback) {$index++;rsb.increaseInfoModalProgress();var errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.closeInfoModal();rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else {!!$successCallback && $successCallback($item);deleteItemImpl($apiList, $ports, $index)}}
$index >= $apiList.length && rsb.connect.deleteOnePort(rsb.workflow.flow.getCurrentWorkspace(), $item.getPortId(), function (data, textStatus, jqXHR, $workspaceid, $connectorid) {$handler(data, function ($port) {portDeletedHandler($port, $connectorid, data.items && data.items[0])})});$index < $apiList.length && deleteFlowAPIImpl($item, function (data, $api) {$handler(data)})} else {rsb.closeInfoModal()}}
var deleteFlowAPIImpl = function ($flowAPI, $callback) {$.ajax({dataType: "json",url: "src/flowapis.rsd",type: "DELETE",data: {"@json": true,"workspaceid": rsb.workflow.flow.getCurrentWorkspace(),"apiname": $flowAPI.name,"httpmethod": $flowAPI.method},success: function (data, textStatus, jqXHR) {var errorMsg = rsb.getResultErrorMessage(data["items"]);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else {rsb.workflow.apiGroupMgr.deleteGroup($flowAPI);rsb.workflow.nav.removeFlowAPI($flowAPI);delete _apiCollection[getFlowAPIIndex($flowAPI.getKey())];rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('The flow API "$name$ ($method$)" has been deleted.', {name: $flowAPI.name,method: $flowAPI.method}), true);saveFlow(false);rsb.workflow.updatePageHash(rsb.workflow.flow.getCurrentWorkspace(), "", "")}
!!$callback && $callback(data, $flowAPI)}})}
var deleteItems = function ($ports, $groups) {var $apiList = [];$ports = $ports || [];!!$groups && rsb.forEach($groups, function ($group) {var $flowAPI = rsb.workflow.apiGroupMgr.getFlowAPI($group[0]);!!$flowAPI && $apiList.push($flowAPI);!!$flowAPI && rsb.forEach($flowAPI.connectors, function ($connectorId) {var $connector = rsb.workflow.flow.getPort($connectorId);!!$connector && $ports.push($connector)})});if ($apiList.length <= 0) {rsb.workflow.flow.deletePort($ports)} else if (!$ports || $ports.length <= 0) {rsb.workflow.flow.deleteFlowAPI($apiList)} else {var $message = "<p>" + 'This operation can not be undone, are you sure you want to delete these Items?'+ " </p><div class=\"form-group row mb-3\">";$message += "<p><b>Connectors:</b> " + $ports.reduce(function ($result, $port, $index) {return $result + ($index > 0 ? ", " : "") + rsb.htmlEncode($port.getPortId())}, "") + "</p>";$message += "<p><b>API Settings:</b> " + $apiList.reduce(function ($result, $flowAPI, $index) {return $result + ($index > 0 ? ", " : "") + rsb.htmlEncode($flowAPI.name) + " (" + rsb.htmlEncode($flowAPI.method) + ")"}, "") + "</p>"
+ "</div>";rsb.confirmModal({title: 'Delete Items',body: $message,okText: 'Yes',cancelText: 'No',ok: function () {rsb.showInfoModal('Delete Items', "", false, true, $apiList.length + $ports.length, true);deleteItemImpl($apiList, $ports, 0)}})}}
var exportItems = function ($ports, $groups) {var newPorts = [];if (!($ports instanceof Array)) {newPorts.push($ports)} else {newPorts = $ports}
var portList = [];for (var index in newPorts) {var port = newPorts[index];portList.push(port.getPortId())}
var uniqPortList = portList.reduce(function ($arr, $ele) {$arr.indexOf($ele) < 0 && $arr.push($ele);return $arr}, []);$groups = ($groups || []).reduce(function ($array, $group) {var $flowAPI = rsb.workflow.apiGroupMgr.getFlowAPI($group[0]);!!$flowAPI && $array.push(($flowAPI.name + $flowAPI.method).toLowerCase());$flowAPI.connectors.forEach(function($connector) {uniqPortList.push($connector)});return $array}, []);rsb.workflow.currentWorkspaceId = rsb.workflow.flow.getCurrentWorkspace();rsb.workflow.selectedConnectors = uniqPortList.join(";");rsb.workflow.selectedGroups = $groups;$("#flowConnectorsMigrationExportModal").modal("show")}
var copyConnector = function($ports, $group) {if (!rsb.workflow.hasWorkspacePrivilege("CreateConnector")) return;var redoPorts = [];var portContainer = {portid: new Array($ports.length),copyportid: new Array($ports.length),copyporttype: new Array($ports.length),style: new Array($ports.length),sendto: new Array($ports.length),trapport: new Array($ports.length),srcworkspace: rsb.workflow.flow.getCurrentWorkspace(),dstworkspace: rsb.workflow.flow.getCurrentWorkspace(),hasConnection: false};var maxTop = 0, minSelectedTop = 0, maxSelectedTop = 0;for (var index in $ports) {var port = $ports[index];var portInfo = port.getPortInfo();portContainer.portid[index] = portInfo.connectorId || "";portContainer.copyporttype[index] = portInfo.connectorType || "";portContainer.style[index] = portInfo.style || "";portContainer.sendto[index] = portInfo.sendPort || {};portContainer.trapport[index] = portInfo.trapPort || "";if (getPortConnected(port)) {portContainer.hasConnection = true}
if (portInfo.posY > maxTop) {maxTop = portInfo.posY}
if (portInfo.posY > maxSelectedTop) {maxSelectedTop = portInfo.posY}
if (minSelectedTop == 0) {minSelectedTop = maxSelectedTop}
if (portInfo.posY < minSelectedTop) {minSelectedTop = portInfo.posY}}
var srcList = [];for (var index in $ports) {var $port = $ports[index];srcList.push($port.getPortId())}
var portid = new Array(portContainer.portid.length);for (var index in portContainer.portid) {portid[index] = portContainer.portid[index] + "_Copy"}
rsb.workflow.getNextPortId(portid, function($nextPortId) {if ($nextPortId instanceof Array) {for (var index in $nextPortId) {portContainer.copyportid[index] = $nextPortId[index]}} else {portContainer.copyportid[0] = $nextPortId}
var offsetPosX = $group.length > 0 ? $group[0].offsetWidth : 0;rsb.connect.copyConnectorModal(portContainer, function(result) {if (result.position) {if (minSelectedTop == 0) {minSelectedTop = result.position.top}
result.position.top = maxTop + result.position.top - minSelectedTop + 80;result.position.left = result.position.left + offsetPosX}
var newPort = createPort(result.connectorid, result.connectortype, result.position, result.width, result.style, result.desc);addPort(newPort);if (result.style) {rsb.workflow.flow.getPort(result.srcconnectorid + "_" + result.style).fireSelect(false);rsb.workflow.flow.getPort(result.connectorid + "_" + result.style).fireSelect(true)} else {rsb.workflow.flow.getPort(result.srcconnectorid).fireSelect(false);rsb.workflow.flow.getPort(result.connectorid).fireSelect(true)}
if (redoPorts.length === 0) {actionPlayer.recordAction(function () {}, function () {var newPorts = redoPorts;rsb.workflow.flow.deletePort(newPorts)})}
redoPorts.push(newPort);saveFlow(true);rsb.workflow.nav.addPort(newPort);if (!result.position) {rsb.workflow.flow.showPortInCenter(newPort)}}, function(portid) {deletePortFromUI(rsb.workflow.flow.getPort(portid, "sender"))}, switchWorkspace)})}
var splitConnector = function ($ports, $notRecordAction) {$ports.forEach(function($port) {if (!$port.getStyle() && rsb.workflow.nav.isTransportPort($port.getPortType())) {var currentPort = $port;var currentPortInfo = currentPort.getPortInfo();var originalPos = {left: currentPortInfo.posX, top: currentPortInfo.posY };var connectorId = currentPort.getPortId();var connectorType = currentPort.getPortType();var receiveFromPort = rsb.workflow.flow.findReceiveFromPort(currentPort.getPortId());currentPort.removeFromUI();delete _portCollection[currentPort.getPortStyleKey()];var receiverPort = createPort(connectorId, connectorType, originalPos, currentPortInfo.width * 0.8, "receiver", currentPort.getDesc());addPort(receiverPort);var senderPort = createPort(connectorId, connectorType, {left: originalPos.left + currentPortInfo.width * 0.8 + 4, top: originalPos.top}, currentPortInfo.width * 0.8, "sender", currentPort.getDesc());addPort(senderPort);if (currentPortInfo.sendPort) {for (var name in currentPortInfo.sendPort) {senderPort.connectTo(rsb.workflow.flow.getPort(currentPortInfo.sendPort[name], "receiver"), name)}}
if (currentPortInfo.trapPort) {receiverPort.trapTo(rsb.workflow.flow.getPort(currentPortInfo.trapPort, "receiver"))}
if (currentPortInfo.successPort) {receiverPort.successTo(rsb.workflow.flow.getPort(currentPortInfo.successPort, "receiver"))}
if(receiveFromPort) {receiveFromPort.forEach(function($info) {$info.outputs.forEach(function($output) {if ($output === "trap") {$info.port.trapTo(receiverPort)} else if ($output === "success") {$info.port.successTo(receiverPort)} else {$info.port.connectTo(receiverPort, $output)}})})}
saveFlow(false);if (!$notRecordAction) {var portStyleKey = $port.getPortStyleKey();actionPlayer.recordAction(function () {var mergedPort = _portCollection[portStyleKey];var mergedPorts = [];mergedPorts.push(mergedPort);splitConnector(mergedPorts, true)}, function () {var splitedPort = [];splitedPort.push(rsb.workflow.flow.getPort($port.getPortId(), "receiver"));mergeConnectors(splitedPort, true)})}}})}
var mergeConnectors = function ($ports, $notRecordAction) {var splitPorts = {};$ports.forEach(function($port){if ($port.getStyle()) {splitPorts[$port.getPortId()] = {...splitPorts[$port.getPortId()], [$port.getStyle()]: $port}}});if (Object.values(splitPorts).length <= 0) {rsb.showResult(rsb.workflow.resultContainer, 'Only these split ports can be merged, please choose the split port.', false)} else {Object.values(splitPorts).forEach(function($pair){var senderPort = $pair["sender"];var receiverPort = $pair["receiver"];if (senderPort || receiverPort) {senderPort = senderPort || rsb.workflow.flow.getPort(receiverPort.getPortId(), "sender");receiverPort = receiverPort || rsb.workflow.flow.getPort(senderPort.getPortId(), "receiver");if (senderPort && receiverPort) {var senderInfo = senderPort.getPortInfo();var receiverInfo = receiverPort.getPortInfo();var portId = receiverPort.getPortId();var receiveFromPort = rsb.workflow.flow.findReceiveFromPort(portId);var clickInfo = $pair["sender"] ? senderInfo : receiverInfo;var mergedPos = {left: clickInfo.posX, top: clickInfo.posY };receiverPort.removeFromUI();delete _portCollection[receiverPort.getPortStyleKey()];senderPort.removeFromUI();delete _portCollection[senderPort.getPortStyleKey()];var mergedPort = createPort(portId, receiverPort.getPortType(), mergedPos, ((senderInfo.width / 0.8 + receiverInfo.width / 0.8) / 2), null, receiverPort.getDesc());addPort(mergedPort);if (senderInfo.sendPort) {for (var name in senderInfo.sendPort) {mergedPort.connectTo(rsb.workflow.flow.getPort(senderInfo.sendPort[name], "receiver"), name)}}
if (receiverInfo.trapPort) {mergedPort.trapTo(rsb.workflow.flow.getPort(receiverInfo.trapPort, "receiver"))}
if (receiverInfo.successPort) {mergedPort.successTo(rsb.workflow.flow.getPort(receiverInfo.successPort, "receiver"))}
if(receiveFromPort) {receiveFromPort.forEach(function($info) {$info.outputs.forEach(function($output) {if ($output === "trap") {$info.port.trapTo(mergedPort)} else if ($output === "success") {$info.port.successTo(mergedPort)} else {$info.port.connectTo(mergedPort, $output)}})})}
saveFlow(false);if (!$notRecordAction) {var portStyleKey = mergedPort.getPortStyleKey();actionPlayer.recordAction(function () {var splitPorts = [];splitPorts.push(rsb.workflow.flow.getPort(mergedPort.getPortId(), "receiver"));mergeConnectors(splitPorts, true)}, function () {var mergedPort = _portCollection[portStyleKey];var mergedPorts = [];mergedPorts.push(mergedPort);splitConnector(mergedPorts, true)})}}}})}}
var createFlowAPI = function ($ports) {var $isLegal = true;var $connectors = [];var $portIds = [];$ports.forEach($port => {$portIds.push($port.getPortId())});$ports.forEach($port => {if (!rsb.workflow.isAPIAble($port.getPortType())) {$isLegal = false;rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('API Settings cannot be added to flows containing a $type$ connector.', {type: $port.getPortType()}), false)} else if (!rsb.workflow.flow.isAllConnectionInAPI($port, $portIds)) {$isLegal = false;rsb.showResult(rsb.workflow.resultContainer, 'Selected connectors have connections outside the API.', false)}
$isLegal && $connectors.push($port.getPortId());return $isLegal});$isLegal && rsb.workflow.getNextAPIName(currentWorkspace, function ($apiName) {rsb.createFlowAPI(currentWorkspace, $apiName, function ($name, $method) {var $flowAPI = new FlowAPI({name: $name, method: $method, connectors: $connectors});addFlowAPI($flowAPI);rsb.workflow.apiGroupMgr.createGroup($flowAPI);rsb.workflow.nav.addFlowAPI($flowAPI);saveFlow(false);rsb.workflow.updatePageHash(currentWorkspace, "api:" + $name + ":" + $method, "");rsb.workflow.flow.getActionPlayer().recordAction(function () {}, function () {rsb.workflow.flow.deleteFlowAPI($flowAPI)})})})}
var asyncPrepareConnectors = function(ports, callback){var worker = function(ports, index, callback) {var chunkSize = 50;var connectorCount = ports.length;var iterNum = Math.ceil(connectorCount / chunkSize);setTimeout(function() {if (index < iterNum) {for (var i = 0; i < chunkSize; i++) {var offset = index * chunkSize + i;if (offset < ports.length) {var $port = ports[offset];var portId = $port.connectorId;var portType = $port.connectorType;$port.nodes.forEach(function($node) {var port = createPort(portId, portType, {left: $node.posX, top: $node.posY}, $node.width, $node.style);addPort(port, true);rsb.workflow.nav.addPort(port)})} else {callback && callback();return}}
worker(ports, index + 1, callback)} else {callback && callback()}},0)}
worker(ports, 0, callback)}
var prepareConnections = function(ports){ports.forEach(function($port) {var sourcePort = rsb.workflow.flow.getPort($port.connectorId, "sender");$port.connections.forEach(function($connection) {if (typeof($connection) == "object") {if ($connection.output === "trap") {sourcePort = rsb.workflow.flow.getPort($port.connectorId, "receiver");sourcePort.trapTo(rsb.workflow.flow.getPort($connection.dest, "receiver"));sourcePort = rsb.workflow.flow.getPort($port.connectorId, "sender")} else if ($connection.output === "success") {sourcePort = rsb.workflow.flow.getPort($port.connectorId, "receiver");sourcePort.successTo(rsb.workflow.flow.getPort($connection.dest, "receiver"));sourcePort = rsb.workflow.flow.getPort($port.connectorId, "sender")} else {sourcePort.connectTo(rsb.workflow.flow.getPort($connection.dest, "receiver"), $connection.output)}} else {sourcePort.connectTo(rsb.workflow.flow.getPort($connection, "receiver"), "")}})})};var ensureConnectors = function(ports, $callback){if(!ports || ports.length <= 0){_ui.flow.removeClass("flow-loading");rsb.workflow.nav.fireFlowReady(true);saveFlow(true);return}else{var oriProcessBarHtml = _ui.processBar.html();_ui.processBar.html('Preparing Connectors ...');asyncPrepareConnectors(ports, function() {addedPorts = true;_ui.processBar.html('Preparing Connections ...');afterGetAutomationInfo();prepareConnections(ports);_ui.flow.removeClass("flow-loading");rsb.workflow.nav.fireFlowReady(true);_ui.processBar.html(oriProcessBarHtml);saveFlow(true);_ui.processBarMsgDiv.addClass("hidden");!!$callback && $callback()})}}
var ensureAPIs = function ($apis, $callback) {rsb.workflow.listAPIEntities(rsb.workflow.flow.getCurrentWorkspace(), function ($apiEntities) {if (!$apiEntities) return false;var $apiList = [];!!$apis && $apis.length && $apis.forEach(function ($api) {if (!!$apiEntities[$api.name.toUpperCase()] && $apiEntities[$api.name.toUpperCase()].indexOf($api.method.toUpperCase()) >= 0) {var $flowAPI = new FlowAPI($api);$apiList.push($flowAPI);$apiEntities[$api.name.toUpperCase()].splice($apiEntities[$api.name.toUpperCase()].indexOf($api.method.toUpperCase()), 1)}});for (var $apiName in $apiEntities) {rsb.forEach($apiEntities[$apiName], function ($httpMethod) {var $flowAPI = new FlowAPI({name: $apiName, method: $httpMethod});$apiList.push($flowAPI)})}
loadAPI($apiList, 0, $callback)})}
var loadAPI = function ($apiList, $index, $callback) {if ($index < $apiList.length) {var $flowAPI = $apiList[$index];$.ajax({url: "src/flowapis.rsd",type: "GET",data: {"@json": true,"WorkspaceId": rsb.workflow.flow.getCurrentWorkspace(),"APIName": $flowAPI.name,"HTTPMethod": $flowAPI.method},dataType: "json",success: function (data) {var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else {addFlowAPI($flowAPI);rsb.workflow.nav.addFlowAPI($flowAPI);rsb.workflow.apiGroupMgr.createGroup($flowAPI);rsb.workflow.apiGroupMgr.updateGroupSettings($flowAPI, result[0])}
loadAPI($apiList, $index + 1, $callback)}})} else {!!$callback && $callback()}}
var getWorkflow = function($workspace, $callback) {currentWorkspace = $workspace;_ui.workspaceList.find(".workspace-name").text($workspace);$.ajax({url: "src/workflow.rsd",type: "GET",data: { "@json": true, "workspaceid": $workspace, "_randomtoken": rsb.securityRand() },dataType: "json"}).done(function(data, textStatus, jqXHR) {var flowResult = data["items"];var errorMsg = rsb.getResultErrorMessage(flowResult);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else if (flowResult[0]) {flowResult = rsb.workflow.normalizeResponse(flowResult[0]);if ($callback != null) {$callback($workspace, flowResult)}}});rsb.workflow.updateFlowinSession()}
var afterGetWorkflow = function(workspace, flowResult) {var afterLoaded = function () {var event;if (typeof(Event) === 'function') {event = new Event('hashchange')} else {event = document.createEvent('Event');event.initEvent('hashchange', true, true)}
window.dispatchEvent(event)}
var portCount = 0;var jsonData = flowResult["jsondata"];if (jsonData && jsonData.length > 0) {var obj = JSON.parse(flowResult.jsondata[0]);var ports = obj.ports;portCount = ports.length;isInitializing = true;const finishInitializing = () => {isInitializing = false;saveFlow(!hasActionCache);_ui.flow.removeClass("flow-loading");rsb.workflow.nav.fireFlowReady(true);afterLoaded()};getWorkspace(workspace);if (ports.length > 0) {ensureConnectors(ports, () => {getConnectors(workspace);if (obj.apis.length > 0) {ensureAPIs(obj.apis, () => {finishInitializing()})} else {finishInitializing()}})} else {connectorFinish = true;finishInitializing()}
var views = obj.views;views.forEach(function ($view) {var view = new View({name: $view.name,zoom: $view.zoom,zoomOrigin: $view.zoomOrigin,posX: $view.posX,posY: $view.posY});addView(view);rsb.workflow.nav.addView(view)})} else {finishInitializing()}
if (currentWorkspace == "Default") {_ui.deleteWorkspaceBtn.hide()} else {_ui.deleteWorkspaceBtn.show()}
saveFlow(true);_ui.portContainer.css("display", "none");_ui.portContainer.fadeIn(function() {rsb.workflow.flow.resize();rsb.workflow.portSettings.init();var portCount = _ui.portContainer.find(".flow-port").length;if (portCount > 0) {afterLoaded();getUnsendCount(workspace)} else {var userList = window.localStorage.getItem("cdata.arc.flow.usagenotifiedusers");if (userList == null) {userList = []} else {userList = userList.split(",")}
if (!userList.includes(rsb.workflow.currentUser)) {userList.push(rsb.workflow.currentUser);window.localStorage.setItem("cdata.arc.flow.usagenotifiedusers", userList);rsb.confirmModal({title: 'Flow Designer',body: 'Get started designing your flow by dragging a connector from the pane on the left and dropping it into the canvas. Connectors in the canvas can be connected to each other by dragging the arrow on the right side of one connector onto the empty bubble on the left side of another connector.',enableCancelBtn: false})}}})}
var afterGetAutomationInfo = function() {if (addedPorts && automationInfo != null) {var infoLength = automationInfo["portid"] ? automationInfo["portid"].length : 0;for (var i = 0; i < infoLength; i++) {var sourcePort = rsb.workflow.flow.getPort(automationInfo["portid"][i], "sender");if (sourcePort) {sourcePort.fireUpdateAutomationInfo({outputDefs: automationInfo["outputdefs"][i], extensionDefs: automationInfo["flowextensiondefs"][i], receiveEnabled: automationInfo["receiveenabled"][i], flowUiStyle: automationInfo["flowuistyle"][i]})}}}};var getAutomationInfo = function($workspace, $portid, $callback) {var data = { "@json": true, "workspaceid": $workspace, "random": rsb.securityRand() }
if ($portid != null) {data.portid = $portid}
$.ajax({url: "src/getConnectorAutomationInfo.rsb",type: "GET",data: data,dataType: "json"}).done(function(data, textStatus, jqXHR) {var automationInfoResult = data["items"];var errorMsg = rsb.getResultErrorMessage(automationInfoResult);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else if (automationInfoResult[0]) {if ($callback != null) {$callback(rsb.workflow.normalizeResponse(automationInfoResult[0]))}}})}
const getWorkspace = (workspaceId) => {rsb.connectorList = rsb.connectorList || {};rsb.connectorList[workspaceId.toLowerCase()] = rsb.connectorList[workspaceId.toLowerCase()] || {};$.ajax({url: "api/workspaces.rsd?@json&WorkspaceId=" + encodeURIComponent(workspaceId) + "&pushprivileges=true&random=" + rsb.securityRand(),type: "GET",dataType: "json"}).done(function(data, textStatus, jqXHR) {const result = data["items"];const errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else if (result[0]) {rsb.connectorList[workspaceId.toLowerCase()]["id"] = result[0]["workspaceid"];rsb.connectorList[workspaceId.toLowerCase()]["allowedPrivileges"] = result[0]["allowedprivileges"].toLowerCase().split(",");if (result[0]["allowedconnectortype"]) {rsb.connectorList[workspaceId.toLowerCase()]["allowedConnectorType"] = result[0]["allowedconnectortype"].toLowerCase().split(",")}
rsb.connectorList[workspaceId.toLowerCase()].connectors = rsb.connectorList[workspaceId.toLowerCase()].connectors || {}}
workspaceFinish = true;if (workspaceFinish && connectorFinish) {updatePrivilege();updateIcons()}})}
const getConnectors = (workspaceId) => {rsb.connectorList = rsb.connectorList || {};rsb.connectorList[workspaceId.toLowerCase()] = rsb.connectorList[workspaceId.toLowerCase()] || {};rsb.connectorList[workspaceId.toLowerCase()]["connectors"] = rsb.connectorList[workspaceId.toLowerCase()]["connectors"] || {};$.ajax({url: "src/listConnectors.rsb?@json&WorkspaceId=" + encodeURIComponent(workspaceId) + "&pushprivileges=true&pushdescription=true&random=" + rsb.securityRand(),type: "GET",dataType: "json"}).done(function(data, textStatus, jqXHR) {const result = data["items"];const errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else if (result[0]) {const map =  rsb.connectorList[workspaceId.toLowerCase()]["connectors"];result.forEach((output) => {map[output["portid"].toLowerCase()] = {"id": output["portid"],"allowedPrivileges": output["allowedprivileges"].toLowerCase().split(","),"description": output["description"],"type": output["porttype"]}})}
connectorFinish = true;if (workspaceFinish && connectorFinish) {updatePrivilege();updateIcons()}})}
const updatePrivilege = () => {_ui.autoFormatBtn.toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));_ui.redoBtn.toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));_ui.undoBtn.toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));_ui.addViewTrigger.toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));_ui.createWorkspaceBtn.toggleClass("hidden", !rsb.workflow.isStandardOrAdmin);_ui.deleteWorkspaceBtn.toggleClass("hidden", !rsb.workflow.isStandardOrAdmin);_ui.importWorkspaceBtn.toggleClass("hidden", !rsb.workflow.isStandardOrAdmin);_ui.exportWorkspaceBtn.toggleClass("hidden", !rsb.workflow.isStandardOrAdmin);rsb.workflow.nav.updatePrivilege();_ui.portContainer.find(".flow-port").each((i, elem) => {const instance = $(elem).data("instance");instance.updatePrivilege()})}
const updateIcons = () => {_ui.portContainer.find(".flow-port").each((i, elem) => {const instance = $(elem).data("instance");var desc = rsb.connectorList[currentWorkspace.toLowerCase()].connectors[instance.getPortId().toLowerCase()].description;instance.upDateDescriptionIcon(desc);instance.updateWarningIcon()})}
var isPortInTheCurrentView = function($port, $view) {var zoomOriginX = parseInt($view.zoomOrigin.substring(0, $view.zoomOrigin.indexOf("px")));var temp = $view.zoomOrigin.substring($view.zoomOrigin.indexOf("px") + 2).trim();var zoomOriginY = parseInt(temp.substring(0, temp.indexOf("px")));var wdw = {left: (-$view.posX - zoomOriginX * (1 - $view.zoom))/$view.zoom,right: (-$view.posX - zoomOriginX * (1 - $view.zoom) + _ui.flow.width())/$view.zoom,top: (-$view.posY - zoomOriginY * (1 - $view.zoom))/$view.zoom,bottom: (-$view.posY - zoomOriginY * (1 - $view.zoom) + _ui.flow.height())/$view.zoom};var info = $port.getPortInfo();if (info.posX > wdw.left && info.posX < wdw.right && info.posY > wdw.top && info.posY < wdw.bottom && info.style != "sender") {return info.connectorId} else {return null}}
var getUnsendCount = function($workspace) {if (!showPendingMessagesInfo.keepalived) {$(document).on("mousemove keydown", function() {showPendingMessagesInfo.count = showPendingMessagesInfo.defaultCount});showPendingMessagesInfo.keepalived = true}
showPendingMessagesInfo.count = showPendingMessagesInfo.defaultCount;getUnsendCountImpl($workspace)}
var getUnsendCountImpl = function($workspace) {if (showPendingMessagesInfo.timeoutHandler) {clearTimeout(showPendingMessagesInfo.timeoutHandler);delete showPendingMessagesInfo.timeoutHandler}
if(!Number.isInteger(showPendingMessagesInfo.count) || showPendingMessagesInfo.count <= 0 || document.visibilityState == "hidden") {showPendingMessagesInfo.count = 0;showPendingMessagesInfo.timeoutHandler = setTimeout(getUnsendCountImpl, 5000, $workspace);return}
var connectorIds = [];for (var port in rsb.workflow.flow.listPorts()) {var connectorId = isPortInTheCurrentView(rsb.workflow.flow.getPort(port), rsb.workflow.flow.getCurrentView());if (connectorId != null && !connectorIds.includes(connectorId)) {connectorIds.push(connectorId)}}
var postData = { "@json": true, "workspaceid": $workspace, "connectorid": connectorIds.join(";"), "_randomtoken": rsb.securityRand() };$.ajax({url: "api/getMessageCount.rsb",type: "GET",data: postData,dataType: "json"}).done(function(data, textStatus, jqXHR) {var results = data["items"];var errorMsg = rsb.getResultErrorMessage(results);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else {var portList = rsb.workflow.flow.listPorts();for (var i = 0; i < results.length; i++) {var portid = results[i].connectorid;var port = portList[portid] || portList[portid + "_receiver"];if (port) {var count = parseInt(results[i].count);port.getUIElement().find(".unsend-count").html(count > 99 ? "99+" : count)}}}
showPendingMessagesInfo.timeoutHandler = setTimeout(getUnsendCountImpl, 5000, $workspace)});showPendingMessagesInfo.count--}
var ensureConnections = function(info, obj){if(!info.sendPort && !info.trapPort && !Array.isArray(obj.connections)) return;if (info.sendPort) {for (var name in info.sendPort) {var connection;if (name.length > 0) {connection = {"dest": info.sendPort[name],"output": name}} else {connection = info.sendPort[name]}
obj.connections.push(connection)}}
if (info.trapPort) {var connection = {"dest": info.trapPort,"output": "trap"}
obj.connections.push(connection)}
if (info.successPort) {var connection = {"dest": info.successPort,"output": "success"}
obj.connections.push(connection)}}
this.registerLayoutAlgorithm = (key, algorithm) => _layoutAlgorithms[key || ""] = algorithm;this.autoLayout = (ports, groups) => {const algorithm = _layoutAlgorithms["TREE"] || _layoutAlgorithms[""];if (!algorithm || typeof algorithm !== "function") return;const toGrid = (v) => Math.round(v / 5) * 5;const stat = (nodes) => {const rect = {sx: Number.MAX_SAFE_INTEGER, sy: Number.MAX_SAFE_INTEGER, ex: Number.MIN_SAFE_INTEGER, ey: Number.MIN_SAFE_INTEGER};nodes.forEach(node => {rect.sx = Math.min(rect.sx, node.x);rect.ex = Math.max(rect.ex, node.x + node.w);rect.sy = Math.min(rect.sy, node.y);rect.ey = Math.max(rect.ey, node.y + node.h)});return rect}
const updateConnectorPosition = (port, position) => {port.setPortPosition(position);port.getUIElement().css({"left": position.left + "px","top": position.top + "px"})};const applyLayout = (actions, actionIndex) => {actions.forEach(action => action[actionIndex].call())
jsPlumb.repaintEverything();rsb.workflow.flow.save()}
const formatAll = groups.length <= 0 && ports.length <=0;const formarGroup = groups.length === 1 && ports.length === 0;const groupsKeys = groups.map(group => rsb.workflow.apiGroupMgr.getFlowAPI(group).getKey());ports = ports.map(port => port.getPortStyleKey());const groupAPI = formarGroup ? rsb.workflow.flow.getFlowAPI(groupsKeys[0]) : null;const excludePorts = [];const nodes = [];const edges = [];const apis = [];for (const apiKey in _apiCollection) {const api = _apiCollection[apiKey];if (!formarGroup && (formatAll || groupsKeys.includes(apiKey))) {rsb.workflow.apiGroupMgr.saveGroup(api)
apis.push({id: "API:" + api.name, x: api.posX, y: api.posY, w: api.width, h: api.height, connections: [], api});excludePorts.splice(-1, 0, ...api.connectors)} else if (!formarGroup && ports.length > 0) {excludePorts.splice(-1, 0, ...api.connectors)}}
for (const portStyleKey in _portCollection) {const port = _portCollection[portStyleKey];const info = port.getPortInfo();if (formarGroup && !groupAPI.connectors.includes(portStyleKey) || !formarGroup && (groups.length > 1 && ports.length === 0 || excludePorts.length > 0 && excludePorts.includes(info.connectorId) || ports.length > 0 && !ports.includes(portStyleKey))) continue;if (formarGroup) {info.posX -= groups[0][0].offsetLeft;info.posY -= groups[0][0].offsetTop}
const node = {id: "CONN:" + portStyleKey, x: info.posX, y: info.posY, w: info.width, h: port.getUIElement().outerHeight(), connections: [], port, posX: info.posX, posY: info.posY};ensureConnections(info, node);const names = node.connections.length > 0 && port.getOutputDefs() != null ? port.getOutputDefs().map(def => def.name.toLowerCase()) : [];node.connections = node.connections.map(connection => {if (typeof connection === "string") {connection = {source: node.id, target: connection, output: ""}} else {connection = {source: node.id, target: connection.dest, output: connection.output.toLowerCase(), bottom: port.getUiStyle() !== 1}}
if (!_portCollection[connection.target] && _portCollection[connection.target + "_receiver"]) connection.target+= "_receiver";connection.target = "CONN:" + connection.target;return connection}).sort((lhs, rhs) => names.indexOf(lhs.output) - names.indexOf(rhs.output));node.connections.forEach(connection => edges.push(connection));nodes.push(node)}
nodes.splice(-1, 0, ...apis);if (nodes.length <= 0) return;const actions = [];const rect = stat(nodes);if (formatAll) {const left = _ui.portContainer.css("left");const top = _ui.portContainer.css("top");const zoomOrigin = rsb.getDraftCssAttribute(_ui.portContainer, "transform-origin");nodes.forEach(node => {node.x -= rect.sx;node.y -= rect.sy});rect.ex -= rect.sx;rect.ey -= rect.sy;rect.sx = rect.sy = 50 / jsPlumb.currentZoom;actions.push([() => {_ui.portContainer.css({left: 0, top: 0});rsb.setDraftCssAttribute(_ui.portContainer, "transform-origin", "center")}, () => {_ui.portContainer.css({left, top});rsb.setDraftCssAttribute(_ui.portContainer, "transform-origin", zoomOrigin)}])}
algorithm(nodes, edges, rect).forEach(node => {const position = {left: toGrid(node.x),top: toGrid(node.y)};if (node.port) {actions.push([updateConnectorPosition.bind(null, node.port, position), updateConnectorPosition.bind(null, node.port, {left: node.posX, top: node.posY})])} else {actions.push(rsb.workflow.apiGroupMgr.moveGroup(node.api, position.left, position.top))}});if (formarGroup) {actions.push(rsb.workflow.apiGroupMgr.resizeGroup(groupAPI, groups[0][0]))}
rsb.workflow.flow.getActionPlayer().recordAction(applyLayout.bind(null, actions, 0), applyLayout.bind(null, actions, 1));applyLayout(actions, 0)}
var saveWorkflow = function($workspace) {if (isInitializing) return;if (!rsb.workflow.hasWorkspacePrivilege("ModifyFlow")) return;isSaving = true;var postData = { "@json": true, "workspaceid": $workspace };var i = 1;var json = {"anchorType": 2, "version": 1, "ports": [], "connections": [], "views": [], "apis": []};var portList = [];for (var portStyleKey in _portCollection) {var info = _portCollection[portStyleKey].getPortInfo();if (!portList.includes(info.connectorId)) {portList.push(info.connectorId);var obj = {"connectorId": info.connectorId,"connectorType": info.connectorType || "","nodes": [{"style": info.style || "","posX": info.posX,"posY": info.posY,"width": info.width}],"connections": []}
ensureConnections(info,obj);json.ports.push(obj)} else {var nodeObj = {"style": info.style || "","posX": info.posX,"posY": info.posY,"width": info.width}
json.ports[portList.indexOf(info.connectorId)].nodes.push(nodeObj);ensureConnections(info,json.ports[portList.indexOf(info.connectorId)])}
i++}
var viewList = [];for (var viewName in _viewCollection) {var view = _viewCollection[viewName];if (!viewList.includes(view.name)) {viewList.push(view.name);var viewObj = {"name": view.name,"zoom": view.zoom,"zoomOrigin": view.zoomOrigin,"posX": view.posX,"posY": view.posY};json.views.push(viewObj)}}
for (var apiKey in _apiCollection) {var api = _apiCollection[apiKey];rsb.workflow.apiGroupMgr.saveGroup(api);json.apis.push({"name": api.name,"method": api.method,"posX": api.posX,"posY": api.posY,"width": api.width,"height": api.height,"start": api.start,"connectors": (api.connectors || []).slice(),"end": (api.end || []).slice()})}
postData["jsondata"] = JSON.stringify(json);$.ajax({url: "src/workflow.rsd",type: "PUT",data: postData,dataType: "json",success: function(data, textStatus, jqXHR) {var errorMsg = rsb.getResultErrorMessage(data["items"]);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else {if (hasActionCache) {saveFlow(false)} else {saveFlow(true)}}}}).fail(function () {if (arguments[0].statusText !== "abort") {rsb.showResult(rsb.workflow.resultContainer, 'Auto-Save error. Can not connect to server.', "error")}
_ui.savedStatusLabel.addClass("hidden")}).always(function () {isSaving = false})}
var changeLabelToSaved = function () {_ui.savedStatusLabel.html("<p>" + 'Saved'+ "</p>");_ui.savedStatusLabel.fadeOut("slow")}
var changeLabelToSaving = function () {_ui.savedStatusLabel.removeClass("hidden");_ui.savedStatusLabel.html("<p>" + 'Saving...'+ "</p>");_ui.savedStatusLabel.show()}
var saveFlow = function ($saved) {if ($saved) {isSaved = true} else {if (isInitializing || isSaving && !hasActionCache) {isSaved = false;hasActionCache = true} else {saveWorkflow(currentWorkspace);hasActionCache = false}}}
var switchWorkspace = function($workspace) {rsb.workflow.updatePageHash($workspace)}
var drawRect = function($start, $end) {var helper = $(".ui-selectable-customhelper");helper.removeClass("hidden");helper.css({left: Math.min($start[0], $end[0]) + "px",top: Math.min($start[1],$end[1]) + "px",width: Math.abs($start[0] - $end[0]) + "px",height: Math.abs($start[1] - $end[1]) + "px"})};var clearRect = function() {var helper = $(".ui-selectable-customhelper");helper.css({left: 0 + "px",top: 0 + "px",width: 0 + "px",height: 0 + "px"});helper.addClass("hidden")}
var updatePortContextMenu = function ($ports, $group, $canModifyFlow) {_ui.contextMenu.find(".dropdown-port-menu-clone-txt").text('Copy Connectors');_ui.contextMenu.find(".dropdown-port-menu-delete-txt").text('Delete Connector');_ui.contextMenu.find(".dropdown-port-menu-export-txt").text('Export Connector Settings');_ui.contextMenu.find(".dropdown-port-menu-show-trap-txt").text('Show Error Path');_ui.contextMenu.find(".dropdown-port-menu-hide-trap-txt").text('Hide Error Path');_ui.contextMenu.find(".dropdown-port-menu-show-success-txt").text('Show Success Path');_ui.contextMenu.find(".dropdown-port-menu-hide-success-txt").text('Hide Success Path');_ui.contextMenu.find(".dropdown-port-menu-split-txt").text('Split Send / Receive');_ui.contextMenu.find(".dropdown-port-menu-merge-txt").text('Rejoin Send / Receive');_ui.contextMenu.find(".dropdown-add-api-settings-txt").text('Create API Settings');var menuMerge = false;var menuSplit = false;var menuShowTrap = false;var menuHideTrap = false;var menuShowSuccess = false;var menuHideSuccess = false;var menuDelete = true;var menuClone = true;$ports.forEach(function($port) {if ($group.length <= 0 && rsb.workflow.nav.isTransportPort($port.getPortType())) {if ($port.getStyle()) {menuMerge = true} else {menuSplit = true}}
if (rsb.workflow.nav.isTrappablePort($port.getPortType()) && !$port.hasTrappedTo()) {if ($port.getStyle() != "sender") {if(!menuHideTrap && $port.hasTrapToEndpoint()) menuHideTrap = true;if(!menuShowTrap && !$port.hasTrapToEndpoint()) menuShowTrap = true}}
if (rsb.workflow.nav.isSupportSuccessPort($port.getPortType()) && !$port.hasSuccessPort()) {if ($port.getStyle() != "sender") {if(!menuHideSuccess && $port.hasSuccessEndpoint()) menuHideSuccess = true;if(!menuShowSuccess && !$port.hasSuccessEndpoint()) menuShowSuccess = true}}
if (!$canModifyFlow) {menuMerge = false;menuSplit = false;menuShowTrap = false;menuHideTrap = false;menuShowSuccess = false;menuHideSuccess = false}
menuDelete = menuDelete && rsb.workflow.hasConnectorPrivilege($port.getPortId(), "Delete");menuClone = menuClone && rsb.workflow.hasConnectorPrivilege($port.getPortId(), "Create")});if(menuMerge) {_ui.contextMenu.find(".dropdown-port-menu-merge").show()} else {_ui.contextMenu.find(".dropdown-port-menu-merge").hide()}
if(menuSplit) {_ui.contextMenu.find(".dropdown-port-menu-split").show()} else {_ui.contextMenu.find(".dropdown-port-menu-split").hide()}
if(menuShowTrap) {_ui.contextMenu.find(".dropdown-port-menu-show-trap").show()} else {_ui.contextMenu.find(".dropdown-port-menu-show-trap").hide()}
if(menuHideTrap) {_ui.contextMenu.find(".dropdown-port-menu-hide-trap").show()} else {_ui.contextMenu.find(".dropdown-port-menu-hide-trap").hide()}
if(menuShowSuccess) {_ui.contextMenu.find(".dropdown-port-menu-show-success").show()} else {_ui.contextMenu.find(".dropdown-port-menu-show-success").hide()}
if(menuHideSuccess) {_ui.contextMenu.find(".dropdown-port-menu-hide-success").show()} else {_ui.contextMenu.find(".dropdown-port-menu-hide-success").hide()}
if (menuDelete) {_ui.contextMenu.find('.dropdown-port-menu-delete').show()} else {_ui.contextMenu.find('.dropdown-port-menu-delete').hide()}
if (menuClone) {_ui.contextMenu.find(".dropdown-port-menu-clone").show()} else {_ui.contextMenu.find('.dropdown-port-menu-clone').hide()}
_ui.contextMenu.find(".dropdown-port-menu-export").toggle(rsb.workflow.isStandardOrAdmin);_ui.contextMenu.find(".dropdown-add-api-settings").toggle($group.length <= 0);_ui.contextMenu.find(".dropdown-test-api-settings").hide();if ($ports.length == 1) {var $isLastPortInGroup = $group.length > 0 && rsb.workflow.apiGroupMgr.getFlowAPI($group).connectors.length === 1;_ui.contextMenu.find(".dropdown-port-menu-delete").toggle(!$isLastPortInGroup && menuDelete)}
var $notAPIAblePorts = [];for (let $index = 0; $group.length <= 0 && $index < $ports.length; $index++) {if (!!$ports[$index].getStyle()) {$notAPIAblePorts.push($ports[$index].getPortId() + " " + $ports[$index].getStyle())} else if (!rsb.workflow.isAPIAble($ports[$index].getPortType())) {$notAPIAblePorts.push($ports[$index].getPortId())}}
_ui.contextMenu.find(".dropdown-add-api-settings").toggleClass("disabled", $notAPIAblePorts.length > 0).attr("title", $notAPIAblePorts.reduce(function ($result, $portId, $index, $portIds) {if ($index > 0) {$result += ", ";$result += $index == $portIds.length - 1 ? 'and'+ " " : ""} else {$result += " "}
return $result + $portId}, 'API settings cannot be created for')).tooltip('dispose');$notAPIAblePorts.length > 0 && setTimeout(function () {new bootstrap.Tooltip(_ui.contextMenu.find(".dropdown-add-api-settings"))}, 0);_ui.contextMenu.find(".dropdown-add-api-settings").toggleClass("hidden", !rsb.workflow.isStandardOrAdmin)}
var deletePortFromUI = function(port) {if (port) {var portId = port.getPortId();var style = port.getStyle();var otherStyle = style ? (style == "sender" ? "receiver" : "sender") : "";port.removeFromUI();delete _portCollection[port.getPortStyleKey()];if(!otherStyle || (otherStyle && !rsb.workflow.flow.getPort(portId, otherStyle))) {rsb.workflow.nav.removePort(portId)} else if (otherStyle) {var otherStylePort = rsb.workflow.flow.getPort(portId, otherStyle);if (otherStylePort) {deletePortFromUI(otherStylePort)}}}}
var onSliderChanged = function($event, $slide) {var zoomValue = $slide.value / 100;var mousePos = [];mousePos[0] = _ui.canvas.offset().left + _ui.canvas.width() / 2;mousePos[1] = _ui.canvas.offset().top + _ui.canvas.height() / 2;rsb.workflow.flow.zoomCanvas(mousePos, zoomValue)}
var onAddViewBtnClick = function() {var viewList = rsb.workflow.nav.listViewName();var index = 1;while (viewList.indexOf("View" + index) >= 0) {index++}
rsb.addFlowView.workspace.val(rsb.workflow.flow.getCurrentWorkspace());rsb.addFlowView.name.val("View" + index);rsb.addFlowView.zoom.val(jsPlumb.currentZoom);rsb.addFlowView.zoomOrigin.val(rsb.getDraftCssAttribute(_ui.portContainer, "transform-origin"));rsb.addFlowView.posX.val(_ui.portContainer.css("left").replace("px", ""));rsb.addFlowView.posY.val(_ui.portContainer.css("top").replace("px", ""));rsb.addFlowView.form.off("success").one("success", function() {var view = new View({ name: rsb.addFlowView.name.val(),zoom: rsb.addFlowView.zoom.val(),zoomOrigin: rsb.addFlowView.zoomOrigin.val(),posX: rsb.addFlowView.posX.val(),posY: rsb.addFlowView.posY.val()});addView(view);rsb.workflow.nav.addView(view);rsb.addFlowView.modal.modal("hide");rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('View [$view$] has been saved successfully.', {"view" : rsb.addFlowView.name.val()}), true)});rsb.addFlowView.modal.modal('show')}
var onWorkspaceClicked = function() {var newWorkspace = $(this).text().trim();if (newWorkspace != currentWorkspace) {if ( rsb.workflow.flow.checkUnsave() || rsb.workflow.portSettings.checkUnsave()) {var message = 'You haven\'t saved your changes.'+ ' ' + 'Are you sure you want to leave without saving?';rsb.confirmModal({title: 'Save Changes',body: message,ok: function() {saveFlow(true);_ui.flow.addClass("flow-loading");rsb.workflow.nav.fireFlowReady(false);switchWorkspace(newWorkspace, rsb.workflow.resultContainer)}})} else {_ui.flow.addClass("flow-loading");rsb.workflow.nav.fireFlowReady(false);switchWorkspace(newWorkspace, rsb.workflow.resultContainer)}}}
var onCreateWorkspaceBtnClicked = function() {rsb.workspace.createWorkspace(function($newWorkspace) {if (rsb.workflow.flow.checkUnsave() || rsb.workflow.portSettings.checkUnsave()) {var message = 'You haven\'t saved your changes. Are you sure you want to switch to the new workspace without saving?';rsb.confirmModal({title: 'Save Changes',body: message,ok: function() {_ui.workspaceList.find(".workspace-name").text($newWorkspace);_ui.flow.addClass("flow-loading");rsb.workflow.nav.fireFlowReady(false);switchWorkspace($newWorkspace, rsb.workflow.resultContainer)},cancel: function() {$("<li></li>").html($("<a></a>").text($newWorkspace)).appendTo(_ui.workspaceList.find("ul"))},close: function() {$("<li></li>").html($("<a></a>").text($newWorkspace)).appendTo(_ui.workspaceList.find("ul"))}})} else {_ui.flow.addClass("flow-loading");rsb.workflow.nav.fireFlowReady(false);switchWorkspace($newWorkspace, rsb.workflow.resultContainer)}})}
var onDeleteWorkspaceBtnClicked = function() {rsb.confirmModal({title: 'Delete Workspace',body: rsb.evalTemplate('Are you sure you want to delete the Workspace "$workspace$"?', {"workspace" : rsb.workflow.flow.getCurrentWorkspace()}),okText: 'Yes',cancelText: 'No',ok: function() {rsb.workspace.deleteWorkspace(rsb.workflow.flow.getCurrentWorkspace(), rsb.workflow.resultContainer, function() {switchWorkspace("Default", rsb.workflow.resultContainer)})}})}
var onImportWorkspaceBtnClicked = function() {rsb.workflow.currentWorkspaceId = rsb.workflow.flow.getCurrentWorkspace();rsb.workflow.importPosition = rsb.workflow.flow.getDefaultImportPosition();$("#flowMigrationImportModal").modal("show")}
var onExportWorkspaceBtnClicked = function() {rsb.workflow.currentWorkspaceId = rsb.workflow.flow.getCurrentWorkspace();$("#flowMigrationExportModal").modal("show")}
var onWorkspaceSettingsBtnClicked = function () {const workspaceId = rsb.workflow.flow.getCurrentWorkspace();const supportUpdateSettings = rsb.workflow.hasWorkspacePrivilege("UpdateSettings");rsb.workflow.flow.showWorkspaceSettingsModal(workspaceId, supportUpdateSettings)}
var onZoomResetBtnClicked = function() {rsb.workflow.flow.setSliderValue(100);_ui.portContainer.css("left", 0);_ui.portContainer.css("top", 0)}
var onZoomInBtnClicked = function() {rsb.workflow.flow.setSliderValue(_slider.slider("value") + 5)}
var onZoomOutBtnClicked = function() {rsb.workflow.flow.setSliderValue(_slider.slider("value") - 5)}
var onDrop = function($event) {$event.preventDefault();$event = $event.originalEvent;if ($event.dataTransfer && $event.dataTransfer.files && $event.dataTransfer.files.length > 0) {var ext = $event.dataTransfer.files[0].name.toLowerCase();if(ext.endsWith(".zip") || ext.endsWith(".arcflow")) {var $offsetX = $event.clientX - _ui.canvas.offset().left;var $offsetY = $event.clientY - _ui.canvas.offset().top;$offsetX = ($offsetX - _ui.portContainer.position().left) / jsPlumb.currentZoom;$offsetY = ($offsetY - _ui.portContainer.position().top) / jsPlumb.currentZoom;rsb.workflow.currentFile = $event.dataTransfer.files[0];rsb.workflow.currentWorkspaceId = rsb.workflow.flow.getCurrentWorkspace();rsb.workflow.importPosition = {left: $offsetX, top: $offsetY};$("#flowConnectorsMigrationImportModal").modal("show")}}
_ui.canvas.removeClass("flow-dropping")}
var onDragging = function($mousemoveEvent) {var offsetX = $mousemoveEvent.pageX - $mousemoveEvent.data[0];var offsetY = $mousemoveEvent.pageY - $mousemoveEvent.data[1];var currentLeft = rsb.workflow.getPosition(_ui.portContainer).left;var currentTop = rsb.workflow.getPosition(_ui.portContainer).top;_ui.portContainer.css("left", currentLeft + offsetX);_ui.portContainer.css("top", currentTop + offsetY);$mousemoveEvent.data[0] = $mousemoveEvent.pageX;$mousemoveEvent.data[1] = $mousemoveEvent.pageY}
var onDragEnter = function($event) {$event.preventDefault();$event = $event.originalEvent;if ($event.dataTransfer && $event.dataTransfer.items && $event.dataTransfer.items.length > 0 && $event.dataTransfer.items[0].kind == "file") {_ui.canvas.addClass("flow-dropping")}}
var onDragOver = function($event) {$event.preventDefault()}
var onDragLeave = function($event) {_ui.canvas.removeClass("flow-dropping")}
var onSelecting = function($event) {clearRect();var offset = _ui.canvas.offset();var currentX = $event.clientX - offset.left;var currentY = $event.clientY - offset.top;drawRect($event.data, [currentX, currentY]);var connectors = _ui.canvas.find(".port-container .flow-port");var groups = jsPlumb.groupManager.getGroups();var helper = $(".ui-selectable-customhelper");var rect = {left: helper.offset().left,top: helper.offset().top,right: helper.offset().left + helper.outerWidth(),bottom: helper.offset().top + helper.outerHeight()};connectors.each(function() {if (rsb.workflow.apiGroupMgr.getGroupFor(this)){return}
var portRect = {left: $(this).offset().left,top: $(this).offset().top,right: $(this).offset().left + $(this).outerWidth() * jsPlumb.currentZoom,bottom: $(this).offset().top + $(this).outerHeight() * jsPlumb.currentZoom}
$(this).data("instance").fireSelect(rsb.workflow.isRectOverlapped(rect, portRect))});groups.forEach(function (group) {var groupRect = {left: $(group.el).offset().left,top: $(group.el).offset().top,right: $(group.el).offset().left + $(group.el).outerWidth() * jsPlumb.currentZoom,bottom: $(group.el).offset().top + $(group.el).outerHeight() * jsPlumb.currentZoom}
rsb.workflow.apiGroupMgr.onSelect(group, rsb.workflow.isRectOverlapped(rect, groupRect))})}
var onHashChange = function() {var info = rsb.workflow.getPageHashInfo();if (!info.flow) {info.flow = _ui.workspaceList.find(".dropdown-menu > li:not(.workspace-search) > .dropdown-item:eq(0))").text()}
if (!currentWorkspace) {var pendingFlowResult = null;getWorkflow(info.flow, function(workspace, flowResult) {if (automationInfo != null) {afterGetWorkflow(workspace, flowResult)} else {pendingFlowResult = flowResult}});getAutomationInfo(info.flow, null, function($automationInfo) {automationInfo = $automationInfo;if (pendingFlowResult != null) {afterGetWorkflow(info.flow, pendingFlowResult)}});setSessionWorkspace(info.flow)} else if (info.flow != currentWorkspace) {setSessionWorkspace(info.flow, function(){window.location.reload()})}
rsb.workspaces.updateAccessDate(currentWorkspace)}
var setSessionWorkspace = function($workspace, $callback) {$.ajax({url: "src/switchFlowWorkspace.rst?@json",data: {"workspace": $workspace},type: "POST"}).always(function() {if ($callback) {$callback()}})}
var getPortEndpoints = function ($port) {var $endpoints = [];!!$port.getSendToEndPoint() && $endpoints.push($port.getSendToEndPoint());!!$port.getReceiveEndPoint() && $endpoints.push($port.getReceiveEndPoint());!!$port.getTrappedToEndPoint() && $endpoints.push($port.getTrappedToEndPoint());!!$port.getSuccessEndPoint() && $endpoints.push($port.getSuccessEndPoint());var additionalEndpoints = $port.getAdditionalOutputEndpoints() || {};for (const ep in additionalEndpoints) {!!additionalEndpoints[ep] && $endpoints.push(additionalEndpoints[ep])}
return $endpoints}
var getPortConnected = function ($port) {if (!!$port.getSendToEndPoint() && $port.getSendToEndPoint().connections.length > 0) return true;if (!!$port.getReceiveEndPoint() && $port.getReceiveEndPoint().connections.length > 0) return true;if (!!$port.getTrappedToEndPoint() && $port.getTrappedToEndPoint().connections.length > 0) return true;if (!!$port.getSuccessEndPoint() && $port.getSuccessEndPoint().connections.length > 0) return true;var additionalEndpoints = $port.getAdditionalOutputEndpoints() || {};for (const ep in additionalEndpoints) {if (additionalEndpoints[ep].connections.length > 0) return true}
return false}
this.createPort = function ($portType, $portName, $position) {if (!rsb.workflow.hasWorkspacePrivilege("CreateConnector")) return;rsb.workflow.getNextPortId($portType, function($nextPortId) {if(_ui.portContainer.find(".flow-port").length >= 100){rsb.showResult(rsb.createPort.form.resultContainer, 'There are more than 100 connectors in the current workspace. Please consider moving some connectors to a new workspace in order to improve the performance of the flow designer.', "warning")}
rsb.createPort.form.workspaceId.val(rsb.workflow.flow.getCurrentWorkspace());var portDesc = rsb.workflow.nav.getPortDesc($portType);var helpLocation = rsb.workflow.nav.getHelpLocation($portType);rsb.connect.createPortModal($portType, $nextPortId, true, portDesc, function($newPortId, $newPortType) {var newPort = createPort($newPortId, $newPortType, $position);addPort(newPort);var createdPort = newPort;newPort.updateWarningIcon();actionPlayer.recordAction(function () {}, function () {var createdPorts = [];createdPorts.push(createdPort);rsb.workflow.flow.deletePort(createdPorts)});rsb.workflow.portSettings.showSettings($newPortId);rsb.workflow.nav.addPort(newPort);if (!$position) {rsb.workflow.flow.showPortInCenter(newPort)} else {rsb.workflow.apiGroupMgr.getGroups().forEach(function ($group) {if (rsb.workflow.apiGroupMgr.isInsideGroup($group.el, newPort.getUIElement())) {jsPlumb.addToGroup($group.id, newPort.getUIElement()[0]);return false}})}}, $portName, helpLocation)})}
this.getCurrentWorkspace = function() {return currentWorkspace};this.getPort = function($obj, $style) {if ($obj instanceof Port) {return $obj} else if ($obj instanceof jQuery) {return $obj.closest(".flow-port").data("instance")} else if (typeof($obj) == "string") {var styleKey = $style ? ($obj + "_" + $style) : $obj;return _portCollection[styleKey] || _portCollection[$obj]}
return null}
this.getFlowAPI = function ($apiKey) {return _apiCollection[getFlowAPIIndex($apiKey)]}
this.deleteFlowAPI = function ($apis) {var $apiList = [];if (!($apis instanceof Array)) {$apiList.push($apis)} else {$apiList = $apis}
if ($apiList.length <= 0) return false;var $message = "";if ($apiList.length == 1) {$message = rsb.evalTemplate('This operation can not be undone, are you sure you want to delete flow API <b>$name$ ($method$)</b>?', {name: $apiList[0].name,method: $apiList[0].method})} else {$message = 'This operation can not be undone, are you sure you want to delete flow APIs';rsb.forEach($apiList, function ($flowAPI, $index) {if ($index) $message += ",";$message += "&nbsp;<b>" + $flowAPI.name + " (" + $flowAPI.method + ")</b>"})}
rsb.confirmModal({title: 'Delete API',body: $message,okText: 'Yes',cancelText: 'No',ok: function () {rsb.forEach($apiList, function ($api) {deleteFlowAPIImpl($api)})}})}
this.adjustDOMOrder = function (endpoints, el) {for (let index = 0; index < endpoints.length; index++) {$(el).parent().append(endpoints[index])}}
this.addClassToPort = function ($portId, $class) {var $port = rsb.workflow.flow.getPort($portId);var $endpoints = getPortEndpoints($port) || [];$port.getUIElement().addClass($class);$endpoints.forEach(function ($endpoint) {$($endpoint.endpoint.canvas).addClass($class);!!$endpoint.connections && !!$endpoint.connections[0] && $($endpoint.connections[0].connector.canvas).addClass($class)})}
this.removeClassFromPort = function ($portId, $style, $class) {var $port = rsb.workflow.flow.getPort($portId, $style);var $endpoints = getPortEndpoints($port) || [];var $endpointElements = [];$port.getUIElement().removeClass($class);$endpoints.forEach(function ($endpoint) {$($endpoint.endpoint.canvas).removeClass($class);!!$endpoint.connections && !!$endpoint.connections[0] && $($endpoint.connections[0].connector.canvas).removeClass($class);$endpointElements.push($endpoint.endpoint.canvas)});return $endpointElements}
this.getActionPlayer = function () {return actionPlayer}
this.deletePort = function($ports) {if(!$ports) return;var newPorts = [];if (!($ports instanceof Array)) {newPorts.push($ports)} else {newPorts = $ports}
var portList = [];var stylePorts = [];for (var index in newPorts) {var port = newPorts[index];if (!portList.includes(port.getPortId())) {portList.push(port.getPortId())}
if(port.getStyle() && !stylePorts.includes(port.getPortId())) {stylePorts.push(port.getPortId())}}
const notAllowedPortId = portList.find(portId => !rsb.workflow.hasConnectorPrivilege(portId, "Delete"));if (notAllowedPortId != null) {rsb.confirmModal({title: 'Delete Connector',body: 'You do not have permission to delete the connector'+ " [" + notAllowedPortId + "].",okText: 'OK'});return}
rsb.connect.deletePortModal(rsb.workflow.flow.getCurrentWorkspace(), portList, stylePorts, function($portId, $result) {portDeletedHandler($ports[0] || $ports, $portId, $result)})}
this.listPorts = function() {return _portCollection}
this.findReceiveFromPort = function($receiverPortId, $type) {var sender = [];for (var id in _portCollection) {var port = _portCollection[id];var outputs = [];var portInfo = port.getPortInfo();if (portInfo.sendPort) {for (var key in portInfo.sendPort) {if (portInfo.sendPort[key] == $receiverPortId) {outputs.push(key)}}}
if (portInfo.trapPort == $receiverPortId) {outputs.push("trap")}
if (outputs.length > 0) {sender.push({"port": port,"outputs": outputs})}}
return sender}
this.hasStylePort = function() {for (var id in _portCollection) {var port = _portCollection[id];if (port.getStyle()) {return true}}
return false}
this.showAPIInCenter = function ($flowAPI) {rsb.setDraftCssAttribute(_ui.portContainer, "transform-origin", $flowAPI.posX + "px " + $flowAPI.posY + "px");var containerTop = -$flowAPI.posY + (_ui.canvas.height() / 2) - ($flowAPI.height / 2);var containerLeft = -$flowAPI.posX + (_ui.canvas.width() / 2) - ($flowAPI.width / 2);containerLeft -= $flowAPI.width / 2;_ui.portContainer.css({"top": containerTop + "px", "left": containerLeft + "px"});rsb.workflow.updateFlowinSession()}
this.showPortInCenter = function ($port, $callback) {var elem = $port.getUIElement();rsb.setDraftCssAttribute(_ui.portContainer, "transform-origin", rsb.workflow.getPosition(elem).left + "px " + rsb.workflow.getPosition(elem).top + "px");var containerTop = -rsb.workflow.getPosition(elem).top + (_ui.canvas.height() / 2) - (elem.outerHeight() / 2);var containerLeft = -rsb.workflow.getPosition(elem).left + (_ui.canvas.width() / 2) - (elem.outerWidth() / 2);containerLeft -= rsb.workflow.portSettings.getWidth() / 2;_ui.portContainer.css({"top": containerTop + "px", "left": containerLeft + "px"});if ($callback) {$callback()}
rsb.workflow.updateFlowinSession()}
this.checkUnsave = function() {if (!isSaved) {return 'You haven\'t saved your changes.'+ '\n\n' + 'Are you sure you want to leave without saving?'}}
this.zoomCanvas = function($originPosition, $level) {if ($level > 0.1 && $level < 2) {var containerPos = [rsb.workflow.getPosition(_ui.portContainer).left, rsb.workflow.getPosition(_ui.portContainer).top];var containerViewPos = [_ui.portContainer.position().left, _ui.portContainer.position().top];var transform = jsPlumb.currentZoom;var newTransfrom = $level;var newTransfromOrigin = [($originPosition[0] - containerViewPos[0]) / transform, ($originPosition[1] - containerViewPos[1]) / transform];rsb.setDraftCssAttribute(_ui.portContainer, "transform-origin", "" + newTransfromOrigin[0] + "px " + newTransfromOrigin[1] + "px");var newContainerViewPos = [_ui.portContainer.position().left, _ui.portContainer.position().top];var newContainerPos = [containerPos[0] - (newContainerViewPos[0] - containerViewPos[0]), containerPos[1] - (newContainerViewPos[1] - containerViewPos[1])];_ui.portContainer.css("left", newContainerPos[0]);_ui.portContainer.css("top", newContainerPos[1]);rsb.setDraftCssAttribute(_ui.portContainer, "transform", "scale(" + newTransfrom + ")");jsPlumb.setZoom(newTransfrom);rsb.workflow.updateFlowinSession()}}
this.onContextMenu = function($event) {var currentPort = rsb.workflow.flow.getPort($($event.target));var currentGroup = $($event.target).closest('.apigroup');if (!currentPort && currentGroup.length <= 0) {rsb.workflow.flow.hideContextMenu();return true}
var ports = [];var groups = [];const canModifyFlow = rsb.workflow.hasWorkspacePrivilege("modifyflow");if (currentPort || currentGroup.hasClass("ui-selected")) {var containers = _ui.canvas.find(".flow-port.ui-selected");if (containers.length >= 1) {for (var i = 0; i < containers.length; i++) {var port = rsb.workflow.flow.getPort($(containers[i]).data("instance").getPortId(), $(containers[i]).data("instance").getStyle());port && ports.push(port)}
if (currentPort && ports.indexOf(currentPort) < 0 && ports.length > 1) {rsb.workflow.flow.clearSelected();ports = [currentPort]}} else if (currentPort) {ports.push(currentPort)}
_ui.canvas.find(".apigroup.ui-selected").each(function () {groups.push($(this))})} else {groups.push(currentGroup)}
_ui.contextMenu.find(".dropdown-port-menu-delete").off("click").click(function () {deleteItems(ports, groups)});_ui.contextMenu.find(".dropdown-port-menu-export").off("click").click(function () {exportItems(ports, groups)});if (ports.length > 0 && groups.length <= 0) {updatePortContextMenu(ports, currentGroup, canModifyFlow);_ui.contextMenu.find(".dropdown-port-menu-show-trap").off("click").click(function() {ports.forEach(function($port) {if (!$port.hasTrapToEndpoint()) {$port.showTrapEndpoint();var group = rsb.workflow.apiGroupMgr.getGroupFor($port.getUIElement()[0]);if (group) {$($port.getTrappedToEndPoint().endpoint.canvas).addClass(group.id)}}})});_ui.contextMenu.find(".dropdown-port-menu-hide-trap").off("click").click(function() {ports.forEach(function($port) {if (!$port.hasTrappedTo()) {$port.hideTrapEndpoint()}})});_ui.contextMenu.find(".dropdown-port-menu-show-success").off("click").click(function() {ports.forEach(function($port) {if (!$port.hasSuccessEndpoint()) {$port.showSuccessEndpoint();var group = rsb.workflow.apiGroupMgr.getGroupFor($port.getUIElement()[0]);if (group) {$($port.getSuccessEndPoint().endpoint.canvas).addClass(group.id)}}})});_ui.contextMenu.find(".dropdown-port-menu-hide-success").off("click").click(function() {ports.forEach(function($port) {if (!$port.hasSuccessPort()) {$port.hideSuccessEndpoint()}})});_ui.contextMenu.find(".dropdown-port-menu-clone").off("click").click(function() {copyConnector(ports, currentGroup)});_ui.contextMenu.find(".dropdown-port-menu-split").off("click").click(function() {splitConnector(ports)});_ui.contextMenu.find(".dropdown-port-menu-merge").off("click").click(function() {mergeConnectors(ports)});_ui.contextMenu.find(".dropdown-add-api-settings").off("click").click(function() {if ($(this).hasClass("disabled")) return true;createFlowAPI(ports)})} else if (ports.length <= 0 && groups.length == 1) {_ui.contextMenu.find('.dropdown-port-menu-item').hide();_ui.contextMenu.find(".dropdown-port-menu-delete").show();_ui.contextMenu.find(".dropdown-port-menu-export").toggle(rsb.workflow.isStandardOrAdmin);_ui.contextMenu.find(".dropdown-test-api-settings").show();_ui.contextMenu.find(".dropdown-port-menu-delete-txt").text('Delete API Settings');_ui.contextMenu.find(".dropdown-port-menu-export-txt").text('Export API Settings');_ui.contextMenu.find(".dropdown-test-api-settings-txt").text('Test API Settings');_ui.contextMenu.find(".dropdown-port-menu-delete").off("click").click(function() {var $flowAPI = rsb.workflow.apiGroupMgr.getFlowAPI(currentGroup[0]);rsb.workflow.flow.deleteFlowAPI($flowAPI)});_ui.contextMenu.find(".dropdown-test-api-settings").off("click").click(function() {var $flowAPI = rsb.workflow.apiGroupMgr.getFlowAPI(currentGroup[0]);rsb.flowapiExecuteModal.show(rsb.workflow.flow.getCurrentWorkspace(), $flowAPI.name, $flowAPI.method)})} else {_ui.contextMenu.find('.dropdown-port-menu-item').hide();_ui.contextMenu.find(".dropdown-port-menu-delete").show();_ui.contextMenu.find(".dropdown-port-menu-export").toggle(rsb.workflow.isStandardOrAdmin);_ui.contextMenu.find(".dropdown-port-menu-delete-txt").text('Delete');_ui.contextMenu.find(".dropdown-port-menu-export-txt").text('Export')}
if (groups.length > 0 && !canModifyFlow) {_ui.contextMenu.find(".dropdown-port-menu-delete").hide()}
_ui.contextMenu.find(".dropdown-menu-auto-format").toggle(canModifyFlow && (groups.length > 0 || ports.length > 1)).off("click").click(function () {rsb.workflow.flow.autoLayout(ports, groups)});_ui.contextMenu.css({ top: $event.pageY, left: $event.pageX });if (!_ui.contextMenu.hasClass("open")) {let visibleItems = _ui.contextMenu.find(".dropdown-item").filter((i, e) => $(e).css("display") != "none");if (visibleItems.length > 0) {_ui.contextMenu.trigger.dropdown("toggle")}}
$event.preventDefault();return true}
this.hideContextMenu = function () {if (_ui.contextMenu.hasClass("open")) {_ui.contextMenu.trigger.dropdown("toggle")}}
this.load = function($workspace) {var pendingFlowResult = null;getWorkflow($workspace, function(workspace, flowResult) {if (automationInfo != null) {afterGetWorkflow(workspace, flowResult)} else {pendingFlowResult = flowResult}});getAutomationInfo($workspace, null, function($automationInfo) {automationInfo = $automationInfo;if (pendingFlowResult) {afterGetWorkflow($workspace, pendingFlowResult)}})}
this.resize = function() {_ui.flow.css("left", rsb.workflow.nav.getWidth());var flowWidth = $("#flowContainer").width() - rsb.workflow.nav.getWidth();_ui.flow.width(flowWidth);_ui.sliderContainer.css("left", flowWidth - _ui.sliderContainer.outerWidth() - 10)}
this.applyView = function($view) {if ($view) {if ($view.zoom) {this.setSliderValue($view.zoom * 100)}
if ($view.zoomOrigin) {rsb.setDraftCssAttribute(_ui.portContainer, "transform-origin", $view.zoomOrigin)}
if ($view.posX) {_ui.portContainer.css("left", $view.posX + "px")}
if ($view.posY) {_ui.portContainer.css("top", $view.posY + "px")}}}
this.getCurrentView = function() {return new View({zoom: jsPlumb.currentZoom,zoomOrigin: rsb.getDraftCssAttribute(_ui.portContainer, "transform-origin"),posX: rsb.workflow.getPosition(_ui.portContainer).left,posY: rsb.workflow.getPosition(_ui.portContainer).top})}
this.deleteView = function($viewName) {delete _viewCollection[$viewName]}
this.save = function() {$(":focus").trigger("blur");saveWorkflow(currentWorkspace);return true}
this.getMode = function() {return mode}
this.setMode = function(tempMode) {mode = tempMode;if (mode == rsb.workflow.lassoMode) {_ui.canvas.addClass("flow-lassomode");_ui.modeTrigger.removeClass("btn-outline-secondary").addClass("btn-primary")} else {_ui.canvas.removeClass("flow-lassomode");_ui.modeTrigger.removeClass("btn-primary").addClass("btn-outline-secondary")}}
this.clearSelected = function() {var info = rsb.workflow.getPageHashInfo();if (info.portId && info.portId.indexOf("*") > 0) {rsb.workflow.updatePageHash(info.flow, "", "")}
clearRect();for (var styleKey in _portCollection) {_portCollection[styleKey].fireSelect(false)}
jsPlumb.groupManager.getGroups().forEach(function ($group) {rsb.workflow.apiGroupMgr.onSelect($group, false)})
jsPlumb.clearDragSelection()}
this.setSaved = function($saved) {saveFlow($saved)}
this.setCanvasCursor = function($cursor) {_ui.canvas.css("cursor", $cursor)}
this.isAllConnectionInAPI = function ($port, $portIds) {let $connections = !!$port.getReceiveEndPoint() && $port.getReceiveEndPoint().connections || [];for (let i = 0; i < $connections.length; i++) {if (!!$connections[i].source && !!$($connections[i].source).data("instance") && !$portIds.includes($($connections[i].source).data("instance").getPortId())) {return false}}
let $portInfo = $port.getPortInfo();for (let $name in $portInfo.sendPort) {if (!$portIds.includes($portInfo.sendPort[$name])) {return false}}
return (!$portInfo.trapPort || $portIds.includes($portInfo.trapPort)) && (!$portInfo.successPort || $portIds.includes($portInfo.successPort))}
this.correctPortPosition = function () {$('.flow-port-dragging').each(function () {var $port = this.id && rsb.workflow.flow.getPort(this.id);$port && $port.validatePosition(true);$(this).removeClass('flow-port-dragging').removeClass('flow-port-drag-start')})}
this.getDefaultImportPosition = function () {return {left: (_ui.canvas.width() / 3 - _ui.portContainer.position().left) / jsPlumb.currentZoom,top: (_ui.canvas.height() / 3 - _ui.portContainer.position().top) / jsPlumb.currentZoom}}
this.getInitializing = () => {return isInitializing}
_ui.canvas.droppable({accept: ".flow-nav-tab-connectors .flow-port, .flow-nav-tab-transforms .flow-port",over: function (event, $ui) {var dropValidate = function () {var $rect = rsb.workflow.getViewportRect($ui.helper);rsb.workflow.apiGroupMgr.getGroups().forEach($group => {rsb.workflow.apiGroupMgr.toggleBorderStyle($group.el, !rsb.workflow.isRectOverlapped($rect, rsb.workflow.getViewportRect($group.el)) || rsb.workflow.isAPIAble($ui.draggable.attr("data-type")))})};$ui.helper.off('mousemove', dropValidate).on('mousemove', dropValidate)},drop: function(event, $ui) {if (!rsb.workflow.hasWorkspacePrivilege("CreateConnector") && !rsb.workflow.hasWorkspacePrivilege("ModifyFlow")) {rsb.showResult(rsb.workflow.resultContainer, 'You have no permission to create connector, please contact the administrator.', false);return}
var elem = $ui.draggable;var hasLicense = true;var prod = "";var prodName = "";var allowtrialactivate = false;var isSingleConnector = false;var portType = elem.attr("data-type");var portName = rsb.trimStr(elem.find(".flow-port-txt").text());var releaseStatus = elem.attr("data-releasestatus");if (elem.hasClass("flow-port-no-license")) {if (rsb.workflow.licHasOther) {hasLicense = rsb.connect.isOtherConnectorLicensed(portType, true, rsb.workflow.resultContainer)} else {hasLicense = false}
isSingleConnector = true;prod = elem.find("input.port-noLicense-prod").val();prodName = elem.find("input.port-noLicense-name").val();allowtrialactivate = elem.find("input.port-noLicense-allowtrialactivate").val().toLowerCase() == "true"} else {var container = elem.closest(".flow-nav-tab-ports-list");if (container.hasClass("flow-nav-tab-core-ports")) {hasLicense = rsb.workflow.licHasCore} else if (container.hasClass("flow-nav-tab-mft-ports")) {hasLicense = rsb.workflow.licHasMFT} else if (container.hasClass("flow-nav-tab-edi-ports")) {hasLicense = rsb.workflow.licHasEDI} else if (container.hasClass("flow-nav-tab-database-ports")) {hasLicense = rsb.workflow.licHasDatabase} else if (container.hasClass("flow-nav-tab-sample-ports")) {hasLicense = rsb.workflow.licHasSample}}
if (!hasLicense && rsb.equalsIgnoreCase("beta", releaseStatus)) hasLicense = true;if (!hasLicense && rsb.workflow.licDeprecatedOthers.indexOf("|" + portType.toLowerCase().replaceAll(/v\d$/g,"") + "|") >= 0) {hasLicense = true}
if (hasLicense) {var posY = $ui.offset.top - _ui.canvas.offset().top;var posX = $ui.offset.left - _ui.canvas.offset().left;var zoom = jsPlumb.currentZoom;posY = (posY - _ui.portContainer.position().top) / zoom;posX = (posX - _ui.portContainer.position().left) / zoom;if (elem.hasClass("flow-sample")) {rsb.workflow.nav.importSampleFlow(elem, {left: posX, top: posY});return}
var $valid = true;var $rect = rsb.workflow.getViewportRect($ui.helper);rsb.workflow.apiGroupMgr.getGroups().forEach($group => {var $groupEl = $($group.el);if (rsb.workflow.isRectOverlapped($rect, rsb.workflow.getViewportRect($groupEl))) {if (!rsb.workflow.isAPIAble($ui.draggable.attr("data-type"))) {rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('The $type$ connector cannot be added to flows that have api settings..', {type: portType}), false);$valid = false} else if (!rsb.workflow.apiGroupMgr.isInsideGroup($groupEl, $ui.helper[0])) {$valid = false}
rsb.workflow.apiGroupMgr.toggleBorderStyle($groupEl, true);return false}});$valid && rsb.workflow.flow.createPort(portType, portName, {left: posX, top: posY})} else {if (isSingleConnector && rsb.workflow.licHasCore) {rsb.paidFeature.paidFeatureModal(prod, prodName, allowtrialactivate, true)} else {rsb.paidFeature.paidFeatureModal()}}}});jsPlumbBrowserUI.ready(function() {var isEndDetached = false;var sourceEndpoint = null;var targetEndpoint = null;var isOriginalEvent = false;const getCurrentActionSourceEndpoint = (outputDef, connector, actionSourceEndpoint) => {if (outputDef != null && connector.getUiStyle() == 1) {if(outputDef.name == ""){return connector.getSendToEndPoint()} else {return connector.getAdditionalOutputEndpoints()[outputDef.name]}}
return actionSourceEndpoint}
jsPlumb.bind(jsPlumbBrowserUI.EVENT_CONNECTION, function ($info) {if ($($info.source).hasClass('api-design-label') || $($info.target).hasClass('api-design-label')) return;if (sourceEndpoint && sourceEndpoint.connectorStyle && $info.sourceEndpoint.connectorStyle && sourceEndpoint.connectorStyle.type != $info.sourceEndpoint.connectorStyle.type) {jsPlumb.deleteConnection($info.connection);jsPlumb.connect({source: $info.sourceEndpoint, target: $info.targetEndpoint});sourceEndpoint = $info.sourceEndpoint} else {Port.OnPortConnected($info)}
var $apiGroup = rsb.workflow.apiGroupMgr.getGroupFor($info.source);if ($apiGroup != rsb.workflow.apiGroupMgr.getGroupFor($info.target)) {jsPlumb.deleteConnection($info.connection)
return false}
const sourceOutputDef = $($info.source).data("outputDef");var source = $($info.source).data("instance");var target = $($info.target).data("instance");if (source.getPortId() !== target.getPortId()) {var actionSourceEndpoint = $info.sourceEndpoint;var actionTargetEndpoint = $info.targetEndpoint;$apiGroup && $($info.connection.connector.canvas).addClass($apiGroup.id);var $flowAPI = $apiGroup && rsb.workflow.apiGroupMgr.getFlowAPI($apiGroup);$apiGroup && rsb.workflow.apiGroupMgr.validateGroup($flowAPI);isOriginalEvent && actionPlayer.recordAction(function () {const currentSourceEndpoint = getCurrentActionSourceEndpoint(sourceOutputDef, source, actionSourceEndpoint);jsPlumb.connect({source: currentSourceEndpoint, target: actionTargetEndpoint});if ($apiGroup) {if (currentSourceEndpoint.connections.length > 0) {$(currentSourceEndpoint.connections[0].connector.canvas).addClass($apiGroup.id)}
rsb.workflow.apiGroupMgr.validateGroup($flowAPI)}}, function () {const currentSourceEndpoint = getCurrentActionSourceEndpoint(sourceOutputDef, source, actionSourceEndpoint);var connections = jsPlumb.getConnections();for (var i = 0; i < connections.length; i++) {if (connections[i].endpoints && connections[i].endpoints.length > 0 && connections[i].endpoints[0] == currentSourceEndpoint && connections[i].endpoints[1] == actionTargetEndpoint) {jsPlumb.deleteConnection(connections[i]);$apiGroup && rsb.workflow.apiGroupMgr.validateGroup($flowAPI);break}}})}
isOriginalEvent = false});jsPlumb.bind(jsPlumbBrowserUI.EVENT_CONNECTION_DETACHED, function ($info, $event) {if ($($info.source).hasClass('api-design-label') || $($info.target).hasClass('api-design-label')) return;const sourceOutputDef = $($info.source).data("outputDef");const source = $($info.source).data("instance");var actionSourceEndpoint = sourceEndpoint;var actionTargetEndpoint = targetEndpoint;var draggingEndpoint = _ui.canvas.find(".jtk-endpoint.jtk-dragging");isEndDetached = draggingEndpoint && draggingEndpoint.hasClass("endpoint-receive");!!$event && onConnectionDragStop($info, $event);$info.targetEndpoint.endpoint.removeClass(jsPlumbBrowserUI.CLASS_ENDPOINT_CONNECTED);Port.OnPortConnectionDetached($info);if (!!$event) {var $apiGroup = rsb.workflow.apiGroupMgr.getGroupFor($info.sourceEndpoint.element);var $flowAPI = $apiGroup && rsb.workflow.apiGroupMgr.getFlowAPI($apiGroup);$apiGroup && setTimeout(function () {rsb.workflow.apiGroupMgr.validateGroup($flowAPI)}, 0);actionPlayer.recordAction(function () {const currentSourceEndpoint = getCurrentActionSourceEndpoint(sourceOutputDef, source, actionSourceEndpoint);var connections = jsPlumb.getConnections();for (var i = 0; i < connections.length; i++) {if (connections[i].endpoints && connections[i].endpoints.length > 1 && connections[i].endpoints[0] === currentSourceEndpoint && connections[i].endpoints[1] === actionTargetEndpoint) {jsPlumb.deleteConnection(connections[i]);$apiGroup && rsb.workflow.apiGroupMgr.validateGroup($flowAPI);break}}}, function () {const currentSourceEndpoint = getCurrentActionSourceEndpoint(sourceOutputDef, source, actionSourceEndpoint);jsPlumb.connect({source: currentSourceEndpoint, target: actionTargetEndpoint});$apiGroup && $(currentSourceEndpoint.connections[0].connector.canvas).addClass($apiGroup.id);$apiGroup && rsb.workflow.apiGroupMgr.validateGroup($flowAPI)})}
isOriginalEvent = false});jsPlumb.bind(jsPlumbBrowserUI.INTERCEPT_BEFORE_DROP, function ($info) {if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) { return false; }
var source = rsb.workflow.flow.getPort($info.sourceId);if (source == null) {source = $($info.connection.endpoints[0].element).data("instance")}
var target = rsb.workflow.flow.getPort($info.targetId);if (!rsb.workflow.hasWorkspacePrivilege("modifyflow") || (source != null && target != null && source.getPortId() == target.getPortId())) {return false}
return true});jsPlumb.bind(jsPlumbBrowserUI.EVENT_UNMANAGE_ELEMENT, function ($info) {if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) { return false; }
saveFlow(false)});jsPlumb.bind(jsPlumbBrowserUI.EVENT_CONNECTION_DRAG, function ($info) {if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) { return false; }
$($info.connector.canvas).css('z-index', 999);isOriginalEvent = true;$($info.canvas).addClass("connection-dragging");if ($info.endpoints && $info.endpoints.length > 0) {sourceEndpoint = $info.endpoints[0];targetEndpoint = $info.endpoints[1]}});jsPlumb.bind(jsPlumbBrowserUI.EVENT_DRAG_START, ($info) => {if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) { return false; }
var port = $($info.el).data("instance");if (port != null) {var uiStyle = port.getUiStyle();if (uiStyle == 1) {var currentElem = $info.e.target;while (currentElem != null) {if (currentElem.tagName == "LI" && (currentElem.classList.contains("connector-outputs-output") || currentElem.classList.contains("connector-outputs-category"))) {return false}
currentElem = currentElem.parentElement}}
return true}});var onConnectionDragStop = function ($info, $event) {if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) { return false; }
if ($info.endpoints && $info.endpoints.length > 0 || isEndDetached) {var connectors = _ui.canvas.find(".port-container .flow-port");var sourceInstance = $($info.source).data("instance");for (var i = 0; i < connectors.length; i++) {var connector = $(connectors[i]);var targetInstance = connector.data("instance");if (sourceInstance.getPortId() != targetInstance.getPortId() && connector.offset().left < $event.clientX &&
connector.offset().left + connector.outerWidth() * jsPlumb.currentZoom > $event.clientX &&
connector.offset().top < $event.clientY &&
connector.offset().top + connector.outerHeight() * jsPlumb.currentZoom > $event.clientY) {targetEndpoint = rsb.workflow.flow.getPort(connector.attr("id")).getReceiveEndPoint();if (targetEndpoint) {try {$info.connection ? jsPlumb.deleteConnection($info.connection) : jsPlumb.deleteConnection($info)} catch (error) {}
jsPlumb.connect({ source: sourceEndpoint, target: targetEndpoint });if ($info.targetEndpoint && $info.targetEndpoint.element) {saveFlow(false)}
break}}}}
$($info.canvas).removeClass("connection-dragging");isEndDetached = false;sourceEndpoint = null;targetEndpoint = null}
jsPlumb.bind(jsPlumbBrowserUI.EVENT_CONNECTION_ABORT, onConnectionDragStop)});var draggingCanvas = false;_ui.canvas.mousedown(function($mousedownEvent) {if (!$($mousedownEvent.target).hasClass("ui-resizable-handle")) {if ($mousedownEvent.which == 1) {if (mode == rsb.workflow.lassoMode) {var offset = _ui.canvas.offset();var startX = $mousedownEvent.clientX - offset.left;var startY = $mousedownEvent.clientY - offset.top;_ui.canvas.mousemove([startX, startY], onSelecting)} else if (!draggingCanvas) {draggingCanvas = true;_ui.canvas.addClass("flow-dragging");_ui.canvas.mousemove([$mousedownEvent.pageX, $mousedownEvent.pageY], onDragging)}}} else {_ui.canvas.css("cursor", "e-resize")}});_ui.canvas.mouseup(function($mouseupEvent) {rsb.workflow.flow.correctPortPosition();var target = $($mouseupEvent.target);if (mode == rsb.workflow.lassoMode) {_ui.canvas.off("mousemove");clearRect();rsb.workflow.flow.setMode(rsb.workflow.flow.dragMode)} else {if (draggingCanvas) {var hashInfo = rsb.workflow.getPageHashInfo();if (!hashInfo.portId) {rsb.workflow.flow.clearSelected()}
_ui.canvas.off("mousemove");_ui.canvas.removeClass("flow-dragging");draggingCanvas = false;rsb.workflow.updateFlowinSession()} else {rsb.workflow.flow.correctPortPosition()}}});_ui.canvas.mouseleave(function() {if (draggingCanvas) {_ui.canvas.trigger("mouseup")}});_ui.canvas.on("wheel", function($event) {var originalEvent = $event.originalEvent;var mousePos = [originalEvent.pageX - _ui.canvas.offset().left, originalEvent.pageY - _ui.canvas.offset().top];if ($($event.target).hasClass("flow-global-view-panner")) {mousePos = [rsb.workflow.portBuild.width() / 2, rsb.workflow.portBuild.height() / 2]}
var transform = jsPlumb.currentZoom;var newTransfrom = transform + (originalEvent.deltaY > 0 ? -0.02 : 0.02);rsb.workflow.flow.zoomCanvas(mousePos, newTransfrom);rsb.workflow.flow.setSliderValue(newTransfrom * 100)});_ui.canvas.contextmenu(function($event) {return rsb.workflow.flow.onContextMenu($event)});_slider = _ui.sliderElement.slider({min: 10,max: 200,step: 2,orientation: "vertical",value: 100,slide: onSliderChanged,change: onSliderChanged});this.setSliderValue = function($value) {_slider.slider("value", $value)}
_ui.autoFormatBtn.click(() => {const ports = [];const groups = [];_ui.canvas.find(".flow-port.ui-selected").each(function () {const port = rsb.workflow.flow.getPort($(this).data("instance").getPortId(), $(this).data("instance").getStyle());port && ports.push(port)});_ui.canvas.find(".apigroup.ui-selected").each(function () {groups.push($(this))});rsb.workflow.flow.autoLayout(ports, groups)});_ui.modeTrigger.click(function() {if (mode == rsb.workflow.lassoMode) {rsb.workflow.flow.setMode(rsb.workflow.dragMode)} else {rsb.workflow.flow.setMode(rsb.workflow.lassoMode)}
$(this).tooltip("show")});_ui.redoBtn.click(function () {actionPlayer.redoAction();actionPlayer.updateBtnStatus()});_ui.undoBtn.click(function () {actionPlayer.undoAction();actionPlayer.updateBtnStatus()});_ui.addViewTrigger.click(onAddViewBtnClick);_ui.workspaceList.on("click", "a", onWorkspaceClicked);_ui.createWorkspaceBtn.click(onCreateWorkspaceBtnClicked);_ui.deleteWorkspaceBtn.click(onDeleteWorkspaceBtnClicked);_ui.importWorkspaceBtn.click(onImportWorkspaceBtnClicked);_ui.exportWorkspaceBtn.click(onExportWorkspaceBtnClicked);_ui.workspaceSettingsBtn.click(onWorkspaceSettingsBtnClicked);_ui.zoomResetBtn.click(onZoomResetBtnClicked);_ui.zoomInBtn.click(onZoomInBtnClicked);_ui.zoomOutBtn.click(onZoomOutBtnClicked);if (_ui.dropOverlay.length > 0) {_ui.canvas.on("dragenter", onDragEnter);_ui.dropOverlay.on("dragover", onDragOver);_ui.dropOverlay.on("dragleave", onDragLeave);_ui.dropOverlay.on("drop", onDrop)}
window.addEventListener("hashchange", onHashChange)};rsb.workflow.flow = new Flow();var ApiGroupManager = function () {const GROUP_MIN_HEIGHT = 500;const GROUP_MIN_WIDTH = 450;const GROUP_CANVAS = $("#canvas").find(".port-container");const GROUP_PADDING = 60;var _apiCount = 0;var _flowAPIKeyMap = Object.create(null);var _groupIdMap = Object.create(null);var _groupEndpoints = Object.create(null);var _currentHighlightAPI = null;function geneGroupId($apiKey) {return "api_group_" + $apiKey}
function geneStyle($groupId, $zIndex) {var $style = $('#api-style')[0].innerHTML;$style = $style.replaceAll('[api-id]', $groupId);$style = $style.replaceAll('[api-zindex]', $zIndex);$style = $style.replaceAll('[api-connection-zindex]', $zIndex + 1);$style = $style.replaceAll('[api-port-zindex]', $zIndex + 2);$style = $style.replaceAll('[api-endpoint-zindex]', $zIndex + 3);$style = $style.replaceAll('[api-design-label-zindex]', $zIndex + 9);return $style.replaceAll('[api-connection-dragging-zindex]', $zIndex + 5)}
function updateMap($groupId, $apiKey) {_flowAPIKeyMap[$groupId] = $apiKey;_groupIdMap[$apiKey] = $groupId}
function addGroup($groupEl, $apiKey) {let $group = jsPlumb.addGroup({el: $groupEl[0],id: $groupEl[0].id,constrain: true,dropOverride: true,revert: false,orphan: true,autoSize: true});if (!rsb.workflow.hasWorkspacePrivilege("ModifyFlow")) {jsPlumb.setDraggable($groupEl[0], false)}
updateMap($group.id, $apiKey);return $group}
function calculatePositionByPorts($ports, $tabsHeight) {let $position = {x: Number.MAX_SAFE_INTEGER, y: Number.MAX_SAFE_INTEGER};let $endPos = {x: Number.MIN_SAFE_INTEGER, y: Number.MIN_SAFE_INTEGER};let $portCount = 0;for (let index = 0, length = !!$ports ? $ports.length : 0; index < length; index++) {let $port = rsb.workflow.flow.getPort($ports[index]);if (!$port) continue;let $portEle = $port.getUIElement()[0];$position.x = Math.min($position.x, $portEle.offsetLeft);$position.y = Math.min($position.y, $portEle.offsetTop);$endPos.x = Math.max($endPos.x, $portEle.offsetLeft + $portEle.offsetWidth);$endPos.y = Math.max($endPos.y, $portEle.offsetTop + $portEle.offsetHeight);++$portCount}
if ($portCount <= 0) return {x: 0, y: 0, width: 0, height: 0};$position.width = $endPos.x - $position.x + GROUP_PADDING * 4;$position.height = $endPos.y - $position.y + $tabsHeight + GROUP_PADDING * 4;$position.x -= GROUP_PADDING * 2;$position.y -= $tabsHeight + GROUP_PADDING;return $position}
function getInfoBarTotalHeight($groupEl) {return $($groupEl).find(".apigroup-heading").outerHeight() + $($groupEl).find(".apigroup-footer").outerHeight() + 2}
function initGroupEle($flowAPI, $groupEl, groupWidth, groupTop, groupLeft, groupHeight) {var tabHeight = getInfoBarTotalHeight($groupEl);$groupEl.find(".flow-api-name").text(encodeURIComponent($flowAPI.name));$groupEl.find('.api-method').text($flowAPI.method.toUpperCase());$groupEl.find(".flow-api-workspaceid").text(encodeURIComponent(rsb.workflow.flow.getCurrentWorkspace()));$groupEl.addClass("window").css({width: groupWidth, top: groupTop, left: groupLeft, height: groupHeight});$groupEl.find('.apigroup-body').css({height: groupHeight - tabHeight});$groupEl.resizable({disabled: !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"),minWidth: groupWidth,minHeight: groupHeight,start: function () {rsb.workflow.flow.clearSelected()},resize: function ($event) {var tabHeight = getInfoBarTotalHeight($groupEl);$groupEl.find('.apigroup-body').css({height: $groupEl[0].offsetHeight - tabHeight});jsPlumb.repaintEverything()},stop: function ($event, $ui) {rsb.workflow.flow.setCanvasCursor("");var currentWidth = $groupEl[0].offsetWidth;var currentHeight = $groupEl[0].offsetHeight;rsb.workflow.flow.save();rsb.workflow.flow.getActionPlayer().recordAction(function () {$groupEl.css({'width': currentWidth, 'height': currentHeight});$groupEl.find('.apigroup-body').css({height: $groupEl[0].offsetHeight - getInfoBarTotalHeight($groupEl)})}, function () {$groupEl.css({'width': $ui.originalSize.width, 'height': $ui.originalSize.height});$groupEl.find('.apigroup-body').css({height: $groupEl[0].offsetHeight - getInfoBarTotalHeight($groupEl)})})}})}
function addPortToGroup($ports, $groupId) {jsPlumb.setSuspendDrawing(true)
for (let index = 0; index < $ports.length; index++) {var $port = rsb.workflow.flow.getPort($ports[index]);if ($port) {var $group = rsb.workflow.apiGroupMgr.getGroupFor($port.getUIElement()[0]);!!$group && !rsb.workflow.resultContainer.is(":visible") && rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('The connector $connector$ exists in Flow API $name$ ($method$) already.', $.extend({connector: $ports[index]}, rsb.workflow.apiGroupMgr.getFlowAPI($group.el))), false);!$group && jsPlumb.addToGroup($groupId, $port.getUIElement()[0])}}
jsPlumb.setSuspendDrawing(false, true)}
function calculatePosition($groupEl, $flowAPI, $ports) {const $position = calculatePositionByPorts($ports, getInfoBarTotalHeight($groupEl));var groupTop = $position.y;var groupLeft = $position.x;var groupWidth = $position.width;var groupHeight = $position.height;if ($flowAPI.width > 0 && $flowAPI.height > 0) {groupTop = Math.min($flowAPI.posY, groupTop);groupLeft = Math.min($flowAPI.posX, groupLeft);groupWidth = Math.max($flowAPI.width, groupWidth);groupHeight = Math.max($flowAPI.height, groupHeight)}
if (groupWidth < GROUP_MIN_WIDTH) {groupWidth = GROUP_MIN_WIDTH}
if (groupHeight < GROUP_MIN_HEIGHT) {groupHeight = GROUP_MIN_HEIGHT}
return {groupTop, groupLeft, groupWidth, groupHeight}}
function updateParameters(parameterString, paraTab) {if (parameterString) {var paraLength = 0;var paraCount = 0;paraTab.removeClass('hidden');paraTab.find('.para-area').html('');let paraList = parameterString.split(',');for (let i = 0; i < paraList.length; i++) {if (paraLength + paraList[i].length < 30 || paraCount < 3) {paraTab.find('.para-area').append('<span class="label label-default api-para ellipsis">' + rsb.htmlEncode(paraList[i]) + '</span>');paraLength = paraLength + paraList[i].length;paraCount++} else {paraTab.find('.para-area').append('<span class="label label-default api-para">[...]</span>')
break}}} else {paraTab.addClass('hidden')}}
function getEmptyAdditionalEndpoints(port) {var additionalEndpoints = [];if (!$.isEmptyObject(port.getAdditionalOutputEndpoints())) {Object.getOwnPropertyNames(port.getAdditionalOutputEndpoints()).forEach(function (endpoint) {if (port.getAdditionalOutputEndpoints()[endpoint].connections.length === 0) {additionalEndpoints.push(port.getAdditionalOutputEndpoints()[endpoint])}})}
return additionalEndpoints}
var updatePortsPosition = function ($api, $element) {var position = {};position.top = $element.offsetTop + $api.posY;position.left = $element.offsetLeft + $api.posX;rsb.workflow.flow.getPort($element.id).setPortPosition(position)}
this.createGroup = function ($flowAPI) {var $ports = $flowAPI.connectors;var $apiKey = $flowAPI.getKey();var template = $('#api-template')[0].innerHTML;var startLabel = $('#startLabel')[0].innerHTML;var endLabel = $('#endLabel')[0].innerHTML;var baseZIndex = ++_apiCount  * 10;var $groupId = geneGroupId($apiKey);var apiStyle = geneStyle($groupId, baseZIndex);GROUP_CANVAS.append(apiStyle);GROUP_CANVAS.append($(template).attr('id', $groupId)[0]);var $groupEl = $('#' + $groupId);$groupEl.find("button.api-delete").toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("modifyflow"));$groupEl.addClass($groupId);var {groupTop, groupLeft, groupWidth, groupHeight} = calculatePosition($groupEl, $flowAPI, $ports);initGroupEle($flowAPI, $groupEl, groupWidth, groupTop, groupLeft, groupHeight);var DYNAMIC_CONNECTORS = {type: "Flowchart", options: {stub: [10, 10],cornerRadius: 15,midpoint: 0.5,gap: 8}};var ENPOINT_OPTION = {hoverClass: "anchor-hover",endpoint: {type: "Blank"},connector: DYNAMIC_CONNECTORS,connectorStyle: {stroke: "#DDDDDD", strokeWidth: 2},};var ENDPOINT_OPTION_SEND_TO = $.extend({}, ENPOINT_OPTION, {type: "SendTo",cssClass: "endpoint-send-to",source: true,target: false,maxConnections: -1,anchor: [[1, 0.5, 1, 0, 0, 0, "send-right"], [0.56, 1, 0, 1, 0, 0, "send-bottom"]]});var ENDPOINT_OPTION_RECEIVE = $.extend({}, ENPOINT_OPTION, {type: "Receive",cssClass: "endpoint-receive",source: false,target: true,maxConnections: -1,anchor: [[0, 0.5, -1, 0, 0, 0, "receive-left"], [0.5, 0, 0, -1, 0, 0, "receive-top"]]});$groupEl.find(".apigroup-body").append(startLabel).append(endLabel);_groupEndpoints[$groupId] = {};_groupEndpoints[$groupId].startEndPoint = jsPlumb.addEndpoint($groupEl.find(".design-start")[0], $.extend({}, ENDPOINT_OPTION_SEND_TO, {cssClass: "api-start"}));_groupEndpoints[$groupId].endEndPoint = jsPlumb.addEndpoint($groupEl.find(".design-end")[0], $.extend({}, ENDPOINT_OPTION_RECEIVE, {cssClass: "api-end"}));jsPlumb.setDraggable($groupEl.find(".design-start")[0], false);jsPlumb.setDraggable($groupEl.find(".design-end")[0], false);var $group = addGroup($groupEl, $apiKey);var ensurePortPositionInGroupCanvas = function ($groupEl, $portEl) {var $groupArea = rsb.workflow.getViewportRect($($groupEl));var $canvasArea = rsb.workflow.getViewportRect($($groupEl).find('.apigroup-body'));var $portArea = rsb.workflow.getViewportRect($portEl);var position = {};position.top = (Math.min(Math.max($portArea.top, $canvasArea.top), $canvasArea.bottom - 5 - $portArea.height) - $groupArea.top) / jsPlumb.currentZoom;position.left = (Math.min(Math.max($portArea.left, $canvasArea.left + 5), $canvasArea.right - 5 - $portArea.width) - $groupArea.left) / jsPlumb.currentZoom;$($portEl).css(position);position.left += $groupEl.offsetLeft;position.top += $groupEl.offsetTop;rsb.workflow.flow.getPort($portEl.id).setPortPosition(position)}
var updateGroupPosition = function ($api, $element) {$api.posX = $element.offsetLeft;$api.posY = $element.offsetTop;$api.height = $element.offsetHeight;$api.width = $element.offsetWidth}
var toggleSettings = function ($event) {if (!$groupEl.hasClass('selected')) {rsb.workflow.updatePageHash(rsb.workflow.flow.getCurrentWorkspace(), "api:" + $flowAPI.name + ":" + $flowAPI.method, "")} else {rsb.workflow.portSettings.hideSettings()}
rsb.stopPropagation($event);return false};$groupEl.find('.api-delete').on('click', function ($event) {rsb.workflow.flow.deleteFlowAPI($flowAPI);rsb.stopPropagation($event)});$groupEl.find('.api-settings').on('click', toggleSettings);$groupEl.find('.api-run').on('click', function ($event) {rsb.flowapiExecuteModal.show(rsb.workflow.flow.getCurrentWorkspace(), $flowAPI.name, $flowAPI.method);rsb.stopPropagation($event)});var originPosX = groupTop;var originPosY = groupLeft;var isDragging = false;var startDrag = false;var initilized = false;$groupEl.on('mousedown', function ($event) {if ($event.which != 1) return true;rsb.workflow.flow.hideContextMenu();startDrag = true;isDragging = false;rsb.workflow.apiGroupMgr.setDroppable(false);if (!$(this).hasClass('ui-selected')){rsb.workflow.flow.clearSelected()}
originPosX = this.offsetLeft;originPosY = this.offsetTop}).on('mousemove', function ($event) {var dragging = isDragging;isDragging = isDragging || Math.abs($event.originalEvent.movementX) + Math.abs($event.originalEvent.movementY) > 5;if (!dragging && isDragging && !$(this).hasClass('ui-selected')) {var $position = calculatePositionByPorts($flowAPI.connectors, getInfoBarTotalHeight($groupEl));$groupEl.resizable("option", "minWidth", Math.max($position.x + $position.width, GROUP_MIN_WIDTH));$groupEl.resizable("option", "minHeight", Math.max($position.y + $position.height, GROUP_MIN_HEIGHT))}}).on('mouseup', function ($event) {if ($event.which != 1) return true;if ($($event.target).hasClass('ui-resizable-handle')) {return true}
let $connectors = $('.flow-port.ui-selected');for (let $index = 0; $index < $connectors.length; $index++) {let $port = rsb.workflow.flow.getPort($connectors[$index].id);if (!!$port) {$port.getUIElement().trigger("mouseup", {groupId: $groupId})
return true}}
var portsIds = $flowAPI.connectors;for (const i in portsIds) {updatePortsPosition($flowAPI, rsb.workflow.flow.getPort(portsIds[i]).getUIElement()[0])}
updateGroupPosition($flowAPI, $event.currentTarget);let currentPosX = $event.currentTarget.offsetLeft;let currentPosY = $event.currentTarget.offsetTop;if (startDrag && (originPosY !== this.offsetTop || originPosX !== this.offsetLeft)) {if (originPosY && originPosX && (this.offsetTop !== originPosY || this.offsetLeft !== originPosX)) {let deltaLeft = currentPosX - originPosX;let deltaTop = currentPosY - originPosY;let $draggedGroups = [];let $selectedGroups = $(".apigroup.ui-selected");($selectedGroups.length > 0 ? $selectedGroups : $groupEl).each(function () {let $group = $(this);let $position = rsb.workflow.getPosition($group);$draggedGroups.push({"group": $group,"currentPositionTop": $position.top,"currentPositionLeft": $position.left,"originPositionTop": $position.top - deltaTop,"originPositionLeft": $position.left - deltaLeft})});rsb.workflow.flow.getActionPlayer().recordAction(function () {rsb.forEach($draggedGroups, function ($groupInfo) {$groupInfo.group.css({"left": $groupInfo.currentPositionLeft,"top": $groupInfo.currentPositionTop})});jsPlumb.repaintEverything()}, function () {rsb.forEach($draggedGroups, function ($groupInfo) {$groupInfo.group.css({"left": $groupInfo.originPositionLeft,"top": $groupInfo.originPositionTop})});jsPlumb.repaintEverything()})}
originPosY = this.offsetTop;originPosX = this.offsetLeft;for (let i = 0; i < $flowAPI.connectors.length; i++) {updatePortsPosition($flowAPI, rsb.workflow.flow.getPort($flowAPI.connectors[i]).getUIElement()[0])}
rsb.workflow.flow.save()}
startDrag = false});$groupEl.find('.apigroup-heading').on('click', function ($event) {!isDragging && toggleSettings($event)});jsPlumb.bind(jsPlumbBrowserUI.EVENT_GROUP_MEMBER_ADDED, function ($event) {var el = $event.el;if ($event.group.id !== $groupId) {return true}
if (initilized && !rsb.workflow.apiGroupMgr.isInsideGroup($event.group.el, el) && !$(el).hasClass('recordAction')) {jsPlumb.removeFromGroup($event.group.id, el);$(el).css('left', $event.group.el.offsetLeft + el.offsetLeft);$(el).css('top', $event.group.el.offsetTop + el.offsetTop);jsPlumb.repaintEverything()} else if (!initilized && !rsb.workflow.apiGroupMgr.isInsideGroup($event.group.el, el)) {ensurePortPositionInGroupCanvas($event.group.el, el)}
rsb.workflow.flow.getPort(el.id).fireSelect(false);if (initilized && !$flowAPI.connectors.includes(el.id)) {$flowAPI.connectors.push(el.id)}
rsb.workflow.flow.addClassToPort(el.id, $groupId);initilized && rsb.workflow.apiGroupMgr.validateGroup($flowAPI);initilized && rsb.workflow.flow.save();return false});jsPlumb.bind(jsPlumbBrowserUI.EVENT_GROUP_MEMBER_REMOVED, function ($event) {var el = $event.el;if ($event.group.id !== $groupId) {return true}
$flowAPI.connectors.splice($flowAPI.connectors.indexOf(el.id), 1);var endpoints = rsb.workflow.flow.removeClassFromPort(el.id, "", $groupId);rsb.workflow.flow.adjustDOMOrder(endpoints, el);jsPlumb.repaintEverything();rsb.workflow.apiGroupMgr.validateGroup($flowAPI);rsb.workflow.flow.save();return false});jsPlumb.bind(jsPlumbBrowserUI.EVENT_GROUP_REMOVED, function ($event) {if ($event.group.id !== $groupId) {return true}
for (let index = 0; index < $flowAPI.connectors.length; index++) {var port = rsb.workflow.flow.getPort($flowAPI.connectors[index]);if (port.getSendToEndPoint() != null) {port.getSendToEndPoint().enabled = true}
if (port.getReceiveEndPoint() != null) {port.getReceiveEndPoint().enabled = true}
getEmptyAdditionalEndpoints(port).forEach(function (endpoint) {endpoint.enabled = true});port.setPortPosition(rsb.workflow.getPosition(port.getUIElement()));var endpoints = rsb.workflow.flow.removeClassFromPort(port.getPortId(), "", $groupId);rsb.workflow.flow.adjustDOMOrder(endpoints, port.getUIElement()[0])}
_currentHighlightAPI = null;rsb.workflow.flow.getActionPlayer().cleanUpActions();return false});addPortToGroup($ports, $groupId);$group.droppable = false;rsb.workflow.apiGroupMgr.validateGroup($flowAPI);var dropCrossConnection = function ($endpoint, $portIds) {var $connections = !!$endpoint && $endpoint.connections || [];for (let index = 0; index < $connections.length; index++) {if (!!$connections[index].source && !!$connections[index].target && !!$($connections[index].source).data("instance") && !!$($connections[index].target).data("instance") && (!$portIds.includes($($connections[index].source).data("instance").getPortId()) || !$portIds.includes($($connections[index].target).data("instance").getPortId()))) {rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('Drop the crossed connection between $source$ and $target$.', {source: $($connections[index].source).data("instance").getPortId(),target: $($connections[index].target).data("instance").getPortId()}), false);jsPlumb.deleteConnection($connections[index])}}}
for (let index = 0; index < $flowAPI.connectors.length; index++) {var $port = rsb.workflow.flow.getPort($flowAPI.connectors[index]);if (!rsb.workflow.flow.isAllConnectionInAPI($port, $flowAPI.connectors)) {dropCrossConnection($port.getSendToEndPoint(), $flowAPI.connectors);dropCrossConnection($port.getReceiveEndPoint(), $flowAPI.connectors);dropCrossConnection($port.getTrappedToEndPoint(), $flowAPI.connectors);dropCrossConnection($port.getSuccessEndPoint(), $flowAPI.connectors);var $additionalOutputEndpoints = $port.getAdditionalOutputEndpoints() || {};for (let name in $additionalOutputEndpoints) {dropCrossConnection($additionalOutputEndpoints[name], $flowAPI.connectors)}}}
rsb.workflow.flow.getActionPlayer().cleanUpActions();initilized = true}
this.updateGroupSettings = function ($flowAPI, $settings) {var method = $settings.newhttpmethod || $settings.httpmethod || $flowAPI.method;var newKey = new FlowAPI({"name": $flowAPI.name, "method": method}).getKey();var $group = jsPlumb.getGroup(_groupIdMap[$flowAPI.getKey()]);updateMap($group.id, newKey);var apiContainer = $($group.el);var paraTab = apiContainer.find('.api-para-tab');var bodyFormatTab = apiContainer.find('.api-format-tab');var type = ($settings.bodytype || 'Raw').toLowerCase();var methodLabel = apiContainer.find(".api-method");methodLabel.text(method.toUpperCase());methodLabel.removeClass($flowAPI.method.toUpperCase()).addClass(method.toUpperCase());var parseType = function (type) {if (type === 'raw') {return 'Raw'} else if (type === 'form-data') {return 'Form Data'} else {return type}};if (bodyFormatTab[0].offsetHeight === 0) {bodyFormatTab.removeClass('hidden')}
apiContainer.find(".body-title").text('Body -'+ parseType(type));bodyFormatTab.find('.para-area').show();if (type === 'none') {bodyFormatTab.addClass('hidden')} else if (type === 'raw') {bodyFormatTab.find('.raw-section').show();bodyFormatTab.find('.para-area').hide();var $requestContentType = ($settings.requestcontenttype || "application/json").toLowerCase();if ($requestContentType === "application/xml") {apiContainer.find(".api-body-format").text("XML");apiContainer.find(".body-format-detail").text("application/xml")} else if ($requestContentType === "application/json") {apiContainer.find(".api-body-format").text("JSON");apiContainer.find(".body-format-detail").text("application/json")} else {apiContainer.find(".api-body-format").text("Custom");apiContainer.find(".body-format-detail").text($requestContentType)}} else {bodyFormatTab.find('.raw-section').hide();updateParameters($settings.requestbody, bodyFormatTab)}
var $responseType = ($settings.responsetype || "application/json").toLowerCase();if ($responseType === "application/xml") {apiContainer.find(".api-response-format").html("XML");apiContainer.find(".response-format-detail").html("application/xml")} else if ($responseType === "application/json") {apiContainer.find(".api-response-format").html("JSON");apiContainer.find(".response-format-detail").html("application/json")} else {apiContainer.find(".api-response-format").html("Custom");apiContainer.find(".response-format-detail").html($responseType)}
updateParameters($settings.queryparameters, paraTab);apiContainer.find('.apigroup-body').css({height: apiContainer.outerHeight() - getInfoBarTotalHeight(apiContainer)});jsPlumb.repaintEverything()}
this.saveGroup = function ($flowAPI) {var groupEl = $('#' + _groupIdMap[$flowAPI.getKey()])[0];if (!groupEl) return false;$flowAPI.width = groupEl.offsetWidth;$flowAPI.height = groupEl.offsetHeight;$flowAPI.posX = groupEl.offsetLeft;$flowAPI.posY = groupEl.offsetTop}
this.validateGroup = function ($flowAPI) {var $connectors = $flowAPI.connectors.slice();$flowAPI.start = '';$flowAPI.end = [];$flowAPI.connectors = [];var isLegal = true;var startPortCount = 0;var $group = jsPlumb.getGroup(_groupIdMap[$flowAPI.getKey()]);var groupEl = $group.el;var startEndPoint = _groupEndpoints[groupEl.id].startEndPoint;var endEndPoint = _groupEndpoints[groupEl.id].endEndPoint;var additionalEndpoints = [];if ($group.getNodes() && $group.getNodes().length != $connectors.length) {$connectors = $group.getNodes().reduce(function ($result, $node) {$node.el && $node.el.id && rsb.workflow.flow.getPort($node.el.id) && $result.push($node.el.id);return $result}, [])}
if (startEndPoint.connections.length > 0) {rsb.workflow.flow.getPort(startEndPoint.connections[0].targetId).getReceiveEndPoint().enabled = true}
if (endEndPoint.connections.length > 0) {for (let i = 0; i < endEndPoint.connections.length; i++) {var source = $(endEndPoint.connections[i].source).data("instance");if (source != null) {var endPort = rsb.workflow.flow.getPort(source.getPortId());if (endPort.getSendToEndPoint() != null) {endPort.getSendToEndPoint().enabled = true}
var endpoints = endPort.getAdditionalOutputEndpoints();if (!$.isEmptyObject(endpoints)) {Object.getOwnPropertyNames(endpoints).forEach(function (endpoint) {endpoints[endpoint].enabled = true})}}}}
endEndPoint.deleteEveryConnection();startEndPoint.deleteEveryConnection();for (let index = 0; index < $connectors.length; index++) {let $port = rsb.workflow.flow.getPort($connectors[index]);if (!!$port && !$flowAPI.connectors.includes($port.getPortId())) {$flowAPI.connectors.push($port.getPortId())}}
for (let index = 0; isLegal && index < $flowAPI.connectors.length; index++) {var $port = rsb.workflow.flow.getPort($flowAPI.connectors[index]);var $connectorId = $port.getPortId();var $portInfo = $port.getPortInfo();var hasSendTo = !$.isEmptyObject($portInfo.sendPort[""]);var hasAnySource = $port.getReceiveEndPoint().connections.length > 0;if (!hasAnySource) {$flowAPI.start = $connectorId;isLegal = ++startPortCount == 1 && ($flowAPI.connectors.length == 1 || !!$portInfo.hasConnections)}
var endpoints = getEmptyAdditionalEndpoints($port);endpoints.forEach(function (endpoint) {additionalEndpoints.push(endpoint)});(!hasSendTo || endpoints.length > 0) && $flowAPI.end.push($connectorId)}
if (startPortCount != 1 || $flowAPI.end.length === 0) {isLegal = false}
if (isLegal) {$(groupEl).find('.apigroup-validate-error').hide();$(groupEl).find('.api-design-label').show();jsPlumb.repaintEverything();if (rsb.workflow.flow.getPort($flowAPI.start) && startEndPoint.connections.length === 0) {var receiveEndpoint = rsb.workflow.flow.getPort($flowAPI.start).getReceiveEndPoint();jsPlumb.connect({source: startEndPoint,target: receiveEndpoint});receiveEndpoint.enabled = false}
for (let i = 0; i < $flowAPI.end.length; i++) {var port = rsb.workflow.flow.getPort($flowAPI.end[i]);var sendToEndpoint = port.getSendToEndPoint();if (sendToEndpoint?.connections == null || sendToEndpoint.connections.length > 0) continue;var connection = jsPlumb.connect({source: sendToEndpoint,target: endEndPoint});sendToEndpoint.enabled = false;connection.setPaintStyle({stroke: "#DDDDDD", strokeWidth: 2, type: "basic"});connection.hideOverlays()}
for (let j = 0; j < additionalEndpoints.length; j++) {var additionalConnection = jsPlumb.connect({source: additionalEndpoints[j],target: endEndPoint});additionalEndpoints[j].enabled = false;additionalConnection.setPaintStyle({stroke: "#DDDDDD", strokeWidth: 2, type: "basic", dashstyle: '0'});additionalConnection.hideOverlays()}
if (startEndPoint.connections.length > 0) {for (let i = 0; i < startEndPoint.connections.length; i++) {$(startEndPoint.connections[i].connector.canvas).addClass(groupEl.id)}}
if (endEndPoint.connections.length > 0) {for (let i = 0; i < endEndPoint.connections.length; i++) {$(endEndPoint.connections[i].connector.canvas).addClass(groupEl.id)}}} else {$(groupEl).find('.apigroup-validate-error').show().find("span").text(startPortCount == 0 || $flowAPI.end.length === 0 ? 'Flow APIs must have a clear start and end path. Circular flows are not allowed.': 'All connectors must be connected to each other.');$(groupEl).find('.api-design-label').hide()}
jsPlumb.repaintEverything()}
this.deleteGroup = function ($flowAPI) {jsPlumb.removeGroup(_groupIdMap[$flowAPI.getKey()])}
this.moveGroup = function ($flowAPI, $posX, $posY) {const $group = jsPlumb.getGroup(_groupIdMap[$flowAPI.getKey()]);const $groupEl = $($group.el);const diffX = $posX - $flowAPI.posX;const diffY = $posY - $flowAPI.posY;if ($groupEl != null && (diffX != 0 || diffY != 0)) {const movePosition = (dx, dy) => {$flowAPI.posX += dx;$flowAPI.posY += dy;for (const portsId of $flowAPI.connectors) {updatePortsPosition($flowAPI, rsb.workflow.flow.getPort(portsId).getUIElement()[0])}
$groupEl.css({left: $flowAPI.posX, top: $flowAPI.posY})}
return [movePosition.bind(null, diffX, diffY), movePosition.bind(null, -diffX, -diffY)]} else {return [() => undefined, () => undefined]}}
this.resizeGroup = function ($flowAPI, $groupEl) {const position = {width: $groupEl.offsetWidth,height: $groupEl.offsetHeight,left: $groupEl.offsetLeft,top: $groupEl.offsetTop};const resizeAction = (groupWidth, groupTop, groupLeft, groupHeight) => {$groupEl = $($groupEl);const tabHeight = getInfoBarTotalHeight($groupEl);$groupEl.css({width: groupWidth, top: groupTop, left: groupLeft, height: groupHeight});$groupEl.find('.apigroup-body').css({height: groupHeight - tabHeight});$groupEl.resizable("option", "minWidth", Math.max(groupWidth, GROUP_MIN_WIDTH));$groupEl.resizable("option", "minHeight", Math.max(groupHeight, GROUP_MIN_HEIGHT))}
return [() => {const {groupTop, groupLeft, groupWidth, groupHeight} = calculatePosition($groupEl, {posY: 0, posX: 0, width: 0, height: 0}, $flowAPI.connectors);resizeAction(Math.max(groupLeft + groupWidth, GROUP_MIN_WIDTH), position.top, position.left, Math.max(groupTop + groupHeight, GROUP_MIN_HEIGHT))},() => resizeAction(position.width, position.top, position.left, position.height)
]}
this.getFlowAPI = function ($group) {$group = $group instanceof jQuery ? $group[0] : $group
return rsb.workflow.flow.getFlowAPI(_flowAPIKeyMap[$group.id])}
this.updateHighlight = function ($flowAPI) {if ($flowAPI) {$(jsPlumb.getGroup(_groupIdMap[$flowAPI.getKey()]).el).addClass('selected');_currentHighlightAPI = _groupIdMap[$flowAPI.getKey()]} else {if (_currentHighlightAPI) {$(jsPlumb.getGroup(_currentHighlightAPI).el).removeClass('selected')}}}
this.getGroupFor = function ($ele) {$ele = $ele instanceof jQuery ? $ele[0] : $ele
var $group = jsPlumb.getGroupFor($ele);return !!$group && !!$group.el ? $group : null}
this.getGroups = function () {return jsPlumb.groupManager.getGroups()}
this.setDroppable = function ($droppable) {rsb.workflow.apiGroupMgr.getGroups().forEach(function ($group) {$group.droppable = $droppable})}
this.onSelect = function ($group, $selected) {var $groupEl = $($group.el);if ($selected) {$groupEl.addClass("ui-selected");$groupEl.addClass("active");jsPlumb.addToDragSelection($groupEl[0]);rsb.workflow.apiGroupMgr.setDroppable(false)} else if ($groupEl.hasClass("ui-selected")) {$groupEl.removeClass("ui-selected");$groupEl.removeClass("active");jsPlumb.removeFromDragSelection($groupEl[0])}}
this.isInsideGroup = function ($groupEl, $portEl) {var $canvasArea = rsb.workflow.getViewportRect($($groupEl).find('.apigroup-body'));var $portArea = rsb.workflow.getViewportRect($portEl);return $portArea.left + 5 >= $canvasArea.left && $portArea.right - 5 <= $canvasArea.right && $portArea.top >= $canvasArea.top && $portArea.bottom <= $canvasArea.bottom}
this.toggleBorderStyle = function ($groupEl, $valid) {$($groupEl).find('.apigroup-body').toggleClass('alert', !$valid)}}
rsb.workflow.apiGroupMgr = new ApiGroupManager();var Port = function($props, $elem) {var DYNAMIC_CONNECTORS = {type:"Flowchart", options:{stub: [10,10],cornerRadius: 15,midpoint: 0.45,gap:10}};var STATIC_CONNECTORS = {type:"Flowchart",options: {cornerRadius: 20,midpoint: 0.45,gap:10,alwaysRespectStubs: true}};var ENDPOINT_OPTION = {hoverClass: "anchor-hover",endpoint: {type:"Dot",options: { radius: 8 }},connector: DYNAMIC_CONNECTORS,connectorStyle: { stroke:"#0662AE", strokeWidth:2, type: "send" },connectorOverlays:[{ type:"Arrow", options : { width:10, length:10, location:1, id:"arrow" } }
]};var ENDPOINT_OPTION_RECEIVE = $.extend({}, ENDPOINT_OPTION, {type: "Receive",cssClass:"endpoint-receive",source: false,target: true,maxConnections: -1,anchor: Port.RECEIVE_ANCHORS});var ENDPOINT_OPTION_SEND_TO = $.extend({}, ENDPOINT_OPTION, {type: "SendTo",cssClass: "endpoint-send-to",source: true,target: false,maxConnections: 1,anchor: Port.SENDTO_ANCHORS,paintStyle:{ fill:"#0662AE" },hoverPaintStyle:{ fill:"#115D8B" }});var ENDPOINT_OPTION_FORK = $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "Fork",paintStyle: {fill: "#999"},hoverPaintStyle: {fill: "#999"},connectorStyle: { dashstyle:"2 4", stroke:"#999", strokeWidth:2, type:"fork" },anchor: Port.FORK_ANCHORS});var ENDPOINT_OPTION_COPY = $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "Copy",anchor: Port.FORK_ANCHORS});var ENDPOINT_OPTION_TRAP = $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "Trap",cssClass: "endpoint-trap",paintStyle:{ fill: "#A94442" },hoverPaintStyle:{ fill: "#A94442" },connectorStyle: { dashstyle:"2 4", stroke:"#A94442", strokeWidth:2, type:"trap" },anchor: Port.TRAP_ANCHORS});var ENDPOINT_OPTION_SUCCESS = $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "Success",cssClass: "endpoint-success",paintStyle:{ fill: "#198754" },hoverPaintStyle:{ fill: "#198754" },connectorStyle: { stroke:"#198754", strokeWidth:2, type:"success" },anchor: Port.SUCCESS_ANCHORS});const ENDPOINT_CONNECTOR_OPTIONS = {"blue": $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "blue"}),"bluedashed": $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "bluedashed",connectorStyle: { dashstyle:"2 4", stroke:"#0662AE", strokeWidth:2 }}),"gray": $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "gray",paintStyle:{ fill: "#999" },hoverPaintStyle:{ fill: "#999" },connectorStyle: { stroke:"#999", strokeWidth:2 },}),"graydashed": $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "gray",paintStyle:{ fill: "#999" },hoverPaintStyle:{ fill: "#999" },connectorStyle: { dashstyle:"2 4", stroke:"#999", strokeWidth:2 },}),"red": $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "red",cssClass: "endpoint-trap",paintStyle:{ fill: "#A94442" },hoverPaintStyle:{ fill: "#A94442" },connectorStyle: { dashstyle:"2 4", stroke:"#A94442", strokeWidth:2 }}),"green": $.extend({}, ENDPOINT_OPTION_SEND_TO, {type: "green",cssClass: "endpoint-success",paintStyle:{ fill: "#198754" },hoverPaintStyle:{ fill: "#198754" },connectorStyle: { stroke:"#198754", strokeWidth:2 },})};var DEFAULTS = {portId: "",portType: "",position: {left: 0, top: 0},width: 295,style: "",onDragged: function() {},onConnectTo: function() {},onConnectionDetached: function() {},onClicked: function() {}}
var _props = $.extend({}, DEFAULTS, $props);var _ui = {port: $($elem),middleContent: $elem.find(".flow-port-content-middle"),portTypeTxt: $elem.find(".flow-port-connectortype"),infoIcons: $elem.find(".flow-port-content-icons"),outputList: null};var _receiveEndpoint = null;var _sendToEndpoint = null;var _trappedToEndpoint = null;var _successEndpoint = null;var _additionalOutputEndpoints = null;var _mouseDown = {};var _uiStyle = 0;var _outputDefs = null;var _extensionDefs = null;this.getPortId = function() {return _props.portId}
this.getPortType = function() {return _props.portType}
this.getDesc = function() {return _props.desc}
this.getStyle = function() {return _props.style}
this.getPortStyleKey = function() {if (_props.style) {return _props.portId + "_" + _props.style} else {return _props.portId}}
this.hasTrappedTo = function() {return _trappedToEndpoint && _trappedToEndpoint.connections.length > 0}
this.showTrapEndpoint = function() {appendTrapEndpoint()}
this.hideTrapEndpoint = function() {let $endpoint = _trappedToEndpoint;_trappedToEndpoint = null;if (_uiStyle == 1) {setOutputDefs(_outputDefs);setExtensionDefs(_extensionDefs);if (_successEndpoint != null) {const target = $(_successEndpoint.connections[0].target).data("instance");successTo(target)}} else {removeEndpoint($endpoint)}}
this.hasSuccessPort = function() {return _successEndpoint && _successEndpoint.connections.length > 0}
this.showSuccessEndpoint = function() {appendSuccessEndpoint()}
this.hideSuccessEndpoint = function() {let $endpoint = _successEndpoint;_successEndpoint = null;if (_uiStyle == 1) {setOutputDefs(_outputDefs);setExtensionDefs(_extensionDefs);if (_trappedToEndpoint != null) {const target = $(_trappedToEndpoint.connections[0].target).data("instance");trapTo(target)}} else {removeEndpoint($endpoint)}}
this.appendToUI = function($container) {_ui.portTypeTxt.text(rsb?.connectorTypeList?.[_props.portType.toLowerCase()]?.name || _props.portType);if (_props.desc) {_ui.middleContent.addClass("flow-port-txt-info");var iconElem = $("<a class='flow-item-settings flow-item-info'><i class='fa fa-info-circle'/></>");new bootstrap.Popover(iconElem, {html: false,placement: "top",trigger: "hover",content: _props.desc});iconElem.prependTo(_ui.infoIcons)} else {_ui.infoIcons.find("a.flow-item-info").remove()}
jsPlumbBrowserUI.ready(function() {if (_ui.port.hasClass("ui-draggable")) {_ui.port.draggable("destroy")}
if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) {_ui.port.toggleClass("restricted-modifyflow", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));jsPlumb.setDraggable(_ui.port[0], false)}
if (!_props.style || _props.style == "receiver") {_ui.port.append($("<span class='position-absolute top-0 start-0 translate-middle badge rounded-pill bg-secondary unsend-count'>0</span>"))}
var $startPosition = null;_ui.port.addClass("window").css({position: "absolute",top: Math.round(_props.position["top"] / 5) * 5 + "px",left: Math.round(_props.position["left"] / 5) * 5 + "px",width: _props.width + "px"}).mousedown(function ($event) {var $group = rsb.workflow.apiGroupMgr.getGroupFor(_ui.port[0]);var $port = rsb.workflow.flow.getPort($event.currentTarget.id);var portIds = []
for (let i = 0; i < $('.ui-selected').length; i++) {portIds.push($('.ui-selected')[i].id)}
var $selectedGroupCount = 0;if (!$($event.target).parents(".flow-port").hasClass("ui-selected") && !$($event.target).hasClass("ui-selected")) {rsb.workflow.flow.clearSelected()} else {$selectedGroupCount = $(".apigroup.ui-selected").length}
if ($selectedGroupCount <= 0) {var $valid = true;if ($port.getStyle() || !$group && !rsb.workflow.flow.isAllConnectionInAPI($port, portIds)) {$valid = false}
rsb.workflow.apiGroupMgr.setDroppable($valid && rsb.workflow.isAPIAble($port.getPortType()))} else {rsb.workflow.apiGroupMgr.setDroppable(false)}
if (!!$group) {if (rsb.workflow.flow.getPort(this.id).getPortInfo().hasConnections || $group.children.length === 1) {$group.constrain = true} else {$group.constrain = false;$group.revert = false}}
if ($event.which == 1) {_ui.port.addClass("flow-port-drag-start")}
$startPosition = { x: $event.clientX, y: $event.clientY }}).mousemove(function($event) {if ($event.which == 1 && !!$startPosition && _ui.port.hasClass("flow-port-drag-start") && Math.abs($event.clientX - $startPosition.x) + Math.abs($event.clientY - $startPosition.y) > 5) {var selectedPorts=$('.flow-port.ui-selected');if (selectedPorts.length > 0) {for (let index = 0; index < selectedPorts.length; index++) {rsb.workflow.flow.addClassToPort(selectedPorts[index].id, "flow-port-dragging")}} else {rsb.workflow.flow.addClassToPort($event.currentTarget.id, "flow-port-dragging")}}
if (!rsb.workflow.apiGroupMgr.getGroupFor(_ui.port[0]) && _ui.port.hasClass("flow-port-drag-start")) {var port = rsb.workflow.flow.getPort(this.id);var $rect = rsb.workflow.getViewportRect(_ui.port);rsb.workflow.apiGroupMgr.getGroups().forEach($group => {rsb.workflow.apiGroupMgr.toggleBorderStyle($group.el, !rsb.workflow.isRectOverlapped($rect, rsb.workflow.getViewportRect($group.el)) || rsb.workflow.isAPIAble(port.getPortType()))})}}).mouseup(function($event, $group) {let $groupId = !!$group && $group.groupId;if ($event.which == 1 && !!$startPosition || !!$groupId) {$startPosition = null;if (!_ui.port.hasClass("flow-port-dragging") && _ui.port.hasClass("flow-port-drag-start") && rsb.workflow.flow.getMode() != rsb.workflow.lassoMode) {if (!_ui.port.data("isExtensionClicking")) {fireClicked($event)}
_ui.port.data("isExtensionClicking", null)} else if (_props.onDragged && (_ui.port.hasClass("flow-port-drag-start") || !!$groupId)) {var $port = rsb.workflow.flow.getPort(this.id);var $isAPIAble = rsb.workflow.isAPIAble($port.getPortType());var $dropToGroupMap = null;if (!$groupId && !rsb.workflow.apiGroupMgr.getGroupFor(_ui.port[0])) {$dropToGroupMap = dropToGroupValidate(rsb.workflow.apiGroupMgr.getGroups(), $port, $isAPIAble)} else {!$groupId && $port.validatePosition()}
_props.onDragged(!!$groupId ? {currentTarget: _ui.port} : $event["originalEvent"], rsb.workflow.getPosition(_ui.port), $dropToGroupMap)}
_ui.port.removeClass("flow-port-drag-start")} else if ($event.which == 1 && !$startPosition) {rsb.workflow.flow.correctPortPosition()}
$('.flow-port-dragging').removeClass("flow-port-dragging");rsb.workflow.apiGroupMgr.setDroppable($(".apigroup.ui-selected").length <= 0);jsPlumb.repaintEverything()}).appendTo($container);if (_props.style) {_ui.port.addClass("port-icon-" + _props.style)}
jsPlumb.setDragGrid({w:5,h:5});if (rsb.workflow.hasWorkspacePrivilege("modifyflow")) {_ui.port.resizable({handles: "e",grid: [5, 0],minWidth: _props.style ? 236 : 295,start: function (event, ui) {ui.originalSize.width = $(this).outerWidth();var $group = rsb.workflow.apiGroupMgr.getGroupFor(_ui.port);_ui.port.resizable("option", "maxWidth", !!$group ? $group.el.offsetWidth - _ui.port[0].offsetLeft : null)},resize: function () {updateWarningIcon();jsPlumb.repaintEverything()},stop: function () {jsPlumb.setDraggable($(this)[0], true);rsb.workflow.flow.setSaved(false);rsb.workflow.flow.setCanvasCursor("");var minPortWidth = _props.style ? 236 : 295;var originWidth = _props.width;var finalWidth = $(this).width() < minPortWidth ? minPortWidth : $(this).width();rsb.workflow.flow.getPort(this.id).setPortWidth(finalWidth);var targetPort = $(this);var portInstance = rsb.workflow.flow.getPort(this.id);rsb.workflow.flow.getActionPlayer().recordAction(function () {targetPort.outerWidth(finalWidth);portInstance.setPortWidth(finalWidth);jsPlumb.repaintEverything()}, function () {targetPort.outerWidth(originWidth);portInstance.setPortWidth(originWidth);jsPlumb.repaintEverything()})}})}
_ui.port.find(".ui-resizable-handle").mousedown(function() {jsPlumb.setDraggable(_ui.port[0], false)});_uiStyle = rsb.workflow.nav.getUiStyle(_props.portType);if (_uiStyle == 0) {var configPort = function (port,anchorType,portClass) {port.setAnchor(anchorType);port.connector = DYNAMIC_CONNECTORS;port.addClass(portClass)}
if (_props.style) {if (_props.style == "sender") {_sendToEndpoint = jsPlumb.addEndpoint(_ui.port[0], $.extend({}, ENDPOINT_OPTION_SEND_TO, {cssClass: "endpoint-send-to sender-endpoint"}));configPort(_sendToEndpoint, Port.SENDTO_ANCHORS, Port.INIT_ANCHOR_CLASS_SEND)} else {_receiveEndpoint = jsPlumb.addEndpoint(_ui.port[0], $.extend({}, ENDPOINT_OPTION_RECEIVE, {cssClass: "endpoint-receive receiver-endpoint"}));configPort(_receiveEndpoint, Port.RECEIVE_ANCHORS, Port.INIT_ANCHOR_CLASS_RECEIVE)}} else {_receiveEndpoint = jsPlumb.addEndpoint(_ui.port[0], ENDPOINT_OPTION_RECEIVE);_sendToEndpoint = jsPlumb.addEndpoint(_ui.port[0], ENDPOINT_OPTION_SEND_TO);if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) {_sendToEndpoint.enabled = false;_receiveEndpoint.enabled = false}
configPort(_sendToEndpoint, Port.SENDTO_ANCHORS, Port.INIT_ANCHOR_CLASS_SEND);configPort(_receiveEndpoint, Port.RECEIVE_ANCHORS, Port.INIT_ANCHOR_CLASS_RECEIVE)}
var additionalOutputs = rsb.workflow.nav.getAdditionalOutputs(_props.portType);if (additionalOutputs && additionalOutputs.length > 0) {_additionalOutputEndpoints = Object.create(null);let $map = additionalOutputs.reduce(function($result, $name) { $result[$name.toLowerCase()] = $name; return $result}, {})
let $anchorPositions = adjustBottomAnchorPositions(null, $map, null);let $index = 0;for (let $outputName in $map) {let $option = _props.portType.match(/copy/i) ? ENDPOINT_OPTION_COPY : ENDPOINT_OPTION_FORK;let $anchor = $anchorPositions[$index++] || Port.FORK_ANCHORS;_additionalOutputEndpoints[$outputName] = jsPlumb.addEndpoint(_ui.port[0], $.extend({}, $option, {anchor: $anchor}));_additionalOutputEndpoints[$outputName].connector = DYNAMIC_CONNECTORS;if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) {_additionalOutputEndpoints[$outputName].enabled = false}}}}})}
this.removeFromUI = function() {jsPlumbBrowserUI.ready(function() {jsPlumb.deleteConnectionsForElement(_ui.port[0])
jsPlumb.unmanage(_ui.port[0]);_ui.port.remove()});if (this.hasClass("active")) {rsb.workflow.portSettings.hideSettings()}}
this.getReceiveEndPoint = function() {return _receiveEndpoint}
this.getSendToEndPoint = function() {return _sendToEndpoint}
this.getTrappedToEndPoint = function() {return _trappedToEndpoint}
this.getSuccessEndPoint = function() {return _successEndpoint}
this.getAdditionalOutputEndpoints = function() {return _additionalOutputEndpoints}
this.connectTo = function($sendTo, $outputName) {if ($sendTo) {if ($outputName?.length > 0) {$outputName = $outputName.toLowerCase();if (!!_additionalOutputEndpoints && !!_additionalOutputEndpoints[$outputName]) {jsPlumb.connect({ source: _additionalOutputEndpoints[$outputName], target: $sendTo.getReceiveEndPoint()})}} else if (_sendToEndpoint) {jsPlumb.connect({ source: _sendToEndpoint, target: $sendTo.getReceiveEndPoint()})}}}
this.trapTo = function($trapTo) {trapTo($trapTo)}
this.successTo = function($successPort) {successTo($successPort)}
this.addClass = function($classes, $selector) {if ($selector) {_ui.port.find($selector).addClass($classes)} else {_ui.port.addClass($classes)}}
this.removeClass = function($classes, $selector) {if ($selector) {_ui.port.find($selector).removeClass($classes)} else {_ui.port.removeClass($classes)}}
this.hasClass = function($class) {return _ui.port.hasClass($class)}
this.getUIElement = function() {return _ui.port}
this.getPortInfo = function() {var info = {};var position = rsb.workflow.getPosition(_ui.port);info.posY = position.top;info.posX = position.left;info.connectorId = this.getPortId();info.connectorType = this.getPortType();info.style = this.getStyle();info.width = Number(_ui.port.css("width").replace("px", "")) || 295;info.sendPort = {};info.hasConnections = false;info.trapPort = "";if (_sendToEndpoint && _sendToEndpoint.connections.length > 0) {if ($(_sendToEndpoint.connections[0].target).data("instance")) {info.sendPort[""] = $(_sendToEndpoint.connections[0].target).data("instance").getPortId()}}
if (_receiveEndpoint && _receiveEndpoint.connections && _receiveEndpoint.connections.length > 0 ||
_sendToEndpoint && _sendToEndpoint.connections && _sendToEndpoint.connections.length > 0) {info.hasConnections = true}
if (_trappedToEndpoint && _trappedToEndpoint.connections.length > 0) {if ($(_trappedToEndpoint.connections[0].target).data("instance")) {info.trapPort = $(_trappedToEndpoint.connections[0].target).data("instance").getPortId();info.hasConnections = true}}
if (_successEndpoint && _successEndpoint.connections.length > 0) {if ($(_successEndpoint.connections[0].target).data("instance")) {info.successPort = $(_successEndpoint.connections[0].target).data("instance").getPortId();info.hasConnections = true}}
if (_additionalOutputEndpoints) {for (var name in _additionalOutputEndpoints) {if (_additionalOutputEndpoints[name] && _additionalOutputEndpoints[name].connections.length > 0) {info.hasConnections = true;if ($(_additionalOutputEndpoints[name].connections[0].target).data("instance")) {info.sendPort[name] = $(_additionalOutputEndpoints[name].connections[0].target).data("instance").getPortId()}}}}
return info}
this.getPortPosition = function() {return _props.position}
this.setPortPosition = function($position) {_props.position = $position}
this.setPortWidth = function($width) {_props.width = $width}
this.hasTrapToEndpoint = function() {return _trappedToEndpoint != null}
this.hasSuccessEndpoint = function() {return _successEndpoint != null}
this.fireConnectTo = function($target, $sourceEndpoint, $targetEndpoint) {if (this.onConnectTo) {this.onConnectTo($target, $sourceEndpoint, $targetEndpoint)}}
this.onConnectTo = _props.onConnectTo;this.fireConnectionDetached = function($target, $sourceEndpoint, $targetEndpoint) {if (this.onConnectionDetached) {this.onConnectionDetached($target, $sourceEndpoint, $targetEndpoint)}}
this.onConnectionDetached = _props.onConnectionDetached;this.fireShowSettings = function() {var portList = rsb.workflow.flow.listPorts();for (var i in portList) {portList[i].fireSelect(false)}
if (_ui.port.attr("port-style")) {portList[this.getPortId() + "_sender"].fireSelect(true);portList[this.getPortId() + "_receiver"].fireSelect(true)} else {onSelect(true)}}
this.fireSettingsHidden = function() {if (_ui.port.attr("port-style")) {var ports = rsb.workflow.flow.listPorts();if ( ports[this.getPortId() + "_sender"] && ports[this.getPortId() + "_receiver"]) {ports[this.getPortId() + "_sender"].fireSelect(false);ports[this.getPortId() + "_receiver"].fireSelect(false);return}}
onSelect(false)}
this.fireSelect = function($selected) {onSelect($selected)}
this.validatePosition = function ($fireEvent) {let $group = rsb.workflow.apiGroupMgr.getGroupFor(this.getUIElement()[0]);if (!!$group) {let $groupEl = $group.el;if (!rsb.workflow.apiGroupMgr.isInsideGroup($groupEl, this.getUIElement())) {if (!rsb.workflow.isRectOverlapped(rsb.workflow.getViewportRect($groupEl), rsb.workflow.getViewportRect(this.getUIElement()))) {return false}
_ui.port.addClass('window').css({"position": "absolute","top": _props.position.top - $groupEl.offsetTop,"left": _props.position.left - $groupEl.offsetLeft})}
if (!!$fireEvent && _props.onDragged && _ui.port.hasClass("flow-port-drag-start")) {_props.onDragged({currentTarget: _ui.port}, rsb.workflow.getPosition(_ui.port), null)}}}
this.getOutputDefs = () => {return _outputDefs}
this.fireSettingsChanged = function(success) {if (success) {setTimeout(() => {$.ajax({url: "src/getConnectorAutomationInfo.rsb",type: "GET",data: { "@json": true, "workspaceid": rsb.workflow.flow.getCurrentWorkspace(), "portid": this.getPortId(), "_randomtoken": rsb.securityRand() },dataType: "json"}).done(function(data, textStatus, jqXHR) {var automationInfoResult = data["items"];var errorMsg = rsb.getResultErrorMessage(automationInfoResult);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else if (automationInfoResult[0]) {var automationInfo = rsb.workflow.normalizeResponse(automationInfoResult[0]);onUpdateAutomationInfo({outputDefs: automationInfo["outputdefs"][0], extensionDefs: automationInfo["flowextensiondefs"][0], receiveEnabled: automationInfo["receiveenabled"][0], flowUiStyle: automationInfo["flowuistyle"][0]})}})}, 0);var desc = $("textarea[name='connectordescription']").val();if (_props.style) {var nodes = [];nodes.push(rsb.workflow.flow.getPort(this.getPortId(), "sender"));var receiverNode = rsb.workflow.flow.getPort(this.getPortId(), "receiver");nodes.push(receiverNode);nodes.forEach(function($node) {$node.upDateDescriptionIcon(desc)})} else {this.upDateDescriptionIcon(desc)}}}
this.getUiStyle = () => {return _uiStyle}
this.fireUpdateAutomationInfo = ({outputDefs, extensionDefs, receiveEnabled, flowUiStyle}) => {onUpdateAutomationInfo({outputDefs, extensionDefs, receiveEnabled, flowUiStyle});this.updatePrivilege()}
this.updatePrivilege = () => {var modifyFlow = rsb.workflow.hasWorkspacePrivilege("ModifyFlow");_ui.port.toggleClass("restricted-modifyflow", !modifyFlow);jsPlumb.setDraggable(_ui.port[0], modifyFlow);if (_receiveEndpoint != null) _receiveEndpoint.enabled = modifyFlow;if (_sendToEndpoint != null) _sendToEndpoint.enabled = modifyFlow;if (_trappedToEndpoint != null) _trappedToEndpoint.enabled = modifyFlow;if (_successEndpoint != null) _successEndpoint.enabled = modifyFlow;if (_additionalOutputEndpoints != null) {Object.keys(_additionalOutputEndpoints).forEach((name) => {_additionalOutputEndpoints[name].enabled = modifyFlow})}
const updateExtensionItemPrivilege = (elem) => {const extensionDef = $(elem).data("extensionDef");let hasPermission = true;if (extensionDef?.requiredPermissions != null) {extensionDef.requiredPermissions.split(",").forEach((permission) => {if (!rsb.workflow.hasConnectorPrivilege(_props.portId, permission) && !rsb.workflow.hasWorkspacePrivilege(permission)) {hasPermission = false}})}
$(elem).toggleClass("hidden", !hasPermission)}
_ui.outputList?.find(".connector-extension").each((i, elem) => {updateExtensionItemPrivilege(elem)});_ui.extensionList?.find(".connector-extension").each((i, elem) => {updateExtensionItemPrivilege(elem)});const hasExtensions = _ui.extensionList?.find(".connector-extension:visible")?.length > 0;_ui.extensionList?.toggleClass("hidden", !hasExtensions);_ui.port.toggleClass("has-extensions", hasExtensions)}
this.upDateDescriptionIcon = (desc) => {if (desc) {_props.desc = desc.length > 300 ? (desc.substring(0, 300) + "...") : desc;_ui.port.find(".flow-port-content-middle").toggleClass("flow-port-txt-info", true);_ui.infoIcons.find("a.flow-item-info").remove();var iconElem = $("<a class='flow-item-settings flow-item-info'><i class='fa fa-info-circle'/></>");new bootstrap.Popover(iconElem, {html: false,placement: "top",trigger: "hover",content: _props.desc});iconElem.prependTo(_ui.infoIcons)} else {_ui.port.find(".flow-port-content-middle").toggleClass("flow-port-txt-info", false);_ui.infoIcons.find("a.flow-item-info").remove()}
updateWarningIcon()}
this.updateWarningIcon = () => {updateWarningIcon()}
var adjustBottomAnchorPositions = function ($successTo, $additionalOutputEndpoints, $trapTo) {let $endpointCount = $additionalOutputEndpoints && Object.keys($additionalOutputEndpoints).length || 0;let $positions = [];if ($endpointCount <= 0 && !$successTo) {$positions = [Port.TRAP_ANCHORS]} else if ($endpointCount <= 0 || $endpointCount == 1 && !$successTo) {$positions = [Port.FORK_ANCHORS, Port.TRAP_ANCHORS]} else {if (!!$successTo) {++$endpointCount}
if (!!$trapTo) {++$endpointCount}
if ($endpointCount <= 2) {$positions = [Port.FORK_ANCHORS, Port.TRAP_ANCHORS]} else if ($endpointCount == 3) {$positions = [Port.SUCCESS_ANCHORS, Port.FORK_ANCHORS, Port.TRAP_ANCHORS]} else {let $padding = Math.max(0, 0.08 - $endpointCount * 0.01);let $delta = Math.min($endpointCount * 0.005, 0.08);[[$padding, 0.52 - $delta, ($endpointCount + 1) >>> 1], [0.48 + $delta, 1 - $padding, $endpointCount >>> 1]].forEach(function ($chunk) {let $distance = ($chunk[1] - $chunk[0]) / ($chunk[2] + 1);for (let index = 0; index < $chunk[2]; index++) {$positions.push([$chunk[0] + (index + 1) * $distance, 1, 0, 1, 0, 0, "send-bottom"])}})}}
let $anchorIndex = 0;if (!!$successTo) {let $anchor = $positions[$anchorIndex++];!!$successTo.setAnchor && $successTo.setAnchor($anchor)}
if ($additionalOutputEndpoints) {for (let $outputName in $additionalOutputEndpoints) {let $anchor = $positions[$anchorIndex++];let $endpoint = $additionalOutputEndpoints[$outputName];!!$endpoint.setAnchor && $endpoint.setAnchor($anchor)}}
if (!!$trapTo) {let $anchor = $positions[$anchorIndex++];!!$trapTo.setAnchor && $trapTo.setAnchor($anchor)}
return $positions}
var dropToGroupValidate = function ($groups) {if (!$groups || !$groups.length) return null;var portsList = $('.flow-port.ui-selected');if (portsList.length === 0) portsList.push(_ui.port[0]);var $revertConnectors = function ($port, $groupEl) {for (let $portIndex = 0; $portIndex < portsList.length; $portIndex++) {var $port = rsb.workflow.flow.getPort(portsList[$portIndex].id);var $position = $port.getPortPosition();$port.getUIElement().addClass('window').css({"position": "absolute","top": $position.top,"left": $position.left});_ui.port[0].id !== $port.getPortId() && rsb.workflow.flow.removeClassFromPort($port.getPortId(), $port.getStyle(), "flow-port-dragging");$port.fireSelect(false)}
rsb.workflow.apiGroupMgr.toggleBorderStyle($groupEl, true);setTimeout(function () {jsPlumb.repaintEverything()}, 0)}
for (let $groupIndex = 0; $groupIndex < $groups.length; $groupIndex++) {var groupEl = $groups[$groupIndex].el;var $dropList = [];for (let $portIndex = 0; $portIndex < portsList.length; $portIndex++) {if (rsb.workflow.isRectOverlapped(rsb.workflow.getViewportRect(portsList[$portIndex]), rsb.workflow.getViewportRect(groupEl))) {var $port = rsb.workflow.flow.getPort(portsList[$portIndex].id);var $apiAble = rsb.workflow.isAPIAble($port.getPortType());if (!$port.getStyle() && $apiAble && rsb.workflow.apiGroupMgr.isInsideGroup(groupEl, portsList[$portIndex])) {$dropList.push($port.getPortId())} else {!$apiAble && rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('API Settings cannot be added to flows containing a $type$ connector.', {type: $port.getPortType()}), false);$revertConnectors();return null}}}
if ($dropList.length > 0) {var $dropToGroupMap = {};for (let $portIndex = 0; $portIndex < $dropList.length; $portIndex++) {var $port = rsb.workflow.flow.getPort($dropList[$portIndex]);if (!rsb.workflow.flow.isAllConnectionInAPI($port, $dropList)) {rsb.showResult(rsb.workflow.resultContainer, 'Selected connectors have connections outside the API.', false);$revertConnectors();return null}
$dropToGroupMap[$port.getPortId()] = $groups[$groupIndex]}
return $dropToGroupMap}}
return null}
var fireClicked = function($event) {var info = rsb.workflow.getPageHashInfo();var button = $($event.target);var ports = rsb.workflow.flow.listPorts();rsb.workflow.flow.clearSelected();var selected = true;if (info.portId == _props.portId) {if (info.portTab == "automation" && button.closest(".flow-item-option").length > 0) {rsb.workflow.portSettings.showSettings( _props.portId, "settings")} else {selected = false;rsb.workflow.portSettings.hideSettings()}} else {rsb.workflow.portSettings.showSettings( _props.portId)}
if (selected) {if (_ui.port.attr("port-style")) {ports[_props.portId + "_sender"].fireSelect(true);ports[_props.portId + "_receiver"].fireSelect(true)} else {onSelect(true)}}
if (_props.onClicked) {_props.onClicked($event)}}
var appendTrapEndpoint = function () {if (!_trappedToEndpoint && rsb.workflow.nav.isTrappablePort(_props.portType) && _props.style != "sender") {if (_outputDefs != null && _uiStyle == 1) {var trapDef = null;_outputDefs.forEach(output => {if (output.name?.toLowerCase() == "trap") {trapDef = output}});if (trapDef != null) {if (_successEndpoint == null && _trappedToEndpoint == null && trapDef.category != null && trapDef.category.length > 0) {buildOutputCategory(trapDef).appendTo(_ui.outputList)}
var listItem = buildOutputListItem(trapDef);listItem.appendTo(_ui.outputList);var endpoint = jsPlumb.addEndpoint(listItem[0], $.extend({}, ENDPOINT_OPTION_TRAP, {cssClass: "endpoint-trap sender-endpoint", anchor: Port.TRAP_ANCHORS_LIST}));listItem.data("endpoint", endpoint);if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) {endpoint.enabled = false}
_trappedToEndpoint = endpoint} else {rsb.showResult(rsb.workflow.resultContainer, 'No Error Path definition is found.', false)}} else {let $options = {};let $position = Port.TRAP_ANCHORS;if (_props.style == "sender") {$options = $.extend({}, ENDPOINT_OPTION_TRAP, {cssClass: "endpoint-trap sender-endpoint"})} else {$options = $.extend({}, ENDPOINT_OPTION_TRAP)}
adjustBottomAnchorPositions(_successEndpoint, _additionalOutputEndpoints, {setAnchor: function ($pos) {$position = $pos}});_trappedToEndpoint = jsPlumb.addEndpoint(_ui.port[0], $.extend($options, {anchor: $position || Port.TRAP_ANCHORS}));_trappedToEndpoint.connector = DYNAMIC_CONNECTORS;jsPlumb.repaint(_trappedToEndpoint.element)}}}
var appendSuccessEndpoint = function () {if (!_successEndpoint && rsb.workflow.nav.isSupportSuccessPort(_props.portType) && _props.style != "sender") {if (_outputDefs != null && _uiStyle == 1) {var successDef = null;_outputDefs.forEach(output => {if (output.name?.toLowerCase() == "success") {successDef = output}});if (successDef != null) {if (_successEndpoint == null && _trappedToEndpoint == null && successDef.category != null && successDef.category.length > 0) {buildOutputCategory(successDef).appendTo(_ui.outputList)}
var listItem = buildOutputListItem(successDef);listItem.appendTo(_ui.outputList);var endpoint = jsPlumb.addEndpoint(listItem[0], $.extend({}, ENDPOINT_OPTION_SUCCESS, {cssClass: "endpoint-success sender-endpoint", anchor: Port.SUCCESS_ANCHORS_LIST}));listItem.data("endpoint", endpoint);if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) {endpoint.enabled = false}
_successEndpoint = endpoint} else {rsb.showResult(rsb.workflow.resultContainer, 'No Error Path definition is found.', false)}} else {let $options = {};let $position = Port.SUCCESS_ANCHORS;if (_props.style == "sender") {$options = $.extend($options, ENDPOINT_OPTION_SUCCESS, {cssClass: "endpoint-success sender-endpoint"})} else {$options = $.extend($options, ENDPOINT_OPTION_SUCCESS)}
adjustBottomAnchorPositions({setAnchor: function ($pos) {$position = $pos}}, _additionalOutputEndpoints, _trappedToEndpoint);_successEndpoint = jsPlumb.addEndpoint(_ui.port[0], $.extend($options, {anchor: $position || Port.SUCCESS_ANCHORS}));_successEndpoint.connector = DYNAMIC_CONNECTORS;jsPlumb.repaint(_successEndpoint.element)}}}
var removeEndpoint = function ($endpoint) {if (!!$endpoint) {adjustBottomAnchorPositions(_successEndpoint, _additionalOutputEndpoints, _trappedToEndpoint);jsPlumb.deleteEndpoint($endpoint);jsPlumb.repaint($endpoint.element)}}
var onSelect = function($selected) {var portEl = _ui.port[0];if ($selected) {_ui.port.addClass("ui-selected");_ui.port.addClass("active");jsPlumb.addToDragSelection(portEl)} else if (_ui.port.hasClass("ui-selected")) {_ui.port.removeClass("ui-selected");_ui.port.removeClass("active");jsPlumb.removeFromDragSelection(portEl)}}
const setOutputDefs = (outputDefs) => {_outputDefs = outputDefs;if (_uiStyle == 1) {var outputListElem = $("<ul/>").addClass("list-group text-start connector-outputs-list");var lastCategory = null;_outputDefs.forEach(output => {if (output.name?.toLowerCase() != "success" && output.name?.toLowerCase() != "trap") {if (output.category != null && output.category.length > 0 && output.category != lastCategory) {buildOutputCategory(output).appendTo(outputListElem);lastCategory = output.category}
var outputElem = buildOutputListItem(output);outputElem.appendTo(outputListElem)}});var oldConnections = {};if (_ui.outputList != null) {_ui.outputList.children("li.connector-outputs-output").each((i, elem) => {var output = $(elem).data("outputDef");var endpoint = $(elem).data("endpoint");if (output != null && endpoint != null && endpoint.connections.length > 0) {oldConnections[output.name.toLowerCase()] = $(endpoint.connections[0].target).data("instance")}
jsPlumb.deleteConnectionsForElement(elem);jsPlumb.deleteEndpoint(endpoint)});_ui.outputList.remove();jsPlumb.repaintEverything()}
_ui.outputList = outputListElem;_ui.outputList.appendTo(_ui.port[0]);_sendToEndpoint = null;_additionalOutputEndpoints = Object.create(null);const group = rsb.workflow.apiGroupMgr.getGroupFor(_ui.port[0]);_ui.outputList.children("li.connector-outputs-output").each((i, elem) => {var output = $(elem).data("outputDef");if (output != null) {let endpointOption = ENDPOINT_OPTION_SEND_TO;if (output.connectionStyle != null && output.connectionStyle.length > 0) {endpointOption = ENDPOINT_CONNECTOR_OPTIONS[output.connectionStyle.toLowerCase()] ?? endpointOption}
var endpoint = jsPlumb.addEndpoint(elem, $.extend({}, endpointOption, {anchor: Port.SENDTO_ANCHORS_LIST}));endpoint.addClass(Port.INIT_ANCHOR_CLASS_SEND);if (group?.id != null) {endpoint.addClass(group.id)}
$(elem).data("endpoint", endpoint);jsPlumb.setDraggable(elem, false);if (output.name == "") {_sendToEndpoint = endpoint} else {_additionalOutputEndpoints[output.name.toLowerCase()] = endpoint}
if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) {endpoint.enabled = false}}}).each((i, elem) => {var output = $(elem).data("outputDef");if (output != null) {var target = oldConnections[output.name.toLowerCase()];if (target != null) {const endpoint = $(elem).data("endpoint");jsPlumb.connect({ source: endpoint, target: target.getReceiveEndPoint()})}}});_ui.outputList.children("li.connector-outputs-category").each((i, elem) => {jsPlumb.setDraggable(elem, false)});if (group != null) {const flowAPI = rsb.workflow.apiGroupMgr.getFlowAPI(group);rsb.workflow.apiGroupMgr.validateGroup(flowAPI)}
if (_receiveEndpoint == null) {_receiveEndpoint = jsPlumb.addEndpoint(_ui.port[0], $.extend({}, ENDPOINT_OPTION_RECEIVE, {anchor: Port.RECEIVE_ANCHORS_LIST}));_receiveEndpoint.addClass(Port.INIT_ANCHOR_CLASS_RECEIVE);if (!rsb.workflow.hasWorkspacePrivilege("modifyflow")) {_receiveEndpoint.enabled = false}}}}
var buildOutputCategory = (outputDef) => {return $("<li/>").addClass("list-group-item text-truncate connector-outputs-category").html(outputDef.category)}
var buildOutputListItem = (outputDef) => {var itemElem = $("<li/>");itemElem
.addClass("list-group-item connector-outputs-output d-flex")
.addClass(outputDef.category != null && outputDef.category.length > 0 ? "indent" : "")
.data("instance", _ui.port.data("instance"))
.data("outputDef", outputDef)
.html("<span class='text-truncate'>" + (outputDef.label ?? "&nbsp;") + "</span>");if (outputDef.description != null && outputDef.description.length > 0) {var iconElem = $("<i/>").addClass("fa fa-info-circle connector-output-else ms-2");new bootstrap.Popover(iconElem, {html: true,trigger: "hover",content: outputDef.description});iconElem.appendTo(itemElem)}
if (outputDef.notConnectedWarning != null && outputDef.notConnectedWarning.length > 0) {var iconElem = $("<i/>").addClass("fa fa-info-circle ms-auto me-2 text-warning connector-output-not-connected-warning");new bootstrap.Popover(iconElem, {html: true,trigger: "hover",content: outputDef.notConnectedWarning});iconElem.appendTo(itemElem)}
return itemElem}
var buildExtentionListItem = (extensionDef) => {let itemElem = null;if (extensionDef.type == 1) {if (extensionDef.outputName != null && extensionDef.outputName.length > 0) {itemElem = buildOutputButton(extensionDef)} else {itemElem = $("<button type=\"button\" class=\"list-group-item list-group-item-action connector-extension connector-extension-button\" />");itemElem.html(extensionDef.label ?? "&nbsp;")}}
if (itemElem != null) {itemElem.data("instance", _ui.port.data("instance"));itemElem.data("extensionDef", extensionDef);itemElem.click(onExtensionClick);itemElem.mouseup(() => _ui.port.data("isExtensionClicking", true))}
return itemElem}
var buildOutputButton = (extensionDef) => {const itemElem = $(extensionDef.label ?? "<button type=\"button\" class=\"btn\" />");itemElem.addClass("connector-extension connector-output-extension-button ms-auto");return itemElem}
var onExtensionClick = (e) => {e.stopPropagation();const target = $(e.currentTarget).data("instance");const extensionDef = $(e.currentTarget).data("extensionDef");if (target != null && extensionDef != null) {if (extensionDef.type == 1 && extensionDef.triggerCallback) {const extResId = rsb.workflow.flow.getCurrentWorkspace().toLowerCase() + ":" + target.getPortId().toLowerCase();$.ajax({url: "src/flowExtensionCallback.rsb",type: "POST",data: {"@json": true, "workspaceId": rsb.workflow.flow.getCurrentWorkspace(), "connectorId": target.getPortId(), "source": extensionDef.id},dataType: "json",headers: {"If-Unmodified-Since": rsb.getResourceLastModified(extResId)},}).done(function(data, textStatus, jqXHR) {var automationInfoResult = data["items"];var errorMsg = rsb.getResultErrorMessage(automationInfoResult);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else if (automationInfoResult[0]) {rsb.setResourceLastModified(extResId, jqXHR.getResponseHeader("Last-Modified"));var automationInfo = rsb.workflow.normalizeResponse(automationInfoResult[0]);onUpdateAutomationInfo({outputDefs: automationInfo["outputdefs"][0], extensionDefs: automationInfo["flowextensiondefs"][0], receiveEnabled: automationInfo["receiveenabled"][0], flowUiStyle: automationInfo["flowuistyle"][0]});rsb.workflow.flow.save();jsPlumb.repaintEverything()}})}}}
const setExtensionDefs = (extensionDefs) => {_extensionDefs = extensionDefs;_ui.port.removeClass("has-extensions");_ui.extensionList?.remove();if (_uiStyle == 1) {if (_extensionDefs.length > 0) {var extensionsListElem = $("<div/>").addClass("list-group text-start connector-extension-buttons-list");_extensionDefs.forEach(extension => {var extensionElem = buildExtentionListItem(extension);if (extension.outputName != null && extension.outputName.length > 0) {_ui.outputList.children("li.connector-outputs-output").each((i, elem) => {var output = $(elem).data("outputDef");if (output != null && output.name == extension.outputName) {$(elem).append(extensionElem.clone(true))}})} else {extensionElem.appendTo(extensionsListElem)}});_ui.extensionList = extensionsListElem;_ui.extensionList.appendTo(_ui.port[0]);_ui.port.addClass("has-extensions")}}}
const onUpdateAutomationInfo = ({outputDefs, extensionDefs, receiveEnabled, flowUiStyle}) => {_uiStyle = parseInt(flowUiStyle);let sendToTarget = null;const additionalTargets = {};let trapTarget = null;let successTraget = null;if (_uiStyle == 1) {if (_sendToEndpoint != null) {if (_sendToEndpoint.connections.length > 0) {sendToTarget = $(_sendToEndpoint.connections[0].target).data("instance")}
jsPlumb.deleteEndpoint(_sendToEndpoint)}
if (_additionalOutputEndpoints != null) {Object.keys(_additionalOutputEndpoints).forEach((name) => {const endpoint = _additionalOutputEndpoints[name];if (endpoint.connections.length > 0) {additionalTargets[name] = $(endpoint.connections[0].target).data("instance")}
jsPlumb.deleteEndpoint(endpoint)})}
if (_trappedToEndpoint != null) {trapTarget = $(_trappedToEndpoint.connections[0].target).data("instance");jsPlumb.deleteEndpoint(_trappedToEndpoint)}
if (_successEndpoint != null) {successTraget = $(_successEndpoint.connections[0].target).data("instance");jsPlumb.deleteEndpoint(_successEndpoint)}
_sendToEndpoint = null;_additionalOutputEndpoints = null;_trappedToEndpoint = null;_successEndpoint = null}
if (extensionDefs != null && extensionDefs.length > 0) {setExtensionDefs({})}
if (outputDefs != null && outputDefs.length > 0) {setOutputDefs(JSON.parse(outputDefs))}
if (extensionDefs != null && extensionDefs.length > 0) {setExtensionDefs(JSON.parse(extensionDefs))}
if (sendToTarget != null) {this.connectTo(sendToTarget, "")}
if (Object.keys(additionalTargets).length) {Object.keys(additionalTargets).forEach((name) => {const target = additionalTargets[name];this.connectTo(target, name)})}
if (trapTarget != null) {trapTo(trapTarget)}
if (successTraget != null) {successTo(successTraget)}
if (_receiveEndpoint != null && _uiStyle == 1) {_receiveEndpoint.setAnchor(Port.RECEIVE_ANCHORS_LIST)}
if (!rsb.workflow.flow.getInitializing() && rsb.workflow.hasWorkspacePrivilege("ModifyFlow")) {setTimeout(() => rsb.workflow.flow.setSaved(), 0)}}
const trapTo = ($trapTo) => {if ($trapTo) {appendTrapEndpoint();if (_trappedToEndpoint) {jsPlumb.connect({ source: _trappedToEndpoint, target: $trapTo.getReceiveEndPoint()})}}}
const successTo = ($successPort) => {if ($successPort) {appendSuccessEndpoint();if (_successEndpoint) {jsPlumb.connect({ source: _successEndpoint, target: $successPort.getReceiveEndPoint()})}}}
const updateWarningIcon = () => {if (_ui.port.find(".flow-port-txt").get(0).clientWidth < _ui.port.find(".flow-port-txt").get(0).scrollWidth) {var left = (_ui.port.find(".flow-port-txt").get(0).clientWidth + 10 + 22 + 25 -1) + "px";_ui.port.find(".flow-port-txt .flow-port-uninstall-icon, .flow-port-txt .flow-port-deprecated-icon").css({"left": left})} else {_ui.port.find(".flow-port-txt .flow-port-uninstall-icon, .flow-port-txt .flow-port-deprecated-icon").css("left", "")}}
_ui.port.data("instance", this);_ui.port.attr("id", this.getPortStyleKey());_ui.port.attr("port-id", _props.portId);_ui.port.attr("port-style", _props.style);_ui.port.find(".flow-port-img").addClass("app-icon-" + _props.portType.toLowerCase());_ui.port.find(".flow-port-txt span").text(_props.portId);if (!rsb.workflow.nav.isInstalled(_props.portType)) {_ui.port.addClass("flow-port-uninstall")} else {_ui.port.removeClass("flow-port-uninstall")}
if (rsb.workflow.nav.isDeprecated(_props.portType)) {_ui.port.addClass("flow-port-deprecated")} else {_ui.port.removeClass("flow-port-deprecated")}
_ui.port.find("[data-bs-toggle='tooltip']").tooltip()}
Port.INIT_ANCHOR_CLASS_SEND = "jtk-endpoint-anchor-send-init";Port.INIT_ANCHOR_CLASS_RECEIVE = "jtk-endpoint-anchor-receive-init";jsPlumbBrowserUI.ready(function() {jsPlumb.bind(jsPlumbBrowserUI.EVENT_ANCHOR_CHANGED, function (endpoint, anchor) {$(endpoint).removeClass(Port.INIT_ANCHOR_CLASS_SEND);$(endpoint).removeClass(Port.INIT_ANCHOR_CLASS_RECEIVE)})});Port.SENDTO_ANCHORS = [[ 1,  0.5, 1,  0, 0, 0, "send-right" ],[ 0.56, 1, 0,  1, 0, 0, "send-bottom" ],[ 0.44, 0, 0, -1, 0, 0, "send-top" ]
];Port.RECEIVE_ANCHORS = [[ 0,  0.5, -1,  0, 0, 0, "receive-left" ],[ 0.44, 1,  0,  1, 0, 0, "receive-bottom" ],[ 0.56, 0,  0, -1, 0, 0, "receive-top" ]
];Port.SENDTO_ANCHORS_LIST = [ 1,  0.5, 1,  0, 0, Math.ceil(window.devicePixelRatio ?? 1) > 1 ? (window.devicePixelRatio - 1) : 1, "send-right" ];Port.RECEIVE_ANCHORS_LIST = [ 0,  0, -1,  0, 0, 32 + (window.devicePixelRatio > 1 ? 0 : 0.5), "receive-left" ];Port.SUCCESS_ANCHORS = [ 0.2, 1,  0,  1, 0, 0, "send-bottom" ];Port.SUCCESS_ANCHORS_LIST = [ 1,  0.5, 1,  0, 0, 0.5, "send-right" ];Port.FORK_ANCHORS = [ 0.32, 1,  0,  1, 0, 0, "send-bottom" ];Port.TRAP_ANCHORS = [ 0.68, 1,  0,  1, 0, 0, "send-bottom" ];Port.TRAP_ANCHORS_LIST = [ 1,  0.5, 1,  0, 0, 0.5, "send-right" ];Port.OnPortConnected = function($info) {var source = $($info.source).data("instance");var target = $($info.target).data("instance");if (source.getPortId() == target.getPortId()) {jsPlumb.deleteConnection($info.connection)} else if (source) {source.fireConnectTo(target, $info.sourceEndpoint, $info.targetEndpoint)}}
Port.OnPortConnectionDetached = function($info) {var source = $($info.source).data("instance");var target = $($info.target).data("instance");if (source && source.getPortId() != target.getPortId()) {source.fireConnectionDetached(target, $info.sourceEndpoint, $info.targetEndpoint);setTimeout(function() {if (rsb.workflow.flow.listPorts()[target.getPortStyleKey()]) {var targetUiStyle = target.getUiStyle();$info.targetEndpoint.setAnchor(targetUiStyle == 1 ? Port.RECEIVE_ANCHORS_LIST : Port.RECEIVE_ANCHORS);if ($info.sourceEndpoint == source.getSendToEndPoint() && rsb.workflow.flow.listPorts()[source.getPortStyleKey()]) {var sourceUiStyle = source.getUiStyle();if (sourceUiStyle == 1) {$info.sourceEndpoint.setAnchor(Port.SENDTO_ANCHORS_LIST);$($info.source).removeClass("jtk-connected")} else {$info.sourceEndpoint.setAnchor(Port.SENDTO_ANCHORS)}}}}, 10)}}
var Nav = function() {var NAV_MIN_WIDTH = 295;var DRAG_OPTIONS = {revert: "invalid",helper: "clone",containment: "document",cancel: ".flow-item-add-port",distance: 10};var _ui = {};_ui.nav =  $("#nav");_ui.navTrigger =_ui.nav.find(".flow-nav-trigger");_ui.connectorsSearchBar = _ui.nav.find("#connectorsSearchBar");_ui.connectorsSearchClear = _ui.nav.find("#connectorsSearchClear");_ui.connectorContainer = _ui.nav.find(".flow-nav-tab-connectors");_ui.corePortTrigger = _ui.connectorContainer.find(".core-ports-sub-header");_ui.corePortContainer = _ui.connectorContainer.find(".flow-nav-tab-core-ports");_ui.mftPortTrigger = _ui.connectorContainer.find(".mft-ports-sub-header");_ui.mftPortContainer = _ui.connectorContainer.find(".flow-nav-tab-mft-ports");_ui.ediPortTrigger = _ui.connectorContainer.find(".edi-ports-sub-header");_ui.ediPortContainer = _ui.connectorContainer.find(".flow-nav-tab-edi-ports");_ui.databasePortTrigger = _ui.connectorContainer.find(".database-ports-sub-header");_ui.databasePortContainer = _ui.connectorContainer.find(".flow-nav-tab-database-ports");_ui.otherPortTrigger = _ui.connectorContainer.find(".other-ports-sub-header");_ui.otherPortContainer = _ui.connectorContainer.find(".flow-nav-tab-other-ports");_ui.samplePortTrigger = _ui.connectorContainer.find(".sample-ports-sub-header");_ui.samplePortContainer = _ui.connectorContainer.find(".flow-nav-tab-sample-ports");_ui.flowNav = _ui.nav.find(".flow-nav-tab-flow");_ui.flowsSearchBar = _ui.nav.find("#flowsSearchBar");_ui.flowsSearchClear = _ui.nav.find("#flowsSearchClear");_ui.portContainerExpander = _ui.flowNav.find(".flow-nav-tab-ports");_ui.portContainer = _ui.portContainerExpander.find(".port-expander");_ui.portTemplate = _ui.flowNav.find("#navPortTemplate");_ui.portNavTrigger = _ui.flowNav.find(".ports-sub-header");_ui.portNavSummary = _ui.flowNav.find(".flow-port-summary-badge");_ui.apiContainerExpander = _ui.flowNav.find(".flow-nav-tab-apis");_ui.apiContainer = _ui.apiContainerExpander.find(".port-expander");_ui.apiTemplate = _ui.flowNav.find("#navAPITemplate");_ui.apiNavTrigger = _ui.flowNav.find(".apis-sub-header");_ui.apiNavSummary = _ui.flowNav.find(".flow-api-summary-badge");_ui.viewContainerExpander = _ui.flowNav.find(".flow-nav-tab-views");_ui.viewContainer = _ui.viewContainerExpander.find(".port-expander");_ui.viewTemplate = _ui.flowNav.find("#navViewTemplate");_ui.viewNavTrigger = _ui.flowNav.find(".views-sub-header");_ui.viewNavSummary = _ui.flowNav.find(".flow-view-summary-badge");var lastNavViewsHeight = 0.375;let flowReady = false;this.addPort = function($port) {if ($port) {var portId = $port.getPortId();if (_ui.portContainer.find("#" + rsb.escapeSelector(portId)).get(0)) {return}
var elem = _ui.portTemplate.clone().removeClass("hidden");elem.attr("id", portId);if (!this.isInstalled($port.getPortType())) {elem.addClass("flow-port-uninstall")}
if (this.isDeprecated($port.getPortType())) {elem.addClass("flow-port-deprecated")}
elem.find(".flow-port-img").addClass("app-icon-" + $port.getPortType().toLowerCase());elem.find(".flow-port-txt").text($port.getPortId());elem.find("[data-toggle='tooltip']").tooltip();elem.data("instance", $port);elem.click(onPortClicked);elem.find(".flow-item-trash").toggleClass("hidden", !rsb.workflow.hasConnectorPrivilege(portId, "Delete"));appendInOrder(_ui.portContainer, elem);updateSummary(_ui.portNavSummary, _ui.portContainer.find(".flow-port").length);_ui.portContainerExpander.collapse("show")}}
this.removePort = function($portId) {if ($portId) {var elem = _ui.portContainer.find("#" + rsb.escapeSelector($portId));elem.fadeOut(500, function() {elem.remove();updateSummary(_ui.portNavSummary, _ui.portContainer.find(".flow-port").length)})}}
this.addView= function($view) {var elem = _ui.viewTemplate.clone().removeClass("hidden");elem.attr("id", rsb.htmlEncode($view.name) || "");elem.find(".flow-view-txt").text(rsb.htmlEncode($view.name) || "");elem.data("instance", $view);elem.click(onViewClick);elem.find(".flow-item-trash").toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));appendInOrder(_ui.viewContainer, elem);updateSummary(_ui.viewNavSummary, _ui.viewContainer.find(".flow-view").length);_ui.viewContainerExpander.collapse("show");elem.css("display", "none").removeClass("hidden").fadeIn(500)}
this.addFlowAPI = function ($flowAPI) {if (!!$flowAPI && !!$flowAPI.name && !!$flowAPI.method) {if (_ui.apiContainer.find("." + $flowAPI.getKey()).get(0)) {return}
var elem = _ui.apiTemplate.clone().removeClass("hidden");elem.attr("id", "").addClass($flowAPI.getKey());elem.find(".flow-api-method").addClass($flowAPI.method.toUpperCase()).text($flowAPI.method.toUpperCase());elem.find(".flow-api-workspaceid").text(rsb.workflow.flow.getCurrentWorkspace());elem.find(".flow-api-name").text(encodeURIComponent($flowAPI.name));elem.find(".flow-item-trash").toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));elem.click(onFlowAPIClicked);appendInOrder(_ui.apiContainer, elem);updateSummary(_ui.apiNavSummary, _ui.apiContainer.find(".flow-api").length);_ui.apiContainerExpander.collapse("show")}}
this.removeFlowAPI = function ($flowAPI) {var elem = _ui.apiContainer.find("." + $flowAPI.getKey());elem.fadeOut(500, function () {elem.remove();updateSummary(_ui.apiNavSummary, _ui.apiContainer.find(".flow-api").length)})}
this.updateFlowAPI = function ($flowAPI, $newFlowAPI) {if ($flowAPI.name == $newFlowAPI.name && $flowAPI.method != $newFlowAPI.method) {var elem = _ui.apiContainer.find("." + $flowAPI.getKey());elem.removeClass($flowAPI.getKey()).addClass($newFlowAPI.getKey());elem.find(".flow-api-method").removeClass($flowAPI.method.toUpperCase()).addClass($newFlowAPI.method.toUpperCase()).text($newFlowAPI.method.toUpperCase())}}
this.listViewName = function() {var list = [];_ui.viewContainer.find(".flow-view .flow-view-txt").each(function() {list.push($(this).text())});return list}
this.resize = function() {var currentWidth = this.getWidth();_ui.nav.resizable("option", "maxWidth", Math.max($("#flowContainer").width() * 0.25, NAV_MIN_WIDTH));_ui.nav.resizable("option", "minWidth", NAV_MIN_WIDTH);var offset = this.getWidth() - currentWidth;if (offset > 0 && rsb.workflow.getPosition(_ui.nav).left < 0) {_ui.nav.css("left", rsb.workflow.getPosition(_ui.nav).left - offset)}
onResize();updateNavHeight()}
this.isInstalled = function($portType) {return isMatchPortType("", $portType)}
this.isDeprecated = function($portType) {return isMatchPortType(".deprecated", $portType)}
this.isReceivePort = function($portType) {return isMatchPortType(".flow-port-receive-port", $portType)}
this.getAdditionalOutputs = function($portType) {var outputs = _ui.connectorContainer.find(".flow-port-type-" + rsb.escapeSelector($portType.toLowerCase())).attr("data-additional-outputs");if (outputs && outputs.length > 0) {return outputs.split(',')}
return null}
this.getUiStyle = function($portType) {var style = _ui.connectorContainer.find(".flow-port-type-" + rsb.escapeSelector($portType.toLowerCase())).attr("data-flow-ui-style");if (style != null && style.length > 0) {return parseInt(style)}
return 0}
this.isTrappablePort = function($portType) {return isMatchPortType(".flow-port-trappable-port", $portType)}
this.isSupportSuccessPort = function($portType) {return isMatchPortType(".flow-port-support-success-port", $portType)}
this.isTransportPort = function($portType) {return isMatchPortType(".flow-port-transport-port", $portType)}
this.getPortDesc = function($portType) {var desc = _ui.connectorContainer.find(".flow-port-type-" + rsb.escapeSelector($portType.toLowerCase())).attr("data-desc");return desc}
this.getHelpLocation = function($portType) {var location = _ui.connectorContainer.find(".flow-port-type-" + rsb.escapeSelector($portType.toLowerCase())).attr("data-help-location");return location}
this.getWidth = function() {return _ui.nav.width() + rsb.workflow.getPosition(_ui.nav).left}
this.setWidth = function($width) {_ui.nav.width($width);onResize()}
this.getFlowsTabViewsHeight = function() {return _ui.portContainerExpander.hasClass("flow-collapse-in") ? (_ui.viewContainer.height() / getFlowsNavHeight()) : 0}
this.setFlowsTabViewsHeight = function($height) {if ($height) {lastNavViewsHeight = $height}}
this.importSampleFlow = function(sampleElem, $position) {onSampleFlowClicked(sampleElem, $position)}
this.updatePrivilege = () => {const options = {...DRAG_OPTIONS,disabled: !flowReady,};if (rsb.workflow.hasWorkspacePrivilege("CreateConnector")) {_ui.connectorContainer.find(".flow-port:not(.flow-port-no-license-port)").each((index, elem) => {if (rsb.workflow.hasWorkspacePrivilege("CreateConnector", $(elem).attr("data-type"))) {$(elem).removeClass("restricted-create");$(elem).draggable(options)} else {$(elem).addClass("restricted-create");if ($(elem).draggable("instance") != null) {$(elem).draggable("destroy")}}})} else {_ui.connectorContainer.find(".flow-port:not(.flow-port-no-license-port)").each((index, elem) => {$(elem).addClass("restricted-create");if ($(elem).draggable("instance") != null) {$(elem).draggable("destroy")}})}
if (rsb.workflow.hasWorkspacePrivilege("CreateConnector")) {_ui.samplePortContainer.find(".flow-sample").each((index, elem) => {$(elem).removeClass("restricted-create");$(elem).draggable(options)})} else {_ui.samplePortContainer.find(".flow-sample").each((index, elem) => {$(elem).addClass("restricted-create");if ($(elem).draggable("instance") != null) {$(elem).draggable("destroy")}})}
_ui.apiContainer.find(".flow-item-trash").toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));_ui.viewContainer.find(".flow-item-trash").toggleClass("hidden", !rsb.workflow.hasWorkspacePrivilege("ModifyFlow"));_ui.portContainer.find(".flow-port").each((index, elem) => {const instance = $(elem).data("instance");$(elem).toggleClass("restricted-delete", !rsb.workflow.hasConnectorPrivilege(instance.getPortId(), "Delete"))})}
this.fireFlowReady = (ready) => {flowReady = ready;this.updatePrivilege()}
var appendInOrder = function($container, $elem) {var inserted = false;$container.children("div").each(function() {if (!$(this).hasClass("ui-resizable-handle") && $(this).attr("id").toLowerCase() > $elem.attr("id").toLowerCase()) {$elem.insertBefore($(this));inserted = true;return false}});if (!inserted) {$container.append($elem)}}
var updateSummary = function($summary, $count) {$summary.text($count)}
var deleteView = function($viewName, $callback) {var elem = _ui.viewContainer.find("div[id=" + rsb.escapeSelector($viewName) + "]");if (elem.length > 0) {rsb.confirmModal({title: 'Delete View',body: rsb.evalTemplate('Are you sure you want to delete view "$view$"?', {"view" : elem.attr("id")}),okText: 'Yes',cancelText: 'No',ok: function() {elem.find("a").prop("disabled", true);$.ajax({dataType: "json",url: "src/deleteFlowView.rsb",type: "POST",data: { "@json":true, name: rsb.htmlDecode(elem.attr("id")), "workspaceid": rsb.workflow.flow.getCurrentWorkspace() },success: function(data, textStatus, jqXHR) {var errorMsg = rsb.getResultErrorMessage(data["items"]);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else {rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('View [$view$] has been deleted.', {"view" : elem.attr("id")}), true);delete rsb.workflow.flow.deleteView(elem.attr("id"));if ($callback) {$callback()}}},complete: function() {elem.find("a").prop("disabled", false)}})}})}}
var isMatchPortType = function($selector, $portType) {var match = _ui.connectorContainer.find($selector + ".flow-port-type-" + rsb.escapeSelector($portType.toLowerCase())).length > 0;return match}
var onViewClick = function($event) {var elem = $($event.target).closest(".flow-view");if ($($event.target).closest(".flow-item-trash").length > 0) {deleteView(elem.attr("id"), function() {elem.fadeOut(500, function() {elem.remove();updateSummary(_ui.viewNavSummary, _ui.viewContainer.find(".flow-view").length)})})} else {var view = elem.data("instance");rsb.workflow.flow.applyView(view)}}
var onFlowAPIClicked = function ($event) {var elem = $($event.target).closest(".flow-api");var apiName = decodeURIComponent(elem.find(".flow-api-name").text());var apiMethod = decodeURIComponent(elem.find(".flow-api-method").text());if ($($event.target).closest(".flow-item-trash").length > 0) {rsb.workflow.flow.deleteFlowAPI(rsb.workflow.flow.getFlowAPI(new FlowAPI({ name: apiName, method: apiMethod }).getKey()))} else {rsb.workflow.updatePageHash(rsb.workflow.flow.getCurrentWorkspace(), "api:" + apiName + ":" + apiMethod, "");rsb.workflow.flow.showAPIInCenter(rsb.workflow.flow.getFlowAPI(new FlowAPI({ name: apiName, method: apiMethod }).getKey()))}}
var onPortClicked = function($event) {var elem = $($event.target).closest(".flow-port");var port = rsb.workflow.flow.getPort(elem.attr("id"));var sender = rsb.workflow.flow.getPort(elem.attr("id"), "sender");var receiver = rsb.workflow.flow.getPort(elem.attr("id"), "receiver");if ($($event.target).closest(".flow-item-trash").length > 0) {if(!port) {var ports = [];if(sender) {ports.push(sender)}
if(receiver) {ports.push(receiver)}
rsb.workflow.flow.deletePort(ports)} else {var $group = rsb.workflow.apiGroupMgr.getGroupFor(port.getUIElement()[0]);if (!$group || rsb.workflow.apiGroupMgr.getFlowAPI($group).connectors.length !== 1) {rsb.workflow.flow.deletePort(port)} else {rsb.showResult(rsb.workflow.resultContainer, rsb.evalTemplate('The last connector in API can not be deleted.', {type: port.getPortType()}), false)}}} else {if (!port) {port = sender || receiver}
rsb.workflow.portSettings.showSettings(port.getPortId(), null, function() {rsb.workflow.flow.showPortInCenter(port)})}}
var onAddPortClicked = function() {if (!rsb.workflow.hasWorkspacePrivilege("CreateConnector")) return;if (!flowReady) return;var portElem = $(this).closest(".flow-port");if (portElem.hasClass("flow-sample")) {onSampleFlowClicked(portElem);return false}
var portType = portElem.attr("data-type");var portName = rsb.trimStr(portElem.find(".flow-port-txt").text());rsb.workflow.flow.createPort(portType, portName);return false}
var onResize = function() {rsb.workflow.flow.resize();rsb.workflow.updateFlowinSession()}
var onViewsResize = function() {_ui.portContainer.height(getFlowsNavViewMaxHeight() - _ui.viewContainer.height());lastNavViewsHeight = _ui.viewContainer.height() / getFlowsNavHeight()}
var getConnectorsNavHeight = function() {return (_ui.nav.find(".flow-nav-tab-connectors").hasClass("active") ? (parseInt(_ui.connectorContainer.height()) - 238) : (parseInt(_ui.connectorContainer.height()) - 260)) +(_ui.corePortTrigger.hasClass("hidden") ? 30 : 0) +(_ui.mftPortTrigger.hasClass("hidden") ? 30 : 0) +(_ui.ediPortTrigger.hasClass("hidden") ? 30 : 0) +(_ui.databasePortTrigger.hasClass("hidden") ? 30 : 0) +(_ui.otherPortTrigger.hasClass("hidden") ? 30 : 0) +(_ui.samplePortTrigger.hasClass("hidden") ? 30 : 0)}
var getFlowsNavHeight = function() {return _ui.nav.find(".flow-nav-tab-connectors").hasClass("active") ? (parseInt(_ui.flowNav.height()) - 180) : (parseInt(_ui.flowNav.height()) - 142)}
var getFlowsNavViewMaxHeight = function () {return _ui.apiContainerExpander.hasClass("flow-collapse-in") ? getFlowsNavHeight() - _ui.apiContainer.height() : getFlowsNavHeight()}
var updateNavHeight = function() {_ui.apiContainer.height(getFlowsNavHeight() * 0.25);if (_ui.viewContainerExpander.hasClass("flow-collapse-in") && !_ui.portContainerExpander.hasClass("flow-collapse-in")) {_ui.viewContainer.height(getFlowsNavViewMaxHeight())} else if (_ui.viewContainerExpander.hasClass("flow-collapse-in") && _ui.portContainerExpander.hasClass("flow-collapse-in")) {_ui.viewContainer.height(getFlowsNavHeight() * lastNavViewsHeight);_ui.portContainer.height(getFlowsNavViewMaxHeight() - _ui.viewContainer.height())} else if (!_ui.viewContainerExpander.hasClass("flow-collapse-in") && _ui.portContainerExpander.hasClass("flow-collapse-in")) {_ui.portContainer.height(getFlowsNavViewMaxHeight())}
_ui.viewContainer.resizable("option", "maxHeight", getFlowsNavViewMaxHeight());_ui.connectorContainer.find(".port-expander").height(getConnectorsNavHeight())}
var onSampleFlowClicked = function(sampleElem, $position) {if (false === sampleElem.data("enabled")) {$("#upgradeBuildModal").modal("show")} else {rsb.workflow.currentWorkspaceId = rsb.workflow.flow.getCurrentWorkspace();window.rsb.sampleFlow = window.rsb.sampleFlow || {};window.rsb.sampleFlow.guid = sampleElem.attr("id");window.rsb.sampleFlow.title = sampleElem.data("title");window.rsb.sampleFlow.icons = sampleElem.data("icons");window.rsb.sampleFlow.desc = sampleElem.data("desc");window.rsb.sampleFlow.url = sampleElem.data("help-location");rsb.workflow.importPosition = $position || rsb.workflow.flow.getDefaultImportPosition();$("#importSampleflowModal").modal("show")}}
var loadSampleFlow = function () {if (rsb.workflow.disableSampleFlow) {const text = 'The sample flow feature is disabled.';_ui.samplePortContainer.find(".port-expander").html(`<div class="alert alert-dismissible alert-warning"><content>${text}</content></div>`);return}
$.ajax({url: "src/getSampleFlows.rsb?@json",type: "Get"}).done(function(data, textStatus, jqXHR) {const result = data["items"];const errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {_ui.samplePortContainer.find(".port-expander").html(`<div class="alert alert-dismissible alert-danger"><content>${errorMsg}</content></div>`);return}
let rawHtml = "";for (const out of result) {let html = `<div class="flow-port flow-sample" id="${out.guid}" data-additional-outputs data-icons="${out.icons}" data-title="${out.title}" data-desc="${out.desc}" data-help-location="${out.url}" data-enabled="${out.isenable}" >`
+ `<span class="flow-port-txt" style="display: inherit;">${rsb.htmlEncode(out.title)}</span>`;html += "<span>";let iconList = out.icons.split(",");for (let i = 0; i < iconList.length; i++) {if (i > 0) {html += '<i class="fa fa-solid fa-arrow-right-long"></i>'}
html += `<a class="flow-port-img app-icon app-icon-${iconList[i].trim().replace(/^cdata(.+)$/, "$1")}"></a>`}
html += "</span>";if (out.isenable) {html += '<a class="flow-item-add-port flow-item-option"><i class="fa fa-plus" aria-hidden="true"></i></a>'} else {html += '<span class="flow-sample-upgrade text-warning">' + 'Upgrade Required'+ '</span>'}
html += '<a class="flow-port-license-overlay" target="_blank" href="' + 'https://arc.cdata.com/order/'+ '">' + 'Purchase License'+ '</a>';html += "</div>";rawHtml += html}
_ui.samplePortContainer.find(".port-expander").html(rawHtml);_ui.samplePortContainer.find(".port-expander").height(getConnectorsNavHeight());_ui.samplePortContainer.find(".flow-item-add-port").click(onAddPortClicked);rsb.workflow.nav.updatePrivilege()})}
_ui.nav.resizable({handles: "e",minWidth: NAV_MIN_WIDTH,maxWidth: Math.max($("#flowContainer").width() * 0.25, NAV_MIN_WIDTH),resize: onResize});_ui.nav.find(".flow-nav-tabs a").click(function($e) {rsb.stopPropagation($e);var selector = $(this).attr("data-bs-target");_ui.nav.find(".flow-nav-tabs li").removeClass("active");_ui.nav.find(".tab-pane").removeClass("active in");$(this).closest("li").addClass("active");_ui.nav.find(".tab-pane" + selector).addClass("active in")});_ui.navTrigger.click(function() {$(this).find("i").toggleClass("fa-chevron-left fa-chevron-right");if (_ui.nav.hasClass("collapsed")) {_ui.nav.css("left", "0px");_ui.nav.removeClass("collapsed")} else {_ui.nav.css("left", "-" + rsb.workflow.nav.getWidth() + "px");_ui.nav.addClass("collapsed")}
rsb.workflow.flow.resize()});_ui.connectorContainer.find(".flow-item-add-port").click(onAddPortClicked);var connectorsSearch = function() {var filter = _ui.connectorsSearchBar.val().trim().toLowerCase();if (filter) {_ui.connectorContainer.find(".flow-port").each(function() {var name = $(this).find(".flow-port-txt").text().trim().toLowerCase();if (!name.includes(filter)) {$(this).addClass("search-not-matched")} else {$(this).removeClass("search-not-matched")}});if (_ui.corePortContainer.find(".flow-port:not(.search-not-matched):not(.hidden)").length < 1) {_ui.corePortContainer.addClass("hidden");_ui.corePortTrigger.addClass("hidden")} else {_ui.corePortContainer.removeClass("hidden");_ui.corePortTrigger.removeClass("hidden")}
if (_ui.mftPortContainer.find(".flow-port:not(.search-not-matched):not(.hidden)").length < 1) {_ui.mftPortContainer.addClass("hidden");_ui.mftPortTrigger.addClass("hidden")} else {_ui.mftPortContainer.removeClass("hidden");_ui.mftPortTrigger.removeClass("hidden")}
if (_ui.ediPortContainer.find(".flow-port:not(.search-not-matched):not(.hidden)").length < 1) {_ui.ediPortContainer.addClass("hidden");_ui.ediPortTrigger.addClass("hidden")} else {_ui.ediPortContainer.removeClass("hidden");_ui.ediPortTrigger.removeClass("hidden")}
if (_ui.databasePortContainer.find(".flow-port:not(.search-not-matched):not(.hidden)").length < 1) {_ui.databasePortContainer.addClass("hidden");_ui.databasePortTrigger.addClass("hidden")} else {_ui.databasePortContainer.removeClass("hidden");_ui.databasePortTrigger.removeClass("hidden")}
if (_ui.otherPortContainer.find(".flow-port:not(.search-not-matched):not(.hidden)").length < 1) {_ui.otherPortContainer.addClass("hidden");_ui.otherPortTrigger.addClass("hidden")} else {_ui.otherPortContainer.removeClass("hidden");_ui.otherPortTrigger.removeClass("hidden")}
if (_ui.samplePortContainer.find(".flow-port:not(.search-not-matched):not(.hidden)").length < 1) {_ui.samplePortContainer.addClass("hidden");_ui.samplePortTrigger.addClass("hidden")} else {_ui.samplePortContainer.removeClass("hidden");_ui.samplePortTrigger.removeClass("hidden")}
_ui.corePortContainer.collapse("show");_ui.corePortContainer.find(".port-expander").height("auto");_ui.corePortContainer.find(".port-expander").css({"max-height": "300px"});_ui.mftPortContainer.collapse("show");_ui.mftPortContainer.find(".port-expander").height("auto");_ui.mftPortContainer.find(".port-expander").css({"max-height": "300px"});_ui.ediPortContainer.collapse("show");_ui.ediPortContainer.find(".port-expander").height("auto");_ui.ediPortContainer.find(".port-expander").css({"max-height": "300px"});_ui.databasePortContainer.collapse("show");_ui.databasePortContainer.find(".port-expander").height("auto");_ui.databasePortContainer.find(".port-expander").css({"max-height": "300px"});_ui.otherPortContainer.collapse("show");_ui.otherPortContainer.find(".port-expander").height("auto");_ui.otherPortContainer.find(".port-expander").css({"max-height": "300px"});_ui.samplePortContainer.collapse("show");_ui.samplePortContainer.find(".port-expander").height(getConnectorsNavHeight())} else {_ui.connectorContainer.find(".flow-port").each(function() {$(this).removeClass("search-not-matched")});_ui.corePortContainer.removeClass("hidden");_ui.corePortTrigger.removeClass("hidden");_ui.mftPortContainer.removeClass("hidden");_ui.mftPortTrigger.removeClass("hidden");_ui.ediPortContainer.removeClass("hidden");_ui.ediPortTrigger.removeClass("hidden");_ui.databasePortContainer.removeClass("hidden");_ui.databasePortTrigger.removeClass("hidden");_ui.otherPortContainer.removeClass("hidden");_ui.otherPortTrigger.removeClass("hidden");_ui.samplePortContainer.removeClass("hidden");_ui.samplePortTrigger.removeClass("hidden");_ui.corePortContainer.collapse("show");_ui.mftPortContainer.collapse("hide");_ui.ediPortContainer.collapse("hide");_ui.databasePortContainer.collapse("hide");_ui.otherPortContainer.collapse("hide");_ui.samplePortContainer.collapse("hide");_ui.corePortContainer.find(".port-expander").height(getConnectorsNavHeight());_ui.corePortContainer.find(".port-expander").css({"max-height": ""})}}
_ui.connectorsSearchBar.on("keyup", function($event) {var event = $event || window.event;if (event.keyCode == 13) {connectorsSearch();return} else if (event.keyCode == 27) {_ui.connectorsSearchBar.val("")}
if (_ui.connectorsSearchBar.val().length > 0) {_ui.connectorsSearchClear.removeClass("hidden")} else {_ui.connectorsSearchClear.addClass("hidden")}
connectorsSearch()});_ui.connectorsSearchClear.click(function() {_ui.connectorsSearchBar.val("");_ui.connectorsSearchClear.addClass("hidden");connectorsSearch()});var flowsSearch = function() {var filter = _ui.flowsSearchBar.val().trim().toLowerCase();if (filter) {_ui.viewContainer.find(".flow-view").each(function() {var name = $(this).find(".flow-view-txt").text().trim().toLowerCase();if (!name.includes(filter)) {$(this).addClass("search-not-matched")} else {$(this).removeClass("search-not-matched")}});_ui.apiContainer.find(".flow-api").each(function() {var method = $(this).find(".flow-api-method").text().trim().toLowerCase();var name = $(this).find(".flow-api-name").text().trim().toLowerCase();if (!name.includes(filter) && !method.includes(filter)) {$(this).addClass("search-not-matched")} else {$(this).removeClass("search-not-matched")}});_ui.portContainer.find(".flow-port").each(function() {var type = $(this).data("instance").getPortType();var displayname = rsb.workflow.connectorTypeNameMap[type];var name = $(this).find(".flow-port-txt").text().trim().toLowerCase();if (!name.includes(filter) && displayname && !displayname.toLowerCase().includes(filter)) {$(this).addClass("search-not-matched")} else {$(this).removeClass("search-not-matched")}});if (_ui.viewContainer.find(".flow-view:not(.search-not-matched)").length < 1) {_ui.viewContainer.addClass("hidden");_ui.viewNavTrigger.addClass("hidden")} else {_ui.viewContainer.removeClass("hidden");_ui.viewNavTrigger.removeClass("hidden")}
if (_ui.apiContainer.find(".flow-api:not(.search-not-matched)").length < 1) {_ui.apiContainer.addClass("hidden");_ui.apiNavTrigger.addClass("hidden")} else {_ui.apiContainer.removeClass("hidden");_ui.apiNavTrigger.removeClass("hidden")}
if (_ui.portContainer.find(".flow-port:not(.search-not-matched)").length < 1) {_ui.portContainer.addClass("hidden");_ui.portNavTrigger.addClass("hidden")} else {_ui.portContainer.removeClass("hidden");_ui.portNavTrigger.removeClass("hidden")}} else {_ui.viewContainer.find(".flow-view").each(function() {$(this).removeClass("search-not-matched")});_ui.apiContainer.find(".flow-api").each(function() {$(this).removeClass("search-not-matched")});_ui.portContainer.find(".flow-port").each(function() {$(this).removeClass("search-not-matched")});_ui.viewContainer.removeClass("hidden");_ui.viewNavTrigger.removeClass("hidden");_ui.apiContainer.removeClass("hidden");_ui.apiNavTrigger.removeClass("hidden");_ui.portContainer.removeClass("hidden");_ui.portNavTrigger.removeClass("hidden")}
updateSummary(_ui.viewNavSummary, _ui.viewContainer.find(".flow-view:not(.search-not-matched)").length);updateSummary(_ui.apiNavSummary, _ui.apiContainer.find(".flow-api:not(.search-not-matched)").length);updateSummary(_ui.portNavSummary, _ui.portContainer.find(".flow-port:not(.search-not-matched)").length);_ui.viewContainerExpander.collapse("show");_ui.apiContainerExpander.collapse("show");_ui.portContainerExpander.collapse("show")}
_ui.flowsSearchBar.on("keyup", function($event) {var event = $event || window.event;if (_ui.flowsSearchBar.val().length > 0) {_ui.flowsSearchClear.removeClass("hidden")} else {_ui.flowsSearchClear.addClass("hidden")}
if (event.keyCode == 13) {flowsSearch();return} else if (event.keyCode == 27) {_ui.flowsSearchBar.val("")}
flowsSearch()});_ui.flowsSearchClear.click(function() {_ui.flowsSearchBar.val("");_ui.flowsSearchClear.addClass("hidden");flowsSearch()});$(document).ready(function() {if (rsb.workflow.isStandardOrAdmin) {loadSampleFlow()}
_ui.corePortContainer.find(".port-expander").height(getConnectorsNavHeight());_ui.apiContainer.height(getFlowsNavHeight() * 0.25);_ui.nav.find(".nav-link").on("show.bs.tab", function() {var activeTab = $("#nav .nav-link.active");if (activeTab.text().toLowerCase() == "flows") {flowsSearch()}});_ui.corePortContainer.on("show.bs.collapse", function() {$(this).addClass("flow-collapse-in");_ui.corePortTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");if (_ui.connectorsSearchBar.val()) {_ui.corePortContainer.find(".port-expander").height("auto");_ui.corePortContainer.find(".port-expander").css({"max-height": "300px"})} else {_ui.corePortContainer.find(".port-expander").height(getConnectorsNavHeight());_ui.corePortContainer.find(".port-expander").css({"max-height": ""});_ui.mftPortContainer.collapse("hide");_ui.ediPortContainer.collapse("hide");_ui.databasePortContainer.collapse("hide");_ui.otherPortContainer.collapse("hide");_ui.samplePortContainer.collapse("hide")}});_ui.corePortContainer.on("hide.bs.collapse", function() {if (!_ui.connectorsSearchBar.val() && !_ui.mftPortContainer.hasClass("flow-collapse-in") && !_ui.ediPortContainer.hasClass("flow-collapse-in") && !_ui.databasePortContainer.hasClass("flow-collapse-in") && !_ui.otherPortContainer.hasClass("flow-collapse-in") && !_ui.samplePortContainer.hasClass("flow-collapse-in")) {_ui.mftPortContainer.collapse("show");return false}
_ui.corePortTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o")});_ui.corePortContainer.on("hidden.bs.collapse", function() {$(this).removeClass("flow-collapse-in")});_ui.mftPortContainer.on("show.bs.collapse", function() {$(this).addClass("flow-collapse-in");_ui.mftPortTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");if (_ui.connectorsSearchBar.val()) {_ui.mftPortContainer.find(".port-expander").height("auto");_ui.mftPortContainer.find(".port-expander").css({"max-height": "300px"})} else {_ui.mftPortContainer.find(".port-expander").height(getConnectorsNavHeight());_ui.mftPortContainer.find(".port-expander").css({"max-height": ""});_ui.corePortContainer.collapse("hide");_ui.ediPortContainer.collapse("hide");_ui.databasePortContainer.collapse("hide");_ui.otherPortContainer.collapse("hide");_ui.samplePortContainer.collapse("hide")}});_ui.mftPortContainer.on("hide.bs.collapse", function() {if (!_ui.connectorsSearchBar.val() && !_ui.corePortContainer.hasClass("flow-collapse-in") && !_ui.ediPortContainer.hasClass("flow-collapse-in") && !_ui.databasePortContainer.hasClass("flow-collapse-in") && !_ui.otherPortContainer.hasClass("flow-collapse-in") && !_ui.samplePortContainer.hasClass("flow-collapse-in")) {_ui.ediPortContainer.collapse("show");return false}
_ui.mftPortTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o")});_ui.mftPortContainer.on("hidden.bs.collapse", function() {$(this).removeClass("flow-collapse-in")});_ui.ediPortContainer.on("show.bs.collapse", function() {$(this).addClass("flow-collapse-in");_ui.ediPortTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");if (_ui.connectorsSearchBar.val()) {_ui.ediPortContainer.find(".port-expander").height("auto");_ui.ediPortContainer.find(".port-expander").css({"max-height": "300px"})} else {_ui.ediPortContainer.find(".port-expander").height(getConnectorsNavHeight());_ui.ediPortContainer.find(".port-expander").css({"max-height": ""});_ui.corePortContainer.collapse("hide");_ui.mftPortContainer.collapse("hide");_ui.databasePortContainer.collapse("hide");_ui.otherPortContainer.collapse("hide");_ui.samplePortContainer.collapse("hide")}});_ui.ediPortContainer.on("hide.bs.collapse", function() {if (!_ui.connectorsSearchBar.val() && !_ui.corePortContainer.hasClass("flow-collapse-in") && !_ui.mftPortContainer.hasClass("flow-collapse-in") && !_ui.databasePortContainer.hasClass("flow-collapse-in") && !_ui.otherPortContainer.hasClass("flow-collapse-in") && !_ui.samplePortContainer.hasClass("flow-collapse-in")) {_ui.databasePortContainer.collapse("show");return false}
_ui.ediPortTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o")});_ui.ediPortContainer.on("hidden.bs.collapse", function() {$(this).removeClass("flow-collapse-in")});_ui.databasePortContainer.on("show.bs.collapse", function() {$(this).addClass("flow-collapse-in");_ui.databasePortTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");if (_ui.connectorsSearchBar.val()) {_ui.databasePortContainer.find(".port-expander").height("auto");_ui.databasePortContainer.find(".port-expander").css({"max-height": "300px"})} else {_ui.databasePortContainer.find(".port-expander").height(getConnectorsNavHeight());_ui.databasePortContainer.find(".port-expander").css({"max-height": ""});_ui.corePortContainer.collapse("hide");_ui.mftPortContainer.collapse("hide");_ui.ediPortContainer.collapse("hide");_ui.otherPortContainer.collapse("hide");_ui.samplePortContainer.collapse("hide")}});_ui.databasePortContainer.on("hide.bs.collapse", function() {if (!_ui.connectorsSearchBar.val() && !_ui.corePortContainer.hasClass("flow-collapse-in") && !_ui.mftPortContainer.hasClass("flow-collapse-in") && !_ui.ediPortContainer.hasClass("flow-collapse-in") && !_ui.otherPortContainer.hasClass("flow-collapse-in") && !_ui.samplePortContainer.hasClass("flow-collapse-in")) {_ui.otherPortTrigger.hasClass("hidden") ? _ui.ediPortContainer.collapse("show") : _ui.otherPortContainer.collapse("show");return false}
_ui.databasePortTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o")});_ui.databasePortContainer.on("hidden.bs.collapse", function() {$(this).removeClass("flow-collapse-in")});_ui.otherPortContainer.on("show.bs.collapse", function() {$(this).addClass("flow-collapse-in");_ui.otherPortTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");if (_ui.connectorsSearchBar.val()) {_ui.otherPortContainer.find(".port-expander").height("auto");_ui.otherPortContainer.find(".port-expander").css({"max-height": "300px"})} else {_ui.otherPortContainer.find(".port-expander").height(getConnectorsNavHeight());_ui.otherPortContainer.find(".port-expander").css({"max-height": ""});_ui.corePortContainer.collapse("hide");_ui.mftPortContainer.collapse("hide");_ui.databasePortContainer.collapse("hide");_ui.ediPortContainer.collapse("hide");_ui.samplePortContainer.collapse("hide")}});_ui.otherPortContainer.on("hide.bs.collapse", function() {if (!_ui.connectorsSearchBar.val() && !_ui.corePortContainer.hasClass("flow-collapse-in") && !_ui.mftPortContainer.hasClass("flow-collapse-in") && !_ui.ediPortContainer.hasClass("flow-collapse-in") && !_ui.databasePortContainer.hasClass("flow-collapse-in") && !_ui.samplePortContainer.hasClass("flow-collapse-in")) {_ui.samplePortTrigger.hasClass("hidden") ? _ui.databasePortContainer.collapse("show") : _ui.samplePortContainer.collapse("show");return false}
_ui.otherPortTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o")});_ui.otherPortContainer.on("hidden.bs.collapse", function() {$(this).removeClass("flow-collapse-in")});_ui.samplePortContainer.on("show.bs.collapse", function() {$(this).addClass("flow-collapse-in");_ui.samplePortTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");_ui.samplePortContainer.find(".port-expander").height(getConnectorsNavHeight());if (!_ui.connectorsSearchBar.val()) {_ui.corePortContainer.collapse("hide");_ui.mftPortContainer.collapse("hide");_ui.databasePortContainer.collapse("hide");_ui.ediPortContainer.collapse("hide");_ui.otherPortContainer.collapse("hide")}});_ui.samplePortContainer.on("hide.bs.collapse", function() {if (!_ui.connectorsSearchBar.val() && !_ui.corePortContainer.hasClass("flow-collapse-in") && !_ui.mftPortContainer.hasClass("flow-collapse-in") && !_ui.ediPortContainer.hasClass("flow-collapse-in") && !_ui.databasePortContainer.hasClass("flow-collapse-in") && !_ui.otherPortContainer.hasClass("flow-collapse-in")) {_ui.otherPortContainer.collapse("show");return false}
_ui.samplePortTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o")});_ui.samplePortContainer.on("hidden.bs.collapse", function() {$(this).removeClass("flow-collapse-in")});_ui.portContainerExpander.on("show.bs.collapse", function() {_ui.apiContainer.height(getFlowsNavHeight() * 0.25);$(this).addClass("flow-collapse-in");_ui.viewContainer.height(Math.min(getFlowsNavViewMaxHeight() * 0.5, getFlowsNavHeight() * lastNavViewsHeight));_ui.portNavTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o")});_ui.portContainerExpander.on("shown.bs.collapse", function() {_ui.viewContainer.resizable("enable");if (_ui.viewContainerExpander.hasClass("flow-collapse-in")) {_ui.viewContainer.height(Math.min(getFlowsNavViewMaxHeight() * 0.5, getFlowsNavHeight() * lastNavViewsHeight));_ui.portContainer.height(getFlowsNavHeight() - _ui.viewContainer.height())} else {_ui.portContainer.height(getFlowsNavViewMaxHeight())}});_ui.portContainerExpander.on("hide.bs.collapse", function() {_ui.portNavTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o");if (_ui.viewContainerExpander.hasClass("flow-collapse-in")) {lastNavViewsHeight = _ui.viewContainer.height() / (getFlowsNavHeight())} else if (_ui.apiContainerExpander.hasClass("flow-collapse-in")) {_ui.apiContainer.height(getFlowsNavHeight())}});_ui.portContainerExpander.on("hidden.bs.collapse", function() {if (_ui.viewContainerExpander.hasClass("flow-collapse-in")) {_ui.viewContainer.height(getFlowsNavViewMaxHeight());_ui.viewContainer.resizable("disable")}
$(this).removeClass("flow-collapse-in")});_ui.apiContainerExpander.on("show.bs.collapse", function () {_ui.apiContainer.height(getFlowsNavHeight() * 0.25);$(this).addClass("flow-collapse-in");_ui.apiNavTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o")});_ui.apiContainerExpander.on("shown.bs.collapse", function () {if (_ui.viewContainerExpander.hasClass("flow-collapse-in")) {lastNavViewsHeight = _ui.viewContainer.height() / (getFlowsNavHeight());if (_ui.portContainerExpander.hasClass("flow-collapse-in")) {_ui.viewContainer.height(Math.min(getFlowsNavViewMaxHeight(), _ui.viewContainer.height()));_ui.portContainer.height(getFlowsNavViewMaxHeight() - _ui.viewContainer.height())} else {_ui.viewContainer.height(getFlowsNavViewMaxHeight())}
_ui.viewContainer.resizable("option", "maxHeight", getFlowsNavViewMaxHeight())} else if (_ui.portContainerExpander.hasClass("flow-collapse-in")) {_ui.portContainer.height(getFlowsNavViewMaxHeight())} else {_ui.apiContainer.height(getFlowsNavHeight())}});_ui.apiContainerExpander.on("hide.bs.collapse", function () {_ui.apiNavTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o");$(this).removeClass("flow-collapse-in")});_ui.apiContainerExpander.on("hidden.bs.collapse", function () {_ui.apiContainer.height(getFlowsNavHeight() * 0.25);if (_ui.viewContainerExpander.hasClass("flow-collapse-in")) {_ui.viewContainer.resizable("option", "maxHeight", getFlowsNavViewMaxHeight());if (_ui.portContainerExpander.hasClass("flow-collapse-in")) {_ui.portContainer.height(getFlowsNavViewMaxHeight() - _ui.viewContainer.height())} else {lastNavViewsHeight = _ui.viewContainer.height() / (getFlowsNavHeight());_ui.viewContainer.height(getFlowsNavViewMaxHeight())}} else if (_ui.portContainerExpander.hasClass("flow-collapse-in")) {_ui.portContainer.height(getFlowsNavViewMaxHeight())}});_ui.viewContainerExpander.on("show.bs.collapse", function() {_ui.apiContainer.height(getFlowsNavHeight() * 0.25);$(this).addClass("flow-collapse-in")});_ui.viewContainerExpander.on("shown.bs.collapse", function() {_ui.viewNavTrigger.find("i").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");if (_ui.portContainerExpander.hasClass("flow-collapse-in")) {_ui.viewContainer.height(getFlowsNavHeight() * lastNavViewsHeight);_ui.portContainer.height(getFlowsNavViewMaxHeight() - _ui.viewContainer.height())} else {_ui.viewContainer.resizable("disable");_ui.viewContainer.height(getFlowsNavViewMaxHeight())}});_ui.viewContainerExpander.on("hide.bs.collapse", function() {_ui.viewNavTrigger.find("i").removeClass("fa-minus-square-o").addClass("fa-plus-square-o");if (_ui.portContainerExpander.hasClass("flow-collapse-in")) {lastNavViewsHeight = _ui.viewContainer.height() / (getFlowsNavHeight());_ui.portContainer.height(getFlowsNavViewMaxHeight())} else if (_ui.apiContainerExpander.hasClass("flow-collapse-in")) {_ui.apiContainer.height(getFlowsNavHeight())}});_ui.viewContainerExpander.on("hidden.bs.collapse", function() {$(this).removeClass("flow-collapse-in")});_ui.viewContainer.resizable({handles: "s",minHeight: 40,maxHeight: getFlowsNavViewMaxHeight(),resize: onViewsResize})})};rsb.workflow.nav = new Nav();var View = function($props) {$props = $props || {};this.name = $props["name"];this.zoom = $props["zoom"];this.zoomOrigin = $props["zoomOrigin"];this.posX = $props["posX"];this.posY = $props["posY"]}
var FlowAPI = function ($props) {$props = $props || {};this.name = $props["name"] || "API1";this.method = $props["method"] || "POST";this.posX = $props["posX"];this.posY = $props["posY"];this.width = $props["width"];this.height = $props["height"];this.start = $props["start"];this.connectors = $props["connectors"] || [];this.end = $props["end"] || [];var _this = this;var _key = "";var setMethod = function ($method) {_this.method = ($method || "POST").toUpperCase();_key = "api-" + (_this.name || "").replace(/\s/g, '_').toUpperCase().replace(/./g, function (ch) { return ch.charCodeAt(0).toString(16)}) + "-" + (_this.method || "").replace(/\s/g, '_').toUpperCase()}
setMethod(this.method);this.update = function ($settings) {var $key = this.getKey();setMethod($settings["method"]);rsb.workflow.flow.save();return $key}
this.getKey = function () {return _key}}
var PortSettings = function() {var _ui = {};_ui.portSettings = $("#portSettings");_ui.closeButton = _ui.portSettings.find("div.flow-settings-header button.close");_ui.container = _ui.portSettings.children("div.flow-settings-container");var _currentShownPort = null;var _currentShownAPI = null;var _onBeforeShowSettings = null;const API_SETTINGS_MIN_WIDTH = 600;this.showSettings = function($portId, $tab, $beforeShowSettings) {_onBeforeShowSettings = $beforeShowSettings;if ($portId) {changePageHashWithCheckUnsave($portId, $tab)}}
this.hideSettings = function() {changePageHashWithCheckUnsave()}
this.revertChanges = function() {rsb.revertUnsave(getCurrentPortSettingsForm())}
this.checkUnsave = function() {var form = getCurrentPortSettingsForm();return rsb.checkUnsave(form, rsb.externalCheckUnsaveFunc[form.attr("id")])}
this.resize = function() {_ui.portSettings.resizable("option", "maxWidth", Math.max($("#flowContainer").width() * 0.75, getMinWidth()));_ui.portSettings.resizable("option", "minWidth", getMinWidth());if (this.getWidth() < getMinWidth()) {this.setWidth(getMinWidth())}
_ui.portSettings.css({"left": $("#flowContainer").width() - _ui.portSettings.width()});if ($("#flowContainer").width() - _ui.portSettings.width() > $("#nav").width() + 30) {_ui.portSettings.css({"left": $("#flowContainer").width() - _ui.portSettings.width()});_ui.portSettings.resizable('enable')} else {_ui.portSettings.css({"left": $("#nav").width() + 30});_ui.portSettings.resizable('disable');this.setWidth($(window).width() - ($("#nav").width() + 30))}
onResize()}
this.getWidth = function() {return _ui.portSettings.width()}
this.setWidth = function($width) {_ui.portSettings.width($width);onResize()}
this.saveSettings = function() {var obj = $(document.activeElement).closest(".shortcut-save") || $(document.activeElement).find(".shortcut-save");if (obj && obj.is(":visible")) {var savebtn = $(obj).attr("savebutton");$(":focus").trigger("blur");$("#" + rsb.escapeSelector(savebtn)).click();return true}
obj = _ui.container.find("#portSaveButton button");if (obj.length > 0) {$(":focus").trigger("blur");obj.click();return true}
return false}
this.init = function() {window.addEventListener("hashchange", onHashChange)}
var getCurrentPortSettingsForm = function() {var lastTabId = _ui.container.find("ul.nav-tabs li a.active").attr("data-bs-target");return _ui.container.find("div.tab-pane").filter(lastTabId).children("form")}
var getMinWidth = function() {var width = 280;_ui.portSettings.find("#port-tab li").each(function() {width += $(this).outerWidth(true)});if (!!_currentShownAPI && width < API_SETTINGS_MIN_WIDTH) {width = API_SETTINGS_MIN_WIDTH}
return width}
var switchPortSettingsTab = function($event) {var info = rsb.workflow.getPageHashInfo();var target = $($($event.target).attr("data-bs-target"))[0].id;var message = rsb.workflow.portSettings.checkUnsave();if (!message) {rsb.workflow.updatePageHash(info.flow, info.portId, target)} else {var okCallback = function() {rsb.workflow.updatePageHash(info.flow, info.portId, target)};rsb.confirmModal({clone: true,title: 'Save Changes',body: 'You have unsaved changes.  Do you want to keep the changes?',okText:'OK',ok: function() {var form = getCurrentPortSettingsForm();form.off("success", okCallback).one("success", okCallback);if (info.portTab != "events") {_ui.container.find("#portSaveButton button").click()} else {_ui.container.find("#btn-event-save").click();okCallback()}},cancelText: 'Continue Without Saving',cancel: function(){var form = getCurrentPortSettingsForm();rsb.revertUnsave(form);rsb.workflow.updatePageHash(info.flow, info.portId, target)}})}}
var loadSettings = function($portId, $callback) {if ($portId && (_currentShownPort == null || $portId != _currentShownPort.getPortId())) {clearSettings();var port = rsb.workflow.flow.getPort($portId, "sender");if (!port) {console.warn($i18n("flow_js_0034", "Connector [" + $portId + "] not exists."));return}
_currentShownPort = port;_currentShownAPI = null;if (!rsb.workflow.nav.isInstalled(port.getPortType()) && !rsb.workflow.removedTypes.includes(port.getPortType().toLowerCase())) {rsb.workflow.portSettings.hideSettings();rsb.connect.createPortModal(port.getPortType(), port.getPortId(), false)} else {_ui.container.html("<i class='fa fa-spinner fa-spin' style='position: absolute; top: calc(50% - 25px); left: calc(50% - 25px); font-size: 56px'></i>");_ui.portSettings.removeClass("hidden");if (_onBeforeShowSettings) {_onBeforeShowSettings();_onBeforeShowSettings = null}
port.fireShowSettings();_ui.container.load("src/flowPortSettings.rst?page:workflow=true&page:enablesendtoport=false&page:currentportid=" + encodeURIComponent($portId) + "&page:currentworkspaceid=" + encodeURIComponent(rsb.workflow.flow.getCurrentWorkspace()) + "&" + rsb.securityRand(), function() {initSettingComponents();_ui.container.find("form").on("success", function() {onPortSettingsChanged(true)});_ui.container.find("form").on("error", function() {onPortSettingsChanged(false)});if ($callback) {$callback()}
rsb.workflow.portSettings.resize();rsb.workflow.flow.resize();if (rsb.workflow.portSettings.getWidth() < 768) {_ui.portSettings.addClass("flow-settings-sm")}})}} else {if ($callback) {$callback()}}}
var loadAPISettings = function ($flowAPI, $callback) {if (!!$flowAPI.name && !!$flowAPI.method && (_currentShownAPI == null || _currentShownAPI.name != $flowAPI.name || _currentShownAPI.method != $flowAPI.method)) {clearSettings();_currentShownAPI = $flowAPI;_currentShownPort = null;_ui.container.html("<i class='fa fa-spinner fa-spin' style='position: absolute; top: calc(50% - 25px); left: calc(50% - 25px); font-size: 56px'></i>");_ui.portSettings.removeClass("hidden");if (_onBeforeShowSettings) {_onBeforeShowSettings();_onBeforeShowSettings = null}
_ui.container.load("src/flowAPISettings.rst?page:workflow=true&page:workspaceid=" + encodeURIComponent(rsb.workflow.flow.getCurrentWorkspace()) + "&page:apiname=" + encodeURIComponent($flowAPI.name) + "&page:httpmethod=" + encodeURIComponent($flowAPI.method) + "&" + rsb.securityRand(), function () {initSettingComponents();!!$callback && $callback();rsb.workflow.portSettings.resize();rsb.workflow.flow.resize();if (rsb.workflow.portSettings.getWidth() < 768) {_ui.portSettings.addClass("flow-settings-sm")}})} else {!!$callback && $callback()}}
var initSettingComponents = function () {_ui.container.find("[data-bs-toggle='popover']").popover({container: 'body',placement: 'top'}).on("show.bs.popover", function() {_ui.container.find("select:focus").not(this).blur()});_ui.container.find("[data-bs-toggle='tooltip']").tooltip().on("show.bs.tooltip", function() {_ui.container.find("select:focus").not(this).blur()});rsb.initSettingsForms();rsb.initSubSettingsSwitcher();rsb.initCopyToClipboard();if (_currentShownPort != null) {rsb.connect.initRestrictionFeatures((rsb.workflow.hasConnectorPrivilege(_currentShownPort.getPortId(), "UpdateSettings") ? "disabled" : "true"), _ui.container)}
if (_currentShownAPI != null) {rsb.connect.initRestrictionFeatures(rsb.workflow.userRole, _ui.container)}
_ui.container.find("ul.nav-tabs li a").click(switchPortSettingsTab)}
var showTab = function($tab) {if ($tab !== undefined && $tab.length > 0) {var currentTab = _ui.container.find("ul.nav-tabs li a.active");if (currentTab.length <= 0 || $tab != currentTab.attr("data-bs-target")) {var tab = _ui.container.find("ul.nav-tabs li a[data-bs-target='#" + rsb.escapeSelector($tab) + ".tab-pane']");if (tab.length > 0) {$(tab).tab("show");if ($("#" + $tab).find(".react-switch-tab")[0]) {var reactEvent = new Event("show.bs.tab");$("#" + $tab).find(".react-switch-tab")[0].dispatchEvent(reactEvent)}} else if (_ui.container.find("ul.nav-tabs li a").length > 0) {var firstTab = _ui.container.find("ul.nav-tabs li a").first();var target = $(firstTab.attr("data-bs-target"))[0].id;var info = rsb.workflow.getPageHashInfo();rsb.workflow.updatePageHash(info.flow, info.portId, target)}}} else {var firstTab = _ui.container.find("ul.nav-tabs li a").first();$(firstTab).tab("show")}
rsb.connect.initPasswordInputBox()}
var clearSettings = function() {_ui.portSettings.addClass("hidden");_ui.container.find(".rsb-root-component").trigger("unmountComponent");_ui.container.empty();rsb.editors = [];if (_currentShownPort) {_currentShownPort.fireSettingsHidden();_currentShownPort = null}
_currentShownAPI = null;rsb.workflow.flow.resize();rsb.workflow.apiGroupMgr.updateHighlight(null)}
var changePageHashWithCheckUnsave = function($portId, $tab) {var message = rsb.workflow.portSettings.checkUnsave();if (!message) {rsb.abortAllAjax();var info = rsb.workflow.getPageHashInfo();rsb.workflow.updatePageHash(info.flow, $portId, $tab)} else {var afterSaveChange = () => {var info = rsb.workflow.getPageHashInfo();rsb.abortAllAjax();rsb.workflow.updatePageHash(info.flow, $portId, $tab)}
rsb.confirmModal({title: 'Save Changes',body: 'You have unsaved changes.  Do you want to keep the changes?',ok: function() {var form = getCurrentPortSettingsForm();var info = rsb.workflow.getPageHashInfo();form.off("success", afterSaveChange);form.one("success", afterSaveChange);if (info.portTab != "events") {_ui.container.find("#portSaveButton button").click()} else {_ui.container.find("#btn-event-save").click();rsb.workflow.updatePageHash(info.flow, $portId, $tab)}},cancelText: 'Continue Without Saving',cancel: function(){var form = getCurrentPortSettingsForm();rsb.revertUnsave(form);var info = rsb.workflow.getPageHashInfo();rsb.abortAllAjax();rsb.workflow.updatePageHash(info.flow, $portId, $tab)}})}}
var onHashChange = function ($event, $retrying) {var hashInfo = rsb.workflow.getPageHashInfo();if (hashInfo.portId) {rsb.workflow.apiGroupMgr.updateHighlight(null);loadSettings(hashInfo.portId, function() {showTab(hashInfo.portTab)})} else if (!!hashInfo.name && !!hashInfo.method) {var $flowAPI = rsb.workflow.flow.getFlowAPI(new FlowAPI({ name: hashInfo.name, method: hashInfo.method }).getKey());!!$flowAPI && loadAPISettings($flowAPI, function () {rsb.workflow.apiGroupMgr.updateHighlight($flowAPI);showTab(hashInfo.portTab);var $form = getCurrentPortSettingsForm();$form.off("rsb.flowapiSettings.updated").on("rsb.flowapiSettings.updated", function (event, $data) {var $settings = $.extend($data, {name: $flowAPI.name, method: $data.newhttpmethod});rsb.workflow.nav.updateFlowAPI($flowAPI, new FlowAPI($settings));rsb.workflow.apiGroupMgr.updateGroupSettings($flowAPI, $settings);$flowAPI.update($settings);var $info = rsb.workflow.getPageHashInfo();!$info.portId & $info.name === hashInfo.name && $info.method === hashInfo.method && rsb.workflow.updatePageHash(rsb.workflow.flow.getCurrentWorkspace(), "api:" + $flowAPI.name + ":" + $flowAPI.method, "")})});!$flowAPI && setTimeout(function () {if (!!_currentShownAPI) return false;if (!!$retrying) {rsb.workflow.updatePageHash(rsb.workflow.flow.getCurrentWorkspace(), "", "")} else {onHashChange($event, true)}}, !!$retrying ? 0 : 100)} else {clearSettings()}}
var onResize = function() {if (rsb.workflow.portSettings.getWidth() < 768) {_ui.portSettings.addClass("flow-settings-sm")} else {_ui.portSettings.removeClass("flow-settings-sm")}
_ui.portSettings.find("#loadportFormResult").outerWidth(_ui.portSettings.width(), true);_ui.portSettings.find("#testConnectionResult").outerWidth(_ui.portSettings.width(), true);if (_ui.portSettings.width() > getMinWidth() - 1) {_ui.container.children(".tab-content").css({"width": this.getWidth()});_ui.container.children(".port-navbar").css({"width": this.getWidth()});_ui.container.css({"overflow-x": "hidden"})} else {_ui.container.children(".tab-content").css({"width": getMinWidth()});_ui.container.children(".port-navbar").css({"width": getMinWidth()});_ui.container.css({"overflow-x": "auto"})}
rsb.workflow.flow.resize();_ui.portSettings.trigger("rsb.flow.resizePortSettings", [_ui.portSettings]);rsb.workflow.updateFlowinSession()}.bind(this);var onPortSettingsChanged = function(success) {_currentShownPort.fireSettingsChanged(success)}
_ui.portSettings.resizable({handles: "w",minWidth: getMinWidth(),maxWidth: Math.max($("#flowContainer").width() * 0.75, getMinWidth()),resize: onResize,stop: onResize});_ui.closeButton.click(function() {rsb.workflow.portSettings.hideSettings()})};rsb.workflow.portSettings = new PortSettings();rsb.workflow.getNextPortId = function($portType, $callback) {var postData = {"@json": true};if ($portType instanceof Array) {if ($portType.length > 1) {for (var index = 0; index < $portType.length; index++) {var attr = "PortId#" + (index + 1);postData[attr] = $portType[index]}} else {postData.PortType = $portType[0]}} else {postData.PortType = $portType}
$.ajax({url: "src/getNextPortId.rsb",type: "POST",data: postData,dataType: "json",success: function(data, textStatus, jqXHR) {var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else if (result.length > 0) {var portId = "";if (result.length == 1) {portId = result[0].portid} else {portId = [];for (var index in result) {portId.push(result[index].portid)}}
if ($callback) {$callback(portId)}}}})}
rsb.workflow.listAPIEntities = function ($workspaceId, $callback) {$.ajax({url: "src/flowapis.rsd",type: "GET",data: {"@json": true, "WorkspaceId": $workspaceId},dataType: "json",success: function (data, textStatus, jqXHR) {var result = data["items"];var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(rsb.workflow.resultContainer, errorMsg, false)} else {var $entities = Object.create(null);result.length > 0 && rsb.forEach(result, function ($api) {$entities[$api.apiname.toUpperCase()] = $entities[$api.apiname.toUpperCase()] || [];$entities[$api.apiname.toUpperCase()].push($api.httpmethod.toUpperCase())});!!$callback && $callback($entities)}}})}
rsb.workflow.getNextAPIName = function ($workspaceId, $callback) {rsb.workflow.listAPIEntities($workspaceId, function ($apiEntities) {var $index = 1;while (!!$apiEntities["API" + $index]) {$index++}
!!$callback && $callback("API" + $index)})}
rsb.workflow.isAPIAble = function ($connectorType) {return ["", "copy", "sftpserver", "emailreceive", "api", "ftpserver", "rss", "workspacereceive", "webhook", "schedule", "form"].indexOf(($connectorType || "").toLowerCase()) < 0}
rsb.workflow.normalizeResponse = function($data) {for (var key in $data) {if (typeof($data[key]) == "string") {$data[key] = [$data[key]]}}
return $data}
rsb.workflow.updateTimer = null;rsb.workflow.updateFlowinSession = function() {clearTimeout(rsb.workflow.updateTimer);rsb.workflow.updateTimer = setTimeout(function() {var currentView = rsb.workflow.flow.getCurrentView();var postData = {zoom: currentView.zoom,zoomorigin: currentView.zoomOrigin,posX: currentView.posX,posY: currentView.posY,workspace: rsb.workflow.flow.getCurrentWorkspace(),navwidth: rsb.workflow.nav.getWidth(),navviewsheight: rsb.workflow.nav.getFlowsTabViewsHeight(),portsettingswidth: rsb.workflow.portSettings.getWidth()}
$.ajax({dataType: "html",url: "src/setFlowViewInfo.rst",type: "POST",data: postData})}, 500)}
rsb.workflow.getPageHashInfo = function() {var hash = window.location.hash;if (hash.startsWith("#")) {hash = hash.substring(1)}
var parts = hash.split("|");var info = {};if (parts[0]) info.flow = decodeURIComponent(parts[0]);if (parts[1]) {info.portId = decodeURIComponent(parts[1]);var $parts = info.portId.split(':')
if (!!$parts && $parts.length == 3 && $parts[0] == "api") {info.name = $parts[1];info.method = $parts[2];delete info.portId}}
if (parts[2]) info.portTab = decodeURIComponent(parts[2]);return info}
rsb.workflow.updatePageHash = function($flow, $portId, $portTab) {var currentHash = rsb.workflow.getPageHashInfo();if (currentHash.flow != $flow || currentHash.portId != $portId || currentHash.portTab != $portTab || !$portId) {var hash = "#";if (typeof($flow) == "string" && $flow.length > 0) {hash += encodeURIComponent($flow)}
if (typeof($portId) == "string" && $portId.length > 0) {hash += "|" +  encodeURIComponent($portId);if (typeof($portTab) == "string" && $portTab.length > 0) {hash += "|" + $portTab}}
window.location.hash = hash}}
rsb.workflow.getPosition = function ($elem) {var position = {left: Number($elem.css("left").replace("px", "")) || 0,top: Number($elem.css("top").replace("px", "")) || 0};var $group = rsb.workflow.apiGroupMgr.getGroupFor($elem[0]);if (!!$group) {position.left += $group.el.offsetLeft;position.top += $group.el.offsetTop}
return position}
rsb.workflow.getViewportRect = function ($elem) {return $($elem)[0].getBoundingClientRect()}
rsb.workflow.isRectOverlapped = function ($curRect, $destRect) {return $curRect.right >= $destRect.left && $curRect.left <= $destRect.right && $curRect.bottom >= $destRect.top && $curRect.top <= $destRect.bottom}
rsb.workflow.hasWorkflow = function($workspace) {var hasFlow = false;$.ajax({url: "src/workflow.rsd",type: "GET",data: { "@json": true, "workspaceid": $workspace, "_randomtoken": rsb.securityRand() },dataType: "json",async: false}).done(function(data, textStatus, jqHex) {var flowResult = data["items"];var errorMsg = rsb.getResultErrorMessage(flowResult);hasFlow = !errorMsg});return hasFlow}
rsb.workflow.hasWorkspacePrivilege = (privilege, connectorTypeCondition) => {const key = rsb.workflow.flow.getCurrentWorkspace()?.toLowerCase();if (key != null) {const allowedPrivileges = rsb?.connectorList?.[key]?.allowedPrivileges;const allowedConnectorType = rsb?.connectorList?.[key]?.allowedConnectorType;if (allowedPrivileges != null) {if (allowedPrivileges.includes(privilege.toLowerCase())) {if (connectorTypeCondition != null && allowedConnectorType != null && allowedConnectorType.length > 0) {return allowedConnectorType.includes(connectorTypeCondition.toLowerCase())}} else {return false}}}
return true}
rsb.workflow.hasConnectorPrivilege = (connectorId, privilege) => {const key = rsb.workflow.flow.getCurrentWorkspace()?.toLowerCase();if (key != null) {const allowedPrivileges = rsb?.connectorList?.[key]?.connectors?.[connectorId.toLowerCase()]?.allowedPrivileges;if (allowedPrivileges != null) {return allowedPrivileges.includes(privilege.toLowerCase())}}
return true}
$(document).ready(function(){rsb.keepalive();window.onbeforeunload = function() { return rsb.workflow.flow.checkUnsave() || rsb.workflow.portSettings.checkUnsave(); };$(window).resize(function($event) {if ($event.target == window) {rsb.workflow.nav.resize();rsb.workflow.portSettings.resize();rsb.workflow.flow.resize()}});$(document).on("mouseenter", ".flow-port-txt,.flow-view-txt", function(){var $txt = $(this).get(0);if ($txt.clientWidth < $txt.scrollWidth) {if (!$(this).attr('title')) {$(this).attr('title', $(this).text())}} else {$(this).attr('title', '')}});$(document).on("keydown", function($event) {var event = $event || window.event;var redoBtn = $(".flow-slider-redo button");var undoBtn = $(".flow-slider-undo button");const canModifyFlow = rsb.workflow.hasWorkspacePrivilege("modifyflow");var escapeEvent = $('.flow-settings.hidden').length === 0 || $("#deleteportmodal_modal").attr("aria-hidden") === "false";if (canModifyFlow && event.ctrlKey && event.keyCode == 83) {event.preventDefault();rsb.workflow.portSettings.saveSettings() || rsb.workflow.flow.save()}
if (canModifyFlow && !escapeEvent && (event.ctrlKey || event.metaKey) && event.keyCode != 17) {if (event.keyCode == 90) {event.preventDefault();undoBtn.click()} else if (event.keyCode == 89) {event.preventDefault();redoBtn.click()}}
if (event.ctrlKey && event.keyCode == 191) {event.preventDefault();var activeTab = $("#nav .nav-link.active");if (activeTab.text().toLowerCase() == "connectors") {$("#connectorsSearchBar").focus()} else {$("#flowsSearchBar").focus()}}});$(document).mouseup(function () {rsb.workflow.flow.correctPortPosition()}).mouseleave(function () {rsb.workflow.flow.correctPortPosition()})});