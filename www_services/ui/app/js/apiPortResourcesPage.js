rsb.resource = rsb.resource || {};rsb.resource.options = {};rsb.resource.resourceTableResultContainer = $("#apiportresourcespage_resourceTableResultContainer");rsb.resource.resourceTableContainer = $("#resourceTable");rsb.resource.resourceTable = rsb.resource.resourceTableContainer.find("tbody");rsb.resource.resourceTemplate = "";rsb.resource.init = function($options) {rsb.resource.options = $.extend($options, rsb.connect.options);rsb.resource.resourceTemplate = $(rsb.resource.getTemplate())}
rsb.resource.getTemplate = function() {var hover = "";if (!rsb.resource.readonly) {hover = '\
    <i class="pull-right fa fa-remove hover-display" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete"></i> \
    <i class="pull-right fa fa-edit hover-display" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit"></i></td>'}
return '<tr class="hover pointercursor"><td class="table-name col-4" style="word-break: break-all;"></td>\
  <td class="operations col-3"></td><td class="resource-table col-4" style="word-break: break-all;"></td>\
  <td class="template-result col-1">' + hover + '</tr>'}
rsb.resource.resourceTable.on("click", "tr", function(e){if ($(e.target).hasClass("fa-edit")) {rsb.resource.editor.code($(this).find(".table-name").text(), {isnew: false})} else if($(e.target).hasClass("fa-remove")) {rsb.resource.deleteResource($(this))} else {rsb.resource.editor.edit($(this).find(".table-name").text(), {isnew: false, table: $(this).find(".resource-table").text(), connection: "Connection", description: $(this).data("description"), operation: $(this).data("operation"), restrictUser: $(this).data("restrictuser"), isResource: true})}});rsb.resource.reloadResource = function () {$.ajax({dataType: "json",url: 'src/tables.rsd?@json&connectorid=' + encodeURIComponent(rsb.resource.options.portId) + "&workspaceid=" + encodeURIComponent(rsb.resource.options.workspaceid),cache: false,type: 'GET',success: function(data) {rsb.resource.resourceTable.empty();var result = data["items"];if (result && result.length > 0) {var errorMsg = rsb.getResultErrorMessage(result);var operations = "";rsb.resource.resourceTableContainer.removeClass("hidden");if (!rsb.resource.resourceTableResultContainer.hasClass("alert-danger")
&& !rsb.resource.resourceTableResultContainer.hasClass("alert-warning")) {rsb.resource.resourceTableResultContainer.addClass("hidden")}
result.sort(function (lhs, rhs) {return lhs.name.localeCompare(rhs.name)});for (var i = 0; i < result.length; i++) {var elem = rsb.resource.resourceTemplate.clone();var rawOp = "";if (result[i]["rsb:emessage"]) {var label = elem.find(".template-result");label.append('<span class="badge text-bg-danger" data-bs-toggle="popover" data-container="body" data-bs-trigger="hover" data-bs-placement="top" data-template=\'<div class="popover" role="tooltip" style="max-width: 400px;margin-right: 2em;"><div class="popover-content" style="max-width: 400px; word-wrap: break-word;"></div></div>\' onclick="rsb.stopPropagation(event)" data-bs-content="' + result[i]["rsb:emessage"] + '" title="">' + 'Failure!'+ '</span>')} else {rawOp = result[i].operations}
elem.find(".table-name").text(result[i].name);var operations = "";var parts = rawOp.split(";");for (var j in parts) {var idx = parts[j].indexOf(":");if (idx > 0) {if (operations.length > 0) {operations += ","}
operations += parts[j].substring(0, idx)}}
elem.find(".operations").text(operations);elem.data("operation", result[i].operations);var tableName = result[i].table;if (tableName.indexOf("].[") < 0) {if (tableName.startsWith("[") && tableName.endsWith("]")) {tableName = tableName.substring(1, tableName.length - 1)}}
elem.find(".resource-table").text(tableName);elem.data("description", result[i].description);elem.data("restrictuser", result[i].restrictuser);elem.appendTo(rsb.resource.resourceTable);rsb.resource.resourceTable.find('[data-bs-toggle="tooltip"]').tooltip()}} else {rsb.resource.resourceTableContainer.addClass("hidden");rsb.resource.resourceTableResultContainer.find("button.btn-close").addClass("hidden");rsb.resource.resourceTableResultContainer.removeClass("hidden alert-success alert-danger alert-info alert-warning").addClass("fade-out");rsb.resource.resourceTableResultContainer.find("content").text('Resources are objects exposed in your API that can be queried, created, updated, and deleted.  Add resources by clicking on the button to the right.')}},error: function(xhr, ajaxOptions, thrownError) {rsb.showResult(rsb.resource.resourceTableResultContainer, 'Error retrieving table listing.  Please check your connection settings.'+ thrownError, false)}})};$(document).ready(function() {var resourceEditorOption = {hasDataConnections: false,hasAddTableBtn: false,hasRestrictUsers: true,wizardTitle: 'Add Resource',editorTitle: 'Edit Resource',templateNameLabel: 'Resource Name',retrieveTemplateInfo: 'Retrieving resource',columnInfo: 'Configure the columns for your resource from the list below.',visibleColumnColumns: ["key", "alias", "description"],skipEditor: true,columnEditable: !rsb.resource.readonly,templateNameEditable: true,useSaveGenerateButton: true,multiSchemaImport: true,listTables: function(connectionname, args, callback) {var postData = { "@json": true, "ConnectionName" : "Connection", "ConnectorId" : rsb.resource.options.portId, "WorkspaceId": rsb.resource.options.workspaceid};$.ajax({dataType: "json",type: 'POST',url: 'src/listAvailableTables.rsb',data: postData,success: function(data, textStatus, jqXHR) {callback(data["items"])}})},listColumns: function(connectionname, name, args, callback) {var postData = { "@json": true, "table" : name, "ConnectionName" : "Connection", "ConnectorId" : rsb.resource.options.portId, "WorkspaceId": rsb.resource.options.workspaceid};$.ajax({dataType: "json",type: 'POST',url: 'src/listTableColumns.rsb',data: postData,success: function(data, textStatus, jqXHR) {callback(data["items"])}})},getSchemaInfo: function(name, args, callback) {$.ajax({dataType: "json",type: 'GET',url: 'src/listSchemaColumns.rsb?@json&tablename=' + encodeURIComponent(name) + '&connectorid=' + encodeURIComponent(rsb.resource.options.portId) + '&workspaceid=' + encodeURIComponent(rsb.resource.options.workspaceid),success: function(data, textStatus, jqXHR) {callback(args.connection, args.table, args.description, data["items"])}})},generate: function(connectionname, name, desc, columns, args, callback) {var postData = {"@json": true, "table": name, "ConnectionName": "Connection", "operation": args["operation"], "restrictUser":args["restrictUser"], "fulltextsearch":args["fulltextsearch"], "description": desc, "genMsg":args["genMsg"], "ConnectorId": rsb.resource.options.portId, "WorkspaceId": rsb.resource.options.workspaceid};var colInfos = {};if(columns == null) {postData["listAllColumn"] = "true"} else {for (i in columns) {for (info in columns[i]) {var colInfo = colInfos[info] || (colInfos[info]=[]);colInfo.push(columns[i][info])}}
for (info in colInfos) {postData["column:" + info] = colInfos[info].join(",")}}
$.ajax({dataType: "json",type: 'POST',url: 'src/generateResourceSchema.rsb',data: postData,success: function(data, textStatus, jqXHR) {callback(data["items"][0].schema)}})},save : function(connectionname, tablename, name, code, args, callback) {if (!args.isnew && !confirm(rsb.evalTemplate('Are you sure you want to save changes?  Changes to your API may affect user implementations.', null))) {return }
var newName = args.new_name || "";var resId = rsb.resource.options.workspaceid.toLowerCase() + ":" + rsb.resource.options.portId.toLowerCase();$.ajax({url: "src/saveSchema.rsb?@json&@fmtoptions=exparen",type: "POST",data: {"isnew" : args.isnew, "table": name, "newtable" : newName, "data": code, "ConnectorId" : rsb.resource.options.portId, "WorkspaceId": rsb.resource.options.workspaceid},dataType: "json",headers: {"If-Unmodified-Since": rsb.getResourceLastModified(resId)},success: function (data, textStatus, jqXHR) {rsb.setResourceLastModified(resId, jqXHR.getResponseHeader("Last-Modified"));data = data["items"];if (data && data.length > 0 && data[0]["result"] == "false") {data[0]["rsb:emessage"] = data[0]["error"]} else {rsb.resource.reloadResource()}
callback(data)}})},load : function(name, args, callback){$.post("src/readSchema.rsb?@json&@fmtoptions=exparen", {"schemaName": name, "ConnectorId": rsb.resource.options.portId, "WorkspaceId": rsb.resource.options.workspaceid}, function(data) {data["items"][0]["content"] = data["items"][0]["data"];callback(data["items"])})},ready: function(modal) {rsb.connect.initRestrictionFeatures((rsb.resource.readonly ? "true" : "disabled"), modal)}};rsb.connect.loadModal("templateEditorModal.rst", function() {window.self !== window.top && (rsb.templateEditor = window.parent.rsb.templateEditor);rsb.resource.editor = new rsb.templateEditor(resourceEditorOption)});rsb.resource.reloadResource()});rsb.resource.deleteResource = function(row) {var table = row.find(".table-name").text();var postData = {"@json": true, "Table" : table, "ConnectorId" : rsb.resource.options.portId, "WorkspaceId": rsb.resource.options.workspaceid};if (confirm(rsb.evalTemplate('Are you sure you want to delete $table$?', {"table": table}))) {var resId = rsb.resource.options.workspaceid.toLowerCase() + ":" + rsb.resource.options.portId.toLowerCase();$.ajax({dataType: "json",url: 'src/tables.rsd',data: postData,type: 'DELETE',headers: {"If-Unmodified-Since": rsb.getResourceLastModified(resId)},success: function($result, textStatus, jqXHR) {rsb.setResourceLastModified(resId, jqXHR.getResponseHeader("Last-Modified"));rsb.resource.reloadResource()},error: function(xhr, ajaxOptions, thrownError) {rsb.showResult(rsb.resource.resourceTableResultContainer, 'Error deleting table'+ ": " + thrownError, false)}})}}
