rsb.mappingEditor = function (container, resultContainer, $options) {var DEFAULTS = {retrieveTemplateInfo: 'Retrieving template',retrieveTableInfo: 'Retrieving table listing',retrieveColumnInfo: 'Retrieving table information',visibleColumns: ["key", "datatype", "size", "nullable"],disabled: false,load: function (name, args, callback) {throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "load"})},save: function (tablename, name, code, args, callback) {throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "save"})},listTables: function (args, callback) {throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "listTables"})},listColumns: function (tablename, args, callback) {throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "listColumns"})},getSchemaInfo: function (templateName, content, args, callback) {throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "getSchemaInfo"})},generate: function (structure, args) {throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "generate"})},getValidElementName: function (ele) {throw rsb.evalTemplate('The $func$ function is not implemented.', {"func": "getValidElementName"})},preview: function (templateName, data, input, top, skip, count, args, callback) {throw rsb.evalTemplate("The $func$ function is not implemented.", {"func": "preview"})},saveSample: function (templateName, sample, input, args, callback) {throw rsb.evalTemplate("The $func$ function is not implemented.", {"func": "saveSample"})},saveMapping: function (templatename, content, args, callback) {throw rsb.evalTemplate("The $func$ function is not implemented.", {"func": "saveMapping"})},isFilterable: function (tableName) {return true},isRemovable: function (tableName) {return true},supportCustomQuery: function (tableName) {return true},supportUpsert: function (tableName, defVal) {return defVal}};if (!container || !$(container).length) {throw 'The container of the mapping editor is required.'}
var _container = $(container).find("div.mapping-editor");if (!_container || !_container.length) {throw 'The mapping editor does not exist.'}
var _resultContainer = resultContainer ? $(resultContainer) : null;if (!_resultContainer || !_resultContainer.length) {throw 'The error container is required.'}
var _options = $.extend(DEFAULTS, $options);var _args = null;var _templateName = null;var _structute = {};var _structuteMap = {};var _initializing = false;var _changed = false;var _left = _container.find(".mapping-editor-left");var _right = _container.find(".mapping-editor-right");var _addTableBtn = _left.find(".mapping-editor-add-btn");var _mappingTree = _left.find(".mapping-editor-tree");var _codeBtn = _right.find(".mapping-editor-code-btn");var _designBtn = _right.find(".mapping-editor-design-btn");var _previewBtn = _right.find(".mapping-editor-preview-btn");var _loadingStatus = _right.find(".loading-status");var _columnsPanel = _right.find(".columns-panel");var _allColumnsCb = _columnsPanel.find(".panel-heading>table>thead>tr>th>input");var _columnsTable = _columnsPanel.find("tbody");var _isInput = _container.hasClass("input");var CONST_COLUMN_AGGREGATE_TABLE_POPOVER = '<span data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="top" data-bs-content="' + 'XML Aggregate'+ '"><i class="fa fa-code p-0 bg-white"></i></span>';if (_isInput) {var CONST_COLUMN_TOGGLE = '<span class="span-toggle" data-bs-toggle="popover" data-bs-placement="top" data-bs-trigger="manual" data-bs-content="$column$">$column$</span>\n' +'<button type="button" class="btn btn-toggle btn-sm btn-lookup" data-bs-toggle="button" aria-pressed="false" autocomplete="off" $disabled$><span>$type$</span>\n' +'  <div class="handle"></div>\n' +'</button>';var CONST_COLUMN_AUTO_REF = '<span class="span-toggle" data-bs-toggle="popover" data-bs-placement="top" data-bs-trigger="manual" data-bs-content="$column$">$column$</span>\n' +'<span class="badge badge-secondary" data-bs-toggle="popover" data-bs-trigger="hover" data-bs-placement="top" data-bs-content="$foreignKey$" style="float: right; left: unset !important">' + 'REF'+ '</span>\n';var CONST_ROW_UPSERT = '<tr class="upsert-settings-container" style="display: none;">\n' +'  <td colspan="2"></td>\n' +'  <td colspan="4">\n' +'    <div class="radio upsert-container pt-1">\n' +'      <label><input type="radio" name="$name$" class="form-check-input controller" checked $disabled$>' + 'UPSERT by:'+ '&nbsp;</label>\n' +'      <div style="display: inline-block;">\n' +'        <select class="form-control form-select upsert-select" style="width: auto; display: inline-block; min-width: 200px;" $disabled$></select>\n' +'      </div>\n' +'    </div>\n' +'    <div class="radio upsert-query-container pt-1">\n' +'      <label><input type="radio" name="$name$" class="form-check-input controller" $disabled$>' + 'Perform this query to select the UPSERT key:'+ '&nbsp;</label>\n' +'      <div style="display: inline-block;"><input type="text" class="form-control upsert-query-input" style="width: auto; display: inline-block; min-width: 300px;" disabled></div>\n' +'    </div>\n' +'  </td>\n' +'</tr>';var CONST_ROW_LOOKUP = '<tr class="lookup-settings-container" style="display: none">\n' +'  <td colspan="2"></td>\n' +'  <td colspan="4">\n' +'    <div class="radio">\n' +'      <span>' + 'LOOKUP by'+ ':&nbsp;</span>\n' +'      <div style="display: inline-block;">\n' +'        <select class="form-control form-select lookup-select" style="width: auto; display: inline-block; min-width: 300px;"></select>\n' +'      </div>\n' +'      <div style="display: inline-block; margin-top: 5px">\n' +'        <input type="text" class="form-control lookup-query-input" style="width: auto; display: none; margin-left: 76px; min-width: 360px;">\n' +'      </div>\n' +'    </div>\n' +'    <div class="checkbox">\n' +'      <label style="margin-top: 5px;"><input type="checkbox" class="form-check-input use-first-result-cb">' + 'Use first result if multiple matches'+ '</label>\n' +'    </div>\n' +'    <div class="checkbox insert-null-value-container">\n' +'      <label style="margin-top: 5px;"><input type="checkbox" class="form-check-input insert-null-value-cb">' + 'Insert null value(s) if no match is found'+ '</label>\n' +'    </div>\n' +'    <div class="checkbox insert-query-container" style="display: none">\n' +'      <label style="margin-right:15px; margin-top:10px;"><input type="checkbox" class="form-check-input insert-query-cb">' + 'Insert new record if no matches'+ '</label>\n' +'      <div style="display: inline-block;"><input type="text" class="form-control insert-query" style="width: auto; display: inline-block; min-width: 300px;" disabled></div>\n' +'    </div>\n' +'  </td>\n' +'</tr>'} else {var _builderContainer = _right.find(".mapping-editor-builder");var _refColumns = _right.find(".mapping-editor-ref-columns");var _orderByColumn = _right.find(".order-by-column");var _orderByRule = _right.find(".order-by-rule");var _customQueryCheckbox = _right.find(".mapping-editor-customquery");var _sqlText = _right.find(".sql-text");var _advanced = _container.find(".mapping-editor-advanced");var _processChangesOnlyContainer = _advanced.find(".processchangesonly-container");var _timeCheckColumnCheckbox = _processChangesOnlyContainer.find(".mapping-editor-processchangesonly");var _timeCheckColumn = _processChangesOnlyContainer.find(".mapping-editor-processchangesonly-settings." + (_processChangesOnlyContainer.hasClass("automatic") ? "automatic" : "manually") + ">select");var _updateValueCheckbox = _advanced.find(".mapping-editor-updatevalue");var _updateValueColumn = _advanced.find(".mapping-editor-updatevalue-settings>select");var _updateValueValue = _advanced.find(".mapping-editor-updatevalue-settings>input");var CONST_IDENTIFIER_QUOTE = "`";var CONST_ESCAPE_SPACE = '___x32___';var CONST_ESCAPE_QUOTE = '___x60___';var CONST_ESCAPE_SHARP = '___x35___';var CONST_ESCAPE_LEFT_BRACE = '___x123___';var CONST_ESCAPE_RIGHT_BRACE = '___x125___';var CONST_ESCAPE_LEFT_BRACK = '___x40___';var CONST_ESCAPE_RIGHT_BRACK = '___x41___';var CONST_ESCAPE_QUOTE_PATTERN = /\\`/g;var CONST_IDENTIFIER_PATTERN = /`[^`]+`/g;var CONST_IDENTIFIER_QUOTED_PATTERN = /^`[^`]+?`$/;var CONST_LITERAL_TOKEN_PATTERN = /^`?([a-z_][a-z0-9_]{0,}(\:(number|float|string|date|boolean))?)`?$/i;var CONST_LITERAL_TOKEN_STX = '___x02___';var CONST_LITERAL_TOKEN_ETX = '___x03___';var CONST_EMPTY_FILTER_ITEM = {id: "-1", label: '------'};var CONST_COLUMN_TYPE_MAPPING = {"date": "date","time": "time","fmtime": "time","timespan": "time","datetime": "datetime","timestamp": "datetime","boolean": "boolean","bool": "boolean","bit": "boolean","tinyint": "integer","smallint": "integer","mediumint": "integer","integer": "integer","int": "integer","bigint": "integer","float": "double","double": "double","decimal": "double","numeric": "double","real": "double"};var CONST_NEGATIVE_OPERATION_MAP = {"not_begins_with": "begins_with","not_contains": "contains","not_ends_with": "ends_with",}}
var _addTableModal = new rsb.addTableModal({addTable: function (tableName, alias, innerTables, supportUpsert, hasTimeCheckColumns, args) {_addChildTable(tableName, {"alias": alias || "","innerTables": innerTables || "","supportUpsert": supportUpsert,"hasTimeCheckColumns": hasTimeCheckColumns})}});var _previewModal = new rsb.previewModal($.extend({previewTitle: rsb.trimStr(_previewBtn.text())}, _options));var _codeEditor = CodeMirror.fromTextArea(_right.find(".code-content")[0], {mode: "text/xml",theme: "xml",lineNumbers: true,textWrapping: false,indentUnit: 4,autoRefresh: true});this.edit = function (name, args) {_templateName = name;_args = $.extend(_args, args);_initializing = !!_templateName;_changed = false;_reset();if (!!_templateName) {_options.getSchemaInfo(_templateName, null, _args, function ($errorMsg, $structute, $content, $editable, $result) {_initializing = false;_changed = false;var _toCodeView = function () {_initializing = true;_codeBtn.click();_setCode($content);_previewBtn.show();_designBtn.prop("invalid", true);_initializing = false;_changed = false}
if ($errorMsg) {rsb.showResult(_resultContainer, "Failure! " + $errorMsg, false);_toCodeView();return false} else if ($editable && $structute && !!$structute.table) {_structute = $structute;_templateName = _templateName || _structute.name;_initializing = true;_mappingTree.off("shown").one("shown", function () {_initializing = false;_changed = false}).off("error").one("error", function () {_toCodeView()});_structute.columns.some(col => rsb.getValueAsBool(col.timeCheck, false)) && _updateProps({supportReplicate: false});_addTables(_structute);_previewBtn.show()} else if (!!$content) {!!$result && $result.result == "warning" && rsb.showResult(_resultContainer, $result.message, "warning");_toCodeView()}})}}
this.save = function () {_options.saveMapping(_templateName, _getMappingData(), _args, function (result) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(_resultContainer, errorMsg, false)} else {!!_args.savedCallback && _args.savedCallback();_codeEditor.clearHistory();_changed = false}})}
this.changed = function () {return !_initializing && (_changed || _right.hasClass("code") && _codeEditor.historySize().undo > 0)}
this.addChildTable = function (tableName, options) {if (!_right.hasClass("code")) {_addChildTable(tableName, options)}}
this.updateProps = function ($props) {_updateProps($props)}
var _updateProps = function ($props) {if (!!$props && $props.supportReplicate != null && _processChangesOnlyContainer.hasClass("changeable")) {var $automatic = !!$props.supportReplicate;if (!!$automatic != _processChangesOnlyContainer.hasClass("automatic")) {_processChangesOnlyContainer.toggleClass("automatic");_timeCheckColumn = _processChangesOnlyContainer.find(".mapping-editor-processchangesonly-settings." + (!!$automatic ? "automatic" : "manually") + ">select")}}}
var _reset = function () {_structute = {};_structuteMap = {};_structuteMap.maxId = 0;_mappingTree.find("li").each(_removeTableNode);_mappingTree.empty();!_isInput && _advanced.hide();_previewBtn.hide();_codeBtn.show();_designBtn.hide().prop("invalid", false)}
var _getMappingData = function () {if (_right.hasClass("code")) {return _codeEditor.getValue()} else {var $activeNode = _mappingTree.find("li.active");$activeNode && $activeNode.length && _persistTableStructure($activeNode);return _options.generate(_structute, _args)}}
var _persistTableStructure = function ($node) {var $timeCheckColumn = null;var $updateValueColumn = null;$node = $node || _mappingTree.find("li.active");var $backupStructure = {};var $structure = _structuteMap[$node.data("id")] || {};for (var $key in $structure) {$backupStructure[$key] = $structure[$key];delete $structure[$key]}
$.extend($structure, {table: _getTableName($node),alias: $node.children("div").children("span.table-alias").text(),action: $backupStructure.action,innerTables: $node.prop("innerTables"),supportUpsert: $node.prop("supportUpsert"),hasTimeCheckColumns: $node.prop("hasTimeCheckColumns")});if (!!$structure.innerTables && _columnsTable.find("tr.table>td.column-checkbox>input").length != _columnsTable.find("tr.table>td.column-checkbox>input:checked").length) {var $excludedInnerTables = [];_columnsTable.find("tr.table>td.column-checkbox>input").each(function () {if (!$(this).prop("checked")) {$excludedInnerTables.push(rsb.trimStr($(this).parent().siblings('td.column-name').text()))}});$structure.excludedInnerTables = $excludedInnerTables.join()}
var $isRoot = $node.parent().is(_mappingTree);if (!_isInput && !!_options.isFilterable($structure.table)) {$structure.query = rsb.trimStr(_sqlText.val());$structure.custom = _customQueryCheckbox.prop("checked");if ($isRoot) {$structure.processChangesOnly = _timeCheckColumnCheckbox.prop("checked") && (_processChangesOnlyContainer.hasClass("automatic") || _timeCheckColumn.val());$timeCheckColumn = $structure.processChangesOnly && !_processChangesOnlyContainer.hasClass("automatic") ? _timeCheckColumn.val() : null;$updateValueColumn = _updateValueCheckbox.prop("checked") && _updateValueValue.val() ? _updateValueColumn.val() : null;if (!$structure.custom && !!$updateValueColumn && !_orderByColumn.val() && !_builderContainer.queryBuilder('getRules').rules.length) {delete $structure.query}}} else if (!_isInput && $backupStructure && !!$backupStructure.query) {$structure.query = $backupStructure.query}
$structure.allColumns = !_isInput && _customQueryCheckbox.prop("checked") || _columnsTable.find(".column-checkbox input:checked").length == 0 ? "true" : null;$structure.columns = _getSelectedColumns(_isInput || !$structure.allColumns, _isInput || !!$timeCheckColumn || $updateValueColumn ? function ($row, $col) {if (_isInput) {if ($row.find("td.column-name .btn-toggle.active").length) {var $extend = $row.next();if ($extend.hasClass("upsert-settings-container")) {if ($extend.find(".upsert-container input.controller").prop("checked")) {if ($col.name != $extend.find("select.upsert-select").val()) {$col.upsert = $extend.find("select.upsert-select").val()}} else {$structure.upsertQuery = rsb.trimStr($extend.find("input.upsert-query-input").val())}} else if ($extend.hasClass("lookup-settings-container")) {$col.lookup = $extend.find("select.lookup-select").val();if (!$col.lookup) {$col.lookupquery = rsb.trimStr($extend.find(".lookup-query-input").val());if ($extend.find(".insert-query-cb").prop("checked")) {$col.insertquery = rsb.trimStr($extend.find(".insert-query").val())}} else {$col.insertnullvalue = $extend.find(".insert-null-value-cb").prop("checked")}
$col.usefirstresult = $extend.find(".use-first-result-cb").prop("checked")}}} else if ($timeCheckColumn && $timeCheckColumn == $col.name) {$col.timeCheck = "true"} else if ($updateValueColumn && $updateValueColumn == $col.name) {$col.updateValue = _updateValueValue.val()}} : null);var $children = $backupStructure.children;if ($children && $children.length) {$structure.children = $children}
_structuteMap[$node.data("id")] = $structure;if ($isRoot) {_structute = $structure} else {_structuteMap[$node.parent().parent().data("id")].children[$node.prevAll("li").length] = $structure}}
var _addTables = function ($structure, $parentNode, $addOnly, $addCallback, $shownCallback) {$parentNode = $parentNode || _mappingTree.find("li.active");if ($parentNode && $parentNode.length) {if ($parentNode.children("ul").length <= 0) {$parentNode.append("<ul></ul>")}
$parentNode = $parentNode.children("ul")} else {$parentNode = _mappingTree}
var $nodeId = ++_structuteMap.maxId;_structuteMap[$nodeId] = $structure;let removable = _options.disabled ? false : _options.isRemovable($structure.table);var $tableNode = $("<li data-id='" + $nodeId + "' data-table='" + rsb.htmlEncode($structure.table) + "' class='nowrap pointercursor'><div><i class='fa fa-table'></i>&nbsp;<span class='table-alias'>" + rsb.htmlEncode($structure.alias || $structure.table) + "</span>" + (removable ? "&nbsp;<i class='fa fa-remove hover-opacity'></i>" : "") + "</div></li>");$tableNode.prop("innerTables", $structure.innerTables || "");$tableNode.prop("supportUpsert", $structure.supportUpsert);$tableNode.prop("hasTimeCheckColumns", $structure.hasTimeCheckColumns);$tableNode.on("click", function (e) {rsb.stopPropagation(e);if (!$(this).hasClass("active")) {var $activeNode = _mappingTree.find("li.active").removeClass("active");$activeNode && $activeNode.length && !$activeNode.hasClass("initialize") && _persistTableStructure($activeNode);$(this).addClass("active");_initTableEditor(_structuteMap[$nodeId], $parentNode == _mappingTree)}});$tableNode.on("click", "i.fa-remove", function (e) {rsb.stopPropagation(e);var $confirmText = 'Are you sure you want to delete the table [$table$]?';$structure = _structuteMap[$nodeId];if ($structure.children && $structure.children.length) {$confirmText = 'Are you sure you want to delete the table [$table$] and children?'}
const deleteCallback = () => {rsb.deleteConfirmModal.hide();_changed = true;if ($parentNode == _mappingTree) {_reset();_initTableEditor({}, true)} else {var parentStructure = _structuteMap[$parentNode.parent().data("id")];if (parentStructure && parentStructure.children) {parentStructure.children.splice($tableNode.prevAll("li").length, 1);if (parentStructure.children.length <= 0) {delete parentStructure.children}}
$tableNode.find("li").add($tableNode).each(_removeTableNode);if (_mappingTree.find("li.active").length <= 0) {$parentNode.parent().click()}}};rsb.connect.loadModal("deleteConfirmModal.rst", () => rsb.deleteConfirmModal.show('Delete Table', rsb.evalTemplate($confirmText, {"table": $structure.table}), deleteCallback))});if ($structure.children && $structure.children.length) {rsb.forEach($structure.children, function ($subStructure) {_addTables($subStructure, $tableNode, true)})}
$parentNode.append($tableNode);!!$addCallback && $addCallback();!$addOnly && !!$shownCallback && $tableNode.one("shown", function () {$shownCallback($tableNode, $nodeId)});!$addOnly && $parentNode.children("li:last").click();_previewBtn.show();_codeBtn.show();return $parentNode == _mappingTree ? null : $parentNode.parent()}
var _this = this;var _addChildTable = function (tableName, options) {if (!!tableName) {_changed = true;var $structure = $.extend(options, {table: tableName});var $parentNode = _mappingTree.find("li.active");_addTables($structure, null, false, function () {if ($parentNode && $parentNode.length) {var $parentStructure = _structuteMap[$parentNode.data("id")];if ($parentStructure && $parentStructure.children) {$parentStructure.children.push($structure)} else if ($parentStructure) {$parentStructure.children = [$structure]}
!_isInput && _advanced.hide()} else {_structute = $structure}}, !!_options.tableAddedCallback ? function ($tableNode, $nodeId) {_options.tableAddedCallback(_getTableName($tableNode), _structuteMap[$nodeId], _this)} : null)}}
var _removeTableNode = function () {$(this).off("click").off("click", "i.fa-remove").removeClass("active").remove();delete _structuteMap[$(this).data("id")]}
var _initTableEditor = function ($structure, $root) {var $changed = _changed;if (!_isInput) {_orderByColumn.val("");_refColumns.find(".dropdown-menu").html("");_customQueryCheckbox.prop("checked", false).change();_sqlText.val("");_advanced.hide();_timeCheckColumnCheckbox.prop("checked", false).change();_updateValueCheckbox.prop("checked", false).change()}
var $activeNode = _mappingTree.find("li.active");_initColumns($structure, function ($cols, $success) {if (!$activeNode.hasClass("active")) return false;if (!$success) {$activeNode = null;_mappingTree.trigger("error")} else if (!_isInput) {_initQueryPanel($structure, $cols, $root)} else {_initUpsertPanel($structure, $cols, $root)}
_disableValidation();$activeNode && $activeNode.trigger("shown");_changed = $changed})}
var _listColumns = function ($tablename, $args, $callback) {_right.removeClass("loading");_loadingStatus.css("padding", Math.max(_columnsPanel.height() / 2 - 9, 50) + "px 0px");_right.addClass("loading");_options.listColumns($tablename, $args, function ($result, $tempName) {$callback && $callback($result, $tempName);_right.removeClass("loading");_adjustViewpoint()})}
var _initColumns = function ($structure, $callback) {const $node = _mappingTree.find("li.active").removeClass("initialize");(!$structure.table || _mappingTree.find("li.initialize").length > 0) && (_columnsTable.off("click", "td,tr,input").empty(), _allColumnsCb.prop("checked", false));$structure.table && $node.addClass("initialize");$structure.table && _listColumns($structure.table || _templateName, _args, function (result, tempName) {$node.removeClass("initialize");if (!$node.hasClass("active")) return false;_columnsTable.off("click", "td,tr,input").empty();var cols = null;var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(_resultContainer, errorMsg, false)} else {cols = _unionColumns($structure.columns, result);if (cols && cols.length > 0) {const disabledAttr = _options.disabled ? " disabled" : "";for (var i = 0; i < cols.length; i++) {var $row = $("<tr class='column'><td class='column-checkbox'><input type='checkbox' class='form-check-input'" + cols[i].checked + disabledAttr + "></td><td class='column-key'><span class='hidden'>" + cols[i].iskey + "</span>" + (cols[i].iskey.toLowerCase() == "true" ? "<i class='fa fa-solid fa-key-skeleton'></i>" : "") + "</td><td class='column-name'><span data-bs-toggle='popover' data-bs-placement='top' data-bs-trigger='manual' data-bs-content='" + rsb.htmlEncode(cols[i].aggregatetable || cols[i].alias || cols[i].name) + "'>" + rsb.htmlEncode(cols[i].aggregatetable || cols[i].alias || cols[i].name) + "</span>" + "</td><td class='column-direction'>" + cols[i].direction + "</td><td class='column-alias'>" + rsb.htmlEncode(cols[i].alias) + "</td><td class='column-datatype'>" + cols[i].datatype + "</td><td class='column-size'>" + cols[i].columnsize + "</td><td class='column-nullable'>" + cols[i].isnullable + "</td><td class='column-description'>" + rsb.htmlEncode(cols[i].description) + "</td><td class='column-internalcolumnname'>" + rsb.htmlEncode(cols[i].internalcolumnname) + "</td><td class='column-autoincrement'>" + cols[i].autoincrement + "</td><td class='column-readonly'>" + cols[i].isreadonly + "</td><td class='column-search'>" + cols[i].search + "</td><td class='column-id'>" + cols[i].id + "</td><td class='column-ref'>" + cols[i].ref + "</td><td class='column-istimecheckcolumn'>" + cols[i].istimecheckcolumn + "</td><td class='column-foreignkey'>" + cols[i].foreignkey + "</td><td class='column-internaltype'>" + cols[i].internaltype + "</td></tr>");if (!!cols[i].aggregatetable || (cols[i].datatype || "").toLowerCase() == "json" || (cols[i].internaltype || "").toLowerCase().startsWith("aggregate")) {!!cols[i].aggregatetable && $row.find("td.column-name").data("column", cols[i].name);$(CONST_COLUMN_AGGREGATE_TABLE_POPOVER).appendTo($row.find("td.column-key")).popover()}
if (!cols[i].aggregatetable && !!cols[i].alias && cols[i].alias != cols[i].name) {$row.find("td.column-alias").data("column", cols[i].name)}
_columnsTable.append($row)}
var $excludedInnerTables = [];!!$structure.innerTables && rsb.forEach(($structure.excludedInnerTables || "").split(","), function (table, index) {table = rsb.trimStr(table);if (!!table) {$excludedInnerTables.push(table)}});!!$structure.innerTables && rsb.forEach($structure.innerTables.split(","), function (table) {table = rsb.trimStr(table);if (!!table) {var $row = $("<tr class='table'><td class='column-checkbox'><input type='checkbox' class='form-check-input'" + ($excludedInnerTables.length <= 0 || $excludedInnerTables.indexOf(table) < 0 ? " checked" : "") + "></td><td class='column-key'><span class='hidden'>false</span>" + CONST_COLUMN_AGGREGATE_TABLE_POPOVER + "</td><td class='column-name' data-column='" + rsb.htmlEncode(table) + "'>" + rsb.htmlEncode(table) + "</td><td class='column-direction'></td><td class='column-alias'></td><td class='column-datatype'>TABLE</td><td class='column-size'></td><td class='column-nullable'></td><td class='column-description'></td><td class='column-internalcolumnname'></td><td class='column-autoincrement'></td><td class='column-readonly'></td><td class='column-search'></td><td class='column-id'></td><td class='column-ref'></td><td class='column-istimecheckcolumn'></td><td class='column-foreignkey'></td><td class='column-internaltype'></td></tr>");$row.find("td.column-key>span").popover();_columnsTable.append($row)}});_columnsTable.find("tr").click(_toggleColumnSelected);_columnsTable.find("tr>td.column-checkbox>input").click(_columnSelectedChanged);_adjustVisibleColumns();if ((!$structure.columns || cols.length <= $structure.columns.length)) {_allColumnsCb.prop("checked", true)} else {_allColumnsCb.prop("checked", false)}
var $columnsBody = _columnsPanel.find(".panel-body");$columnsBody.length && $columnsBody.prev(".panel-heading").css("padding-right", $columnsBody[0].scrollHeight > $columnsBody[0].clientHeight ? "17px" : "0px")}}
$callback && $callback(cols, !errorMsg)})}
var _unionColumns = function (columns, result) {var colIndexes = {};var cols = [];if (columns) {for (var i = 0; i < columns.length; i++) {if (colIndexes["COLUMN_" + columns[i].name] >= 0) continue;colIndexes["COLUMN_" + columns[i].name] = cols.length;var columnSize = columns[i].columnsize || "";var isNullAble = columns[i].isnullable ? columns[i].isnullable.toLowerCase() : "";var isReadOnly = columns[i].isreadonly ? columns[i].isreadonly.toLowerCase() : "";var $col = $.extend($.extend({}, columns[i]), {name: columns[i].name,direction: (columns[i].direction || ""),alias: (columns[i].alias || ""),datatype: (columns[i].datatype || ""),columnsize: columnSize,iskey: columns[i].iskey.toLowerCase(),isnullable: isNullAble,description: columns[i].description || "",checked: "checked",internalcolumnname: (columns[i].internalcolumnname || ""),autoincrement: (columns[i].autoincrement || columns[i].isautoincrement || ""),isreadonly: isReadOnly,search: (columns[i].search || ""),id: (columns[i].id || ""),ref: (columns[i].ref || ""),istimecheckcolumn: (columns[i].istimecheckcolumn || "").toLowerCase(),internaltype: (columns[i].internaltype || ""),foreignkey: (columns[i].foreignkey || "")});$col.defined = false;cols.push($col)}}
var tmpChecked = columns ? "" : " checked";for (var i = 0; i < result.length; i++) {var index = colIndexes["COLUMN_" + result[i].columnname];if (index >= 0) {var col = cols[index];col.defined = true;col.istimecheckcolumn = result[i].istimecheckcolumn || "false";col.internaltype = result[i].internaltype || col.internaltype || "";col.foreignkey = result[i].foreignkey || "";col.direction = result[i].direction || "";col.autoincrement = result[i].isautoincrement || col.autoincrement;col.ref = result[i].ref || col.ref;col.aggregatetable = result[i].aggregatetable || col.aggregatetable;if (!col.alias) {col.alias = result[i].columnalias || ""}
if (!col.columnsize) {col.columnsize = result[i].columnsize || ""}
if (!col.isnullable) {col.isnullable = result[i].isnullable || ""}
if (!col.isreadonly) {col.isreadonly = result[i].isreadonly || ""}} else {colIndexes["COLUMN_" + result[i].columnname] = cols.length;var columnSize = result[i].columnsize || "";var isNullAble = result[i].isnullable ? result[i].isnullable.toLowerCase() : "";var isReadOnly = result[i].isreadonly ? result[i].isreadonly.toLowerCase() : "";cols.push({defined: true,name: result[i].columnname,direction: (result[i].direction || ""),alias: (result[i].columnalias || ""),datatype: result[i].datatype,columnsize: columnSize,iskey: result[i].iskey.toLowerCase(),isnullable: isNullAble,description: result[i].description || "",checked: tmpChecked,internalcolumnname: (result[i].internalcolumnname || ""),autoincrement: (result[i].isautoincrement || ""),isreadonly: isReadOnly,search: (result[i].search || ""),id: (result[i].id || ""),ref: (result[i].ref || ""),istimecheckcolumn: (result[i].istimecheckcolumn || "false"),internaltype: (result[i].internaltype || ""),foreignkey: (result[i].foreignkey || ""),aggregatetable: result[i].aggregatetable})}}
cols.sort(function (lhs, rhs) {if (lhs.direction != rhs.direction) {lhs.direction = lhs.direction.toUpperCase();if (lhs.direction == "IN" || lhs.direction == "INPUT") {return -1}
if (lhs.direction == "OUT" || lhs.direction == "OUTPUT") {return 1}
rhs.direction = rhs.direction.toUpperCase();return rhs.direction == "IN" || rhs.direction == "INPUT" ? 1 : -1}
if (lhs.iskey != rhs.iskey) {return lhs.iskey == "true" ? -1 : 1}
return lhs.name.toLowerCase() <= rhs.name.toLowerCase() ? -1 : 1});return cols}
var _getSelectedColumns = function ($onlySelected, $callback) {var $cols = [];_columnsTable.find("tr.column>td.column-checkbox>input" + ($onlySelected ? ":checked" : "")).each(function () {var $col = {};var $columns = $(this).parent().nextAll('td');$col.iskey = $col.key = rsb.trimStr($($columns[0]).text());$col.name = $($columns[1]).children("span.span-toggle").text() || $($columns[1]).text();if (!!$($columns[1]).data("column")) {$col.aggregatetable = $col.name;$col.name = $($columns[1]).data("column")} else {$col.name = $($columns[3]).data("column") || $col.name}
$col.direction = rsb.trimStr($($columns[2]).text());$col.alias = rsb.trimStr($($columns[3]).text());$col.datatype = $col.type = rsb.trimStr($($columns[4]).text());$col.size = rsb.trimStr($($columns[5]).text());$col.isnullable = rsb.trimStr($($columns[6]).text());$col.description = rsb.trimStr($($columns[7]).text());$col.internalcolumnname = rsb.trimStr($($columns[8]).text());$col.autoincrement = rsb.trimStr($($columns[9]).text());$col.isreadonly = rsb.trimStr($($columns[10]).text());$col.search = rsb.trimStr($($columns[11]).text());$col.id = rsb.trimStr($($columns[12]).text());$col.ref = rsb.trimStr($($columns[13]).text());$col.istimecheckcolumn = $col.datatype && $col.datatype.toLowerCase() == "datetime" ? "true" : "false";$col.foreignkey = rsb.trimStr($($columns[15]).text());$col.internaltype = rsb.trimStr($($columns[16]).text());$callback && $callback($(this).parent().parent(), $col);$cols.push($col)});return $cols}
var _adjustVisibleColumns = function () {rsb.forEach(["direction", "alias", "datatype", "size", "key", "nullable", "description", "internalcolumnname", "autoincrement", "readonly", "search", "id", "ref", "istimecheckcolumn", "foreignkey", "internaltype"], function (c) {if ($.inArray(c, _options.visibleColumns) >= 0) {_columnsPanel.find(".column-" + c).removeClass("hidden")} else {_columnsPanel.find(".column-" + c).addClass("hidden")}});_adjustViewpoint()}
var _adjustViewpoint = function () {var $panelBody = _columnsPanel.find(".panel-body");_columnsPanel.find(".panel-heading").css("padding-right", $panelBody[0].scrollHeight > $panelBody[0].clientHeight ? "17px" : "0px")}
var _disableValidation = function () {_container.find("input,textarea,select,button,option").addClass("rsb-form-nosubmit")}
var _toggleColumnSelected = function (e) {var $cb = $(this).find('td.column-checkbox>input');$cb.click();_updateColumnSelect($cb)}
var _columnSelectedChanged = function (e) {rsb.stopPropagation(e);_updateColumnSelect($(this))}
var _updateColumnSelect = function ($cb) {var isColumn = $cb.closest("tr").hasClass("column");if (isColumn && $cb.prop("checked")) {if (_columnsTable.find("tr.column>td.column-checkbox>input:checked").length == _columnsTable.find("tr.column>td.column-checkbox>input").length) {_allColumnsCb.prop("checked", true)}} else if (isColumn) {_allColumnsCb.prop("checked", false)}
!_isInput && isColumn && _updateQuery();_changed = true}
var _getTableName = function ($node) {return ($node || _mappingTree.find("li.active")).data("table")}
var _setCode = function ($code) {_codeEditor.setValue($code || "");_codeEditor.refresh();_codeEditor.clearHistory()}
if (_isInput) {var _initUpsertPanel = function ($structure, $cols, $root) {var $keys = [];var $upsertOptions = "";var $parents = _mappingTree.find("li.active").parentsUntil(_mappingTree, 'li');var $columnMap = {};$structure.columns && rsb.forEach($structure.columns, function ($col) {$columnMap["_INDEX_" + $col.name] = $col});_getSelectedColumns(false, function ($row, $col) {$upsertOptions += '<option value="' + rsb.htmlEncode($col.name) + '">' + rsb.htmlEncode($col.name) + '</option>';if ($columnMap["_INDEX_" + $col.name]) {$col = $.extend($col, $columnMap["_INDEX_" + $col.name])}
if (!!$col.foreignkey) {var $resolveQualifiedTablename = function ($tableName) {try {return SQLParser.parse('SELECT * FROM ' + $tableName).source.name.values.pop() || $tableName} catch {return $tableName}}
var $parentTable = $resolveQualifiedTablename($col.foreignkey.substring(0, $col.foreignkey.indexOf(".")));$parents.each(function () {if ($resolveQualifiedTablename(_getTableName($(this))) == $parentTable) {$parentTable = null}
return !!$parentTable});if (!$parentTable) {$col.ref = "@" + $col.foreignkey.substring($col.foreignkey.indexOf(".") + 1);$row.find("td.column-ref").text($col.ref);$row.find("td.column-name").html(rsb.evalTemplate(CONST_COLUMN_AUTO_REF, {column: rsb.htmlEncode($col.name),foreignKey: rsb.htmlEncode($col.foreignkey)}));$row.find("td.column-name span.badge").popover();return true}}
if (($col.iskey || "").toLowerCase() == "true") {$keys.push([$row, $col]);return true}
if (!!$col.foreignkey || !!$col.lookupquery) {_initColumnLookup($structure, $row, $col, $parents)}});if ($keys.length > 0) {rsb.forEach($keys, function ($key) {if (!!$key[1].foreignkey || !!$key[1].lookupquery) {_initColumnLookup($structure, $key[0], $key[1], $parents)} else if ($keys.length == 1 && _options.supportUpsert($structure.table, rsb.getValueAsBool($structure.supportUpsert, true))) {_initColumnUpsert($structure, $key[0], $key[1], $upsertOptions)}})}}
var _initColumnUpsert = function ($structure, $row, $col, $upsertOptions) {$row.off("click");$row.find("td.column-name").html(rsb.evalTemplate(CONST_COLUMN_TOGGLE, {type: 'UPSERT',column: rsb.htmlEncode($col.name),disabled: _options.disabled ? "disabled" : ""}));var $upsertSettings = $(rsb.evalTemplate(CONST_ROW_UPSERT, {id: "upsertcontroller_" + Date.now(), disabled: _options.disabled ? "disabled" : ""}));$row.after($upsertSettings);$upsertSettings.off("mouseenter").off("mouseleave").on("mouseenter", function () {$row.css({"background-color": "#f5f5f5"})}).on("mouseleave", function () {$row.css({"background-color": "#fff"})});$row.find("td.column-name button.btn-toggle").off("click").on("click", function () {$upsertSettings.toggle();if ($(this).hasClass("active")) {$structure.action = "upsert"} else {delete $col.upsert;$structure.action = "insert"}
_updateUpsertSection($structure, $upsertSettings, $col);_checkInputPreview();return false});$upsertSettings.find("input.controller").off("click").on("click", function () {_updateUpsertSection($structure, $upsertSettings, $col)});$upsertSettings.find("select.upsert-select").html($upsertOptions).off("change").on("change", function () {var $name = $(this).val();if ($name == $col.name) {$structure.action = "upsert";delete $col.upsert} else {$col.upsert = $name}
_changed = true});$upsertSettings.find("input.upsert-query-input").off("change").on("change", function () {$structure.upsertQuery = rsb.trimStr($(this).val());if (!!$structure.upsertQuery) {_previewBtn.hide()} else {_checkInputPreview()}
_changed = true});if (($structure.action || "upsert").toLowerCase() == 'upsert') {if ($structure.upsertQuery && rsb.trimStr($structure.upsertQuery)) {$upsertSettings.find('.upsert-query-container input.controller').prop("checked", true);$upsertSettings.find('input.upsert-query-input').val($structure.upsertQuery)} else if (!!$col.upsert) {$upsertSettings.find('select.upsert-select').val(rsb.htmlEncode($col.upsert || $col.name))}
$row.find("td.column-name button.btn-toggle").addClass("active").click()}}
var _initColumnLookup = function ($structure, $row, $col, $parents) {$row.off("click");$row.find("td.column-name").html(rsb.evalTemplate(CONST_COLUMN_TOGGLE, {type: 'LOOKUP',column: rsb.htmlEncode($col.name),disabled: ""}));var $lookupSettings = $(CONST_ROW_LOOKUP);$row.after($lookupSettings);$lookupSettings.off("mouseenter").off("mouseleave").on("mouseenter", function () {$row.css({"background-color": "#f5f5f5"})}).on("mouseleave", function () {$row.css({"background-color": "#fff"})});$row.find("td.column-name button.btn-toggle").off("click").on("click", function () {$lookupSettings.toggle();_checkInputPreview();_changed = true;return false});var $lookupQueryInput = $lookupSettings.find(".lookup-query-input");$lookupSettings.find("select.lookup-select").off("change").on("change", function () {var $lookup = rsb.trimStr($(this).val());if (!$lookup) {$lookupQueryInput.show();$lookupSettings.find(".insert-null-value-container").hide();$lookupSettings.find(".insert-query-container").show()} else {$lookupQueryInput.hide();$lookupSettings.find(".insert-null-value-container").show();$lookupSettings.find(".insert-query-container").hide();_checkInputPreview()}
_changed = true});$lookupQueryInput.off("change").on("change", function () {if (!!rsb.trimStr($(this).val())) {_previewBtn.hide()} else {_checkInputPreview()}
_changed = true});$lookupSettings.find(".use-first-result-cb,.insert-null-value-cb").off("change").on("change", function () {_changed = true});$lookupSettings.find(".insert-query-cb").off("change").on("change", function () {var $insertQuery = $lookupSettings.find(".insert-query");if ($(this).prop("checked")) {$insertQuery.prop("disabled", "")} else {$insertQuery.val("").prop("disabled", "disabled")}
_changed = true});var $select = $lookupSettings.find('select.lookup-select');$select.empty();if (!!$col.foreignkey) {_listColumns($col.foreignkey.substring(0, $col.foreignkey.indexOf(".")), _args, function (result, tempName) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(_resultContainer, errorMsg, false)} else {var $found = false;$select.empty();rsb.forEach(result, function ($column, index) {var $value = $col.foreignkey + "." + $column.columnname + "@" + $column.datatype;$found = $found || $col.lookup == $value;$select.append(new Option($column.columnname, $value))});if (!!$col.lookup) {!$found && $select.append(new Option($col.lookup.substring($col.lookup.lastIndexOf(".") + 1, $col.lookup.lastIndexOf("@")), $col.lookup));$select.val($col.lookup).change()}}})}
if (!!$col.lookupquery) {$lookupQueryInput.val($col.lookupquery);$select.append(new Option('<Custom Query>', "")).val("").change()}
if (!!$col.lookup || !!$col.lookupquery) {$row.find("td.column-name button.btn-toggle").addClass("active").click();$col.usefirstresult && $lookupSettings.find(".use-first-result-cb").prop('checked', true);$col.insertnullvalue && $lookupSettings.find(".insert-null-value-cb").prop('checked', true);$col.insertquery && ($lookupSettings.find(".insert-query").val($col.insertquery), $lookupSettings.find(".insert-query-cb").prop('checked', true).change())}}
var _updateUpsertSection = function ($structure, $upsertSettings, $col) {var $upsertContainer = $upsertSettings.find(".upsert-container");if ($upsertContainer.find("input.controller").prop("checked")) {if (!_options.disabled) {$upsertContainer.find("select.upsert-select").prop("disabled", "")}} else {$col && delete $col.upsert;$upsertContainer.find("select.upsert-select").val("").prop("disabled", "disabled")}
var $upsertQueryContainer = $upsertSettings.find(".upsert-query-container");if ($upsertQueryContainer.find("input.controller").prop("checked")) {if (!_options.disabled) {$upsertQueryContainer.find('input.upsert-query-input').prop("disabled", "")}} else {delete $structure.upsertQuery;$upsertQueryContainer.find('input.upsert-query-input').val("").prop("disabled", "disabled")}
_changed = true}
var _canPreviewSample = function ($structure) {if (!!$structure.upsertQuery) {return false}
if ($structure.columns && $structure.columns.length > 0) {for (var index = 0; index < $structure.columns.length; index++) {if ($structure.columns[index].lookupQuery) {return false}}}
if ($structure.children && $structure.children.length > 0) {for (var index = 0; index < $structure.children.length; index++) {if (!_canPreviewSample($structure.children[index])) {return false}}}
return true}
var _checkInputPreview = function () {_persistTableStructure();if (_structute && _canPreviewSample(_structute)) {_previewBtn.show()} else {_previewBtn.hide()}}} else {var _escapeIdentifier = function (identifier) {if (CONST_LITERAL_TOKEN_PATTERN.test(identifier)) return identifier;let encoded = CONST_LITERAL_TOKEN_STX;const isQuoted = CONST_IDENTIFIER_QUOTED_PATTERN.test(identifier);identifier = isQuoted ? identifier.substring(1, identifier.length - 1) : identifier;for (let index = 0; index < identifier.length; index++) {encoded += identifier.charCodeAt(index).toString(16)}
encoded += CONST_LITERAL_TOKEN_ETX;return isQuoted ? _quoteIdentifier(encoded) : encoded}
var _quoteIdentifier = function (identifier) {if (CONST_IDENTIFIER_QUOTED_PATTERN.test(identifier)) return identifier;return CONST_IDENTIFIER_QUOTE + identifier.replace(/`/g, '\\`') + CONST_IDENTIFIER_QUOTE}
var _normalizeQuery = function ($columnIdMap, query, escape) {var newQuery = escape ? query.replace(CONST_ESCAPE_QUOTE_PATTERN, CONST_ESCAPE_QUOTE) : query;rsb.forEach(newQuery.match(CONST_IDENTIFIER_PATTERN), function (identifier, index) {var index = newQuery.indexOf(identifier);if (index >= 0) {var id = _escapeIdentifier(identifier);if ($columnIdMap[id]) {if (identifier != id) {do {newQuery = newQuery.replace(identifier, id)} while (newQuery.indexOf(identifier) >= 0)}} else if (identifier.toLowerCase().match(/(\s+|^`)(and|order|by)\s+/g)) {index += identifier.length - 1;newQuery = newQuery.substring(0, index) + _normalizeQuery($columnIdMap, newQuery.substring(index))}}});newQuery = newQuery.replace(/\${#(\w+)}/g, CONST_ESCAPE_SHARP + "$1" + CONST_ESCAPE_RIGHT_BRACE);newQuery = newQuery.replace(/\${(\w+)}/g, CONST_ESCAPE_LEFT_BRACE + "$1" + CONST_ESCAPE_RIGHT_BRACE);newQuery = newQuery.replace(/\((\w+)\)/g, CONST_ESCAPE_LEFT_BRACK + "$1" + CONST_ESCAPE_RIGHT_BRACK);return newQuery}
var _normalizeCondition = function ($condition) {return $.extend(Object.assign({}, $condition), {left: $condition.left && _normalizeCondition($condition.left),operation: $condition.operation && $condition.operation.toUpperCase(),right: $condition.right && _normalizeCondition($condition.right)})}
var _getQuotedTableName = function ($tableName) {$tableName = rsb.trimStr($tableName);if ($tableName && $tableName.length > 2) {var $quotePatterns = [["\"", "\""], ["[", "]"], ["`", "`"]];for (var index = 0; index < $quotePatterns.length; index++) {if ($tableName.startsWith($quotePatterns[index][0]) && $tableName.endsWith($quotePatterns[index][1])) {return $tableName}}}
return "`" + $tableName + "`"}
var _convertColumnType = function (type) {return CONST_COLUMN_TYPE_MAPPING[type] || "string"}
var _normalizeRule = function ($rules) {for (var index = 0; index < $rules.rules.length; index++) {var $rule = $rules.rules[index];if ($rule.rules) {$rules.rules[index] = _normalizeRule($rule)} else if ($rule.id) {$rule.id = _quoteIdentifier(_escapeIdentifier($rule.id));$rule.field = $rule.field;if (!$.isArray($rule.value)) {$rule.value = [$rule.value]}
if ($.isArray($rule.value)) {var $value = $rule.value;for (var vIndex = 0; vIndex < $value.length; vIndex++) {if (typeof ($value[vIndex]) === "string") {$value[vIndex] = $value[vIndex].replace(new RegExp(CONST_ESCAPE_SHARP, 'g'), "${#");$value[vIndex] = $value[vIndex].replace(new RegExp(CONST_ESCAPE_LEFT_BRACE, 'g'), "${");$value[vIndex] = $value[vIndex].replace(new RegExp(CONST_ESCAPE_RIGHT_BRACE, 'g'), "}");if ($value[vIndex].startsWith("${") && $value[vIndex].endsWith("}")) {$value[vIndex] = [[$value[vIndex]]]}}}
$rule.value = $value}
$rules.rules[index] = $rule}}
return $rules}
var _replaceNegativeOperators = function ($group) {for (var i = 0; i < $group.rules.length; i++) {var $rule = $group.rules[i];if ($rule.rules) {$group.rules[i] = _replaceNegativeOperators($rule)} else if ($rule.id && !!CONST_NEGATIVE_OPERATION_MAP[$rule.operator]) {$rule.operator = CONST_NEGATIVE_OPERATION_MAP[$rule.operator];$group.rules[i] = {"condition": "AND", "rules": [$rule], "not": true, "valid": true}} else if ($rule.id && $rule.operator == "between") {$group.rules[i] = {"condition": "AND","rules": [{"id": $rule.id, "field": $rule.field, "operator": "greater_or_equal", "value": $rule.value[0]},{"id": $rule.id, "field": $rule.field, "operator": "less_or_equal", "value": $rule.value[1]}]}} else if ($rule.id && $rule.operator == "not_between") {$group.rules[i] = {"condition": "AND","rules": [{"id": $rule.id, "field": $rule.field, "operator": "less", "value": $rule.value[0]},{"id": $rule.id, "field": $rule.field, "operator": "greater", "value": $rule.value[1]}]}}}
return $group}
var _parseQuery = function ($structure) {var $result = {query: $structure.query,normalizedQuery: $structure.query,custom: false};if (!!$structure.query) {$result.normalizedQuery = _normalizeQuery(_builderContainer.columnIdMap, $structure.query, true);try {const tableName = _getTableName();const index = $result.normalizedQuery.lastIndexOf(tableName);const query = index <= 0 ? $result.normalizedQuery : $result.normalizedQuery.substring(0, index) + "TEMP" + $result.normalizedQuery.substring(index + tableName.length);var $parser = SQLParser.parse(query);if ($parser.distinct || $parser.joins && $parser.joins.length || $parser.group || $parser.limit || $parser.unions && $parser.unions.length) {$result.custom = true} else if ($parser.source.alias?.length() > 0 || !$parser.source.name || !!$parser.source.name.nested || ![$structure.table, "TEMP", tableName].includes($parser.source.name.value)) {$result.custom = true}
if (!$parser.custom && !!$parser.fields) {$parser.fields.forEach(function ($field) {if ($result.custom || !$field || !!$field.star || !$field.field) return true;else if (!!$field.field.nested || !!$field.field.name || !$field.field.value) $result.custom = true;else $result.custom = !_builderContainer.columnIdMap[_quoteIdentifier($field.field.value)] && $structure.columns.find(column => column.name === $field.field.value) == null;return !$result.custom})}
if (!$result.custom && !!$parser.where) {try {var $rules = null;try {$rules = _builderContainer.queryBuilder('getRulesFromSQL', $result.normalizedQuery)} catch (e) {$rules = _builderContainer.queryBuilder('getRulesFromSQL', "SELECT * FROM TEMP " + $result.normalizedQuery.substring($result.normalizedQuery.indexOf("WHERE")))}
$rules = _normalizeRule($rules);$curRules = _builderContainer.queryBuilder('getRules');try {_builderContainer.queryBuilder('setRules', $rules);var $sql = _builderContainer.queryBuilder('getSQL');var $where = SQLParser.parse(_normalizeQuery(_builderContainer.columnIdMap, "SELECT * FROM TEMP WHERE " + $sql.sql, true)).where || {};if (JSON.stringify($parser.where) != JSON.stringify($where) && JSON.stringify(_normalizeCondition($parser.where)) != JSON.stringify(_normalizeCondition($where))) {$result.custom = true} else {$result.rules = _replaceNegativeOperators($rules)}} finally {$curRules && _builderContainer.queryBuilder('setRules', $curRules)}} catch (e) {$result.custom = true;console.log(rsb.evalTemplate('The query [$query$] can not be parse to rule.', {"query": $structure.query}))}}
if (!$result.custom && $parser.order && $parser.order.orderings && $parser.order.orderings.length) {$result.custom = true;if ($parser.order.orderings.length == 1) {_orderByColumn.children().each(function () {if ($(this).text() == $parser.order.orderings[0].value.value) {$result.custom = false;$result.orderByColumn = $(this).text();$result.orderByRule = ($parser.order.orderings[0].direction || "ASC").toUpperCase();return false}})}}} catch (e) {$result.custom = true}}
return $result}
var _getFilters = function ($cols, $root) {var $filters = [CONST_EMPTY_FILTER_ITEM];$cols && rsb.forEach($cols, function ($col) {if (!$col.defined) {return true}
var $filter = {};$filter.id = _quoteIdentifier(_escapeIdentifier($col.name));$filter.label = $col.name;$filter.type = _convertColumnType(($col.datatype || "string").toLowerCase());$filter.size = 18;if ($filter.type == "boolean") {$filter.operators = ['equal'];$filter.values = {1: 'Yes', 0: 'No'}} else if ($filter.type == "string" || $filter.type == "integer" || $filter.type == "double") {$filter.value_separator = ",";$filter.input = "text"}
if (!$root) {$.extend($filter, {validation: {callback: function (rule, value) {return true}},input: function (rule, name) {var $container = rule.$el.find('.rule-value-container');$container.off("hidden.bs.dropdown", ".dropdown");$container.on("hidden.bs.dropdown", ".dropdown", function () {$(this).trigger("change")});$container.off("click focusout", "button");$container.on("focusout", "button", function (e) {var $selected = $container.find('[data-arc-id="value.container.type"]').data("selected");if ($selected && $selected.length > 0) {var inputEle = $(this).closest(".input-group").find("input");if ($selected == "REF") {$(this).closest(".input-group").find("span.input-group-text").removeClass("hidden");inputEle.removeClass("input-group-const").attr("data-bs-toggle", "dropdown");new bootstrap.Dropdown(inputEle[0], {boundary: document.querySelector('body'),popperConfig: function (defaultBsPopperConfig) {return {...defaultBsPopperConfig, strategy: "fixed"}}})} else {$(this).closest(".input-group").find("span.input-group-text").addClass("hidden");inputEle.addClass("input-group-const").attr("data-bs-toggle", "")}}
$container.find("input").trigger("change")});return '<div class="input-group">' +'<span class="input-group-text hidden p-1 ps-2 pe-2">$</span>' +'<input class="form-control" type="text" name="' + rsb.htmlEncode(name) + '">' +'<ul class="dropdown-menu" role="menu" data-bs-container="body">' + _refColumns.find("ul").html() + '</ul>' +'<button class="btn btn-outline-secondary dropdown-toggle p-1 ps-2 pe-2" type="button" data-bs-toggle="dropdown"></button>' +'<ul class="dropdown-menu" role="menu" data-selected="" data-arc-id="value.container.type"><li onmousedown="rsb.mappingEditor.columnTypeChanged($(this));"><a class="dropdown-item" href="javascript:void(0);">' +'CONST'+'</a></li><li onmousedown="rsb.mappingEditor.columnTypeChanged($(this));"><a class="dropdown-item" href="javascript:void(0);">' +'REF'+'</a></li></ul>' +'</div>'},valueGetter: function (rule) {var $curRule = {$el: rule.$el, valueGetter: rule.filter.valueGetter};var $refMap = {};rule.$el.find('.rule-value-container .input-group input').addClass("input-group-const");if (rule.$el.find('.rule-value-container .input-group span.input-group-text:not(.hidden)').length > 0) {var values = [];rule.$el.find('.rule-value-container .input-group').each(function () {if ($(this).find('span.input-group-text').hasClass("hidden")) {values.push($(this).find('input').val())} else {$(this).find('input').removeClass("input-group-const")}});rule.$el = rule.$el.clone(false);var $index = 1;rule.$el.find('.rule-value-container .input-group').each(function () {if (!$(this).find('span.input-group-text').hasClass("hidden")) {var $refInput = $(this).find('input');while (values.indexOf("$" + $index) >= 0) {$index++}
values.push("$" + $index);var temp = '$' + ($index).toString();$refMap[temp] = [["${" + $refInput.val() + "}"]];$refInput.val("$" + $index)}})}
delete rule.filter.valueGetter;var $inputs = _builderContainer.queryBuilder("getRuleInputValue", rule);if ($refMap) {var _replaceRefs = function ($input, $map) {if ($.isArray($input)) {for (var i = 0; i < $input.length; i++) {$input[i] = _replaceRefs($input[i], $map)}
return $input} else {return $map[$input] || $input}}
$inputs = _replaceRefs($inputs, $refMap)}
rule.$el = $curRule.$el;rule.filter.valueGetter = $curRule.valueGetter;return $inputs},valueSetter: function (rule, value) {var container = rule.$el.find('.rule-value-container');var operator = rule.operator;if (operator.nb_inputs == 1 && !$.isArray(value)) {value = [value]}
for (var i = 0; i < operator.nb_inputs; i++) {var name = rule.id + '_value_' + i;var inputEle = container.find('[name=' + name + ']');var inputVal = value[i];if ($.isArray(inputVal) && inputVal.length == 1 && $.isArray(inputVal[0]) && inputVal[0].length == 1 && inputVal[0][0].startsWith("${") && inputVal[0][0].endsWith("}")) {inputVal = inputVal[0][0].substring(2, inputVal[0][0].length - 1);inputEle.removeClass("input-group-const").attr("data-bs-toggle", "dropdown");new bootstrap.Dropdown(inputEle[0], {boundary: document.querySelector('body'),popperConfig: function (defaultBsPopperConfig) {return {...defaultBsPopperConfig, strategy: "fixed"}}});inputEle.prev("span.input-group-text").removeClass("hidden")} else {inputEle.addClass("input-group-const");if (operator.multiple && operator.nb_inputs === 1) {inputVal = value.join(",")}}
inputEle.val(inputVal)}}})}
$filters.push($filter)});return $filters}
var _getColumnIdMap = function ($filters) {var $map = {};$filters && rsb.forEach($filters, function ($filter) {$map[$filter.id] = _quoteIdentifier($filter.label)});return $map}
var _initQueryPanel = function ($structure, $cols, $root) {var $filterable = !!_options.isFilterable($structure.table);if ($filterable) {_right.removeClass("unfilterable");if (!!_options.supportCustomQuery($structure.table)) {_right.removeClass("no-custom-query")} else {_right.addClass("no-custom-query")}} else {_right.addClass("unfilterable");_right.removeClass("no-custom-query")}
var $option = '<option value="">' + 'Not Specified'+ '</option>';_orderByColumn.html($option).val("");_timeCheckColumn.html($option).val("");_updateValueColumn.html($option).val("");var $dateTimeColumnCount = 0;var $keyCount = 0;for (var index = 0; index < $cols.length; index++) {if ($cols[index].defined) {$option = '<option value="' + rsb.htmlEncode($cols[index].name) + '">' + rsb.htmlEncode($cols[index].name) + '</option>';_orderByColumn.append($option);if ($root) {if (["date", "datetime"].indexOf(($cols[index].datatype || "").toLowerCase()) >= 0) {$dateTimeColumnCount++}
if (($cols[index].iskey || "").toLowerCase() == "true") {$keyCount++}
if (_timeCheckColumn.length && ($cols[index].istimecheckcolumn || "").toLowerCase() == "true") {_timeCheckColumn.append($option);if (($cols[index].timeCheck || "").toLowerCase() == "true") {_timeCheckColumn.val($cols[index].name)}}
if (($cols[index].isreadonly || "").toLowerCase() != "true" && ($cols[index].iskey || "").toLowerCase() != "true") {_updateValueColumn.append($option);if (!!$cols[index].updateValue) {_updateValueCheckbox.prop("checked", true).change();_updateValueColumn.val($cols[index].name);_updateValueValue.val($cols[index].updateValue)}}}}}
if ($root && $filterable) {_advanced.show();if ($dateTimeColumnCount > 0 && ($structure.processChangesOnly || _timeCheckColumn.length || rsb.getValueAsBool($structure.hasTimeCheckColumns, false))) {_timeCheckColumnCheckbox.closest(".checkbox").show()
$structure.processChangesOnly && _timeCheckColumnCheckbox.prop("checked", true).change()} else if ($keyCount > 0) {_timeCheckColumnCheckbox.closest(".checkbox").hide()} else {_advanced.hide()}
_updateValueCheckbox.closest(".checkbox").toggle($keyCount > 0)} else if (!$root && !_isInput) {_advanced.hide();_initColumnRefs()}
_builderContainer.off('change.queryBuilder click.queryBuilder', _updateQuery);_orderByColumn.off("change");_orderByRule.off("change");if (!$filterable) {return false}
var _filters = _getFilters($cols, $root);_builderContainer.columnIdMap = _getColumnIdMap(_filters);_builderContainer.queryBuilder("destroy");_builderContainer.on("afterUpdateGroupNot.queryBuilder", (event, group) => {const group_not = ".rules-group-header  [data-not=group]"
group.$el.find('>' + group_not).prop('disabled', _options.disabled)});_builderContainer.queryBuilder($.extend({filters: _filters}, _builderOption));var _query = _parseQuery($structure);_sqlText.val(_query.query || "");if (_query.custom) {_right.removeClass("no-custom-query");_customQueryCheckbox.prop("checked", true).change()} else {_builderContainer.queryBuilder('setRules', _query.rules || []);_orderByColumn.val(_query.orderByColumn || "");_orderByRule.val(_query.orderByRule || "ASC");!_query.query && _updateQuery()}
_builderContainer.on('change.queryBuilder click.queryBuilder', _updateQuery);_orderByColumn.on("change", _updateQuery);_orderByRule.on("change", _updateQuery)}
var _initColumnRefs = function () {var $parentColumns = [];_mappingTree.find("li.active").parentsUntil(_mappingTree, 'li').each(function ($parent) {var $structure = _structuteMap[$(this).data("id")];if ($structure && $structure.columns && $structure.columns.length) {rsb.forEach($structure.columns, function ($col) {if ($parentColumns.indexOf($col.name) < 0) {$parentColumns.push($col.name);_refColumns.find(".dropdown-menu").append('<li onclick="rsb.mappingEditor.columnRefChanged($(this));"><a class="dropdown-item" href="javascript:void(0);">' + rsb.htmlEncode($col.name) + '</a>')}})}})}
var _updateQuery = function () {if (_customQueryCheckbox.prop("checked")) {return}
var $query = "SELECT ";if (!_allColumnsCb.prop("checked")) {var $columns = _getSelectedColumns(true);if (!$columns || $columns.length <= 0) {_sqlText.val("");return}
for (var index = 0; index < $columns.length; index++) {if (index) {$query += ", "}
$query += CONST_IDENTIFIER_QUOTE + $columns[index].name + CONST_IDENTIFIER_QUOTE}} else {$query += "*"}
$query += " FROM " + _getTableName();try {var $sql = _builderContainer.queryBuilder('getSQL');if (!!$sql.sql && $sql.sql != "NOT (  )") {rsb.forEach($sql.sql.match(CONST_IDENTIFIER_PATTERN), function (identifier, index) {if (_builderContainer.columnIdMap[identifier]) {$sql.sql = $sql.sql.replace(identifier, _builderContainer.columnIdMap[identifier])}});$query += " WHERE " + $sql.sql}} catch (e) {}
if (_orderByColumn.val()) {$query += " ORDER BY " + _quoteIdentifier(_orderByColumn.val()) + " " + _orderByRule.val()}
_sqlText.val($query || "");_changed = true}
_customQueryCheckbox.off("change").on("change", function () {if (_customQueryCheckbox.prop("checked")) {_right.find("div.none-custom").addClass("rsb-disable");_sqlText.removeAttr("readonly")} else {_right.find("div.none-custom").removeClass("rsb-disable");_sqlText.attr("readonly", "readonly")}});_sqlText.off("change").on("change", function () {_changed = _changed || _customQueryCheckbox.prop("checked")});var _advanceCheckboxChanged = function ($cb) {_changed = true;var $settings = $cb.parent().find(".advanced-checkbox-settings");if ($cb.prop("checked")) {$settings.find("select").removeAttr("disabled");$settings.find("input").removeAttr("readonly");return true} else {$settings.find("select").attr("disabled", "disabled");$settings.find("input").attr("readonly", "true");return false}}
_timeCheckColumnCheckbox.off("change").on("change", function () {if (!_advanceCheckboxChanged(_timeCheckColumnCheckbox)) {delete _structute.timeCheckColumn} else if (!_timeCheckColumn.length) {_structute.timeCheckColumn = true}});_updateValueCheckbox.off("change").on("change", function () {if (!_advanceCheckboxChanged(_updateValueCheckbox)) {delete _structute.updateValueColumn;delete _structute.updateValueColumn}});_processChangesOnlyContainer.find("select").off("change").on("change", function () {_structute.timeCheckColumn = _timeCheckColumn.val();if (!_structute.timeCheckColumn) {delete _structute.timeCheckColumn}
_changed = true});_updateValueColumn.off("change").on("change", function () {_structute.updateValueColumn = _updateValueColumn.val();_structute.updateValueValue = _updateValueValue.val();if (!_structute.updateValueColumn) {delete _structute.updateValueColumn;delete _structute.updateValueValue}
_changed = true});_updateValueValue.off("change").on("change", function () {if (_structute.updateValueColumn) {_structute.updateValueValue = _updateValueValue.val()}
_changed = true});_advanced.find(".advanced-checkbox-settings").find("select, input").off("click").on("click", function (e) {rsb.stopPropagation(e);return false});var _builderOption = {plugins: ['not-group', 'bt-tooltip-errors'],allow_empty: true,display_errors: true,display_empty_filter: false,default_group_flags: {condition_readonly: _options.disabled,no_add_rule: _options.disabled,no_add_group: _options.disabled,no_delete: _options.disabled},default_rule_flags: {filter_readonly: _options.disabled,operator_readonly: _options.disabled,value_readonly: _options.disabled,no_delete: _options.disabled},operators: [{type: 'equal', nb_inputs: 1, multiple: false, apply_to: ['string', 'number', 'datetime', 'boolean']},{type: 'not_equal', nb_inputs: 1, multiple: false, apply_to: ['string', 'number', 'datetime', 'boolean']},{type: 'contains', nb_inputs: 1, multiple: false, apply_to: ['string']},{type: 'begins_with', nb_inputs: 1, multiple: false, apply_to: ['string']},{type: 'ends_with', nb_inputs: 1, multiple: false, apply_to: ['string']},{type: 'less', nb_inputs: 1, multiple: false, apply_to: ['number', 'datetime']},{type: 'less_or_equal', nb_inputs: 1, multiple: false, apply_to: ['number', 'datetime']},{type: 'greater', nb_inputs: 1, multiple: false, apply_to: ['number', 'datetime']},{type: 'greater_or_equal', nb_inputs: 1, multiple: false, apply_to: ['number', 'datetime']},{type: 'is_empty', nb_inputs: 0, multiple: false, apply_to: ['string']},{type: 'is_not_empty', nb_inputs: 0, multiple: false, apply_to: ['string']},{type: 'is_null', nb_inputs: 0, multiple: false, apply_to: ['string', 'number', 'datetime', 'boolean']},{type: 'is_not_null', nb_inputs: 0, multiple: false, apply_to: ['string', 'number', 'datetime', 'boolean']},{type: 'in', nb_inputs: 1, multiple: true, apply_to: ['string', 'number', 'datetime']},{type: 'not_in', nb_inputs: 1, multiple: true, apply_to: ['string', 'number', 'datetime']}
],lang: {add_rule: 'Add rule',add_group: 'Add group',delete_rule: 'Delete',delete_group: 'Delete',operators: {equal: 'Equals',not_equal: 'Not Equals',in: 'In',not_in: 'Not In',less: 'Less Than',less_or_equal: 'Less Than or Equal To',greater: 'Greater Than',greater_or_equal: 'Greater Than or Equal To',begins_with: 'Starts With',not_begins_with: 'Doesn\'t Starts With',contains: 'Contains',not_contains: 'Doesn\'t Contains',ends_with: 'Ends With',not_ends_with: 'Doesn\'t Ends With',is_empty: 'Is Empty',is_not_empty: 'Is Not Empty',is_null: 'Is Null',is_not_null: 'Is Not Null'}}};_builderContainer.queryBuilder("destroy");_builderContainer.queryBuilder($.extend({filters: [CONST_EMPTY_FILTER_ITEM]}, _builderOption))}
_allColumnsCb.change(function () {_columnsTable.find("td.column-checkbox>input").prop("checked", _allColumnsCb.prop("checked"));!_isInput && _updateQuery();_changed = true});_addTableBtn.off("click").on("click", function () {_addTableModal.show({dataSource: _options.dataSource}, function ($callback) {_options.listTables(_args, function (result, tempName) {var errorMsg = rsb.getResultErrorMessage(result);if (errorMsg) {rsb.showResult(_resultContainer, errorMsg, false)} else if (!result || !result.length) {errorMsg = 'No tables found.'}
$callback && $callback(result, errorMsg)})})});_codeBtn.off("click").on("click", function () {var $mappingData = _getMappingData();_setCode("");_left.hide();_right.addClass("code col-md-12").removeClass("col-md-9");_setCode($mappingData);_codeBtn.hide();_designBtn.show()
_advanced && _advanced.addClass("hidden")});_designBtn.off("click").on("click", function () {if (_codeEditor.historySize().undo <= 0 && !_designBtn.prop("invalid") || confirm('The modifications you have made will be lost.<br><br>Do you want to continue?')) {_designBtn.prop("invalid", false);_right.removeClass("code col-md-12").addClass("col-md-9");_left.show();_designBtn.hide();_codeBtn.show();_advanced && _advanced.removeClass("hidden")}});_previewBtn.off("click").on("click", function () {var args = $.extend({data: _getMappingData()}, _args);_previewModal.show(_templateName || _getTableName(), args)});_adjustVisibleColumns();_disableValidation();_changed = false;return this}
rsb.mappingEditor.columnRefChanged = function ($li) {var target = $li.closest("div").find("input");var $newValue = $li.find("a").text();if ($newValue && target && $newValue != target.val()) {target.val($newValue);target.trigger("change")}}
rsb.mappingEditor.columnTypeChanged = function($li) {$li.closest("ul.dropdown-menu").data("selected", $li.find("a").text())}
