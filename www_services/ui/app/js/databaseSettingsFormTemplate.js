rsb.DBSetting = rsb.DBSetting || {};rsb.DBSetting.options = {};rsb.DBSetting.isNew = true;rsb.DBSetting.SettingsForm = $("#databaseSettingsForm");rsb.DBSetting.AddTemplateButtons = $("#databaseSettingsForm button.add-template");rsb.DBSetting.resultContainer = rsb.DBSetting.SettingsForm.find("#resultContainer");rsb.DBSetting.databaseurlContainer = rsb.DBSetting.SettingsForm.find("#databaseurlContainer");rsb.DBSetting.propertylistContainer = rsb.DBSetting.SettingsForm.find("#propertylistContainer");rsb.DBSetting.mappingNavPills = rsb.DBSetting.SettingsForm.find("#mappingNavPills");rsb.DBSetting.mappingTabContent = rsb.DBSetting.SettingsForm.find("#databasesettingsform_mapping_tab_content");rsb.DBSetting.spTemplatesTable = rsb.DBSetting.SettingsForm.find("#databasesettingsform_sp_templates_table");rsb.DBSetting.outputTemplatesTable = rsb.DBSetting.SettingsForm.find("#databasesettingsform_output_templates_table");rsb.DBSetting.inputTemplatesTable = rsb.DBSetting.SettingsForm.find("#databasesettingsform_input_templates_table");rsb.DBSetting.templateTables = [rsb.DBSetting.inputTemplatesTable, rsb.DBSetting.inputTemplatesTable, rsb.DBSetting.outputTemplatesTable, rsb.DBSetting.spTemplatesTable];rsb.DBSetting.contextMenu = rsb.DBSetting.SettingsForm.find("#databasesettingsform_context_menu");rsb.DBSetting.contextMenu.trigger = rsb.DBSetting.contextMenu.find("a\[data-bs-toggle='dropdown'\]");rsb.DBSetting.invalidType = "0";rsb.DBSetting.singleTableType = "1";rsb.DBSetting.singleSPType = "2";rsb.DBSetting.multipleType = "3";rsb.DBSetting.complexType = "4";rsb.DBSetting.tabIndexInput = "1";rsb.DBSetting.tabIndexOutput = "2";rsb.DBSetting.tabIndexInputOutput = "3";rsb.DBSetting.init = function($options) {rsb.DBSetting.options = $.extend($options, rsb.connect.options);rsb.DBSetting.databaseurl = rsb.DBSetting.databaseurlContainer.find(rsb.DBSetting.options.databaseurlname);rsb.DBSetting.connectionStringInput = rsb.DBSetting.databaseurlContainer.find("#database_hidden_connection_string");rsb.DBSetting.propIdPrefix  = rsb.DBSetting.propIdPrefix || ""}
rsb.DBSetting.hiddenContainer = function(container) {container.addClass('hidden').find('input,textarea,select,option').each(function() {$(this).addClass('rsb-form-nosubmit').attr("_name_", $(this).attr("name")).removeAttr("name", "")})}
rsb.DBSetting.showContainer = function(container) {container.removeClass('hidden').find('.rsb-form-nosubmit').each(function() {$(this).removeClass('rsb-form-nosubmit').attr("name", $(this).attr("_name_") || $(this).attr("name")).removeAttr("_name_", "")})}
rsb.DBSetting.SettingsForm.find("#settingsformatdatabaseurl").click(function() {if (rsb.DBSetting.propertylistContainer && rsb.DBSetting.propertylistContainer.hasClass('hidden')) return;rsb.connect.buildConnectionString(rsb.DBSetting.SettingsForm, rsb.DBSetting.options.driverType, rsb.DBSetting.getDriverName(), rsb.DBSetting.getDriverClass(), rsb.DBSetting.SettingsForm.find("#connectionstringtype").val(), rsb.connect.pswdmask, "Encrypt", function (result) {var errMsg = rsb.getResultErrorMessage(result) || result[0]["exmessage"];if(errMsg) {rsb.showResult(rsb.DBSetting.resultContainer, errMsg, false, true)} else {rsb.DBSetting.databaseurl.val(result[0]["connectionstring"])}
rsb.DBSetting.showDatabaseUrl()})});rsb.DBSetting.SettingsForm.find("#settingsformatpropertylist").click(function() {if (rsb.DBSetting.propertylistContainer && !rsb.DBSetting.propertylistContainer.hasClass('hidden')) return;rsb.connect.parseConnectionString(rsb.DBSetting.databaseurl.val(), rsb.DBSetting.options.driverType, rsb.DBSetting.getDriverName(), rsb.DBSetting.getDriverClass(), rsb.DBSetting.SettingsForm.find("#connectionstringtype").val(), function(result) {var errMsg = rsb.getResultErrorMessage(result) || result[0]["exmessage"];if(errMsg) {rsb.showResult(rsb.DBSetting.resultContainer, errMsg, false, true)} else {for (var name in result[0]) {var input = rsb.DBSetting.SettingsForm.find("[name='connection" + rsb.escapeSelector(name) + "']");if (input.length && (!input.val() || input.attr("type") != "password" || result[0][name] != rsb.connect.pswdmask)) {input.val(result[0][name]);result[0][name] && input.trigger("updateCentralSetting")}}}
rsb.DBSetting.showPropertyList()})}).on("subsettingsSwitch", function() {if ($(this).prop("checked")) {rsb.DBSetting.showPropertyList()} else {rsb.DBSetting.showDatabaseUrl()}});rsb.DBSetting.fillConnectionString =  function($callback) {if (rsb.DBSetting.SettingsForm.find("#settingsformatdatabaseurl").prop("checked")) {rsb.DBSetting.connectionStringInput.val(rsb.DBSetting.databaseurl.val());var postData = { "@json": true, "ConnectorId": rsb.DBSetting.options.workspaceid + ":" + rsb.DBSetting.options.portId, "ConnectorType": rsb.DBSetting.options.portType, "ConnectionString": rsb.DBSetting.connectionStringInput.val(), "DriverType": rsb.DBSetting.options.driverType, "DriverName": rsb.DBSetting.getDriverName(), "DriverClass": rsb.DBSetting.getDriverClass(), "ConnectionString": rsb.DBSetting.connectionStringInput.val() };$.ajax({dataType: "json",url: rsb.connect.pathCombine(rsb.DBSetting.options.srcDir, "databaseGetEncryptedConnectionString.rsb"),type: "POST",data: postData,async: !!$callback,success: function(data, textStatus, jqXHR) {var result = data.items;var errMsg = rsb.getResultErrorMessage(result);if(errMsg) {rsb.showResult(rsb.DBSetting.resultContainer, errMsg, false, true)} else {result.length && !!result[0]["connectionstring"] && rsb.DBSetting.connectionStringInput.val(result[0]["connectionstring"]);$callback && $callback()}}})} else {$callback && $callback()}}
rsb.DBSetting.SettingsForm.on("beforeSubmit", function() {rsb.DBSetting.fillConnectionString(null)});rsb.DBSetting.testConnection = function($btn) {rsb.DBSetting.fillConnectionString(function() {rsb.connect.testConnection(rsb.DBSetting.SettingsForm, $btn, rsb.DBSetting.options.portId, rsb.DBSetting.options.workspaceid)})}
rsb.DBSetting.connectionStringTypeChanged = function(type, callback) {rsb.DBSetting.resultContainer.hide();var postData = {"@json": true, "ProviderType": rsb.DBSetting.options.driverType, "ProviderName": rsb.DBSetting.getDriverName() || "Other", "ProviderClass": rsb.DBSetting.getDriverClass()};if (!!type) {postData.HierarchyProperty = /^(cdata\.jdbc\.|system\.data\.cdata\.)/.test(postData.ProviderClass.toLowerCase()) ? "AuthScheme" : "ConnectionType";postData.HierarchyPropertyValue = type}
$.ajax({dataType: "json",url: "src/getProviderProperties.rsb",type: "POST",data: postData,success: function(data, textStatus, jqXHR) {rsb.DBSetting.propertylistContainer.find('[data-bs-toggle="popover"]').popover('dispose');rsb.DBSetting.propertylistContainer.empty();rsb.DBSetting.accountContainer && rsb.DBSetting.hiddenContainer(rsb.DBSetting.accountContainer);var result = data["items"];var errMsg = rsb.getResultErrorMessage(result) || result[0]["exmessage"];if(errMsg) {rsb.showResult(rsb.DBSetting.resultContainer, errMsg, false, true)} else {var html = "";var databaseHtml = "";rsb.DBSetting.accountMask = 0;var html2 = rsb.DBSetting.getPropHtml(result, false, function(prop, index) {if (!prop.name) {rsb.DBSetting.driverInfo = prop;rsb.DBSetting.driverInfo.driverName = prop.providername.toLowerCase();rsb.DBSetting.driverInfo.driverType = prop.providertype;rsb.DBSetting.driverInfo.driverClass = prop.providerclass;rsb.DBSetting.driverInfo.isDynamic = rsb.getValueAsBool(prop.iscdata, false) || result.some(p => !!p.name && p.name.toLowerCase() !== "other" && p.tab.toLowerCase() === "advanced");return false} else if (rsb.getValueAsBool(prop.ishierarchy, false) && prop.choice?.length > 0 && ["authscheme", "connectionstringtype"].includes(prop.name.toLowerCase())) {type = type || prop.choice[0];html += '<div class="form-group row mb-3">' +'  <label for="' + rsb.DBSetting.propIdPrefix + prop.name.toLowerCase() + '" class="col-md-3 control-label col-form-label">' + prop.displayname + ':</label>' +'  <div class="col-md-5">' +'    <select class="form-control form-select" name="connection' + prop.name.toLowerCase() + '" id="' + rsb.DBSetting.propIdPrefix + prop.name.toLowerCase() + '" data-bs-html="true" onchange="rsb.DBSetting.connectionStringTypeChanged($(this).val());">';rsb.forEach(prop.choice, function (choice, index) {html += '<option value="' + choice + '"' + (choice === type ? ' selected' : '') + '>' + choice + '</option>'});html += '    </select>' +'  </div>' +'</div>';rsb.DBSetting.checkPropCallback && rsb.DBSetting.checkPropCallback(prop, index);return false} else if (rsb.getValueAsBool(prop.isrequired, false) || prop.tab?.toLowerCase() === "basic") {if (rsb.DBSetting.checkPropCallback) {return rsb.DBSetting.checkPropCallback(prop, index)} else if (rsb.DBSetting.accountContainer &&"`user`password`".match(prop.name.toLowerCase())) {rsb.DBSetting.accountMask |= (prop.name.toLowerCase() == "user" ? 1 : 2);return false} else if (rsb.DBSetting.databaseContainer && rsb.DBSetting.databaseContainer.length > 0 && prop.displayname && prop.displayname.toLowerCase() == 'databasev2') {databaseHtml = '<label for="dbsettings.databasename" class="col-md-3 control-label col-form-label">Database:</label>' +'<div class="col-md-5">' +'<input type="' + (prop.issensitive.toLowerCase() == 'true' ? 'password' : 'text') + '" class="form-control" name="connection' + prop.name.toLowerCase() + '" id="' + prop.name.toLowerCase() + '" value="' + (prop.value || '') + '" required="required"' + (prop.description && prop.description.length > 0 ? 'data-bs-toggle="popover" data-bs-html="true" data-bs-trigger="hover"' + (rsb.isWorkflow ? ' data-bs-placement="top"' : '') + ' data-bs-content="' + prop.description + '"' : '') + '>';return false} else {return true}} else {return false}});rsb.DBSetting.propertylistContainer.append(html + html2);rsb.DBSetting.propertylistContainer.find('[data-bs-toggle="popover"]').popover({container: rsb.DBSetting.propertylistContainer});rsb.DBSetting.accountMask && rsb.DBSetting.accountContainer && rsb.DBSetting.showAccount();if (rsb.DBSetting.databaseContainer && rsb.DBSetting.databaseContainer.length > 0) {rsb.DBSetting.databaseContainer.html(databaseHtml || "");if (databaseHtml) {rsb.DBSetting.showContainer(rsb.DBSetting.databaseContainer)} else {rsb.DBSetting.hiddenContainer(rsb.DBSetting.databaseContainer)}}
rsb.connect.initVaultInputGroups(rsb.DBSetting.SettingsForm, rsb.DBSetting.resultContainer);rsb.connect.initVaultInputGroups($("#databaseAdvancedForm"), rsb.DBSetting.resultContainer);if (callback) {callback(result, type)} else if (rsb.DBSetting.connectionStringTypeChangedCallback) {rsb.DBSetting.connectionStringTypeChangedCallback(result, type)}}}})}
rsb.DBSetting.getPropHtml = function(items, showCategory, accept) {var html = "";var lastCategory = "";rsb.forEach(items, function(prop, index) {if (accept(prop, index)) {if (showCategory && lastCategory != prop.category) {html += '<h4 class="page-header">' + (!prop.category || prop.category == 'Connection' ? 'Optional Connection Properties': prop.category.length > 0 ? prop.category : 'Advanced') + '</h4>';lastCategory = prop.category}
prop.value =  prop.default || "";html += '<div class="form-group row mb-3">' +'<label for="' + prop.name.toLowerCase() + '" class="col-md-3 control-label col-form-label">' + (prop.displayname.toLowerCase() == 'other' ? 'Other Driver Settings' : prop.displayname) + ':</label>';if (prop.choice && prop.choice?.length > 1) {html += '<div class="col-md-5">' +'<select class="form-control form-select" name="connection' + prop.name.toLowerCase() + '" id="' + rsb.DBSetting.propIdPrefix + prop.name.toLowerCase() + '"' + (prop.description && prop.description.length > 0 ? 'data-bs-toggle="popover" data-bs-html="true" data-bs-trigger="hover"' + (rsb.isWorkflow ? ' data-bs-placement="top"' : '') + ' data-bs-content="' + prop.description + '"' : '') + '>';rsb.forEach(prop.choice, function(choice, index) {html += '<option value="' + choice + '"' + (choice == prop.value ? ' selected' : '') + '>' + (choice || 'Not Specified') + '</option>'});html += '</select>'} else {if (prop.type == undefined) {prop.type = "text"}
html += '<div class="' + (prop.type == "file" ? "col-md-6" : prop.type == "int" ? "col-md-4 col-lg-3" : "col-md-5") + '">' +'<input type="' + (!!prop.sensitivity ? 'password' : prop.type == "int" ? 'number' : 'text') + '" class="form-control" name="connection' + prop.name.toLowerCase() + '" id="' + rsb.DBSetting.propIdPrefix + prop.name.toLowerCase() + '" value="' + prop.value + '"' + (prop.description && prop.description.length > 0 ? 'data-bs-toggle="popover" data-bs-html="true" data-bs-trigger="hover"' + (rsb.isWorkflow ? ' data-bs-placement="top"' : '') + ' data-bs-content="' + prop.description + '"' : '') + '>'}
html += '</div></div>'}});return html}
rsb.DBSetting.showAccount = function() {rsb.DBSetting.showContainer(rsb.DBSetting.accountContainer);rsb.DBSetting.accountContainer.children().removeClass("hidden");if ((rsb.DBSetting.accountMask & 1) == 0) {rsb.DBSetting.hiddenContainer(rsb.DBSetting.accountContainer.children("div:eq(0)"))} else if ((rsb.DBSetting.accountMask & 2) == 0) {rsb.DBSetting.hiddenContainer(rsb.DBSetting.accountContainer.children("div:eq(1)"))}}
rsb.DBSetting.getDriverName = function() {throw 'The getDriverName function is not implemented.'}
rsb.DBSetting.getDriverClass = function() {throw 'The getDriverClass function is not implemented.'}
rsb.DBSetting.showDatabaseUrl = function() {throw 'The showDatabaseUrl function is not implemented.'}
rsb.DBSetting.showPropertyList = function() {throw 'The showPropertyList function is not implemented.'}
