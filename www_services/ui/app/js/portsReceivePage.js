rsb.portsReceive = rsb.portsReceive || {};rsb.portsReceive.options = {};rsb.portsReceive.isReceiving = {};rsb.portsReceive.init = function($options) {rsb.portsReceive.options = $.extend($options, rsb.connect.options)}
rsb.portsReceive.inToggleSelected = function(event) {rsb.toggleSelected(event);var transactionLogs = $('#receiveTable').find("tbody tr:not(.unsent-file)").has("input[type='checkbox']:checked");if (transactionLogs.length > 0 && !rsb.portsReceive.options.readonly) {$("#btn-in-delete").prop("disabled", false)} else {$("#btn-in-delete").prop("disabled", true)}}
rsb.connect.downloadFiles = function(workspace, portId, button, resultContainer, refreshBtn) {rsb.portsReceive.isReceiving[portId] = true;button.button("loading");if (refreshBtn) {refreshBtn.prop("disabled", true)}
var postData = { "@json": true, "workspaceid": workspace, "portid": portId };$.ajax({dataType: "json",url: "api/receiveFile.rsb",type: "POST",data: postData,success: function(data, textStatus, jqXHR) {var resultFormat = "success";var resultMsg = "Download Success.";var result = data["items"];var downloadLink = '<a class="btn btn-secondary btn-outline-secondary pull-right me-24" style="margin-top: -5px;" href="src/downloadReceiveFileLog.rst?connectorid=' + encodeURIComponent(portId) + '&workspaceid=' + encodeURIComponent(workspace) + '" download="receiveFileLog.log" role="button"><i class="fa fa-download"></i> ' + 'Download Logs'+ ' </a>';if (result && result.length > 0) {for (var i in result) {if (result[i]["rsb:emessage"]) {resultFormat = "error";resultMsg = result[i]["rsb:emessage"];break} else if (result[i]["result"] == "info" || result[i]["result"] == "warning" || result[i]["result"] == "success" || result[i]["result"] == "error") {resultFormat = result[i]["result"];resultMsg = result[i]["message"]}}}
rsb.showResult(resultContainer, downloadLink + resultMsg, resultFormat, true);$("#receiveTable").DataTable().ajax.reload();rsb.portsReceive.isReceiving[portId] = false}}).always(function() {$("#btn-output-receive").button("reset")})}
$(document).ready(function() {var locked = false;var filter = "direction eq Receive and workspace eq " + rsb.odataEscape(rsb.portsSend.options.workspaceid) + " and portid eq " + rsb.odataEscape(rsb.portsSend.options.portId) + " and batchgroupid eq ''";$("#btn-output-refresh").click(function() {if (!locked) {$('#receiveTable').DataTable().ajax.reload()}});var options = {searching: false,autoWidth: false,sDom: "<'row'<'col-md-3'f>r>t<'row'<'col-md-3'i><'col-md-2 table-filter'><'col-md-2 nowrap'l><'col-md-5'p>>",lengthMenu: [10, 20, 50, 100, 200, 500],pageLength: rsb.pageRecordsCount.get(),language: {url : 'ui/datatables/lang/'+ 'english.js'},rowCallback: function (row, data) {if (data["status"] == "Error" || data["status"] == "Receive Error") {$(row).children(".status").addClass("text-danger")} else if (data["status"] == "Pending" || data["status"] == "Warning" || data["status"] == "Receive Warning" || data["status"] == "Processing") {$(row).children(".status").addClass("text-warning")} else if (data["status"] == "Success" || data["status"] == "Received") {$(row).children(".status").addClass("text-success")}
$(row).children("td:first").html('<input type="checkbox" class="form-check-input pointercursor">').click(rsb.portsReceive.inToggleSelected);if (data["messageid"] != null) {var logInfo = '<input type="hidden" name="messageid" value="' + data["messageid"] + '"><input type="hidden" name="direction" value="Receive"><input type="hidden" name="filename" value="' + data["filename"] + '"><input type="hidden" name="filepath" value="' + data["filepath"] + '">';if (rsb.portsReceive.options.isTransportPort) {$(row).children("td:eq(1)").html('<i class="fa fa-plus-circle"></i>' + logInfo).click({ "data": rsb.decodeRowData(data), "resultContainer": "#receiveError" }, rsb.connect.showDetails)}
else {$(row).children("td:eq(1)").html(logInfo)}
if (rsb.getValueAsBool(data.isbatchgroup, false)) {$(row).children("td:eq(4)").html('<i class="fa fa-envelope-o"></i>').click(rsb.decodeRowData(data), rsb.connect.showMessageInfo)} else {$(row).children("td:eq(4)").html("")}
$(row).children("td:eq(5)").html('<a href="javascript:void(0);">' + data["filename"] + '</a>').click(rsb.decodeRowData(data), rsb.connect.showMessageInfo)}},order: [[ 2, 'desc' ]],columns: [{orderable: false,width: "5px",data: null,className: "details-control center"},{orderable: false,width: "5px",data: "messageid",className: rsb.portsReceive.options.messageIdClassName},{data: "timestamp",render: rsb.formatTimestamp,width: "120px",className: "hidden-xs"},{data: "status",width: "120px",className: "status"},{data: "workspace",visible: false},{data: "connectorid",visible: false},{data: "direction",width: "75px",className: "center",visible: false},{orderable: false,width: "5px",data: null,className: "details-control hidden-xxs"},{data: "filename",width: "100%"},{data: "filepath",visible: false},{data: "filesize",render: rsb.connect.formatFileSize,width: "100px",className: "hidden-xs"},{data: "batchgroupid",defaultContent: "<i>(null)</i>",visible: false},{data: "isbatchgroup",defaultContent: "false",visible: false}
],preAjax: function(opt)  {locked = true;$("#btn-output-refresh").prop("disabled", true);$("#btn-output-refresh").find("i").addClass("fa-spin");opt["requestData"] = { "$filter": filter };var status = $("#receiveTableContainer div.table-filter select").val();if (status && status != "All") {if (status == "Success") {opt["requestData"]["$filter"] += " and (status eq 'Success' or status eq 'Received')"} else if (status == "Error") {opt["requestData"]["$filter"] += " and (status eq 'Error' or status eq 'Receive Error')"} else if (status == "Warning") {opt["requestData"]["$filter"] += " and (status eq 'Warning' or status eq 'Receive Warning')"} else if (status == "Pending") {opt["requestData"]["$filter"] += " and (status eq 'Pending' or status eq 'Processing')"} else if (status == "Skippped") {opt["requestData"]["$filter"] += " and (status eq 'Skippped')"}}},drawCallback: function(settings) {$("#receiveToggleAll").prop("checked", false)},afterAjax: function(settings) {$("#btn-in-delete").prop("disabled", true);$("#btn-output-refresh").prop("disabled", false);$("#btn-output-refresh i").removeClass("fa-spin");locked = false},"initComplete": function() {$("#receiveTable #receiveToggleAll").change(rsb.portsReceive.inToggleSelected);$("#receiveTableContainer div.table-filter").html(rsb.portsReceive.options.filterHtml)}};rsb.initTable($("#receiveTable"), "api/transactions.rsd", $("#receiveError"), options);$("#portsOutputTab").on('shown.bs.tab', function (e) {if (!locked) {$('#receiveTable').DataTable().ajax.reload()}
if (rsb.isWorkflow && rsb.portsReceive.isReceiving[rsb.portsReceive.options.portId]) {$("#btn-output-receive").button("loading")}})});