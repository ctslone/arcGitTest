rsb.connect.users = rsb.connect.users || {};rsb.connect.users.options = {};rsb.connect.users.userTableResultContainer = $("#apiportuserspage_userTableResultContainer");rsb.connect.users.defaultMaxRequest = 0;rsb.connect.users.defaultMaxRequestStr = 0;rsb.connect.users.defaultMaxConcurrent = 0;rsb.connect.users.defaultMaxConcurrentStr = 0;rsb.connect.users.init = function($options) {rsb.connect.users.options = $.extend($options, rsb.connect.options);rsb.connect.users.defaultMaxRequest = rsb.connect.users.options.defaultMaxRequest;rsb.connect.users.defaultMaxRequestStr = 'Default'+ "(" + rsb.connect.users.defaultMaxRequest + ")";rsb.connect.users.defaultMaxConcurrent = rsb.connect.users.options.defaultMaxConcurrent;rsb.connect.users.defaultMaxConcurrentStr = 'Default'+ "(" + rsb.connect.users.defaultMaxConcurrent + ")"}
rsb.connect.users.onUsersSelected = function(event) {var selectedCount = $("#apiportuserspage_users_table .piportuserspage-user-checkbox:checked").length;var elem = $(this);if($(event.target).is("input.piportuserspage-user-checkbox")) {$("#apiportuserspage_user_toggle_all").prop("checked", false);if (elem.hasClass("user-selected-row")) {elem.removeClass("user-selected-row");elem.find("input[type=checkbox]").prop("checked", false)} else {elem.addClass("user-selected-row");elem.find("input[type=checkbox]").prop("checked", "checked")}} else {$("#apiportuserspage_users_table").find("input[type='checkbox']").prop("checked", false);$("#apiportuserspage_users_tbody tr.user-selected-row").each(function(){$(this).removeClass("user-selected-row")});elem.addClass("user-selected-row");elem.find("input[type=checkbox]").prop("checked", "checked");selectedCount = 1}
if(selectedCount == $("#apiportuserspage_users_tbody tr").length) {$("#apiportuserspage_user_toggle_all").prop("checked", "checked")}
if(selectedCount == 0) {$("#apiportuserspage_edit_btn").addClass("disabled");$("#apiportuserspage_delete_btn").addClass("disabled")} else if(selectedCount == 1) {$("#apiportuserspage_edit_btn").removeClass("disabled");$("#apiportuserspage_delete_btn").removeClass("disabled")} else {$("#apiportuserspage_edit_btn").addClass("disabled");$("#apiportuserspage_delete_btn").removeClass("disabled")}}
rsb.connect.users.syncResourceLastModified = function () {rsb.setResourceLastModified(rsb.connect.users.options.workspaceid.toLowerCase() + ":" + rsb.connect.users.options.portId.toLowerCase(), new Date().toUTCString())}
rsb.connect.users.add_user = function() {var form = rsb.apiPort.addUserModal.form;form.find("#addusermodal_active").val(form.find("#addusermodal_is_active").prop('checked') ? "True" : "False");form.find("input\[name=Authtoken\]").val(rsb.connect.users.trimUsername(form.find("#addusermodal_authtoken").val()));form.one("success", function (e, result) {$("#apiportuserspage_users_table").DataTable().ajax.reload();rsb.apiPort.addUserModal.modal('hide');rsb.connect.users.syncResourceLastModified()});form.submit()}
rsb.connect.users.edit_user = function() {var form = rsb.apiPort.editUserModal.form;form.find("#editusermodal_active").val(form.find("#editusermodal_is_active").prop('checked') ? "True" : "False");form.find("input\[name=Authtoken\]").val(rsb.connect.users.trimUsername(form.find("#editusermodal_authtoken").val()));form.one("success", function (e, result) {$("#apiportuserspage_users_table").DataTable().ajax.reload();rsb.apiPort.editUserModal.modal('hide');rsb.connect.users.syncResourceLastModified()});form.submit();$("#apiportuserspage_edit_btn").addClass("disabled");$("#apiportuserspage_delete_btn").addClass("disabled")}
rsb.connect.users.delete_user = function() {var users = null;$("#apiportuserspage_users_tbody tr.user-selected-row").each(function(){var tmp = $(this).find("td:eq(1)").text();if(users == null) {users = tmp} else {users += ", " + tmp}});if (confirm(rsb.evalTemplate('Are you sure you want to delete the following user? $user$', {"user": "\r\n" + users}))) {$.ajax({dataType: "json",type: "DELETE",url: "src/connectorUsers.rsd?@json",data: { "user": users, "ConnectorId" : rsb.connect.users.options.portId, "WorkspaceId": rsb.connect.users.options.workspaceid, "connectortype":"api" },traditional: true,success: function (data, textStatus, jqXHR) {var errorMsg = rsb.getResultErrorMessage(data.items);if (errorMsg) {rsb.showResult(rsb.connect.users.userTableResultContainer, 'Error deleting user'+ ": " + errorMsg, false)} else {$("#apiportuserspage_users_table").DataTable().ajax.reload();$("#apiportuserspage_edit_btn").addClass("disabled");$("#apiportuserspage_delete_btn").addClass("disabled");rsb.connect.users.syncResourceLastModified()}}})}}
rsb.connect.users.load_AddUserModal = function() {rsb.apiPort.addUserModal.modal("show")}
rsb.connect.users.load_EditUserModal = function() {var selectedRow = $("#apiportuserspage_users_tbody tr.user-selected-row");if (!selectedRow[0]) {rsb.showResult(rsb.connect.users.userTableResultContainer, 'You must select a user to edit.', false)} else {var userName = selectedRow.find("td:eq(1)").text();rsb.apiPort.editUserModal.find("#editusermodal_user, #editusermodal_new_user").val(userName.substring(userName.indexOf("\\") + 1));var privileges = selectedRow.find("td:eq(2)").text();rsb.apiPort.editUserModal.find("#editusermodal_privileges_container input").each(function() {if (privileges.indexOf($(this).val()) >= 0) {$(this).prop("checked", "checked")}});var maxrequest = selectedRow.find("td:eq(3)").text();var maxconcurrent = selectedRow.find("td:eq(4)").text();if(maxrequest != rsb.connect.users.defaultMaxRequest) {rsb.apiPort.editUserModal.find("#editusermodal_max_request").val(maxrequest)} else {rsb.apiPort.editUserModal.find("#editusermodal_max_request").val("")}
if(maxconcurrent != rsb.connect.users.defaultMaxConcurrent) {rsb.apiPort.editUserModal.find("#editusermodal_max_concurrent").val(maxconcurrent)} else {rsb.apiPort.editUserModal.find("#editusermodal_max_concurrent").val("")}
if(selectedRow.find("td:eq(5)").text() == "True") {rsb.apiPort.editUserModal.find("#editusermodal_is_active").prop("checked", "checked");rsb.apiPort.editUserModal.find("#editusermodal_active").val("True")}
rsb.apiPort.editUserModal.modal('show')}}
rsb.connect.users.inToggleALLSelected = function(event) {rsb.toggleSelected(event);var selectedCount = $("#apiportuserspage_users_table .piportuserspage-user-checkbox:checked").length;if (selectedCount > 0) {$("#apiportuserspage_users_tbody .piportuserspage-user-checkbox:checked").each(function(){$(this).parent().parent().addClass("user-selected-row")});if(selectedCount == 1) {$("#apiportuserspage_edit_btn").removeClass("disabled")} else {$("#apiportuserspage_edit_btn").addClass("disabled")}
$("#apiportuserspage_delete_btn").removeClass("disabled")} else {$("#apiportuserspage_users_tbody tr.user-selected-row").each(function(){$(this).removeClass("user-selected-row")});$("#apiportuserspage_edit_btn").addClass("disabled");$("#apiportuserspage_delete_btn").addClass("disabled")}};rsb.connect.users.trimUsername = function(authtoken) {if (authtoken && authtoken.lastIndexOf(":") >= 0) {return authtoken.substring(authtoken.lastIndexOf(":") + 1)} else {return authtoken}};rsb.connect.users.getUsername = function(form) {var newname = form.find("input\[name=NewUser\]").val();if (newname && newname.length > 0) {return newname}
var name = form.find("input\[name=User\]").val();if (name && name.length > 0) {return name}};rsb.connect.users.updateAuthtoken = function(form, tokenEle) {var authtoken = rsb.connect.users.trimUsername(tokenEle.val());var name = rsb.connect.users.getUsername(form);if (name && name.length > 0) {tokenEle.val(name + ":" + authtoken)}};rsb.connect.users.showTokenTip = function(form) {var resultContainer = rsb.getFormResultContainer(form);rsb.showResult(resultContainer, 'For security purposes, this is the last time the authtoken will be shown. Please copy this authtoken to a safe place before saving this new user. If the authtoken is lost, a new one can be created for this user at any time.', "warning", true, false, 60 * 1000)};$(document).ready( function () {var updateLastModified = rsb.connect.users.syncResourceLastModified
var options = {serverSide: true,searching: false,autoWidth: false,sDom: "<'row'<'col-md-4 apiportuserspage-edit-bar'><'col-md-3 apiportuserspage-search-bar pull-right'>r>t<'row'<'col-md-4'i><'col-md-3'l><'col-md-5 pull-right'p>>",lengthMenu: [10, 20, 50],pageLength: rsb.pageRecordsCount.get(),language: {url : 'ui/datatables/lang/'+ 'english.js'},rowCallback: function (row, data) {$(row).click(rsb.connect.users.onUsersSelected);$(row).children("td:eq(0)").html('<input type="checkbox" class="form-check-input pointercursor piportuserspage-user-checkbox">');var maxrequest = data["maxrequest"];var maxconcurrent = data["maxconcurrent"];$(row).children("td:eq(3)").text(maxrequest > 0 ? maxrequest : rsb.connect.users.defaultMaxRequest);$(row).children("td:eq(4)").text(maxconcurrent > 0 ? maxconcurrent : rsb.connect.users.defaultMaxConcurrent);$("#apiportuserspage_user_toggle_all").prop("checked", false)},ordering: false,columns: [{width: "5px",data: null,className: "details-control center"},{data: "username",},{data: "privileges",},{data: "maxrequest",width: "160px",class: "d-none d-xl-table-cell",defaultContent: ""},{data: "maxconcurrent",width: "170px",class: "d-none d-xl-table-cell",defaultContent: ""},{data: "active",width: "40px",class: "d-none d-lg-table-cell"}
],preAjax: function(opt)  {var filter = "";if ($('.apiportuserspage-search-bar input').length > 0 && $('.apiportuserspage-search-bar input').val().length > 0) {filter = "substringof(" + rsb.odataEscape($('.apiportuserspage-search-bar input').val()) + ", username) eq True"}
opt["requestData"] = { "$filter": filter, "ConnectorId" : rsb.connect.users.options.portId, "WorkspaceId": rsb.connect.users.options.workspaceid, "connectortype":"api" }},afterAjax: function () {updateLastModified();updateLastModified = () => void 0},"initComplete": function() {$("#apiportuserspage_user_toggle_all").change(rsb.connect.users.inToggleALLSelected);var readonly = !rsb.connectorList[rsb.connect.users.options.workspaceid.toLowerCase()].connectors[rsb.connect.users.options.portId.toLowerCase()].allowedPrivileges.includes("updatesettings");if (!readonly) {$(".apiportuserspage-search-bar").html('<div class="input-group ' + rsb.connect.users.options.connString + '"><input type="text" class="form-control" placeholder="' + 'Search for...'+ '" onkeyup="$(\'#apiportuserspage_users_table\').DataTable().ajax.reload()"><span class="input-group-btn"><button class="btn btn-outline-secondary" type="button" onclick="$(\'#apiportuserspage_users_table\').DataTable().ajax.reload()">&nbsp;<i class="fa fa-search fa-3"></i></button></span></div>');$(".apiportuserspage-edit-bar").html('<div class="btn-group"><button id="add-btn" type="button" class="btn btn-primary btn-sm" onclick="rsb.connect.users.load_AddUserModal()"><i class="icon fa fa-plus"></i> ' + 'Add'+ '</button><button id="apiportuserspage_edit_btn" type="button" class="btn btn-outline-secondary btn-sm disabled" onclick="rsb.connect.users.load_EditUserModal();"><i class="icon fa fa-edit"></i> ' + 'Edit'+ '</button><button id="apiportuserspage_delete_btn" type="button" class="btn btn-outline-secondary btn-sm disabled" onclick="rsb.connect.users.delete_user();"><i class="icon fa fa-minus"></i> ' + 'Delete'+ '</button></div><div class="form-result-static alert alert-dismissible hidden" id="apiportuserspage_users_table_error"><button type="button" class="btn-close" onclick="$(this).parent().hide();"></button><content></content></div></div>')}}};rsb.initTable($("#apiportuserspage_users_table"), "src/connectorUsers.rsd", $("#apiportuserspage_users_table_error"), options);rsb.apiPort = rsb.apiPort || {};rsb.apiPort.userCallbacks = {updateAuthtoken: rsb.connect.users.updateAuthtoken,getUsername: rsb.connect.users.getUsername,showTokenTip: rsb.connect.users.showTokenTip,add_user: rsb.connect.users.add_user,edit_user: rsb.connect.users.edit_user,}
rsb.connect.loadModal("apiPortUserModals.rst", function() {if (window.self !== window.top) {rsb.apiPort.addUserModal = window.parent.rsb.apiPort.addUserModal;rsb.apiPort.editUserModal = window.parent.rsb.apiPort.editUserModal;window.parent.rsb.apiPort.userCallbacks = rsb.apiPort.userCallbacks}
rsb.apiPort.addUserModal.form.connectorid.val(rsb.connect.users.options.portId);rsb.apiPort.addUserModal.form.workspaceid.val(rsb.connect.users.options.workspaceid);rsb.apiPort.editUserModal.form.connectorid.val(rsb.connect.users.options.portId);rsb.apiPort.editUserModal.form.workspaceid.val(rsb.connect.users.options.workspaceid);const modals = [rsb.apiPort.addUserModal, rsb.apiPort.editUserModal];modals.forEach(modal => {modal.find(".default-max-request").text(rsb.connect.users.defaultMaxRequestStr);modal.find(".default-max-concurrent").text(rsb.connect.users.defaultMaxConcurrentStr)});rsb.apiPort.addUserModal.on('shown.bs.modal', function (e) {rsb.apiPort.addUserModal.form.find("button.btn-gen-token").click()})})});