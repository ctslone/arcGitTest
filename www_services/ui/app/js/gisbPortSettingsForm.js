rsb.gisbPort = rsb.gisbPort || {};rsb.gisbPort.options = rsb.gisbPort.options || {};rsb.gisbPort.init = function($options) {rsb.gisbPort.options = $.extend($options, rsb.connect.options);rsb.gisbPort.keyChanged($('#personalkeyid'), $('#personalkeyexport'))}
rsb.gisbPort.showCreateGISBKeyModal = function(key, pwd) {rsb.connect.loadModal("createGISBKeyModal.rst",{"porttype": rsb.gisbPort.options.portType}, function() {window.self !== window.top && (rsb.createGISBKey = window.parent.rsb.createGISBKey);rsb.createGISBKey.form.one("success", function (e, result) {rsb.createGISBKey.modal.modal('hide');rsb.gisbPort.addNewKey($("#alternatekeyid"), result["userid"], result["keyid"]);rsb.gisbPort.addNewKey($("#personalkeyid"), result["userid"], result["keyid"]);rsb.gisbPort.addNewKey($("#recipientkeyid"),result["userid"], result["keyid"]);key.val(result["keyid"]);pwd.val(result["passp"+"hrase"]);if (key.attr("id") == 'alternatekeyid') {rsb.gisbPort.keyChanged($('#alternatekeyid'), $('#alternatekeyexport'))} else {rsb.gisbPort.keyChanged($('#personalkeyid'), $('#personalkeyexport'))}});rsb.createGISBKey.homedirectory.val($("#homedir").val());rsb.createGISBKey.modal.modal('show')})}
rsb.gisbPort.showImportGISBKeyModal = function() {rsb.connect.loadModal("importGISBKeyModal.rst", {"porttype": rsb.gisbPort.options.portType}, function() {window.self !== window.top && (rsb.importGISBKey = window.parent.rsb.importGISBKey);rsb.importGISBKey.form.one("success", function (e, data) {rsb.importGISBKey.modal.modal('hide');var result = {items: data.items[0]};if (result.items && result.items.userid.length > 0) {var $isString = (typeof(result.items.userid) == "string");for (var index = 0; index < ($isString ? 1 : result.items.userid.length); index++) {var userId = rsb.decodeXml(($isString ? result.items.userid : result.items.userid[index]));var keyId = ($isString ? result.items.keyid : result.items.keyid[index]);rsb.gisbPort.addNewKey($("#recipientkeyid"), userId, keyId);if (($isString ? result.items.hassecretkey : result.items.hassecretkey[index]).toLowerCase() == "true") {rsb.gisbPort.addNewKey($("#personalkeyid"), userId, keyId);rsb.gisbPort.addNewKey($("#alternatekeyid"), userId, keyId)}}}});rsb.importGISBKey.modal.modal("show")})}
rsb.gisbPort.keyChanged = function(key, exportlink) {var userId = key.val();if (userId && userId.length > 0 && !exportlink.hasClass("disabled")) {var filename = (key.find("option:selected").text() || userId).replace(new RegExp('[\\|/|:|\\*|\\?|"|<|>|\||~|\\s]', 'gm'), '_');exportlink.attr("href", "src/standard/exportGISBKey.rst" + "?&userid=" + encodeURIComponent(userId) + "&filename=" + encodeURIComponent(filename) + ".gpg")} else {exportlink.attr("href", "javascript:void(0);")}}
rsb.gisbPort.addNewKey = function(obj, userId, keyId) {if (obj && userId) {var duplicate = false;obj.find("option").each(function() {if ($(this).text() == userId) {duplicate = true}});if (!duplicate) {$(obj).append($("<option>").val(keyId || userId).text(userId))}}}
$(document).ready(() => {rsb.gisbPort.keyChanged($('#personalkeyid'), $('#personalkeyexport'))});